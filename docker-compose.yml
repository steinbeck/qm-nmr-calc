# Docker Compose configuration for qm-nmr-calc
# Complete NMR prediction service with API and worker containers
#
# DEPLOYMENT OPTIONS:
#
# Option 1: Use pre-built images from GHCR (recommended for deployment)
#   Replace the 'build' sections with 'image' lines:
#     api:
#       image: ghcr.io/steinbeck/qm-nmr-calc-api:latest
#     worker:
#       image: ghcr.io/steinbeck/qm-nmr-calc-worker:latest
#
# Option 2: Build from source (for development)
#   Keep the existing 'build' configuration (default)
#
# See: https://github.com/steinbeck/qm-nmr-calc/pkgs/container/qm-nmr-calc-api
#
# Usage:
#   Start:    docker compose up -d
#   Stop:     docker compose down
#   Logs:     docker compose logs -f
#   Rebuild:  docker compose up -d --build
#
# Configuration: Copy .env.example to .env and customize values

services:
  # Init service: ensures data volume has correct permissions (UID 999 for appuser)
  # Runs once on startup, then exits
  init:
    image: alpine:latest
    volumes:
      - app-data:/app/data
    command: chown -R 999:999 /app/data
    restart: "no"

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    expose:
      - "8000"
    volumes:
      - app-data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
    env_file:
      - path: .env
        required: false
    depends_on:
      init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  caddy:
    image: caddy:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3 (QUIC)
    cap_add:
      - NET_ADMIN  # Required for QUIC/HTTP3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    depends_on:
      api:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    volumes:
      - app-data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - NWCHEM_NPROC=${NWCHEM_NPROC:-4}
      - OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}
    env_file:
      - path: .env
        required: false
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    # CRITICAL: Huey uses SIGINT for graceful shutdown (finish current task)
    # Docker default SIGTERM causes immediate termination, losing work
    stop_signal: SIGINT
    # Allow 5 minutes for long NMR calculations to complete
    stop_grace_period: 300s
    # MPI requires larger shared memory than Docker's 64MB default
    shm_size: 512m
    # Resource limits (configurable via environment)
    deploy:
      resources:
        limits:
          memory: ${WORKER_MEMORY_LIMIT:-8g}
    healthcheck:
      test: ["CMD", "pgrep", "-f", "huey_consumer"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3

volumes:
  app-data:
    name: qm-nmr-calc-data
  caddy_data:
    name: qm-nmr-calc-caddy-data
  caddy_config:
