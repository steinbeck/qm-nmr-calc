# Milestone v2.4: Docker Deployment

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 35-40
**Total Plans:** 8

## Overview

Docker deployment transforms qm-nmr-calc from a manual installation into a `docker compose up` experience. The roadmap progressed from the most complex, blocking component (worker container with NWChem/CREST/xTB) through orchestration and HTTPS, culminating in CI/CD publishing and documentation. Each phase delivered a testable increment toward production-ready containerization.

## Phases

### Phase 35: Worker Container

**Goal**: NWChem, CREST, and xTB run correctly in a Docker container with all environment configuration.
**Depends on**: Nothing (first phase of v2.4)
**Requirements**: DOCK-02
**Plans**: 1 plan

Plans:
- [x] 35-01-PLAN.md -- Create and validate worker container with NWChem, CREST, xTB, and Huey

**Details:**
- Miniconda Python 3.11 for glibc compatibility
- MPI configured with OMPI_ALLOW_RUN_AS_ROOT
- Worker image size: 2.1GB

### Phase 36: API Container

**Goal**: FastAPI application runs in a minimal, secure container with health checks.
**Depends on**: Nothing (parallel with Phase 35)
**Requirements**: DOCK-03
**Plans**: 1 plan

Plans:
- [x] 36-01-PLAN.md -- Create Dockerfile.api with multi-stage build and validation script

**Details:**
- Multi-stage build for minimal image size (~733MB)
- Non-root user execution
- X11 libraries (libxrender1, libxext6, libexpat1) for RDKit drawing

### Phase 37: Docker Compose Integration

**Goal**: Complete deployment with single `docker compose up -d` command, persistent data, and operational controls.
**Depends on**: Phase 35, Phase 36
**Requirements**: DOCK-01, DOCK-04, DOCK-05, DOCK-06, DOCK-07, DOCK-08, DOCK-09, OPS-01, OPS-02, OPS-03, OPS-04
**Plans**: 2 plans

Plans:
- [x] 37-01-PLAN.md -- Create docker-compose.yml and .env.example configuration
- [x] 37-02-PLAN.md -- Validation script and integration testing

**Details:**
- Named volumes for job data and Huey queue persistence
- SIGINT for Huey graceful shutdown, 5-min grace period
- 512MB shm_size for MPI shared memory
- Health checks and restart policies

### Phase 38: Caddy + HTTPS

**Goal**: Production-ready HTTPS with automatic certificate management via Let's Encrypt.
**Depends on**: Phase 37
**Requirements**: HTTPS-01, HTTPS-02, HTTPS-03, HTTPS-04, HTTPS-05
**Plans**: 1 plan

Plans:
- [x] 38-01-PLAN.md -- Add Caddy reverse proxy with conditional HTTPS

**Details:**
- Conditional HTTPS: domain set → Let's Encrypt, empty → HTTP localhost
- Automatic certificate renewal
- HTTP-to-HTTPS redirect

### Phase 39: CI/CD + GHCR Publishing

**Goal**: Pre-built images available on GitHub Container Registry, built automatically on release.
**Depends on**: Phase 38
**Requirements**: GHCR-01, GHCR-02, GHCR-03, GHCR-04
**Plans**: 1 plan

Plans:
- [x] 39-01-PLAN.md -- Create GitHub Actions workflow for GHCR publishing with OCI labels

**Details:**
- Worker amd64-only due to CREST/xTB lacking arm64 binaries
- API image supports amd64+arm64 for broader deployment options
- GITHUB_TOKEN authentication for GHCR (not PAT)
- GHA cache with per-image scope to avoid cache eviction

### Phase 40: Documentation

**Goal**: Users can deploy qm-nmr-calc in 5 minutes with clear guidance for production setup and troubleshooting.
**Depends on**: Phase 39
**Requirements**: DOCS-01, DOCS-02, DOCS-03, DOCS-04
**Plans**: 2 plans

Plans:
- [x] 40-01-PLAN.md -- Add Docker quick start to README
- [x] 40-02-PLAN.md -- Create deployment guide with VPS setup, troubleshooting, and backup/restore

**Details:**
- Docker as primary deployment method in README
- 460-line comprehensive deployment guide
- VPS providers: DigitalOcean, Linode, Hetzner, Vultr
- Troubleshooting from v2.4 research pitfalls

---

## Milestone Summary

**Key Decisions:**
- Worker image amd64-only due to CREST/xTB lacking arm64 binaries
- API image supports amd64+arm64 for broader deployment options
- GITHUB_TOKEN authentication for GHCR (not PAT)
- GHA cache with per-image scope to avoid cache eviction
- Docker as primary deployment method in README (not source installation)
- Pre-built GHCR images referenced as default (not build-from-source)
- Comprehensive single guide for deployment (combined VPS, troubleshooting, backup)

**Issues Resolved:**
- Miniconda Python 3.11 for glibc compatibility in worker container
- X11 libraries for RDKit headless rendering
- SIGINT for Huey graceful shutdown
- 512MB shm_size for MPI shared memory

**Issues Deferred:**
- arm64 worker image (waiting for CREST/xTB arm64 binaries)

**Technical Debt Incurred:**
- None

---

*For current project status, see .planning/ROADMAP.md*
