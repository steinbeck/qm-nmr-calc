# Milestone v1.1: Accurate Chemical Shifts

**Status:** SHIPPED 2026-01-25
**Phases:** 7-11.2 (8 phases, 3 inserted)
**Total Plans:** 21

## Overview

Milestone v1.1 replaces the ISiCLE dependency with direct NWChem integration, derives NWChem-specific scaling factors from DELTA50 benchmark data, and delivers accurate solvated NMR predictions with publication-quality results. Additionally adds interactive 3D molecule visualization and vacuum (gas-phase) calculation support.

## Phases

### Phase 7: NWChem Integration
**Goal**: System directly handles NWChem I/O and enables accurate solvated calculations
**Depends on**: Phase 6
**Requirements**: NW-01, NW-02, NW-03, NW-04, NW-05, NW-06
**Success Criteria** (what must be TRUE):
  1. System generates valid NWChem input files for geometry optimization without ISiCLE runtime
  2. System generates valid NWChem input files for NMR shielding with COSMO solvation
  3. System parses NWChem output files to extract shielding tensors for H and C atoms
  4. User can submit pre-optimized geometry and system skips geometry optimization step
  5. ISiCLE attribution is visible in code comments and documentation where code adapted
**Plans**: 4 plans

Plans:
- [x] 07-01-PLAN.md -- NWChem input generation module (geometry opt + NMR shielding with COSMO)
- [x] 07-02-PLAN.md -- NWChem output parsing module (geometry extraction + shielding tensors)
- [x] 07-03-PLAN.md -- Geometry handling (SMILES-to-3D via RDKit, XYZ/SDF loading)
- [x] 07-04-PLAN.md -- Integration (replace isicle_wrapper, update tasks.py, add attribution)

**Completed:** 2026-01-21

### Phase 8: DELTA50 Setup
**Goal**: DELTA50 benchmark infrastructure ready to execute calculation matrix
**Depends on**: Phase 7
**Requirements**: BENCH-01, BENCH-02, BENCH-03
**Success Criteria** (what must be TRUE):
  1. All 50 DELTA50 molecule structures are available in SDF or XYZ format
  2. Experimental 1H and 13C shift values are stored with molecule ID associations
  3. Benchmark runner can execute calculations for all combinations: 50 molecules x 2 functionals x 2 solvents
  4. Benchmark runner outputs raw calculation results in organized directory structure
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md -- DELTA50 data acquisition and benchmark data loader module
- [x] 08-02-PLAN.md -- Benchmark runner with CLI, resume support, and summary generation

**Completed:** 2026-01-21

### Phase 8.1: DELTA50 Data Viewer (INSERTED)
**Goal**: Web interface to visually verify extracted DELTA50 structures and experimental shifts before benchmark execution
**Depends on**: Phase 8
**Requirements**: None (QA/validation tool)
**Success Criteria** (what must be TRUE):
  1. Sidebar lists all 50 DELTA50 molecules (selectable)
  2. Selected molecule shows metadata (name, compound ID, atom counts)
  3. 3Dmol.js visualization displays molecule structure with experimental shifts annotated at atoms
  4. Both 1H and 13C shifts visible on the 3D structure
**Plans**: 1 plan

Plans:
- [x] 08.1-01-PLAN.md -- Benchmark viewer with 3Dmol.js, sidebar, and shift labels

**Completed:** 2026-01-22

### Phase 9: Benchmark Calculations
**Goal**: Complete DELTA50 calculation matrix for scaling factor derivation
**Depends on**: Phase 8
**Requirements**: None (execution phase using Phase 8 infrastructure)
**Success Criteria** (what must be TRUE):
  1. All 50 DELTA50 molecules calculated with B3LYP in CHCl3 (50 calculations)
  2. All 50 DELTA50 molecules calculated with B3LYP in DMSO (50 calculations)
  3. Failed calculations documented with error analysis (if any)
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md -- Runner enhancement (status.json, graceful stop, headless mode)
- [x] 09-02-PLAN.md -- Execute pilot (5 molecules) then full headless run (100 B3LYP calculations)

**Completed:** 2026-01-22

### Phase 10: Scaling Factors
**Goal**: Derive and validate NWChem-specific scaling factors from benchmark data
**Depends on**: Phase 9
**Requirements**: SCALE-01, SCALE-02, SCALE-03 (SCALE-04 deferred - no WP04 data)
**Success Criteria** (what must be TRUE):
  1. Scaling factors (slope, intercept) derived via linear regression for B3LYP/CHCl3
  2. Scaling factors derived for B3LYP/DMSO (WP04 deferred - no benchmark data)
  3. Each scaling factor set validated with MAE and RMSD statistics vs experimental shifts
  4. Scaling factors stored in code-accessible format (JSON, Python constants, or config file)
  5. Validation report shows accuracy improvement over current CHESHIRE factors
**Plans**: 2 plans

Plans:
- [x] 10-01-PLAN.md -- Analysis module with data aggregation, OLS regression, ScalingFactor model
- [x] 10-02-PLAN.md -- Report generation with plots, SCALING-FACTORS.md, CLI analyze command

**Completed:** 2026-01-23

### Phase 11: Production Integration
**Goal**: Production calculations use NWChem-derived DELTA50 factors; ISiCLE dependency removed
**Depends on**: Phase 10
**Requirements**: PROD-02, PROD-04 (PROD-01 satisfied in Phase 7, PROD-03 deferred - WP04)
**Success Criteria** (what must be TRUE):
  1. Production calculations use NWChem-derived scaling factors instead of CHESHIRE
  2. ISiCLE is no longer a runtime dependency (removed from pyproject.toml)
  3. API responses include scaling factor metadata (source, expected MAE)
  4. UI and API branding references NWChem only (not ISiCLE)
**Plans**: 3 plans

Plans:
- [x] 11-01-PLAN.md -- Scaling factors infrastructure and pyproject.toml cleanup
- [x] 11-02-PLAN.md -- ISiCLE model removal from JobStatus and storage
- [x] 11-03-PLAN.md -- API metadata enhancement and UI branding update

**Completed:** 2026-01-23

### Phase 11.1: 3D Molecule Visualization (INSERTED)
**Goal**: Add interactive 3D molecule visualization to job status/results page using 3Dmol.js
**Depends on**: Phase 11
**Requirements**: None (UX enhancement)
**Success Criteria** (what must be TRUE):
  1. Job results page displays interactive 3D molecule structure
  2. Calculated chemical shifts are annotated on atoms in 3D view
  3. 3Dmol.js viewer allows rotation/zoom of molecule
  4. Visualization uses optimized geometry from NWChem calculation
**Plans**: 2 plans

Plans:
- [x] 11.1-01-PLAN.md -- Backend: initial geometry storage and geometry.json API endpoint
- [x] 11.1-02-PLAN.md -- Frontend: 3Dmol.js viewer on status and results pages

**Completed:** 2026-01-24

### Phase 11.2: Vacuum Benchmark Calculations (INSERTED)
**Goal**: Run DELTA50 benchmark without solvent (vacuum/gas phase) to provide scaling factors for gas-phase NMR predictions
**Depends on**: Phase 11.1
**Requirements**: None (extends benchmark coverage)
**Success Criteria** (what must be TRUE):
  1. All 50 DELTA50 molecules calculated with B3LYP in vacuum (no COSMO)
  2. Scaling factors derived for B3LYP/vacuum via linear regression
  3. Vacuum scaling factors validated with MAE/RMSD statistics
  4. Production system supports vacuum as solvent option
**Plans**: 3 plans

Plans:
- [x] 11.2-01-PLAN.md -- Enable vacuum support in input_gen.py and benchmark runner
- [x] 11.2-02-PLAN.md -- Execute vacuum benchmark (50 B3LYP calculations)
- [x] 11.2-03-PLAN.md -- Derive vacuum scaling factors and update production

**Completed:** 2026-01-25

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 7. NWChem Integration | 4/4 | Complete | 2026-01-21 |
| 8. DELTA50 Setup | 2/2 | Complete | 2026-01-21 |
| 8.1. DELTA50 Data Viewer | 1/1 | Complete | 2026-01-22 |
| 9. Benchmark Calculations | 2/2 | Complete | 2026-01-22 |
| 10. Scaling Factors | 2/2 | Complete | 2026-01-23 |
| 11. Production Integration | 3/3 | Complete | 2026-01-23 |
| 11.1. 3D Molecule Visualization | 2/2 | Complete | 2026-01-24 |
| 11.2. Vacuum Benchmark Calculations | 3/3 | Complete | 2026-01-25 |

## Milestone Summary

**Decimal Phases:**
- Phase 8.1: DELTA50 Data Viewer (inserted after Phase 8 for QA verification of extracted data)
- Phase 11.1: 3D Molecule Visualization (inserted after Phase 11 for testing new scaling factors with interactive viewer)
- Phase 11.2: Vacuum Benchmark Calculations (inserted after Phase 11.1 for gas-phase scaling factor derivation)

**Key Decisions:**
- Direct NWChem I/O instead of ISiCLE wrapper (simpler, more control)
- COSMO solvation applied to both geometry optimization and NMR shielding
- OLS regression with 3-sigma outlier removal for scaling factors
- Composite factor keys: functional/basis_set/nucleus/solvent
- Vacuum as special solvent value (not separate parameter)
- ETKDGv3 with deterministic seeding (0xF00D) for conformer generation
- Rolling average of last 10 calculations for ETA
- noautoz as optional parameter for linear molecule AUTOZ failure recovery
- 3Dmol.js from CDN for minimal build complexity
- Initial geometry generated before optimization for progressive visualization

**Issues Resolved:**
- COSMO solvation bug fixed (was only applied to shielding, now both optimization and shielding)
- compound_14 (2-butyne) AUTOZ failure fixed with noautoz directive
- ISiCLE runtime dependency fully removed
- Bond order display in 3D viewer improved with SDF format

**Issues Deferred:**
- WP04 functional support (NWChem doesn't support WP04 without custom compilation)
- SCALE-04 and PROD-03 deferred accordingly

**Technical Debt Incurred:**
- NWChem version hardcoded as "7.0.2" (TODO for dynamic parsing)

---

_For current project status, see .planning/ROADMAP.md_
