# Roadmap Archive: v2.7 Automated GCP Deployment

**Shipped:** 2026-02-06
**Phases:** 49-53 (5 phases, 9 plans)
**Duration:** ~32 minutes execution time
**Commits:** 38 (ab0abd9..0829934)
**Code changes:** 22 files changed, 2,607 insertions, 152 deletions (excluding planning docs)

## Milestone Goal

Fully non-interactive GCP deployment that reads config from a file, auto-discovers the cheapest spot instance across all regions, and deploys end-to-end without manual intervention. HTTP-only deployment pattern for fire-up-and-burn usage. Also fixes conformer progress tracking display bug.

## Accomplishments

### Phase 49: Config Foundation and Pricing Query
- TOML config file with Pydantic validation for CPU, RAM, GCP project, disk size
- CloudPrice.net API integration for spot pricing across all GCP regions
- Three-tier price resolution: cache (24h TTL) -> API -> hardcoded fallback
- Bash wrapper libraries (config.sh, pricing.sh) for shell integration
- 19 config tests + 19 pricing tests (TDD)

### Phase 50: Machine Selection and Resource Calculation
- Machine type selection via gcloud with CPU/RAM filtering
- Zone validation with regional fallback using ranked pricing data
- Docker resource calculation: VM RAM - 8GB OS overhead
- HTTP-only startup script generator with runtime nproc detection
- Bash wrapper library (machine.sh) for shell integration
- 19 machine selection tests (TDD)

### Phase 51: Deployment Orchestration
- Infrastructure library (infra.sh): logging, dry-run wrapper, cleanup trap, idempotent operations
- deploy-auto.sh orchestrator: single command, zero prompts, end-to-end deployment
- Six-step pipeline: config -> auth -> machine -> cost -> infra -> VM
- Cost estimate display before VM creation
- Dry-run mode (--dry-run) for safe testing
- Auto-cleanup on failure (VM-only, never disks or IPs)
- Replaces v2.6 interactive deploy-vm.sh

### Phase 52: HTTP-Only Container Deployment
- All 6 lifecycle scripts (start, stop, delete, status, ssh, logs) migrated to TOML config
- Runtime zone detection via gcloud compute instances list
- HTTP-only access (no HTTPS/domain/Caddy references)
- Teardown script with graceful degradation when zone unknown

### Phase 53: Conformer Progress Bug Fix
- One-line fix: added `update_job_status(job_id, conformer_ensemble=ensemble)` to on_progress callback
- Root cause: ensemble mutations not persisted to disk for frontend visibility
- Status bar now shows accurate conformer count (e.g., "1/2" not "0/2")

## Requirements Coverage

31/31 requirements satisfied (100%):
- Configuration (CFG-01 through CFG-05): 5/5
- Pricing (PRC-01 through PRC-05): 5/5
- Machine Selection (MCH-01 through MCH-04): 4/4
- Deployment (DEP-01 through DEP-09): 9/9
- Lifecycle (LCY-01, LCY-02): 2/2
- V2.6 Replacement (RPL-01 through RPL-04): 4/4
- Bug Fix (BUG-01, BUG-02): 2/2

## Key Files Created

- `gcp/__init__.py` - Package marker
- `gcp/validate_config.py` - Pydantic config validation
- `gcp/config.toml.example` - Example TOML config
- `gcp/query_pricing.py` - CloudPrice.net API + cache + fallback
- `gcp/select_machine.py` - Machine type selection + Docker resources
- `gcp/lib/config.sh` - Bash config wrapper
- `gcp/lib/pricing.sh` - Bash pricing wrapper
- `gcp/lib/machine.sh` - Bash machine wrapper
- `gcp/lib/infra.sh` - Infrastructure operations library
- `gcp/deploy-auto.sh` - Main deployment orchestrator
- `tests/test_gcp_config.py` - Config validation tests (19)
- `tests/test_gcp_pricing.py` - Pricing query tests (19)
- `tests/test_gcp_machine.py` - Machine selection tests (19)

## Key Files Modified

- `gcp/start-vm.sh` - TOML config + runtime zone detection
- `gcp/stop-vm.sh` - TOML config + runtime zone detection
- `gcp/delete-vm.sh` - TOML config + runtime zone detection
- `gcp/status-vm.sh` - TOML config + HTTP URLs
- `gcp/ssh-vm.sh` - TOML config + runtime zone detection
- `gcp/logs-vm.sh` - TOML config + runtime zone detection
- `gcp/teardown-infrastructure.sh` - TOML config + graceful zone detection
- `src/qm_nmr_calc/tasks.py` - Conformer progress persistence fix

## Key Decisions

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| TOML config (not YAML) | Python stdlib support, clean syntax | Good -- simple, no deps |
| CloudPrice.net API | Free, no auth, covers spot pricing | Good -- with fallback |
| Extend v2.6 bash scripts | Avoid full rewrite risk | Good -- incremental |
| HTTP-only deployment | Fire-up-and-burn pattern, no domain needed | Good -- simpler |
| Modular bash libraries | Composable, testable, reusable | Good -- clean architecture |
| VM RAM - 8GB for Docker | Leave headroom for OS and overhead | Good -- stable |
| Runtime nproc detection | Works regardless of machine type | Good -- dynamic |

---
*Archived: 2026-02-06*
