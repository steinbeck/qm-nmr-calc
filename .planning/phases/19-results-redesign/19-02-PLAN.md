---
phase: 19-results-redesign
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/qm_nmr_calc/api/templates/results.html
  - src/qm_nmr_calc/api/templates/base.html
autonomous: true

must_haves:
  truths:
    - "3D molecular viewer displayed in hero card position (span-4, largest)"
    - "1H and 13C spectrum images displayed in span-2 cards side by side"
    - "Ensemble metadata card only renders for ensemble jobs (Jinja2 conditional)"
    - "Chemical shift tables in glass-card containers with proper headers"
    - "Download buttons grouped in full-width card (span-6)"
    - "Calculation details visible in dedicated card"
    - "Conformer selector appears only for ensemble jobs"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/results.html"
      provides: "Bento grid layout with glass cards and viewer card"
      contains: "bento-grid"
    - path: "src/qm_nmr_calc/api/templates/base.html"
      provides: "CSS link for results-page.css"
      contains: "results-page.css"
  key_links:
    - from: "results.html"
      to: "results-page.css"
      via: "CSS class references"
      pattern: "viewer-card|shift-table|download-btn"
    - from: "results.html"
      to: "glass-card.css"
      via: "CSS class references"
      pattern: "glass-card"
    - from: "results.html"
      to: "/api/v1/jobs/{job_id}"
      via: "JavaScript fetch"
      pattern: "fetch.*api/v1/jobs"
---

<objective>
Update results.html template to use bento grid layout with glass cards and the new viewer-card component.

Purpose: Transform the existing linear layout into a modern bento grid with prominent 3D viewer, organized data cards, and clear visual hierarchy. Existing JavaScript functionality (3Dmol.js, conformer selector, image modal) must continue working.

Output: Updated `results.html` template using Phase 18 CSS classes and Plan 19-01 components, plus base.html update to conditionally load results-page.css.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-results-redesign/19-RESEARCH.md

# Current template for reference
@src/qm_nmr_calc/api/templates/results.html

# Phase 18 layout reference
@src/qm_nmr_calc/api/static/css/layout.css
@src/qm_nmr_calc/api/static/css/components/glass-card.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update base.html to load results-page.css conditionally</name>
  <files>src/qm_nmr_calc/api/templates/base.html</files>
  <action>
The results-page.css should be loaded only on the results page. Add a block in base.html for page-specific CSS that results.html can use.

In base.html, add a new block after the components CSS link and before utilities.css:

```html
<!-- Components -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/components/glass-card.css') }}">
{% block page_css %}{% endblock %}
<!-- Utilities (highest priority) -->
```

This allows child templates to inject page-specific CSS in the correct cascade order (after components, before utilities).
  </action>
  <verify>
`grep -A1 "page_css" src/qm_nmr_calc/api/templates/base.html` shows the block definition
  </verify>
  <done>
base.html has {% block page_css %}{% endblock %} after components CSS for page-specific stylesheets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite results.html with bento grid layout</name>
  <files>src/qm_nmr_calc/api/templates/results.html</files>
  <action>
Replace the existing results.html content with the new bento grid layout. The JavaScript remains mostly the same (element IDs preserved where possible).

**Key layout structure (6-column desktop grid):**

```
Row 1-2:
+---------------------------+---------------+---------------+
|      3D Viewer (span-4)   |   1H Spectrum |  13C Spectrum |
|       (spans 2 rows)      |    (span-2)   |    (span-2)   |
|                           +---------------+---------------+
|                           |  Ensemble Metadata (span-2)   |
+---------------------------+-------------------------------+

Row 3:
+---------------------------+---------------+---------------+
|  Calculation Details      |  1H Shifts    |  13C Shifts   |
|       (span-2)            |   (span-2)    |    (span-2)   |
+---------------------------+---------------+---------------+

Row 4:
+-----------------------------------------------------------+
|              Downloads (span-6 full width)                |
+-----------------------------------------------------------+
```

**HTML structure:**

```html
{% extends "base.html" %}

{% block title %}Results: {{ job.input_name or job.job_id }} | QM NMR Calculator{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>
{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/results-page.css') }}">
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <header class="results-header">
        <h1>NMR Calculation Results</h1>
        <p class="muted">{{ job.input_name or job.job_id }}</p>
    </header>

    <div class="bento-grid">
        <!-- 3D Viewer (Hero Position - span-4, row-span-2) -->
        <div class="bento-grid__item bento-grid__item--span-4 bento-grid__item--span-row-2">
            <div class="viewer-card">
                <header class="viewer-card__header">
                    <h3 class="viewer-card__title">Interactive 3D Structure</h3>
                    {% if job.conformer_mode == 'ensemble' %}
                    <div class="viewer-card__controls">
                        <label for="conformer-selector" class="sr-only">View Conformer</label>
                        <select id="conformer-selector" class="conformer-select">
                            <!-- Populated by JavaScript -->
                        </select>
                        <span id="current-conformer-info" class="conformer-info"></span>
                    </div>
                    {% endif %}
                </header>
                <div id="viewer-container-3d" class="viewer-card__canvas">
                    <!-- 3Dmol.js renders here -->
                </div>
                <footer class="viewer-card__footer">
                    <div class="viewer-legend">
                        <div class="viewer-legend-item">
                            <span class="viewer-legend-color h1"></span>
                            <span id="legend-h1-label"><sup>1</sup>H shifts (ppm)</span>
                        </div>
                        <div class="viewer-legend-item">
                            <span class="viewer-legend-color c13"></span>
                            <span id="legend-c13-label"><sup>13</sup>C shifts (ppm)</span>
                        </div>
                    </div>
                    <small class="muted">Click and drag to rotate. Scroll to zoom.</small>
                    {% if job.conformer_mode == 'ensemble' %}
                    <div id="ensemble-viewer-note" class="ensemble-note">
                        <strong>Note:</strong> Shift labels show <em>Boltzmann-averaged</em> values. Use the dropdown to view different conformer geometries.
                    </div>
                    {% endif %}
                </footer>
            </div>
        </div>

        <!-- 1H Spectrum Card (span-2) -->
        <div class="bento-grid__item bento-grid__item--span-2">
            <article class="glass-card glass-card--interactive">
                <header class="glass-card__header">
                    <h3 class="glass-card__title"><sup>1</sup>H NMR Spectrum</h3>
                </header>
                <div class="glass-card__body">
                    <figure class="spectrum-figure">
                        <img src="/api/v1/jobs/{{ job.job_id }}/spectrum/1h.png"
                             alt="1H NMR spectrum"
                             class="spectrum-figure__image"
                             onclick="openModal(this.src)">
                    </figure>
                    <small class="muted">Click to enlarge</small>
                </div>
            </article>
        </div>

        <!-- 13C Spectrum Card (span-2) -->
        <div class="bento-grid__item bento-grid__item--span-2">
            <article class="glass-card glass-card--interactive">
                <header class="glass-card__header">
                    <h3 class="glass-card__title"><sup>13</sup>C NMR Spectrum</h3>
                </header>
                <div class="glass-card__body">
                    <figure class="spectrum-figure">
                        <img src="/api/v1/jobs/{{ job.job_id }}/spectrum/13c.png"
                             alt="13C NMR spectrum"
                             class="spectrum-figure__image"
                             onclick="openModal(this.src)">
                    </figure>
                    <small class="muted">Click to enlarge</small>
                </div>
            </article>
        </div>

        <!-- Ensemble Metadata Card (span-2) - ONLY FOR ENSEMBLE JOBS -->
        {% if job.conformer_mode == 'ensemble' %}
        <div class="bento-grid__item bento-grid__item--span-2">
            <article class="glass-card glass-card--featured" id="ensemble-metadata">
                <header class="glass-card__header">
                    <h3 class="glass-card__title">Ensemble Summary</h3>
                </header>
                <div class="glass-card__body">
                    <!-- Warning banner if CREST fallback -->
                    <div id="ensemble-warning" class="warning-banner" style="display: none;">
                        <strong>Note:</strong> <span id="warning-text"></span>
                    </div>

                    <dl class="metadata-list">
                        <div class="metadata-list__item">
                            <dt>Conformers Used</dt>
                            <dd id="meta-conformer-count">-</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Total Generated</dt>
                            <dd id="meta-total-generated">-</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Method</dt>
                            <dd id="meta-method">-</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Temperature</dt>
                            <dd id="meta-temperature">-</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Energy Range</dt>
                            <dd id="meta-energy-range">-</dd>
                        </div>
                    </dl>

                    <h4>Top Contributors</h4>
                    <table class="conformer-table" id="top-conformers-table">
                        <thead>
                            <tr>
                                <th>Conformer</th>
                                <th>Population</th>
                                <th>Rel. Energy</th>
                            </tr>
                        </thead>
                        <tbody id="top-conformers-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </article>
        </div>
        {% endif %}

        <!-- Calculation Details Card (span-2) -->
        <div class="bento-grid__item bento-grid__item--span-2">
            <article class="glass-card">
                <header class="glass-card__header">
                    <h3 class="glass-card__title">Calculation Details</h3>
                </header>
                <div class="glass-card__body">
                    <dl class="metadata-list">
                        <div class="metadata-list__item">
                            <dt>Preset</dt>
                            <dd>{{ job.preset }}</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Solvent</dt>
                            <dd>{{ job.solvent }}</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Functional</dt>
                            <dd>{{ results.functional }}</dd>
                        </div>
                        <div class="metadata-list__item">
                            <dt>Basis Set</dt>
                            <dd>{{ results.basis_set }}</dd>
                        </div>
                    </dl>
                    <details>
                        <summary>SMILES</summary>
                        <code>{{ job.input_smiles }}</code>
                    </details>
                </div>
            </article>
        </div>

        <!-- 1H Shifts Table Card (span-2) -->
        <div class="bento-grid__item bento-grid__item--span-2">
            <article class="glass-card">
                <header class="glass-card__header">
                    <h3 class="glass-card__title"><sup>1</sup>H Chemical Shifts</h3>
                </header>
                <div class="glass-card__body">
                    <table class="shift-table">
                        <thead>
                            <tr>
                                <th>Atom</th>
                                <th>Shift (ppm)</th>
                            </tr>
                        </thead>
                        <tbody id="h1-shifts-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </article>
        </div>

        <!-- 13C Shifts Table Card (span-2) -->
        <div class="bento-grid__item bento-grid__item--span-2">
            <article class="glass-card">
                <header class="glass-card__header">
                    <h3 class="glass-card__title"><sup>13</sup>C Chemical Shifts</h3>
                </header>
                <div class="glass-card__body">
                    <table class="shift-table">
                        <thead>
                            <tr>
                                <th>Atom</th>
                                <th>Shift (ppm)</th>
                            </tr>
                        </thead>
                        <tbody id="c13-shifts-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </article>
        </div>

        <!-- Downloads Card (span-6 full width) -->
        <div class="bento-grid__item bento-grid__item--span-6">
            <article class="glass-card glass-card--subtle">
                <header class="glass-card__header">
                    <h3 class="glass-card__title">Downloads</h3>
                </header>
                <div class="glass-card__body">
                    <div class="download-grid">
                        <a href="/api/v1/jobs/{{ job.job_id }}/geometry" class="download-btn">
                            <span class="download-btn__label">Geometry (XYZ)</span>
                        </a>
                        <a href="/api/v1/jobs/{{ job.job_id }}/geometry.sdf" class="download-btn">
                            <span class="download-btn__label">Geometry (SDF)</span>
                        </a>
                        <a href="/api/v1/jobs/{{ job.job_id }}/output" class="download-btn">
                            <span class="download-btn__label">Raw Output (ZIP)</span>
                        </a>
                        <a href="/api/v1/jobs/{{ job.job_id }}/spectrum/1h.png" class="download-btn" download>
                            <span class="download-btn__label">1H Spectrum (PNG)</span>
                        </a>
                        <a href="/api/v1/jobs/{{ job.job_id }}/spectrum/13c.png" class="download-btn" download>
                            <span class="download-btn__label">13C Spectrum (PNG)</span>
                        </a>
                        <a href="/api/v1/jobs/{{ job.job_id }}/structure.png" class="download-btn" download>
                            <span class="download-btn__label">Structure (PNG)</span>
                        </a>
                    </div>
                </div>
            </article>
        </div>
    </div>

    <p class="back-link"><a href="/">Submit another job</a></p>
</div>

<!-- Image Modal (reuse existing) -->
<dialog id="image-modal">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="closeModal()"></button>
        </header>
        <img id="modal-image" class="modal-image" alt="Enlarged view">
    </article>
</dialog>
{% endblock %}

{% block scripts %}
<!-- Keep existing JavaScript with minor updates -->
```

**JavaScript updates needed:**
1. Update `displayShiftTable` to populate the new table IDs (`h1-shifts-body`, `c13-shifts-body`)
2. Remove old `#shift-comparison-details` logic (now tables are always visible)
3. Remove `style="display: none"` JS toggling for ensemble elements (Jinja2 handles conditional rendering)
4. Keep all existing functionality: modal, 3Dmol.js viewer, conformer selector

**JavaScript section (updated):**
```javascript
<script>
const modal = document.getElementById('image-modal');
const modalImage = document.getElementById('modal-image');

function openModal(src) {
    modalImage.src = src;
    modal.showModal();
    document.body.classList.add('modal-is-open');
}

function closeModal() {
    modal.close();
    document.body.classList.remove('modal-is-open');
}

modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
});

modal.addEventListener('cancel', closeModal);

// 3D Viewer with shift labels and conformer switching
const JOB_ID = "{{ job.job_id }}";
let viewer = null;
let geometryData = null;
let currentConformerIndex = 0;
let jobData = null;

document.addEventListener('DOMContentLoaded', function() {
    initViewer();
    loadJobMetadata();
});

async function loadJobMetadata() {
    try {
        const response = await fetch('/api/v1/jobs/' + JOB_ID);
        jobData = await response.json();

        // Always populate shift tables
        if (jobData.nmr_results) {
            populateShiftTables(jobData.nmr_results);
        }

        // Ensemble-specific metadata (only if ensemble card exists in DOM)
        if (jobData.conformer_mode === 'ensemble' && jobData.ensemble_metadata) {
            displayEnsembleMetadata(jobData.ensemble_metadata, jobData.conformer_method_warning);
        }
    } catch (error) {
        console.error('Failed to load job metadata:', error);
    }
}

function populateShiftTables(nmrResults) {
    const h1Body = document.getElementById('h1-shifts-body');
    if (h1Body && nmrResults.h1_shifts) {
        h1Body.innerHTML = nmrResults.h1_shifts.map(s => `
            <tr>
                <td>H${s.index}</td>
                <td>${s.shift.toFixed(2)}</td>
            </tr>
        `).join('');
    }

    const c13Body = document.getElementById('c13-shifts-body');
    if (c13Body && nmrResults.c13_shifts) {
        c13Body.innerHTML = nmrResults.c13_shifts.map(s => `
            <tr>
                <td>C${s.index}</td>
                <td>${s.shift.toFixed(1)}</td>
            </tr>
        `).join('');
    }
}

function displayEnsembleMetadata(metadata, warning) {
    // Display warning if present
    if (warning) {
        const warningEl = document.getElementById('ensemble-warning');
        if (warningEl) {
            warningEl.style.display = 'block';
            document.getElementById('warning-text').textContent = warning;
        }
    }

    // Populate metadata fields (check existence first - Jinja2 may not render)
    const setIfExists = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    setIfExists('meta-conformer-count', metadata.conformer_count);
    setIfExists('meta-total-generated', metadata.total_generated);
    setIfExists('meta-method', metadata.method === 'rdkit_kdg' ? 'RDKit KDG' : 'CREST/xTB');
    setIfExists('meta-temperature', metadata.temperature_k + ' K');
    setIfExists('meta-energy-range', metadata.energy_range_kcal.toFixed(2) + ' kcal/mol');

    // Populate top conformers table
    const tbody = document.getElementById('top-conformers-body');
    if (tbody) {
        tbody.innerHTML = metadata.top_populations.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${(c.population * 100).toFixed(1)}%</td>
                <td>${c.energy_kcal !== null ? c.energy_kcal.toFixed(2) : '-'}</td>
            </tr>
        `).join('');
    }
}

function initViewer() {
    const container = document.getElementById('viewer-container-3d');
    if (!container) return;

    viewer = $3Dmol.createViewer(container, {
        backgroundColor: 'white'
    });
    loadGeometryData();
}

async function loadGeometryData() {
    if (!viewer) return;

    try {
        const response = await fetch('/api/v1/jobs/' + JOB_ID + '/geometry.json');
        if (!response.ok) {
            console.error('Failed to load geometry');
            return;
        }

        geometryData = await response.json();

        // Check if this is an ensemble job with conformers
        if (geometryData.conformer_mode === 'ensemble' && geometryData.conformers && geometryData.conformers.length > 0) {
            populateConformerSelector(geometryData.conformers);

            // Update legend to clarify these are averaged shifts
            const h1Label = document.getElementById('legend-h1-label');
            const c13Label = document.getElementById('legend-c13-label');
            if (h1Label) h1Label.innerHTML = '<sup>1</sup>H <em>averaged</em> shifts (ppm)';
            if (c13Label) c13Label.innerHTML = '<sup>13</sup>C <em>averaged</em> shifts (ppm)';
        }

        // Display first conformer (lowest energy) or single conformer
        displayConformer(0);
    } catch (error) {
        console.error('Error loading geometry:', error);
    }
}

function populateConformerSelector(conformers) {
    const selector = document.getElementById('conformer-selector');
    if (!selector) return;

    selector.innerHTML = conformers.map((c, i) => {
        const energyStr = c.energy_kcal !== null ? c.energy_kcal.toFixed(2) : '?';
        const popStr = c.population !== null ? (c.population * 100).toFixed(1) : '?';
        return `<option value="${i}">${c.id}: ${energyStr} kcal/mol (${popStr}%)</option>`;
    }).join('');

    selector.addEventListener('change', (e) => {
        displayConformer(parseInt(e.target.value));
    });
}

function displayConformer(index) {
    if (!geometryData || !viewer) return;

    currentConformerIndex = index;

    // Get conformer data
    let xyz, sdf;
    if (geometryData.conformers && geometryData.conformers[index]) {
        const conf = geometryData.conformers[index];
        xyz = conf.xyz;
        sdf = conf.sdf;

        // Update info display
        const info = document.getElementById('current-conformer-info');
        if (info && conf.population !== null) {
            info.textContent = `Geometry view - ${(conf.population * 100).toFixed(1)}% population`;
        }
    } else {
        // Single conformer mode
        xyz = geometryData.xyz;
        sdf = geometryData.sdf;
    }

    // Clear and redraw viewer
    viewer.removeAllModels();
    viewer.removeAllLabels();

    // Add model (prefer SDF for proper bonds)
    let model;
    if (sdf) {
        model = viewer.addModel(sdf, 'sdf');
    } else if (xyz) {
        model = viewer.addModel(xyz, 'xyz', {assignBonds: true});
    } else {
        console.error('No geometry data available');
        return;
    }

    // Apply style
    viewer.setStyle({}, {
        stick: {radius: 0.12, colorscheme: 'Jmol'},
        sphere: {scale: 0.25, colorscheme: 'Jmol'}
    });

    // Add shift labels if available (averaged shifts apply to all conformers)
    if (geometryData.h1_assignments || geometryData.c13_assignments) {
        addShiftLabels(model, geometryData.h1_assignments, geometryData.c13_assignments);
    }

    viewer.zoomTo();
    viewer.render();
}

function addShiftLabels(model, h1Assignments, c13Assignments) {
    const atoms = model.selectedAtoms({});

    atoms.forEach(atom => {
        // CRITICAL: 3Dmol.js uses 0-based serial, NWChem uses 1-based indices
        const atomIndex = String(atom.serial + 1);

        if (atom.elem === 'H' && h1Assignments && h1Assignments[atomIndex]) {
            viewer.addLabel(h1Assignments[atomIndex].toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#3498db',  // Blue for 1H
                backgroundOpacity: 0.85,
                inFront: true
            });
        }

        if (atom.elem === 'C' && c13Assignments && c13Assignments[atomIndex]) {
            viewer.addLabel(c13Assignments[atomIndex].toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#e67e22',  // Orange for 13C
                backgroundOpacity: 0.85,
                inFront: true
            });
        }
    });
}
</script>
```
  </action>
  <verify>
1. Template has bento-grid: `grep -c "bento-grid" src/qm_nmr_calc/api/templates/results.html`
2. Has glass-card: `grep -c "glass-card" src/qm_nmr_calc/api/templates/results.html`
3. Has viewer-card: `grep -c "viewer-card" src/qm_nmr_calc/api/templates/results.html`
4. Has Jinja2 conditional for ensemble: `grep "conformer_mode == 'ensemble'" src/qm_nmr_calc/api/templates/results.html`
5. Span utilities used: `grep -c "span-2\|span-4\|span-6" src/qm_nmr_calc/api/templates/results.html`
6. base.html has page_css block: `grep "page_css" src/qm_nmr_calc/api/templates/base.html`
  </verify>
  <done>
results.html uses bento grid layout with:
- 3D viewer in span-4 hero position with span-row-2
- 1H and 13C spectrum cards in span-2 positions
- Ensemble metadata card only renders for ensemble jobs (Jinja2 conditional)
- Calculation details, shift tables in span-2 cards
- Downloads in span-6 full-width card
- JavaScript updated to populate new table IDs
- base.html updated with page_css block
  </done>
</task>

</tasks>

<verification>
1. Template renders without Jinja2 errors
2. Bento grid layout visible in browser
3. 3D viewer displays correctly (no collapsed height)
4. Spectrum images clickable and modal works
5. Shift tables populate with data from API
6. Ensemble metadata only shows for ensemble jobs
7. Conformer selector only shows for ensemble jobs
8. Download buttons functional
9. Mobile layout collapses to single column
</verification>

<success_criteria>
- Results page displays with bento grid layout
- 3D viewer in prominent hero position (span-4)
- Spectrum cards side by side (span-2 each)
- Ensemble-only cards excluded from DOM for single-conformer jobs
- All interactive elements work (3D rotation, modal, conformer selector, downloads)
- No JavaScript console errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-results-redesign/19-02-SUMMARY.md`
</output>
