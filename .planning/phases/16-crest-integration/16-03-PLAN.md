---
phase: 16-crest-integration
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - src/qm_nmr_calc/conformers/pipeline.py
  - src/qm_nmr_calc/conformers/__init__.py
  - src/qm_nmr_calc/api/routers/health.py
  - tests/test_conformer_pipeline.py
  - tests/test_api.py
autonomous: true

must_haves:
  truths:
    - "Pipeline dispatches to CREST when conformer_method='crest' and CREST is available"
    - "Pipeline dispatches to RDKit KDG when conformer_method='rdkit_kdg' or CREST unavailable"
    - "Pipeline raises ValueError when CREST explicitly requested but not installed"
    - "Pipeline raises ValueError when CREST requested for vacuum jobs"
    - "Pipeline raises ValueError when CREST requested for unsupported solvents"
    - "Health endpoint returns crest_available boolean field"
    - "generate_crest_ensemble is importable from conformers package"
  artifacts:
    - path: "src/qm_nmr_calc/conformers/pipeline.py"
      provides: "Unified conformer generation dispatch"
      exports: ["generate_conformer_ensemble"]
    - path: "src/qm_nmr_calc/api/routers/health.py"
      provides: "Health endpoint with CREST detection"
      contains: "crest_available"
    - path: "src/qm_nmr_calc/conformers/__init__.py"
      provides: "Package-level exports including CREST functions"
      contains: "generate_crest_ensemble"
  key_links:
    - from: "src/qm_nmr_calc/conformers/pipeline.py"
      to: "src/qm_nmr_calc/conformers/crest_generator.py"
      via: "dispatch to CREST path"
      pattern: "generate_crest_ensemble|detect_crest_available"
    - from: "src/qm_nmr_calc/api/routers/health.py"
      to: "src/qm_nmr_calc/conformers/crest_generator.py"
      via: "CREST availability check"
      pattern: "detect_crest_available"
---

<objective>
Wire CREST into the conformer pipeline dispatch and health endpoint. Update pipeline.py to route to CREST or RDKit based on job parameters. Add crest_available to health check.

Purpose: This plan completes the integration by connecting the CREST generator (Plan 01-02) to the existing pipeline entry point and making CREST availability visible through the API.

Output: Updated pipeline.py with method dispatch, health endpoint with crest_available field, package exports updated.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crest-integration/16-02-SUMMARY.md

@src/qm_nmr_calc/conformers/pipeline.py
@src/qm_nmr_calc/conformers/__init__.py
@src/qm_nmr_calc/conformers/crest_generator.py
@src/qm_nmr_calc/api/routers/health.py
@src/qm_nmr_calc/models.py
@tests/test_conformer_pipeline.py
@tests/test_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CREST dispatch to pipeline.py and update health endpoint</name>
  <files>src/qm_nmr_calc/conformers/pipeline.py, src/qm_nmr_calc/conformers/__init__.py, src/qm_nmr_calc/api/routers/health.py</files>
  <action>
    **pipeline.py changes:**

    Update `generate_conformer_ensemble()` to accept new parameters and dispatch:

    Add parameters:
    - `conformer_method: str = "rdkit_kdg"` -- "rdkit_kdg" or "crest"
    - `solvent: str = "chcl3"` -- needed for CREST ALPB (only used when method=crest)
    - `charge: int = 0` -- molecular charge for CREST
    - `timeout_seconds: int = 7200` -- CREST timeout

    Dispatch logic at top of function:
    ```python
    if conformer_method == "crest":
        from .crest_generator import detect_crest_available, get_alpb_solvent, generate_crest_ensemble

        # Fail-fast: CREST requested but not installed
        if not detect_crest_available():
            raise ValueError(
                "CREST conformer method requested but CREST/xTB not installed. "
                "Install both crest and xtb binaries, or use 'rdkit_kdg' method."
            )

        # Fail-fast: CREST requires ALPB solvation
        alpb_solvent = get_alpb_solvent(solvent)
        if alpb_solvent is None:
            raise ValueError(
                f"CREST conformer method requires ALPB-compatible solvent. "
                f"Solvent '{solvent}' is not supported (vacuum or unsupported). "
                f"Use 'rdkit_kdg' method or change solvent to CHCl3 or DMSO."
            )

        return generate_crest_ensemble(
            smiles=smiles,
            job_id=job_id,
            solvent=alpb_solvent,
            charge=charge,
            energy_window_kcal=energy_window_kcal,
            timeout_seconds=timeout_seconds,
        )
    ```

    Existing RDKit logic remains untouched as the else/default path.

    **__init__.py changes:**

    Add `generate_crest_ensemble` and `detect_crest_available` to exports:
    ```python
    from .crest_generator import detect_crest_available, generate_crest_ensemble
    ```
    Add both to `__all__`.

    **health.py changes:**

    Add CREST detection to readiness endpoint:
    ```python
    from ...conformers.crest_generator import detect_crest_available

    # In readiness() function, after existing checks:
    checks["crest_available"] = detect_crest_available()
    ```

    Add `crest_available` as top-level field in return dict:
    ```python
    return {
        "status": "ready",
        "checks": checks,
        "crest_available": checks["crest_available"],
        "timestamp": datetime.utcnow().isoformat() + "Z",
    }
    ```
  </action>
  <verify>
    ```bash
    cd /home/chris/develop/qm-nmr-calc && python -c "
    from qm_nmr_calc.conformers import detect_crest_available, generate_crest_ensemble
    print('Imports OK')
    print(f'CREST available: {detect_crest_available()}')
    "
    ```
    Imports succeed. CREST available returns True or False depending on system.
  </verify>
  <done>
    pipeline.py dispatches to CREST or RDKit based on conformer_method parameter.
    Health endpoint includes crest_available field.
    Package exports updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dispatch and health tests</name>
  <files>tests/test_conformer_pipeline.py, tests/test_api.py</files>
  <action>
    **test_conformer_pipeline.py additions:**

    Add tests for CREST dispatch in pipeline (all with mocked CREST functions):

    1. `test_pipeline_crest_dispatch_when_available` -- mock detect_crest_available=True, get_alpb_solvent returns "chcl3", verify generate_crest_ensemble called
    2. `test_pipeline_crest_raises_when_not_installed` -- mock detect_crest_available=False, verify ValueError with "not installed"
    3. `test_pipeline_crest_raises_for_vacuum` -- mock detect_crest_available=True, get_alpb_solvent=None for vacuum, verify ValueError with "not supported"
    4. `test_pipeline_crest_raises_for_unsupported_solvent` -- mock detect_crest_available=True, get_alpb_solvent=None for "water", verify ValueError
    5. `test_pipeline_rdkit_default_path_unchanged` -- verify existing RDKit path still works with conformer_method="rdkit_kdg"

    All CREST tests mock `detect_crest_available`, `get_alpb_solvent`, and `generate_crest_ensemble` from `qm_nmr_calc.conformers.crest_generator`.

    **test_api.py additions:**

    Add test for health endpoint CREST detection:

    1. `test_health_ready_includes_crest_available` -- mock detect_crest_available, verify response JSON contains "crest_available" key as boolean

    Use the existing FastAPI TestClient pattern from the file.
  </action>
  <verify>
    ```bash
    cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_conformer_pipeline.py tests/test_api.py -v --tb=short
    ```
    All new and existing tests pass.

    Full suite:
    ```bash
    cd /home/chris/develop/qm-nmr-calc && python -m pytest --tb=short -q
    ```
  </verify>
  <done>
    Pipeline dispatch tested: CREST when available, fail-fast when not, fail for vacuum/unsupported solvents.
    Health endpoint tested: crest_available field present in readiness response.
    All existing tests continue to pass.
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass
cd /home/chris/develop/qm-nmr-calc && python -m pytest --tb=short -q

# CREST-specific tests
cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_crest_generator.py tests/test_conformer_pipeline.py tests/test_api.py -v

# Verify health endpoint includes crest_available
cd /home/chris/develop/qm-nmr-calc && python -c "
from qm_nmr_calc.conformers.crest_generator import detect_crest_available
print(f'CREST available: {detect_crest_available()}')
"
```
</verification>

<success_criteria>
- Pipeline dispatches to CREST when method="crest" and CREST available and solvent supported
- Pipeline raises ValueError for CREST when: not installed, vacuum, unsupported solvent
- Pipeline RDKit path is unchanged (backward compatible)
- Health endpoint returns crest_available boolean
- All 229+ existing tests pass plus new dispatch/health tests
</success_criteria>

<output>
After completion, create `.planning/phases/16-crest-integration/16-03-SUMMARY.md`
</output>
