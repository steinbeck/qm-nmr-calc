---
phase: 16-crest-integration
plan: 02
type: tdd
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/qm_nmr_calc/conformers/crest_generator.py
  - tests/test_crest_generator.py
autonomous: true

must_haves:
  truths:
    - "run_crest() invokes CREST subprocess with --gfn2, --alpb, --chrg, --ewin, -T flags"
    - "run_crest() sets OMP_STACKSIZE=2G and GFORTRAN_UNBUFFERED_ALL=1 in subprocess environment"
    - "run_crest() raises RuntimeError with helpful message when CREST exceeds timeout"
    - "run_crest() raises RuntimeError when CREST exits with non-zero code"
    - "run_crest() returns path to crest_conformers.xyz on success"
    - "generate_crest_ensemble() writes individual XYZ files per conformer and returns ConformerEnsemble"
    - "generate_crest_ensemble() applies energy window filter but skips RMSD deduplication"
    - "generate_crest_ensemble() stores energies in kcal_mol relative to minimum (for pre-DFT filtering consistency)"
  artifacts:
    - path: "src/qm_nmr_calc/conformers/crest_generator.py"
      provides: "CREST runner and ensemble builder"
      exports: ["run_crest", "generate_crest_ensemble"]
    - path: "tests/test_crest_generator.py"
      provides: "TDD tests for CREST runner and ensemble builder"
      min_lines: 160
  key_links:
    - from: "src/qm_nmr_calc/conformers/crest_generator.py"
      to: "subprocess.run"
      via: "CREST invocation with timeout"
      pattern: "subprocess\\.run.*timeout"
    - from: "src/qm_nmr_calc/conformers/crest_generator.py"
      to: "src/qm_nmr_calc/models.py"
      via: "ConformerData and ConformerEnsemble construction"
      pattern: "ConformerEnsemble|ConformerData"
    - from: "src/qm_nmr_calc/conformers/crest_generator.py"
      to: "src/qm_nmr_calc/conformers/filters.py"
      via: "filter_by_energy_window for pre-DFT filtering"
      pattern: "filter_by_energy_window"
---

<objective>
Implement and test the CREST subprocess runner and the CREST-to-ConformerEnsemble pipeline.

Purpose: This plan connects CREST binary execution to the existing conformer data model. It handles subprocess timeout for hung CREST processes and converts CREST output into the same ConformerEnsemble format used by the RDKit path, enabling seamless downstream DFT+NMR processing.

Output: `run_crest()` function for subprocess execution and `generate_crest_ensemble()` function that orchestrates CREST run -> parse -> filter -> write XYZ -> build ConformerEnsemble.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crest-integration/16-01-SUMMARY.md

@src/qm_nmr_calc/conformers/crest_generator.py
@src/qm_nmr_calc/conformers/pipeline.py
@src/qm_nmr_calc/conformers/filters.py
@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/storage.py
</context>

<feature>
  <name>CREST Subprocess Runner and Ensemble Builder</name>
  <files>src/qm_nmr_calc/conformers/crest_generator.py, tests/test_crest_generator.py</files>
  <behavior>
    Two functions added to crest_generator.py:

    1. `run_crest(input_xyz, solvent, charge=0, ewin_kcal=6.0, num_threads=None, timeout_seconds=7200) -> Path`:
       - Builds CREST command: `crest <input_xyz> --gfn2 --alpb <solvent> --chrg <charge> --ewin <ewin_kcal> -T <threads>`
       - num_threads defaults to `os.cpu_count() or 4`
       - Sets environment: OMP_STACKSIZE=2G, GFORTRAN_UNBUFFERED_ALL=1 (on top of os.environ.copy())
       - Runs with `subprocess.run(cmd, cwd=input_xyz.parent, capture_output=True, text=True, timeout=timeout_seconds, env=env, check=True)`
       - On subprocess.TimeoutExpired: raise RuntimeError with message suggesting RDKit mode
       - On subprocess.CalledProcessError: raise RuntimeError with exit code and stderr
       - On success: verify crest_conformers.xyz exists in input_xyz.parent, return its Path
       - If output file missing after success: raise RuntimeError
       - Test cases (all use mocked subprocess.run):
         - Success: returns path to crest_conformers.xyz
         - Timeout: raises RuntimeError with "timeout" in message
         - Non-zero exit: raises RuntimeError with exit code
         - Missing output file: raises RuntimeError
         - Correct command args built (verify via mock call inspection)
         - Environment variables set correctly
         - Default num_threads = os.cpu_count()

    2. `generate_crest_ensemble(smiles, job_id, solvent, charge=0, energy_window_kcal=6.0, timeout_seconds=7200) -> ConformerEnsemble`:
       - Creates initial XYZ from SMILES using RDKit (AddHs + EmbedMolecule for single conformer)
         Write XYZ to job_dir / "output" / "crest_input.xyz"
       - Gets ALPB solvent via get_alpb_solvent() -- caller already validated
       - Calls run_crest() with input XYZ, solvent, charge, ewin, timeout
       - Parses output with parse_crest_ensemble()
       - Converts CREST Hartree energies to relative kcal/mol (subtract min, multiply by 627.5095)
       - Applies filter_by_energy_window on relative kcal/mol energies (reuses existing filter)
       - Skips RMSD deduplication (CREST handles this internally)
       - Creates per-conformer directories via create_conformer_directories()
       - Writes individual XYZ files for each conformer
       - Builds ConformerData list with:
         - conformer_id: "conf_001", "conf_002", ... (1-based sequential)
         - energy: relative kcal/mol (matching RDKit pipeline convention for pre-DFT filtering)
         - energy_unit: "kcal_mol"
         - geometry_file: relative path "output/conformers/conf_NNN/geometry.xyz"
         - status: "pending"
       - Returns ConformerEnsemble(method="crest", conformers=..., pre_dft_energy_window_kcal=..., total_generated=..., total_after_pre_filter=...)
       - Test cases (run_crest is mocked, storage functions are mocked):
         - Successful ensemble generation produces correct ConformerEnsemble
         - Energy conversion from Hartree to relative kcal/mol correct
         - Energy window filter applied (high-energy conformer removed)
         - XYZ files written to correct paths
         - ConformerData fields populated correctly
         - method="crest" in ensemble

    Constants needed: HARTREE_TO_KCAL = 627.5095 (import from boltzmann.py)
  </behavior>
  <implementation>
    Add to existing crest_generator.py (from Plan 01):
    - Import os, subprocess, Path
    - Import from models: ConformerData, ConformerEnsemble
    - Import from storage: create_conformer_directories, get_conformer_output_dir, get_job_dir
    - Import from filters: filter_by_energy_window
    - Import from boltzmann: HARTREE_TO_KCAL
    - Import from nwchem.geometry: smiles_to_xyz, mol_to_xyz_block (for initial XYZ generation)

    For generate_crest_ensemble initial geometry:
    - Use RDKit to generate a single 3D conformer from SMILES
    - Write as XYZ to crest_input.xyz in the job output directory
    - This is the input for CREST's conformational search

    All subprocess calls are mocked in tests. No actual CREST execution needed.
    Tests create temp directories with pre-written crest_conformers.xyz for parse/filter testing.
  </implementation>
</feature>

<verification>
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_crest_generator.py -v
```
All tests pass. No existing tests broken:
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest --tb=short -q
```
</verification>

<success_criteria>
- run_crest() builds correct CREST command with all expected flags
- run_crest() sets OMP_STACKSIZE and GFORTRAN_UNBUFFERED_ALL in subprocess env
- run_crest() handles timeout and error cases with clear RuntimeError messages
- generate_crest_ensemble() produces ConformerEnsemble with method="crest"
- Energy conversion from Hartree to relative kcal/mol is correct
- Energy window filter is applied (RMSD dedup is NOT applied)
- Individual XYZ files written per conformer
- All 229+ existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-crest-integration/16-02-SUMMARY.md`
</output>
