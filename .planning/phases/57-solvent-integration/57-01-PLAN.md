---
phase: 57-solvent-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/solvents.py
  - src/qm_nmr_calc/shifts.py
  - src/qm_nmr_calc/nmredata.py
  - tests/test_nmredata.py
autonomous: true

must_haves:
  truths:
    - "API accepts solvent=methanol and returns shifts using Methanol scaling factors"
    - "API accepts solvent=water and returns shifts using Water scaling factors"
    - "API accepts solvent=acetone and returns shifts using Acetone scaling factors"
    - "API accepts solvent=benzene and returns shifts using Benzene scaling factors"
    - "Web UI solvent dropdown lists all 7 solvents"
    - "Existing CHCl3, DMSO, and vacuum solvents still work identically"
    - "NMReData export works for all 7 solvents"
  artifacts:
    - path: "src/qm_nmr_calc/solvents.py"
      provides: "7-solvent SUPPORTED_SOLVENTS dict"
      contains: "methanol"
    - path: "src/qm_nmr_calc/shifts.py"
      provides: "7-solvent solvent_map for scaling factor lookup"
      contains: "methanol"
    - path: "src/qm_nmr_calc/nmredata.py"
      provides: "7-solvent NMReData solvent mapping"
      contains: "methanol"
  key_links:
    - from: "src/qm_nmr_calc/solvents.py"
      to: "src/qm_nmr_calc/api/routers/web.py"
      via: "SUPPORTED_SOLVENTS import drives dropdown rendering"
      pattern: "SUPPORTED_SOLVENTS"
    - from: "src/qm_nmr_calc/shifts.py"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "solvent_map normalizes keys to match JSON keys"
      pattern: "solvent_map.get"
    - from: "src/qm_nmr_calc/solvents.py"
      to: "src/qm_nmr_calc/api/routers/jobs.py"
      via: "validate_solvent gates API submission"
      pattern: "validate_solvent"
---

<objective>
Add 4 new solvents (methanol, water, acetone, benzene) to the 3 gatekeeper modules so users can select them in the web UI and API for NMR predictions.

Purpose: This is the final wiring step for v2.8. The scaling factors and NWChem COSMO support already exist from Phases 54-56. These 3 files are the only remaining gatekeepers preventing users from accessing the new solvents.

Output: All 7 solvents selectable in UI and API, with correct scaling factor lookup and NMReData export.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/qm_nmr_calc/solvents.py
@src/qm_nmr_calc/shifts.py
@src/qm_nmr_calc/nmredata.py
@tests/test_nmredata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 4 new solvents to solvents.py and shifts.py</name>
  <files>
    src/qm_nmr_calc/solvents.py
    src/qm_nmr_calc/shifts.py
  </files>
  <action>
    **solvents.py** - Add 4 entries to the `SUPPORTED_SOLVENTS` dict:
    ```python
    SUPPORTED_SOLVENTS: dict[str, str] = {
        "chcl3": "Chloroform (CDCl3)",
        "dmso": "Dimethylsulfoxide (DMSO-d6)",
        "vacuum": "Gas phase (no solvent)",
        "methanol": "Methanol (Methanol-d4)",
        "water": "Water (D2O)",
        "acetone": "Acetone (Acetone-d6)",
        "benzene": "Benzene (Benzene-d6)",
    }
    ```
    Keep existing entries unchanged. The display names follow the existing pattern: "Full name (Deuterated form)". The parenthesized text is extracted by `get_solvent_display_name()` for display.

    **shifts.py** - Add 4 entries to the `solvent_map` dict in `get_scaling_factor()`:
    ```python
    solvent_map = {
        "chcl3": "CHCl3",
        "dmso": "DMSO",
        "vacuum": "vacuum",
        "methanol": "Methanol",
        "water": "Water",
        "acetone": "Acetone",
        "benzene": "Benzene",
    }
    ```
    These Title-case values must match the keys in `scaling_factors.json` exactly:
    - "B3LYP/6-311+G(2d,p)/1H/Methanol"
    - "B3LYP/6-311+G(2d,p)/1H/Water"
    - "B3LYP/6-311+G(2d,p)/1H/Acetone"
    - "B3LYP/6-311+G(2d,p)/1H/Benzene"
    Keep existing entries unchanged.
  </action>
  <verify>
    Run: `python -c "from qm_nmr_calc.solvents import SUPPORTED_SOLVENTS, validate_solvent, get_solvent_display_name; print(len(SUPPORTED_SOLVENTS)); assert len(SUPPORTED_SOLVENTS) == 7; assert validate_solvent('methanol') == 'methanol'; assert validate_solvent('water') == 'water'; assert validate_solvent('acetone') == 'acetone'; assert validate_solvent('benzene') == 'benzene'; assert get_solvent_display_name('methanol') == 'Methanol-d4'; assert get_solvent_display_name('water') == 'D2O'; print('solvents OK')"`

    Run: `python -c "from qm_nmr_calc.shifts import get_scaling_factor; f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'methanol'); print(f'Methanol 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'water'); print(f'Water 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'acetone'); print(f'Acetone 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'benzene'); print(f'Benzene 1H: slope={f[\"slope\"]:.4f}'); print('shifts OK')"`

    Run: `python -c "from qm_nmr_calc.shifts import get_scaling_factor; f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'chcl3'); print(f'CHCl3 1H: slope={f[\"slope\"]:.4f}'); print('regression OK')"`
  </verify>
  <done>
    - SUPPORTED_SOLVENTS has 7 entries
    - validate_solvent() accepts all 4 new solvents
    - get_solvent_display_name() returns correct deuterated forms
    - get_scaling_factor() resolves all 4 new solvents to correct JSON keys
    - Existing CHCl3/DMSO/vacuum lookups unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 4 new solvents to nmredata.py and fix tests</name>
  <files>
    src/qm_nmr_calc/nmredata.py
    tests/test_nmredata.py
  </files>
  <action>
    **nmredata.py** - Add 4 entries to the `solvent_map` dict in `map_solvent_to_nmredata()`:
    ```python
    solvent_map = {
        "chcl3": "CDCl3",
        "dmso": "(CD3)2SO",
        "vacuum": "vacuum",
        "methanol": "CD3OD",
        "water": "D2O",
        "acetone": "(CD3)2CO",
        "benzene": "C6D6",
    }
    ```
    These are standard NMReData deuterated solvent names used in NMR spectroscopy. Keep existing entries unchanged.

    **tests/test_nmredata.py** - Fix the `test_unknown_solvent_raises_error` test which currently uses `"benzene"` as the unknown solvent (line 54). Benzene is now a valid solvent, so change the test to use a genuinely unknown solvent like `"toluene"`:
    ```python
    def test_unknown_solvent_raises_error(self):
        """Unknown solvent should raise ValueError."""
        with pytest.raises(ValueError, match="Unknown solvent"):
            map_solvent_to_nmredata("toluene")
    ```

    Also add tests for the 4 new solvent mappings to the `TestSolventMapping` class:
    ```python
    def test_methanol_maps_to_cd3od(self):
        """Methanol maps to deuterated form CD3OD."""
        assert map_solvent_to_nmredata("methanol") == "CD3OD"

    def test_water_maps_to_d2o(self):
        """Water maps to D2O."""
        assert map_solvent_to_nmredata("water") == "D2O"

    def test_acetone_maps_to_deuterated_form(self):
        """Acetone maps to NMReData convention (CD3)2CO."""
        assert map_solvent_to_nmredata("acetone") == "(CD3)2CO"

    def test_benzene_maps_to_c6d6(self):
        """Benzene maps to deuterated form C6D6."""
        assert map_solvent_to_nmredata("benzene") == "C6D6"
    ```
    Insert these 4 new test methods after `test_vacuum_maps_to_vacuum` (before the `test_unknown_solvent_raises_error` method).
  </action>
  <verify>
    Run: `python -c "from qm_nmr_calc.nmredata import map_solvent_to_nmredata; assert map_solvent_to_nmredata('methanol') == 'CD3OD'; assert map_solvent_to_nmredata('water') == 'D2O'; assert map_solvent_to_nmredata('acetone') == '(CD3)2CO'; assert map_solvent_to_nmredata('benzene') == 'C6D6'; assert map_solvent_to_nmredata('chcl3') == 'CDCl3'; print('nmredata OK')"`

    Run full test suite: `python -m pytest tests/ -x -q`

    Verify test count is >= 430 (should be 430 + 4 new tests = 434).
  </verify>
  <done>
    - map_solvent_to_nmredata() resolves all 7 solvents correctly
    - test_unknown_solvent_raises_error uses "toluene" instead of "benzene"
    - 4 new test methods cover methanol, water, acetone, benzene NMReData mappings
    - All existing tests pass without modification
    - Total test count is 434+
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` -- All tests pass (434+)
2. `python -c "from qm_nmr_calc.solvents import get_supported_solvents; s = get_supported_solvents(); print(s); assert len(s) == 7"` -- 7 solvents listed
3. `python -c "from qm_nmr_calc.shifts import get_scaling_factor; [get_scaling_factor('B3LYP', '6-311+G(2d,p)', n, s) for n in ['1H', '13C'] for s in ['chcl3', 'dmso', 'vacuum', 'methanol', 'water', 'acetone', 'benzene']]; print('All 14 factor lookups succeed')"` -- All 14 scaling factor keys resolve
4. `python -c "from qm_nmr_calc.nmredata import map_solvent_to_nmredata; [map_solvent_to_nmredata(s) for s in ['chcl3', 'dmso', 'vacuum', 'methanol', 'water', 'acetone', 'benzene']]; print('All 7 NMReData mappings work')"` -- All NMReData mappings work
</verification>

<success_criteria>
- SUPPORTED_SOLVENTS has exactly 7 entries (was 3)
- shifts.py solvent_map has exactly 7 entries (was 3)
- nmredata.py solvent_map has exactly 7 entries (was 3)
- All 14 scaling factor lookups succeed (7 solvents x 2 nuclei)
- All tests pass (434+)
- No changes to any other files (API routes, templates, input_gen auto-propagate)
</success_criteria>

<output>
After completion, create `.planning/phases/57-solvent-integration/57-01-SUMMARY.md`
</output>
