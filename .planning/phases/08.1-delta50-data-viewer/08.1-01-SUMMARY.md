---
phase: 08.1-delta50-data-viewer
plan: 01
subsystem: visualization
tags: [3dmol, benchmark, viewer, delta50]
dependency_graph:
  requires:
    - "08-delta50-setup (DELTA50 data infrastructure)"
  provides:
    - "Web-based DELTA50 benchmark data viewer"
    - "3D molecule visualization with shift annotations"
  affects:
    - "Future benchmark validation workflows"
tech_stack:
  added:
    - "3Dmol.js (CDN, 2.5.3)"
  patterns:
    - "Grid layout with sidebar navigation"
    - "Async molecule loading on sidebar click"
key_files:
  created:
    - "src/qm_nmr_calc/api/routers/benchmark.py"
    - "src/qm_nmr_calc/api/templates/benchmark_viewer.html"
  modified:
    - "src/qm_nmr_calc/api/app.py"
    - "src/qm_nmr_calc/api/static/css/custom.css"
decisions:
  - "3Dmol.js from CDN for minimal build complexity"
  - "Full XYZ format reconstruction for 3Dmol.js compatibility"
  - "String keys for JSON assignment dicts (1-based atom indices)"
metrics:
  duration: "4 min"
  completed: "2026-01-21"
---

# Phase 08.1 Plan 01: DELTA50 Benchmark Data Viewer Summary

**One-liner:** Web viewer with 3Dmol.js for visual QA of DELTA50 structures and experimental NMR shifts

## What Was Built

### Benchmark Router (`benchmark.py`)
- **GET /benchmark/delta50**: Renders viewer page with sorted molecule list (1-50)
- **GET /benchmark/delta50/molecules/{compound_id}**: Returns JSON with:
  - Full XYZ coordinates (reconstructed with header for 3Dmol.js)
  - Experimental 1H and 13C shifts
  - Atom-index assignments for label placement
  - Atom counts and metadata

### Viewer Template (`benchmark_viewer.html`)
- Grid layout with 220px sidebar + main content area
- Sidebar lists all 50 DELTA50 molecules sorted by compound number
- 3Dmol.js viewer displays 3D molecular structure with:
  - Stick + sphere representation (Jmol colorscheme)
  - Blue labels (#3498db) for 1H shifts on hydrogen atoms
  - Green labels (#27ae60) for 13C shifts on carbon atoms
- Metadata panel shows compound info, atom counts, all shift values
- First molecule auto-loads on page visit

### CSS Styles
- Comprehensive benchmark viewer layout styles
- Sidebar navigation with hover/selected states
- Shift badge styling for 1H/13C distinction
- Legend with color indicators
- Responsive layout for mobile screens

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 2cae05b | Create benchmark router with endpoints |
| 2 | 2ae5374 | Create viewer template with 3Dmol.js |
| 3 | bffbfaf | Register router and add viewer styles |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed XYZ format for 3Dmol.js**
- **Found during:** Task 3 verification
- **Issue:** `load_geometry_file()` returns XYZ block without standard header (atom count + comment)
- **Fix:** Reconstruct full XYZ format: `f"{total_atoms}\n{mol_data.name}\n{xyz_block}"`
- **Files modified:** benchmark.py
- **Commit:** bffbfaf

**2. [Rule 1 - Bug] Fixed atom counting logic**
- **Found during:** Task 3 verification
- **Issue:** Code skipped first 2 lines expecting XYZ header, but xyz_block has no header
- **Fix:** Remove line skip, iterate all lines in xyz_block
- **Files modified:** benchmark.py
- **Commit:** bffbfaf

## Success Criteria Verification

- [x] /benchmark/delta50 loads without errors
- [x] Sidebar lists 50 molecules (compound_01 through compound_50)
- [x] Clicking molecule loads 3D structure in viewer
- [x] 1H shifts appear as blue labels on H atoms
- [x] 13C shifts appear as green labels on C atoms
- [x] Metadata panel shows name, ID, atom counts, shift values
- [x] First molecule auto-loads on page visit

## Technical Details

### 3Dmol.js Integration
- Loaded from CDN: `https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js`
- Viewer initialized once on DOMContentLoaded
- Models/labels cleared and rebuilt on each molecule selection
- Style: stick (radius 0.12) + sphere (scale 0.25) with Jmol colorscheme

### Label Positioning
- Labels use `atom.serial` as string key to match JSON assignments
- 1-based atom indices from XYZ serial numbers
- Label positioned at exact atom coordinates
- Background opacity 0.85, font size 11, white text

### API Response Format
```json
{
  "compound_id": "compound_01",
  "name": "Nitromethane",
  "compound_number": 1,
  "xyz": "7\nNitromethane\nC -1.32... (full XYZ)",
  "h1_shifts": [4.33],
  "c13_shifts": [62.49],
  "h1_assignments": {"5": 4.33, "6": 4.33, "7": 4.33},
  "c13_assignments": {"1": 62.49},
  "num_h_atoms": 3,
  "num_c_atoms": 1
}
```

## Next Phase Readiness

Phase 8.1 complete. The DELTA50 data viewer provides visual QA capability for verifying extracted structures and experimental shifts before running expensive benchmark calculations.

**Ready for:** Phase 9 (Production Hardening) or resuming Phase 8 benchmark execution
