# Phase 8.1: DELTA50 Data Viewer - Research

**Researched:** 2026-01-21
**Domain:** JavaScript 3D molecular visualization, FastAPI web UI
**Confidence:** HIGH

## Summary

This phase requires building a web-based molecule viewer to validate DELTA50 benchmark data before running calculations. The viewer needs to display 3D molecular structures with experimental NMR chemical shifts annotated on atoms.

**3Dmol.js** is the clear choice for 3D molecular visualization over JSmol. 3Dmol.js is a modern, WebGL-accelerated JavaScript library with native XYZ format support, a clean API for adding atom labels, and excellent documentation. JSmol is legacy Java-to-JavaScript port with more complex setup. 3Dmol.js is actively maintained (last updated January 2026) and specifically supports the use case of loading XYZ files and adding custom labels to atoms.

The existing project patterns (FastAPI + Jinja2 + Pico CSS) integrate naturally. A new router can serve the viewer page, with API endpoints providing molecule XYZ data and experimental shifts as JSON. The 3Dmol.js library loads via CDN with no build system required.

**Primary recommendation:** Use 3Dmol.js via CDN, create `/benchmark/delta50` web route with sidebar listing molecules, fetch molecule data via JSON API endpoint, programmatically add labels showing experimental shifts at H and C atom positions.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| 3Dmol.js | 2.5.3 | WebGL molecular visualization | Modern, maintained, native XYZ support, clean label API |
| Pico CSS | 2.x | Styling (existing) | Already in project, sidebar-friendly with `<aside>` |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| jQuery | 3.6.x | AJAX, DOM manipulation | Optional - vanilla fetch() preferred for simplicity |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| 3Dmol.js | JSmol | JSmol is legacy Java port, more complex API, no WebGL acceleration |
| 3Dmol.js | NGL Viewer | More complex, overkill for small organic molecules |

**CDN Script:**
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>
```

Note: Do NOT use `3Dmol-min.min.js` - the double-minified version from CDN autominifier does not work correctly. The `3Dmol-min.js` file is already minified.

## Architecture Patterns

### Recommended Project Structure
```
src/qm_nmr_calc/api/
├── routers/
│   └── benchmark.py          # New router for /benchmark/* routes
├── templates/
│   └── benchmark_viewer.html # New template for DELTA50 viewer
└── static/
    └── css/
        └── custom.css        # Add sidebar styles
```

### Pattern 1: Sidebar with List Selection (Pico CSS)
**What:** Vertical navigation list inside `<aside>` element
**When to use:** Molecule list selection
**Example:**
```html
<!-- Source: https://picocss.com/docs/nav -->
<aside>
  <nav>
    <ul>
      <li><a href="#" class="selected" data-id="compound_01">1. Nitromethane</a></li>
      <li><a href="#" data-id="compound_02">2. Nitroethane</a></li>
      <!-- ... -->
    </ul>
  </nav>
</aside>
```

Pico CSS automatically stacks `<nav>` items vertically when inside `<aside>`. Add `.selected` class or `aria-current="page"` for active state.

### Pattern 2: 3Dmol.js Viewer Setup
**What:** Initialize viewer, load XYZ, set style
**When to use:** When molecule selected
**Example:**
```javascript
// Source: https://3dmol.csb.pitt.edu/doc/tutorial-code.html
const container = document.getElementById('viewer-container');
const viewer = $3Dmol.createViewer(container, {
    backgroundColor: 'white'
});

// Load XYZ data (fetched from API)
const model = viewer.addModel(xyzData, 'xyz', {assignBonds: true});
viewer.setStyle({}, {stick: {radius: 0.15}, sphere: {scale: 0.25}});
viewer.zoomTo();
viewer.render();
```

### Pattern 3: Adding Atom Labels with Shifts
**What:** Iterate atoms, add labels at positions
**When to use:** Displaying NMR shifts on structure
**Example:**
```javascript
// Source: https://3dmol.csb.pitt.edu/doc/GLViewer.html
// https://github.com/3dmol/3Dmol.js/blob/master/tests/example.html

// shifts format: { "5": 4.33, "6": 4.33 } (atom index -> shift value)
function addShiftLabels(viewer, model, h1Assignments, c13Assignments) {
    const atoms = model.selectedAtoms({});

    for (const atom of atoms) {
        const atomIndex = String(atom.serial);  // XYZ uses serial numbers
        let labelText = null;
        let bgColor = null;

        if (atom.elem === 'H' && h1Assignments && h1Assignments[atomIndex]) {
            labelText = h1Assignments[atomIndex].toFixed(2);
            bgColor = '#4a90d9';  // Blue for 1H
        } else if (atom.elem === 'C' && c13Assignments && c13Assignments[atomIndex]) {
            labelText = c13Assignments[atomIndex].toFixed(1);
            bgColor = '#2ecc71';  // Green for 13C
        }

        if (labelText) {
            viewer.addLabel(labelText, {
                position: {x: atom.x, y: atom.y, z: atom.z},
                backgroundColor: bgColor,
                fontColor: 'white',
                fontSize: 12,
                inFront: true,
                showBackground: true,
                backgroundOpacity: 0.8
            });
        }
    }
    viewer.render();
}
```

### Pattern 4: API Endpoint for Molecule Data
**What:** Single endpoint returning XYZ + shifts + metadata
**When to use:** When molecule selected in sidebar
**Example:**
```python
# FastAPI endpoint pattern from existing routers/jobs.py

@router.get("/delta50/molecules/{compound_id}")
async def get_molecule_data(compound_id: str):
    """Return XYZ content and experimental shifts for a DELTA50 molecule."""
    # Load from data_loader module
    shifts = load_experimental_shifts()
    molecules = load_delta50_molecules()

    if compound_id not in shifts.molecules:
        raise HTTPException(status_code=404, detail=f"Compound {compound_id} not found")

    mol_data = shifts.molecules[compound_id]
    _, xyz_block = molecules[compound_id]

    return {
        "compound_id": compound_id,
        "name": mol_data.name,
        "xyz": xyz_block,
        "h1_shifts": mol_data.h1_shifts,
        "c13_shifts": mol_data.c13_shifts,
        "h1_assignments": mol_data.h1_assignments,
        "c13_assignments": mol_data.c13_assignments,
        "num_h_atoms": len([s for s in mol_data.h1_shifts]),
        "num_c_atoms": len([s for s in mol_data.c13_shifts])
    }
```

### Anti-Patterns to Avoid
- **Loading 3Dmol.js from 3Dmol.org directly:** Development version changes frequently. Use cdnjs for stability.
- **Using JSmol for new projects:** Legacy Java-based architecture, complex scripting language, no WebGL acceleration.
- **Creating new viewer on every molecule selection:** Memory leaks. Reuse viewer, call `viewer.removeAllModels()` then add new model.
- **Not calling `viewer.render()` after changes:** Labels and style changes won't appear until render() is called.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| 3D molecular visualization | WebGL renderer | 3Dmol.js | Complex rendering, bond detection, interaction handling |
| Atom selection by element | Iterate and filter atoms | `model.selectedAtoms({elem: 'H'})` | Built-in, optimized |
| Bond detection from XYZ | Distance-based algorithm | `{assignBonds: true}` parser option | 3Dmol.js uses proper covalent radii |
| Sidebar navigation | Custom CSS grid | Pico CSS `<aside><nav>` | Automatic vertical stacking |

**Key insight:** 3Dmol.js handles all the hard parts - WebGL context management, molecule parsing, bond inference from coordinates, atom selection, and label positioning. Focus on data flow and UI.

## Common Pitfalls

### Pitfall 1: XYZ Atom Serial Numbers Start at 1
**What goes wrong:** JavaScript arrays are 0-indexed but XYZ atom serials start at 1
**Why it happens:** Different conventions between data formats
**How to avoid:** The DELTA50 `h1_assignments` and `c13_assignments` already use 1-based indices (matching XYZ serial). Use `atom.serial` not `atom.index` when matching.
**Warning signs:** Off-by-one errors, shifts appearing on wrong atoms

### Pitfall 2: Viewer Memory with Multiple Molecules
**What goes wrong:** Memory grows with each molecule selection
**Why it happens:** Creating new viewer instead of reusing
**How to avoid:** Create viewer once. On molecule change: `viewer.removeAllModels()`, `viewer.removeAllLabels()`, then add new model.
**Warning signs:** Browser becoming slow after viewing many molecules

### Pitfall 3: Bonds Not Appearing in XYZ
**What goes wrong:** Molecules display as disconnected atoms
**Why it happens:** XYZ format has no bond information; autobond can fail
**How to avoid:** Ensure XYZ coordinates are in Angstroms (DELTA50 data is correct). Use `{assignBonds: true}` (default). If issues persist, check coordinate scale.
**Warning signs:** Stick style shows nothing, only sphere style works

### Pitfall 4: Labels Obscured by Atoms
**What goes wrong:** Labels render behind molecule, invisible
**Why it happens:** Default label rendering order
**How to avoid:** Always set `inFront: true` in LabelSpec
**Warning signs:** Labels disappear when rotating molecule

### Pitfall 5: CORS Issues with Fetch
**What goes wrong:** API calls blocked in development
**Why it happens:** Browser security when serving from different origins
**How to avoid:** In this project, both API and web pages served from same FastAPI server - no CORS issues. Use relative URLs like `/benchmark/delta50/molecules/compound_01`.
**Warning signs:** Network errors in console mentioning CORS

## Code Examples

Verified patterns from official sources:

### Complete Viewer Initialization
```javascript
// Source: https://3dmol.csb.pitt.edu/doc/tutorial-code.html
// https://3dmol.csb.pitt.edu/doc/GLViewer.html

let viewer = null;

function initViewer() {
    const container = document.getElementById('viewer-container');
    viewer = $3Dmol.createViewer(container, {
        backgroundColor: 'white',
        antialias: true
    });
}

async function loadMolecule(compoundId) {
    // Clear previous
    viewer.removeAllModels();
    viewer.removeAllLabels();

    // Fetch data from API
    const response = await fetch(`/benchmark/delta50/molecules/${compoundId}`);
    const data = await response.json();

    // Add model
    const model = viewer.addModel(data.xyz, 'xyz', {assignBonds: true});

    // Style: stick and ball
    viewer.setStyle({}, {
        stick: {radius: 0.12, colorscheme: 'Jmol'},
        sphere: {scale: 0.25, colorscheme: 'Jmol'}
    });

    // Add shift labels
    addShiftLabels(model, data.h1_assignments, data.c13_assignments);

    viewer.zoomTo();
    viewer.render();

    // Update info panel
    updateMoleculeInfo(data);
}
```

### LabelSpec Configuration
```javascript
// Source: https://3dmol.csb.pitt.edu/doc/LabelSpec.html

// Label style for 1H shifts (blue)
const h1LabelStyle = {
    fontSize: 11,
    font: 'sans-serif',
    fontColor: 'white',
    backgroundColor: '#3498db',
    backgroundOpacity: 0.85,
    borderThickness: 0,
    inFront: true,
    showBackground: true,
    alignment: 'center'
};

// Label style for 13C shifts (green)
const c13LabelStyle = {
    fontSize: 11,
    font: 'sans-serif',
    fontColor: 'white',
    backgroundColor: '#27ae60',
    backgroundOpacity: 0.85,
    borderThickness: 0,
    inFront: true,
    showBackground: true,
    alignment: 'center'
};
```

### Atom Selection by Element
```javascript
// Source: https://3dmol.csb.pitt.edu/doc/AtomSelectionSpec.html

// Select all hydrogen atoms
const hydrogens = model.selectedAtoms({elem: 'H'});

// Select all carbon atoms
const carbons = model.selectedAtoms({elem: 'C'});

// Select specific atom by serial number
const atom5 = model.selectedAtoms({serial: 5})[0];
```

### Sidebar Click Handler
```javascript
// Source: Project pattern from templates/results.html

document.querySelectorAll('[data-compound-id]').forEach(link => {
    link.addEventListener('click', async (e) => {
        e.preventDefault();

        // Update selected state
        document.querySelectorAll('[data-compound-id]').forEach(l =>
            l.classList.remove('selected'));
        e.target.classList.add('selected');

        // Load molecule
        const compoundId = e.target.dataset.compoundId;
        await loadMolecule(compoundId);
    });
});
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| JSmol (Java applet port) | 3Dmol.js (native WebGL) | 2015+ | Better performance, cleaner API |
| Java applets | WebGL libraries | 2015+ | No plugins, cross-platform |
| Server-side rendering | Client-side WebGL | 2015+ | Interactive, responsive |

**Deprecated/outdated:**
- **JSmol:** While still maintained, it's a JavaScript port of Java code. 3Dmol.js is purpose-built for web.
- **GLmol:** Predecessor to 3Dmol.js, no longer actively developed.
- **Java applets:** No longer supported in modern browsers.

## Open Questions

Things that could not be fully resolved:

1. **Equivalent Atom Groups**
   - What we know: Some shifts apply to multiple atoms (e.g., CH3 group has 3 H with same shift)
   - What's unclear: Whether to label all equivalent atoms or just one representative
   - Recommendation: Label all atoms in assignment dict. The h1_assignments/c13_assignments already map each atom index to its shift value.

2. **Label Overlap for Dense Molecules**
   - What we know: Labels can overlap on crowded structures
   - What's unclear: Best UX for handling overlap
   - Recommendation: Start with all labels visible. If problematic, add toggle for H vs C labels only.

## Sources

### Primary (HIGH confidence)
- [3Dmol.js Documentation](https://3dmol.csb.pitt.edu/doc/index.html) - API reference, tutorials
- [3Dmol.js GLViewer API](https://3dmol.csb.pitt.edu/doc/GLViewer.html) - addLabel, addModel methods
- [3Dmol.js LabelSpec](https://3dmol.csb.pitt.edu/doc/LabelSpec.html) - Label configuration options
- [3Dmol.js AtomSelectionSpec](https://3dmol.csb.pitt.edu/doc/AtomSelectionSpec.html) - Atom selection
- [3Dmol.js ParserOptionsSpec](https://3dmol.csb.pitt.edu/doc/ParserOptionsSpec.html) - XYZ loading options
- [Pico CSS Nav](https://picocss.com/docs/nav) - Navigation patterns
- [cdnjs 3Dmol](https://cdnjs.com/libraries/3Dmol) - CDN version info

### Secondary (MEDIUM confidence)
- [3Dmol.js GitHub examples](https://github.com/3dmol/3Dmol.js/blob/master/tests/example.html) - Working code patterns
- [3Dmol.js GitHub Issues](https://github.com/3dmol/3Dmol.js/issues) - Known issues, memory management

### Project Context (HIGH confidence)
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/api/templates/base.html` - Base template pattern
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/api/routers/web.py` - Existing router pattern
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/benchmark/data_loader.py` - DELTA50 data loading
- `/home/chris/develop/qm-nmr-calc/data/benchmark/delta50/experimental_shifts.json` - Data format

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - 3Dmol.js is well-documented, actively maintained
- Architecture: HIGH - Patterns match existing project structure
- Pitfalls: HIGH - Based on official docs and GitHub issues

**Research date:** 2026-01-21
**Valid until:** 2026-02-21 (3Dmol.js is stable, 30 days reasonable)
