---
phase: 08.1-delta50-data-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/api/routers/benchmark.py
  - src/qm_nmr_calc/api/templates/benchmark_viewer.html
  - src/qm_nmr_calc/api/static/css/custom.css
  - src/qm_nmr_calc/api/app.py
autonomous: true

must_haves:
  truths:
    - "User can see sidebar listing all 50 DELTA50 molecules"
    - "User can select a molecule and see its 3D structure"
    - "User can see 1H shifts (blue labels) on hydrogen atoms"
    - "User can see 13C shifts (green labels) on carbon atoms"
    - "User can see metadata panel showing compound name, ID, and atom counts"
  artifacts:
    - path: "src/qm_nmr_calc/api/routers/benchmark.py"
      provides: "Benchmark router with viewer page and molecule data API"
      exports: ["router"]
    - path: "src/qm_nmr_calc/api/templates/benchmark_viewer.html"
      provides: "3Dmol.js viewer with sidebar and metadata panel"
      contains: "3Dmol.createViewer"
  key_links:
    - from: "benchmark_viewer.html"
      to: "/benchmark/delta50/molecules/{compound_id}"
      via: "fetch() on sidebar click"
      pattern: "fetch.*molecules"
    - from: "benchmark.py"
      to: "benchmark.data_loader"
      via: "load_experimental_shifts, load_delta50_molecules"
      pattern: "load_experimental_shifts|load_delta50_molecules"
---

<objective>
Build a web-based DELTA50 data viewer to visually verify extracted molecular structures and experimental NMR shifts before running benchmark calculations.

Purpose: QA/validation tool to catch data extraction errors before expensive benchmark runs
Output: Web page at /benchmark/delta50 with 3D molecular viewer and shift annotations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-delta50-data-viewer/08.1-RESEARCH.md

# Existing patterns
@src/qm_nmr_calc/api/routers/web.py
@src/qm_nmr_calc/api/templates/base.html
@src/qm_nmr_calc/api/app.py
@src/qm_nmr_calc/benchmark/data_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create benchmark router with molecule list and data endpoints</name>
  <files>src/qm_nmr_calc/api/routers/benchmark.py</files>
  <action>
Create benchmark router following web.py patterns:

1. Import dependencies:
   - FastAPI APIRouter, Request, HTTPException
   - Jinja2Templates pointing to ../templates
   - From benchmark module: load_experimental_shifts, load_delta50_molecules

2. Create router with tags=["benchmark"]

3. GET /benchmark/delta50 endpoint:
   - Load experimental shifts to get molecule list
   - Sort molecules by compound_number (1-50)
   - Build molecule_list: [{id, name, compound_number}] for sidebar
   - Return TemplateResponse("benchmark_viewer.html") with molecule_list context

4. GET /benchmark/delta50/molecules/{compound_id} endpoint:
   - Validate compound_id exists in experimental shifts
   - Raise HTTPException(404) if not found
   - Load molecule XYZ from load_delta50_molecules()
   - Return JSON:
     {
       "compound_id": str,
       "name": str,
       "compound_number": int,
       "xyz": str (raw XYZ file content),
       "h1_shifts": list[float],
       "c13_shifts": list[float],
       "h1_assignments": dict[str, float],  # atom_index -> shift
       "c13_assignments": dict[str, float],
       "num_h_atoms": int,
       "num_c_atoms": int
     }

Note: h1_assignments/c13_assignments use 1-based atom indices (matching XYZ serial numbers).
  </action>
  <verify>
python -c "from qm_nmr_calc.api.routers.benchmark import router; print('Router imported OK')"
  </verify>
  <done>
Router exports GET /benchmark/delta50 (HTML) and GET /benchmark/delta50/molecules/{id} (JSON)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create viewer template with 3Dmol.js, sidebar, and metadata panel</name>
  <files>src/qm_nmr_calc/api/templates/benchmark_viewer.html</files>
  <action>
Create benchmark_viewer.html extending base.html:

1. Page structure with Pico CSS grid:
   - Aside (sidebar): Molecule list as nav links
   - Main content: Viewer container + metadata panel

2. Sidebar (left, ~200px):
   - Title: "DELTA50 Molecules"
   - nav > ul with li for each molecule
   - Each li: a with data-compound-id, text: "{compound_number}. {name}"
   - Highlight selected with aria-current="page"

3. Viewer container (center, flex-grow):
   - div#viewer-container with min-height: 500px
   - Background: white with border

4. Metadata panel (below viewer):
   - Show: Name, Compound ID, H atoms, C atoms
   - Show: 1H shifts (unique values), 13C shifts (unique values)
   - Legend: Blue = 1H, Green = 13C

5. JavaScript (in scripts block):
   - Load 3Dmol.js from CDN: https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js
   - Initialize viewer ONCE on DOMContentLoaded
   - Sidebar click handler:
     a. Remove aria-current from all links
     b. Set aria-current="page" on clicked link
     c. Call loadMolecule(compoundId)
   - loadMolecule(compoundId) async function:
     a. viewer.removeAllModels()
     b. viewer.removeAllLabels()
     c. Fetch /benchmark/delta50/molecules/{compoundId}
     d. Add model: viewer.addModel(data.xyz, 'xyz', {assignBonds: true})
     e. Set style: stick (radius 0.12) + sphere (scale 0.25), colorscheme: 'Jmol'
     f. Add shift labels (see addShiftLabels below)
     g. viewer.zoomTo(), viewer.render()
     h. Update metadata panel with data
   - addShiftLabels(model, h1Assignments, c13Assignments):
     a. Get all atoms: model.selectedAtoms({})
     b. For each atom, check if serial (as string) is in assignments
     c. H atoms with h1_assignments entry: blue label (#3498db)
     d. C atoms with c13_assignments entry: green label (#27ae60)
     e. Label text: shift.toFixed(2) for 1H, shift.toFixed(1) for 13C
     f. LabelSpec: fontSize 11, fontColor 'white', backgroundOpacity 0.85, inFront true
     g. Position: {x: atom.x, y: atom.y, z: atom.z}
   - Auto-load first molecule on page load

Template variables from router:
- molecule_list: [{id, name, compound_number}]
  </action>
  <verify>
ls -la src/qm_nmr_calc/api/templates/benchmark_viewer.html
  </verify>
  <done>
Template renders viewer page with sidebar, 3Dmol.js container, and metadata panel
  </done>
</task>

<task type="auto">
  <name>Task 3: Register router and add viewer styles</name>
  <files>src/qm_nmr_calc/api/app.py, src/qm_nmr_calc/api/static/css/custom.css</files>
  <action>
1. In app.py:
   - Import benchmark router: from .routers import health, jobs, web, benchmark
   - Add router AFTER web router: app.include_router(benchmark.router)
   - No prefix (benchmark.py defines /benchmark/delta50 routes)

2. In custom.css, add benchmark viewer styles:

/* Benchmark viewer layout */
.benchmark-layout {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 1rem;
    min-height: 70vh;
}

.benchmark-sidebar {
    background: var(--pico-card-background-color);
    border: 1px solid var(--pico-muted-border-color);
    border-radius: 0.25rem;
    overflow-y: auto;
    max-height: 80vh;
}

.benchmark-sidebar h3 {
    padding: 1rem;
    margin: 0;
    border-bottom: 1px solid var(--pico-muted-border-color);
    font-size: 1rem;
}

.benchmark-sidebar nav ul {
    padding: 0;
    margin: 0;
    list-style: none;
}

.benchmark-sidebar nav ul li {
    margin: 0;
    padding: 0;
}

.benchmark-sidebar nav a {
    display: block;
    padding: 0.5rem 1rem;
    text-decoration: none;
    font-size: 0.875rem;
    border-left: 3px solid transparent;
}

.benchmark-sidebar nav a:hover {
    background: var(--pico-secondary-hover-background);
}

.benchmark-sidebar nav a[aria-current="page"] {
    background: var(--pico-primary-background);
    border-left-color: var(--pico-primary);
    font-weight: 600;
}

/* Viewer container */
#viewer-container {
    min-height: 500px;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: 0.25rem;
    background: white;
}

/* Metadata panel */
.molecule-metadata {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--pico-card-background-color);
    border: 1px solid var(--pico-muted-border-color);
    border-radius: 0.25rem;
}

.molecule-metadata h4 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
}

.metadata-grid {
    display: grid;
    grid-template-columns: auto 1fr auto 1fr;
    gap: 0.5rem 1rem;
}

.shifts-display {
    margin-top: 1rem;
}

.shift-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    margin: 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-family: monospace;
}

.shift-badge.h1 {
    background: #3498db;
    color: white;
}

.shift-badge.c13 {
    background: #27ae60;
    color: white;
}

.legend {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.legend-color {
    width: 1rem;
    height: 1rem;
    border-radius: 0.25rem;
}

.legend-color.h1 { background: #3498db; }
.legend-color.c13 { background: #27ae60; }

@media (max-width: 768px) {
    .benchmark-layout {
        grid-template-columns: 1fr;
    }
    .benchmark-sidebar {
        max-height: 200px;
    }
}
  </action>
  <verify>
cd /home/chris/develop/qm-nmr-calc && uv run uvicorn qm_nmr_calc.api.app:app --host 127.0.0.1 --port 8000 &
sleep 2
curl -s http://127.0.0.1:8000/benchmark/delta50 | head -20
pkill -f "uvicorn.*8000"
  </verify>
  <done>
Benchmark router registered, viewer page loads at /benchmark/delta50, styles applied
  </done>
</task>

</tasks>

<verification>
1. Start server: uv run uvicorn qm_nmr_calc.api.app:app --reload
2. Visit http://localhost:8000/benchmark/delta50
3. Verify sidebar shows all 50 molecules
4. Click molecule: 3D structure appears with shift labels
5. Blue labels on H atoms, green labels on C atoms
6. Metadata panel shows compound info
</verification>

<success_criteria>
- [ ] /benchmark/delta50 loads without errors
- [ ] Sidebar lists 50 molecules (compound_01 through compound_50)
- [ ] Clicking molecule loads 3D structure in viewer
- [ ] 1H shifts appear as blue labels on H atoms
- [ ] 13C shifts appear as green labels on C atoms
- [ ] Metadata panel shows name, ID, atom counts, shift values
- [ ] First molecule auto-loads on page visit
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-delta50-data-viewer/08.1-01-SUMMARY.md`
</output>
