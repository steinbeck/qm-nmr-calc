---
phase: 04-results-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/api/routers/jobs.py
  - src/qm_nmr_calc/storage.py
autonomous: true

must_haves:
  truths:
    - "User can GET NMR shifts as JSON at dedicated endpoint"
    - "User can download optimized geometry as XYZ file"
    - "User can download optimized geometry as SDF file"
    - "User can download raw NWChem output files as zip"
    - "Incomplete jobs return 409 Conflict (not 404)"
    - "Missing files return 404 with clear error message"
  artifacts:
    - path: "src/qm_nmr_calc/api/routers/jobs.py"
      provides: "Results and download endpoints"
      exports: ["get_nmr_results", "download_geometry", "download_geometry_sdf", "download_output"]
    - path: "src/qm_nmr_calc/storage.py"
      provides: "File path helpers"
      exports: ["get_geometry_file", "get_output_files"]
  key_links:
    - from: "jobs.py download_geometry"
      to: "storage.get_geometry_file"
      via: "function call"
      pattern: "get_geometry_file\\(job_id\\)"
    - from: "jobs.py download_output"
      to: "job_dir/scratch"
      via: "zipfile creation"
      pattern: "ZipFile.*scratch"
---

<objective>
Add dedicated endpoints for retrieving NMR results and downloading calculation output files.

Purpose: Enable users to retrieve results in multiple formats - JSON for programmatic access, XYZ/SDF for molecular visualization, and raw NWChem output for advanced users.

Output: Four new GET endpoints under /api/v1/jobs/{job_id}/
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-results-delivery/04-RESEARCH.md

@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/storage.py
@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file path helpers to storage.py</name>
  <files>src/qm_nmr_calc/storage.py</files>
  <action>
Add helper functions for locating output files:

```python
def get_geometry_file(job_id: str) -> Optional[Path]:
    """Get path to optimized geometry XYZ file if it exists."""
    geometry_file = get_job_dir(job_id) / "output" / "optimized.xyz"
    return geometry_file if geometry_file.exists() else None

def get_output_files(job_id: str) -> list[Path]:
    """Get list of raw NWChem output files in job scratch directory.

    Returns .out and .nw files from the scratch directory.
    """
    scratch_dir = get_job_dir(job_id) / "scratch"
    if not scratch_dir.exists():
        return []
    files = []
    for pattern in ["*.out", "*.nw"]:
        files.extend(scratch_dir.glob(pattern))
    return files
```

These helpers encapsulate file location logic and handle missing files gracefully.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.storage import get_geometry_file, get_output_files; print('OK')"`
  </verify>
  <done>
Functions get_geometry_file and get_output_files are importable and return correct types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add results and download endpoints to jobs.py</name>
  <files>src/qm_nmr_calc/api/routers/jobs.py</files>
  <action>
Add four new endpoints to the jobs router. Import FileResponse from fastapi.responses, zipfile, and io at the top.

**1. GET /{job_id}/results - NMR results JSON**
```python
@router.get(
    "/{job_id}/results",
    response_model=NMRResultsResponse,
    responses={
        200: {"description": "NMR calculation results"},
        404: {"model": ProblemDetail, "description": "Job or results not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def get_nmr_results(job_id: str):
    """Get NMR chemical shifts for a completed job.

    Returns 1H and 13C shifts with atom indices, plus calculation metadata.
    """
```
- Load job status, return 404 if not found
- Return 409 if status != "complete" (job exists but not ready)
- Return 404 if nmr_results is None (job complete but no results)
- Return NMRResultsResponse from existing job_status.nmr_results

**2. GET /{job_id}/geometry - Download XYZ**
```python
@router.get(
    "/{job_id}/geometry",
    response_class=FileResponse,
    responses={
        200: {"description": "Optimized molecular geometry (XYZ)", "content": {"chemical/x-xyz": {}}},
        404: {"model": ProblemDetail},
        409: {"model": ProblemDetail},
    },
)
async def download_geometry(job_id: str):
    """Download optimized molecular geometry as XYZ file."""
```
- Same 404/409 pattern for job lookup
- Use get_geometry_file() from storage
- Return 404 if file doesn't exist (with specific error message)
- Return FileResponse with media_type="chemical/x-xyz", filename="{job_id}_optimized.xyz"

**3. GET /{job_id}/geometry.sdf - Download SDF**
```python
@router.get(
    "/{job_id}/geometry.sdf",
    response_class=FileResponse,
    responses={
        200: {"description": "Optimized molecular geometry (SDF)", "content": {"chemical/x-mdl-sdfile": {}}},
        404: {"model": ProblemDetail},
        409: {"model": ProblemDetail},
    },
)
async def download_geometry_sdf(job_id: str):
    """Download optimized molecular geometry as SDF file.

    Generates SDF from original SMILES with optimized 3D coordinates.
    """
```
- Same 404/409 pattern
- Read XYZ file to get coordinates
- Use RDKit: generate mol from job's input.smiles, embed conformer, set coordinates from XYZ
- Write to SDF using Chem.MolToMolBlock()
- Return as Response (not FileResponse) with content, media_type, and Content-Disposition header

**4. GET /{job_id}/output - Download raw output zip**
```python
@router.get(
    "/{job_id}/output",
    responses={
        200: {"description": "Raw NWChem output files (ZIP)", "content": {"application/zip": {}}},
        404: {"model": ProblemDetail},
        409: {"model": ProblemDetail},
    },
)
async def download_output(job_id: str):
    """Download raw NWChem output files as ZIP archive."""
```
- Same 404/409 pattern
- Use get_output_files() from storage
- Return 404 if no output files found
- Create in-memory zip using io.BytesIO + zipfile.ZipFile
- Add each .out and .nw file to zip
- Return Response with zip bytes, media_type="application/zip", Content-Disposition header

**Error format:** All HTTPExceptions use RFC 7807 ProblemDetail structure matching existing pattern.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.api.routers.jobs import get_nmr_results, download_geometry, download_geometry_sdf, download_output; print('OK')"`
  </verify>
  <done>
Four new endpoints are defined and importable. Endpoints return appropriate status codes for job states.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test endpoints with curl</name>
  <files></files>
  <action>
Start the API server and test the new endpoints:

```bash
# Start server in background
cd /home/christoph_steinbeck_gmail_com/develop/qm-nmr-calc
uv run uvicorn qm_nmr_calc.api.app:app --port 8000 &
sleep 2

# Test 1: /results endpoint - should return 404 for non-existent job
curl -s http://localhost:8000/api/v1/jobs/nonexistent123/results | jq .

# Test 2: /geometry endpoint - should return 404
curl -s http://localhost:8000/api/v1/jobs/nonexistent123/geometry | jq .

# Test 3: /output endpoint - should return 404
curl -s http://localhost:8000/api/v1/jobs/nonexistent123/output | jq .

# Test 4: Check OpenAPI includes new endpoints
curl -s http://localhost:8000/api/v1/openapi.json | jq '.paths | keys | map(select(contains("results") or contains("geometry") or contains("output")))'

# Cleanup
pkill -f "uvicorn qm_nmr_calc"
```

All tests should show proper 404 responses with ProblemDetail structure for non-existent jobs, and OpenAPI should list the new endpoints.
  </action>
  <verify>
Curl commands return 404 with proper ProblemDetail JSON. OpenAPI lists /results, /geometry, /geometry.sdf, /output paths.
  </verify>
  <done>
New endpoints respond correctly to requests and appear in OpenAPI documentation.
  </done>
</task>

</tasks>

<verification>
1. Storage helpers exist: `python -c "from qm_nmr_calc.storage import get_geometry_file, get_output_files"`
2. New endpoints exist: `python -c "from qm_nmr_calc.api.routers.jobs import get_nmr_results, download_geometry"`
3. Server starts without errors: `timeout 5 uv run uvicorn qm_nmr_calc.api.app:app --port 8000` (should start, then timeout)
4. Invalid job returns 404: `curl http://localhost:8000/api/v1/jobs/invalid123/results` returns ProblemDetail
</verification>

<success_criteria>
- GET /api/v1/jobs/{job_id}/results returns NMR data JSON for complete jobs
- GET /api/v1/jobs/{job_id}/geometry downloads XYZ file
- GET /api/v1/jobs/{job_id}/geometry.sdf downloads SDF file
- GET /api/v1/jobs/{job_id}/output downloads ZIP of raw output
- Incomplete jobs return 409 Conflict
- Missing jobs/files return 404 Not Found
- OpenAPI documentation includes all new endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/04-results-delivery/04-01-SUMMARY.md`
</output>
