---
phase: 04-results-delivery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/qm_nmr_calc/models.py
  - src/qm_nmr_calc/api/schemas.py
  - src/qm_nmr_calc/api/routers/jobs.py
  - src/qm_nmr_calc/notifications.py
  - src/qm_nmr_calc/queue.py
autonomous: true
user_setup:
  - service: smtp
    why: "Email notification delivery"
    env_vars:
      - name: SMTP_HOST
        source: "Email service provider (e.g., smtp.gmail.com, smtp.sendgrid.net)"
      - name: SMTP_PORT
        source: "Usually 587 for TLS, 465 for SSL"
      - name: SMTP_USER
        source: "Email service account username/API key"
      - name: SMTP_PASSWORD
        source: "Email service account password/API key"
      - name: NOTIFICATION_FROM
        source: "Sender email address (e.g., noreply@yourdomain.com)"
      - name: BASE_URL
        source: "Public URL of the service (e.g., https://qm-nmr-calc.example.com)"
    dashboard_config:
      - task: "Enable SMTP access or create API key"
        location: "Email service provider dashboard"

must_haves:
  truths:
    - "User can provide email address at job submission"
    - "Email field is optional (opt-in)"
    - "Email is validated at submission time (invalid email returns 422)"
    - "User receives email when job completes successfully"
    - "User receives email when job fails"
    - "Email contains job ID, status, and link to results"
  artifacts:
    - path: "src/qm_nmr_calc/notifications.py"
      provides: "Email sending functions"
      exports: ["send_job_notification", "send_job_notification_sync"]
    - path: "src/qm_nmr_calc/models.py"
      provides: "Extended JobInput with email"
      contains: "notification_email"
    - path: "src/qm_nmr_calc/api/schemas.py"
      provides: "Extended JobSubmitRequest with email"
      contains: "notification_email"
  key_links:
    - from: "queue.py on_task_complete"
      to: "notifications.send_job_notification_sync"
      via: "function call"
      pattern: "send_job_notification_sync"
    - from: "queue.py on_task_error"
      to: "notifications.send_job_notification_sync"
      via: "function call"
      pattern: "send_job_notification_sync"
---

<objective>
Add opt-in email notifications for job completion.

Purpose: Users who prefer email alerts over polling can provide an email address at submission and receive notification when their calculation completes (success or failure).

Output: Email notification system integrated with Huey task completion signals.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-results-delivery/04-RESEARCH.md

@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/api/schemas.py
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/queue.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aiosmtplib dependency and notification email field</name>
  <files>pyproject.toml, src/qm_nmr_calc/models.py, src/qm_nmr_calc/api/schemas.py</files>
  <action>
**1. Add aiosmtplib to pyproject.toml dependencies:**
```bash
uv add aiosmtplib
```

**2. Update models.py - Add notification_email to JobInput:**
```python
class JobInput(BaseModel):
    """Input parameters for a calculation job."""

    model_config = ConfigDict(strict=True)

    smiles: str
    name: Optional[str] = None
    preset: Literal["draft", "production"] = "production"
    solvent: str
    notification_email: Optional[str] = None  # Opt-in email for completion notification
```

**3. Update schemas.py - Add notification_email to JobSubmitRequest:**

Add EmailStr import from pydantic:
```python
from pydantic import BaseModel, EmailStr, Field
```

Add field to JobSubmitRequest:
```python
notification_email: Optional[EmailStr] = Field(
    None,
    description="Email address for completion notification (opt-in)",
    examples=["user@example.com"],
)
```

EmailStr provides email validation at submission time - invalid emails return 422 automatically.
  </action>
  <verify>
Run: `uv pip list | grep aiosmtplib` (shows aiosmtplib installed)
Run: `python -c "from qm_nmr_calc.models import JobInput; print(JobInput.model_fields.keys())"` (includes notification_email)
Run: `python -c "from qm_nmr_calc.api.schemas import JobSubmitRequest; print(JobSubmitRequest.model_fields.keys())"` (includes notification_email)
  </verify>
  <done>
aiosmtplib is installed. JobInput and JobSubmitRequest have notification_email field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notifications module</name>
  <files>src/qm_nmr_calc/notifications.py</files>
  <action>
Create new file `src/qm_nmr_calc/notifications.py`:

```python
"""Email notification functions for job completion."""

import asyncio
import logging
import os
from email.message import EmailMessage
from typing import Optional

import aiosmtplib

logger = logging.getLogger(__name__)

# Configuration from environment (with sensible defaults for development)
SMTP_HOST = os.getenv("SMTP_HOST", "localhost")
SMTP_PORT = int(os.getenv("SMTP_PORT", "587"))
SMTP_USER = os.getenv("SMTP_USER", "")
SMTP_PASSWORD = os.getenv("SMTP_PASSWORD", "")
NOTIFICATION_FROM = os.getenv("NOTIFICATION_FROM", "noreply@qm-nmr-calc.example")
BASE_URL = os.getenv("BASE_URL", "http://localhost:8000")


async def send_job_notification(
    to_email: str,
    job_id: str,
    status: str,
    error_message: Optional[str] = None,
) -> bool:
    """Send job completion/failure notification email.

    Args:
        to_email: Recipient email address
        job_id: Job identifier
        status: Job status (complete, failed)
        error_message: Error details if failed

    Returns:
        True if sent successfully, False otherwise
    """
    msg = EmailMessage()
    msg["From"] = NOTIFICATION_FROM
    msg["To"] = to_email
    msg["Subject"] = f"NMR Calculation {status.title()}: {job_id}"

    results_url = f"{BASE_URL}/api/v1/jobs/{job_id}"

    # Plain text version
    if status == "complete":
        plain_body = f"""\
Your NMR calculation has completed successfully.

Job ID: {job_id}
Status: Complete

View your results: {results_url}

Available downloads:
- Chemical shifts (JSON): {results_url}/results
- Optimized geometry (XYZ): {results_url}/geometry
- Optimized geometry (SDF): {results_url}/geometry.sdf
- Raw NWChem output: {results_url}/output
"""
    else:
        plain_body = f"""\
Your NMR calculation has failed.

Job ID: {job_id}
Status: Failed
Error: {error_message or "Unknown error"}

View details: {results_url}
"""

    msg.set_content(plain_body)

    # HTML version
    if status == "complete":
        html_body = f"""\
<html>
<body style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 600px;">
<h2 style="color: #2e7d32;">NMR Calculation Complete</h2>
<p>Your NMR calculation has completed successfully.</p>
<table style="border-collapse: collapse; margin: 15px 0;">
<tr><td style="padding: 5px 15px 5px 0;"><strong>Job ID:</strong></td><td>{job_id}</td></tr>
<tr><td style="padding: 5px 15px 5px 0;"><strong>Status:</strong></td><td style="color: #2e7d32;">Complete</td></tr>
</table>
<h3>Downloads</h3>
<ul>
<li><a href="{results_url}/results">Chemical Shifts (JSON)</a></li>
<li><a href="{results_url}/geometry">Optimized Geometry (XYZ)</a></li>
<li><a href="{results_url}/geometry.sdf">Optimized Geometry (SDF)</a></li>
<li><a href="{results_url}/output">Raw NWChem Output (ZIP)</a></li>
</ul>
<p style="margin-top: 20px;">
<a href="{results_url}" style="background-color: #2e7d32; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">View Results</a>
</p>
</body>
</html>
"""
    else:
        html_body = f"""\
<html>
<body style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 600px;">
<h2 style="color: #c62828;">NMR Calculation Failed</h2>
<p>Your NMR calculation encountered an error.</p>
<table style="border-collapse: collapse; margin: 15px 0;">
<tr><td style="padding: 5px 15px 5px 0;"><strong>Job ID:</strong></td><td>{job_id}</td></tr>
<tr><td style="padding: 5px 15px 5px 0;"><strong>Status:</strong></td><td style="color: #c62828;">Failed</td></tr>
<tr><td style="padding: 5px 15px 5px 0;"><strong>Error:</strong></td><td>{error_message or "Unknown error"}</td></tr>
</table>
<p><a href="{results_url}">View Details</a></p>
</body>
</html>
"""

    msg.add_alternative(html_body, subtype="html")

    try:
        # Only use authentication if credentials provided
        kwargs = {
            "hostname": SMTP_HOST,
            "port": SMTP_PORT,
        }
        if SMTP_USER and SMTP_PASSWORD:
            kwargs["username"] = SMTP_USER
            kwargs["password"] = SMTP_PASSWORD
            kwargs["start_tls"] = True

        await aiosmtplib.send(msg, **kwargs)
        logger.info(f"Sent notification email to {to_email} for job {job_id}")
        return True
    except Exception as e:
        # Log error but don't fail the job - email is best-effort
        logger.warning(f"Failed to send notification email to {to_email}: {e}")
        return False


def send_job_notification_sync(
    to_email: str,
    job_id: str,
    status: str,
    error_message: Optional[str] = None,
) -> bool:
    """Synchronous wrapper for use in Huey signal handlers.

    Huey signals run in sync context, so we need asyncio.run().
    """
    return asyncio.run(
        send_job_notification(to_email, job_id, status, error_message)
    )
```

Key design decisions:
- Uses environment variables for SMTP config (no hardcoded secrets)
- Both async and sync wrappers (for API vs Huey contexts)
- Best-effort delivery (logs errors but doesn't fail jobs)
- Multipart email with plain text and HTML versions
- Links to all download endpoints in completion email
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.notifications import send_job_notification_sync; print('OK')"`
  </verify>
  <done>
notifications.py exists with send_job_notification and send_job_notification_sync functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API and signal handlers</name>
  <files>src/qm_nmr_calc/api/routers/jobs.py, src/qm_nmr_calc/queue.py</files>
  <action>
**1. Update jobs.py - Pass notification_email through to job creation:**

In `submit_smiles()`, add notification_email to create_job_directory call:
```python
job_status = create_job_directory(
    smiles=request.smiles,
    solvent=normalized_solvent,
    isicle_version=versions.isicle,
    nwchem_version=versions.nwchem,
    name=request.name,
    preset=request.preset,
    notification_email=request.notification_email,  # Add this
)
```

In `submit_file()`, add notification_email form field and pass through:
```python
async def submit_file(
    file: UploadFile,
    solvent: Annotated[str, Form(...)],
    name: Annotated[Optional[str], Form(...)] = None,
    preset: Annotated[str, Form(...)] = "production",
    notification_email: Annotated[Optional[str], Form(description="Email for completion notification")] = None,
):
```
And pass to create_job_directory.

**2. Update storage.py - Add notification_email parameter:**

In `create_job_directory()` signature and JobInput creation:
```python
def create_job_directory(
    smiles: str,
    solvent: str,
    isicle_version: str,
    nwchem_version: str,
    name: Optional[str] = None,
    preset: str = "production",
    notification_email: Optional[str] = None,  # Add this
) -> JobStatus:
    # ...
    status = JobStatus(
        # ...
        input=JobInput(
            smiles=smiles,
            name=name,
            preset=preset,
            solvent=solvent,
            notification_email=notification_email,  # Add this
        ),
        # ...
    )
```

**3. Update queue.py - Send emails on completion/error:**

Add import at top:
```python
from .notifications import send_job_notification_sync
from .storage import load_job_status
```

Update `on_task_complete()`:
```python
@huey.signal(signals.SIGNAL_COMPLETE)
def on_task_complete(signal, task):
    """Update job status when task completes successfully."""
    if not task.args:
        return
    job_id = task.args[0]
    try:
        update_job_status(
            job_id,
            status='complete',
            completed_at=datetime.utcnow()
        )
        # Send notification if email was provided
        job_status = load_job_status(job_id)
        if job_status and job_status.input.notification_email:
            send_job_notification_sync(
                to_email=job_status.input.notification_email,
                job_id=job_id,
                status="complete",
            )
    except Exception:
        pass
```

Update `on_task_error()`:
```python
@huey.signal(signals.SIGNAL_ERROR)
def on_task_error(signal, task, exc=None):
    """Update job status when task fails with exception."""
    if not task.args:
        return
    job_id = task.args[0]
    error_msg = str(exc) if exc else 'Unknown error'
    try:
        update_job_status(
            job_id,
            status='failed',
            completed_at=datetime.utcnow(),
            error_message=error_msg,
            error_traceback=traceback.format_exc()
        )
        # Send notification if email was provided
        job_status = load_job_status(job_id)
        if job_status and job_status.input.notification_email:
            send_job_notification_sync(
                to_email=job_status.input.notification_email,
                job_id=job_id,
                status="failed",
                error_message=error_msg,
            )
    except Exception:
        pass
```
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.queue import on_task_complete, on_task_error; print('OK')"`
Run: `python -c "from qm_nmr_calc.storage import create_job_directory; import inspect; print('notification_email' in inspect.signature(create_job_directory).parameters)"`
  </verify>
  <done>
API accepts notification_email, storage persists it, signal handlers send emails on completion/failure.
  </done>
</task>

</tasks>

<verification>
1. Dependency installed: `uv pip list | grep aiosmtplib`
2. Models updated: `python -c "from qm_nmr_calc.models import JobInput; j = JobInput(smiles='CCO', solvent='chcl3', notification_email='test@example.com'); print(j.notification_email)"`
3. API accepts email: Start server and `curl -X POST http://localhost:8000/api/v1/jobs -H "Content-Type: application/json" -d '{"smiles":"CCO","solvent":"chcl3","notification_email":"test@example.com"}' | jq .`
4. Invalid email returns 422: `curl -X POST http://localhost:8000/api/v1/jobs -H "Content-Type: application/json" -d '{"smiles":"CCO","solvent":"chcl3","notification_email":"invalid"}' | jq .`
</verification>

<success_criteria>
- aiosmtplib is installed as dependency
- notification_email field exists in JobInput model
- notification_email field exists in JobSubmitRequest schema with EmailStr validation
- notifications.py module exists with send_job_notification functions
- API submission endpoints accept notification_email
- Invalid email addresses return 422 validation error
- Huey signal handlers call notification functions when email is provided
</success_criteria>

<output>
After completion, create `.planning/phases/04-results-delivery/04-02-SUMMARY.md`
</output>
