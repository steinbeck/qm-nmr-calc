---
phase: 36-api-container
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile.api
  - scripts/validate-api.sh
autonomous: true

must_haves:
  truths:
    - "User can build API image with docker build -f Dockerfile.api"
    - "FastAPI server responds to HTTP requests at port 8000"
    - "Health check endpoint returns 200 OK"
    - "Container runs as non-root user (UID 999)"
    - "Static files (CSS) are accessible"
  artifacts:
    - path: "Dockerfile.api"
      provides: "Multi-stage Docker build for FastAPI application"
      contains: "FROM ghcr.io/astral-sh/uv"
    - path: "scripts/validate-api.sh"
      provides: "Validation script for API container"
      contains: "curl.*health"
  key_links:
    - from: "Dockerfile.api"
      to: "src/qm_nmr_calc/api/app.py"
      via: "uvicorn module path"
      pattern: "qm_nmr_calc\\.api\\.app:app"
    - from: "Dockerfile.api"
      to: "/app/data"
      via: "WORKDIR and relative paths"
      pattern: "WORKDIR /app"
---

<objective>
Create a minimal, secure Docker container for the FastAPI API server with health checks and non-root user.

Purpose: DOCK-03 requires the API to run in a container separate from the worker. The API handles web requests, serves static files, and queues jobs to Huey.

Output: Dockerfile.api and validation script that verify all success criteria.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-api-container/36-RESEARCH.md

# Reference implementation
@Dockerfile.worker
@scripts/validate-worker.sh

# Application entry point
@src/qm_nmr_calc/api/app.py
@src/qm_nmr_calc/api/routers/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile.api with multi-stage build</name>
  <files>Dockerfile.api</files>
  <action>
Create `Dockerfile.api` using multi-stage build pattern from research:

**Stage 1: Builder**
- Base: `ghcr.io/astral-sh/uv:python3.11-bookworm-slim`
- WORKDIR: `/app`
- Environment variables for uv:
  - `UV_COMPILE_BYTECODE=1` (faster startup)
  - `UV_LINK_MODE=copy` (required for cache mounts)
- Install dependencies first (cache layer):
  ```dockerfile
  RUN --mount=type=cache,target=/root/.cache/uv \
      --mount=type=bind,source=uv.lock,target=uv.lock \
      --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
      uv sync --locked --no-install-project --no-dev
  ```
- Copy source and install project:
  ```dockerfile
  COPY pyproject.toml README.md ./
  COPY src/ /app/src/
  RUN --mount=type=cache,target=/root/.cache/uv \
      uv sync --locked --no-dev
  ```

**Stage 2: Runtime**
- Base: `python:3.11-slim-bookworm` (minimal, ~51MB)
- Install curl for health checks (apt-get install -y --no-install-recommends curl)
- Create non-root user with specific UID (reproducible):
  ```dockerfile
  RUN groupadd --system --gid 999 appgroup \
      && useradd --system --uid 999 --gid appgroup --create-home appuser
  ```
- WORKDIR: `/app`
- Copy from builder with ownership:
  - `/app/.venv` -> `/app/.venv` (chown appuser:appgroup)
  - `/app/src` -> `/app/src` (chown appuser:appgroup)
- Create data directory with correct ownership:
  ```dockerfile
  RUN mkdir -p /app/data && chown appuser:appgroup /app/data
  ```
- Environment variables:
  - `PATH="/app/.venv/bin:$PATH"`
  - `PYTHONUNBUFFERED=1`
  - `PYTHONDONTWRITEBYTECODE=1`
- Switch to non-root user: `USER appuser`
- Docker HEALTHCHECK:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
      CMD curl --fail http://localhost:8000/health || exit 1
  ```
- EXPOSE 8000
- CMD with exec form (proper signal handling):
  ```dockerfile
  CMD ["uvicorn", "qm_nmr_calc.api.app:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers"]
  ```

**Important:** Use exec form for CMD (NOT shell form) to ensure proper SIGTERM handling.
  </action>
  <verify>
Build the image:
```bash
docker build -f Dockerfile.api -t qm-nmr-calc-api:test .
```
Should complete without errors and show final image layer.
  </verify>
  <done>Dockerfile.api exists, image builds successfully, final image is under 300MB</done>
</task>

<task type="auto">
  <name>Task 2: Create validation script and verify container</name>
  <files>scripts/validate-api.sh</files>
  <action>
Create `scripts/validate-api.sh` following the pattern from `scripts/validate-worker.sh`:

```bash
#!/bin/bash
# Validation script for qm-nmr-calc API container
# Run inside container: docker run --rm -p 8000:8000 qm-nmr-calc-api:test /app/scripts/validate-api.sh

set -e  # Exit on first error

echo "=== API Container Validation ==="
echo ""

# 1. Python environment validation
echo "--- Testing Python Environment ---"
which python || { echo "FAIL: python not in PATH"; exit 1; }
echo "Python found at: $(which python)"
python --version

# 2. Uvicorn validation
echo ""
echo "--- Testing Uvicorn ---"
which uvicorn || { echo "FAIL: uvicorn not in PATH"; exit 1; }
echo "Uvicorn found at: $(which uvicorn)"
uvicorn --version

# 3. FastAPI app import validation
echo ""
echo "--- Testing FastAPI App Import ---"
python -c "from qm_nmr_calc.api.app import app; print('App title:', app.title)" || {
    echo "FAIL: Cannot import FastAPI app"
    exit 1
}
echo "PASS: FastAPI app imports successfully"

# 4. Static files validation
echo ""
echo "--- Testing Static Files ---"
STATIC_DIR="/app/src/qm_nmr_calc/api/static"
if [ -d "$STATIC_DIR" ]; then
    CSS_COUNT=$(find "$STATIC_DIR" -name "*.css" | wc -l)
    echo "Static directory exists: $STATIC_DIR"
    echo "CSS files found: $CSS_COUNT"
    if [ "$CSS_COUNT" -gt 0 ]; then
        echo "PASS: Static files present"
    else
        echo "FAIL: No CSS files found"
        exit 1
    fi
else
    echo "FAIL: Static directory not found: $STATIC_DIR"
    exit 1
fi

# 5. Templates validation
echo ""
echo "--- Testing Templates ---"
TEMPLATE_DIR="/app/src/qm_nmr_calc/api/templates"
if [ -d "$TEMPLATE_DIR" ]; then
    HTML_COUNT=$(find "$TEMPLATE_DIR" -name "*.html" | wc -l)
    echo "Templates directory exists: $TEMPLATE_DIR"
    echo "HTML files found: $HTML_COUNT"
    if [ "$HTML_COUNT" -gt 0 ]; then
        echo "PASS: Templates present"
    else
        echo "FAIL: No HTML templates found"
        exit 1
    fi
else
    echo "FAIL: Templates directory not found: $TEMPLATE_DIR"
    exit 1
fi

# 6. Data directory validation
echo ""
echo "--- Testing Data Directory ---"
DATA_DIR="/app/data"
if [ -d "$DATA_DIR" ]; then
    if [ -w "$DATA_DIR" ]; then
        echo "Data directory exists and writable: $DATA_DIR"
        echo "PASS: Data directory accessible"
    else
        echo "FAIL: Data directory not writable: $DATA_DIR"
        exit 1
    fi
else
    echo "FAIL: Data directory not found: $DATA_DIR"
    exit 1
fi

# 7. Non-root user validation
echo ""
echo "--- Testing User ---"
CURRENT_USER=$(whoami)
CURRENT_UID=$(id -u)
echo "Running as: $CURRENT_USER (UID: $CURRENT_UID)"
if [ "$CURRENT_UID" -ne 0 ]; then
    echo "PASS: Running as non-root user"
else
    echo "FAIL: Running as root (UID 0)"
    exit 1
fi

# 8. Health endpoint validation (start uvicorn in background)
echo ""
echo "--- Testing Health Endpoint ---"
uvicorn qm_nmr_calc.api.app:app --host 0.0.0.0 --port 8000 &
UVICORN_PID=$!
sleep 3  # Wait for startup

# Test liveness endpoint
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")
if [ "$HTTP_CODE" = "200" ]; then
    echo "PASS: /health returns 200"
else
    echo "FAIL: /health returned $HTTP_CODE (expected 200)"
    kill $UVICORN_PID 2>/dev/null
    exit 1
fi

# Test static file access
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/static/css/base.css || echo "000")
if [ "$HTTP_CODE" = "200" ]; then
    echo "PASS: Static CSS accessible"
else
    echo "FAIL: Static CSS returned $HTTP_CODE (expected 200)"
    kill $UVICORN_PID 2>/dev/null
    exit 1
fi

# Cleanup
kill $UVICORN_PID 2>/dev/null

echo ""
echo "=== All Validations Passed ==="
```

Make executable: `chmod +x scripts/validate-api.sh`

Then run full validation:
```bash
docker run --rm qm-nmr-calc-api:test /app/scripts/validate-api.sh
```

Also verify image size:
```bash
docker images qm-nmr-calc-api:test --format "{{.Size}}"
```
Should be under 300MB (target ~200MB per research).
  </action>
  <verify>
Run validation script in container:
```bash
docker run --rm qm-nmr-calc-api:test /app/scripts/validate-api.sh
```
All validations should pass.

Check final image size:
```bash
docker images qm-nmr-calc-api:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
```
  </verify>
  <done>Validation script exists, runs successfully, all checks pass (Python, uvicorn, app import, static files, templates, data directory, non-root user, health endpoint)</done>
</task>

<task type="auto">
  <name>Task 3: Verify Docker HEALTHCHECK works</name>
  <files></files>
  <action>
Run the container in detached mode and verify the Docker HEALTHCHECK reports healthy status:

```bash
# Start container
docker run -d --name api-health-test -p 8000:8000 qm-nmr-calc-api:test

# Wait for health check (start-period is 10s, interval is 30s)
sleep 15

# Check health status
docker inspect --format='{{.State.Health.Status}}' api-health-test
# Expected: "healthy"

# Also verify from host
curl -s http://localhost:8000/health
# Expected: {"status":"alive"}

# Verify static files accessible from host
curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/static/css/base.css
# Expected: 200

# Cleanup
docker stop api-health-test
docker rm api-health-test
```

If health check fails, check logs:
```bash
docker logs api-health-test
docker inspect --format='{{json .State.Health}}' api-health-test | python -m json.tool
```
  </action>
  <verify>
```bash
docker run -d --name api-health-test -p 8000:8000 qm-nmr-calc-api:test && \
sleep 15 && \
docker inspect --format='{{.State.Health.Status}}' api-health-test
```
Output should be "healthy".

```bash
curl -s http://localhost:8000/health | grep -q "alive" && echo "Health check OK"
```
  </verify>
  <done>Container starts, Docker HEALTHCHECK reports "healthy" status, /health endpoint returns {"status":"alive"}</done>
</task>

</tasks>

<verification>
All phase success criteria from ROADMAP.md:

1. **User can build API image with `docker build -f Dockerfile.api`**
   - `docker build -f Dockerfile.api -t qm-nmr-calc-api:test .` completes without errors

2. **FastAPI server responds to HTTP requests at port 8000**
   - `curl http://localhost:8000/health` returns 200 with JSON response

3. **Health check endpoint returns 200 OK**
   - `/health` endpoint responds with `{"status":"alive"}`
   - Docker HEALTHCHECK reports "healthy" status

4. **Container runs as non-root user**
   - `docker run --rm qm-nmr-calc-api:test id` shows UID 999, not 0
</verification>

<success_criteria>
- [ ] Dockerfile.api builds successfully
- [ ] Image size under 300MB (target ~200MB)
- [ ] Container runs as non-root user (UID 999)
- [ ] scripts/validate-api.sh passes all checks
- [ ] Docker HEALTHCHECK reports "healthy"
- [ ] Static CSS files accessible via /static/
- [ ] Health endpoint returns 200 OK
</success_criteria>

<output>
After completion, create `.planning/phases/36-api-container/36-01-SUMMARY.md`
</output>
