---
phase: 38-caddy---https
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Caddyfile
  - docker-compose.yml
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Caddy reverse proxy serves application on ports 80 and 443"
    - "HTTPS certificate obtained automatically when DOMAIN is set"
    - "HTTP requests redirect to HTTPS when DOMAIN is set"
    - "User can configure domain via DOMAIN environment variable"
    - "Deployment works on localhost without domain (HTTP-only mode)"
  artifacts:
    - path: "Caddyfile"
      provides: "Reverse proxy configuration with conditional HTTPS"
      contains: "{$DOMAIN:localhost}"
    - path: "docker-compose.yml"
      provides: "Caddy service configuration"
      contains: "caddy:"
    - path: ".env.example"
      provides: "DOMAIN variable documentation"
      contains: "DOMAIN="
  key_links:
    - from: "docker-compose.yml"
      to: "Caddyfile"
      via: "volume mount"
      pattern: "./Caddyfile:/etc/caddy/Caddyfile"
    - from: "docker-compose.yml caddy service"
      to: "api service"
      via: "Docker network"
      pattern: "reverse_proxy api:8000"
    - from: "docker-compose.yml"
      to: ".env"
      via: "environment variable"
      pattern: "DOMAIN="
---

<objective>
Add Caddy reverse proxy with automatic HTTPS to the Docker Compose deployment.

Purpose: Enable production-ready HTTPS with zero-configuration certificate management via Let's Encrypt. When DOMAIN is set, Caddy automatically obtains and renews certificates. When DOMAIN is unset, the application runs on localhost over HTTP for development.

Output: Caddyfile, updated docker-compose.yml with caddy service, updated .env.example with DOMAIN configuration.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-caddy---https/38-RESEARCH.md

# Current deployment files
@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Caddyfile with conditional HTTPS</name>
  <files>Caddyfile</files>
  <action>
Create Caddyfile at project root with the following configuration:

```caddyfile
# Caddyfile for qm-nmr-calc reverse proxy
#
# When DOMAIN is unset: serves http://localhost (no TLS)
# When DOMAIN is set: serves https://{DOMAIN} (auto TLS via Let's Encrypt)
#
# Configuration: Set DOMAIN in .env file
# Example: DOMAIN=nmr.example.com

{$DOMAIN:localhost} {
    # Reverse proxy to FastAPI backend
    reverse_proxy api:8000

    # Enable compression for faster responses
    encode gzip
}
```

Key points:
- Use `{$DOMAIN:localhost}` for environment variable with default
- No explicit HTTP/HTTPS - Caddy determines from hostname (localhost = HTTP, domain = HTTPS)
- Reverse proxy targets `api:8000` (Docker service name)
- Enable gzip compression for performance
  </action>
  <verify>
```bash
# Verify Caddyfile exists and contains required patterns
test -f Caddyfile && \
grep -q '{$DOMAIN:localhost}' Caddyfile && \
grep -q 'reverse_proxy api:8000' Caddyfile && \
grep -q 'encode gzip' Caddyfile && \
echo "Caddyfile created correctly"
```
  </verify>
  <done>Caddyfile exists with conditional HTTPS configuration using {$DOMAIN:localhost} pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add Caddy service to docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Modify docker-compose.yml to:

1. Add caddy service after api service:
```yaml
  caddy:
    image: caddy:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3 (QUIC)
    cap_add:
      - NET_ADMIN  # Required for QUIC/HTTP3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - DOMAIN=${DOMAIN:-}
    depends_on:
      api:
        condition: service_healthy
```

2. Change api service from `ports` to `expose`:
   - Remove: `ports: - "${API_PORT:-8000}:8000"`
   - Add: `expose: - "8000"`
   - This makes API accessible only via internal Docker network (through Caddy)

3. Add volumes for Caddy certificate persistence:
```yaml
volumes:
  app-data:
    name: qm-nmr-calc-data
  caddy_data:
    name: qm-nmr-calc-caddy-data
  caddy_config:
```

Key points:
- caddy_data volume is CRITICAL - prevents certificate re-issuance and rate limiting
- Use named volume (not anonymous) so certificates survive `docker compose down`
- DOMAIN env var passed through to Caddy container
- depends_on ensures API is healthy before Caddy starts proxying
- Keep API_PORT in .env.example (may be useful for direct access during debugging)
  </action>
  <verify>
```bash
# Verify docker-compose.yml has Caddy service and correct configuration
grep -q "caddy:" docker-compose.yml && \
grep -q 'image: caddy:alpine' docker-compose.yml && \
grep -q 'caddy_data:/data' docker-compose.yml && \
grep -q 'expose:' docker-compose.yml && \
! grep -q 'ports:.*8000' docker-compose.yml && \
echo "docker-compose.yml updated correctly"
```
  </verify>
  <done>docker-compose.yml contains caddy service with proper volumes and api service uses expose instead of ports</done>
</task>

<task type="auto">
  <name>Task 3: Update .env.example with DOMAIN configuration</name>
  <files>.env.example</files>
  <action>
Add DOMAIN configuration section to .env.example after the API Configuration section:

```bash
# ============================================================================
# HTTPS Configuration (Caddy)
# ============================================================================

# Domain for automatic HTTPS certificates via Let's Encrypt
# When set: Caddy obtains certificates and serves HTTPS
# When empty: Caddy serves HTTP on localhost (development mode)
#
# Example: DOMAIN=nmr.example.com
# Note: Domain must point to this server's IP before starting
DOMAIN=

# Email for Let's Encrypt certificate notifications (optional)
# Recommended for production to receive expiry warnings
# Example: ACME_EMAIL=admin@example.com
ACME_EMAIL=
```

Also update the API_PORT comment to reflect the new architecture:
```bash
# Port to expose the API on the host machine
# Note: When using Caddy (default), API is only accessible via Caddy on ports 80/443
# To access API directly (debugging), uncomment ports section in docker-compose.yml
API_PORT=8000
```
  </action>
  <verify>
```bash
# Verify .env.example has DOMAIN configuration
grep -q "^DOMAIN=" .env.example && \
grep -q "ACME_EMAIL=" .env.example && \
grep -q "HTTPS Configuration" .env.example && \
echo ".env.example updated correctly"
```
  </verify>
  <done>.env.example documents DOMAIN and ACME_EMAIL variables with clear usage instructions</done>
</task>

</tasks>

<verification>
After all tasks complete, run these verification steps:

1. **Configuration syntax validation:**
```bash
# Validate docker-compose.yml syntax
docker compose config --quiet && echo "docker-compose.yml syntax valid"
```

2. **Service definition check:**
```bash
# List services to confirm caddy is defined
docker compose config --services | grep -q caddy && echo "Caddy service defined"
```

3. **Volume definition check:**
```bash
# Confirm caddy volumes are defined
docker compose config --volumes | grep -q caddy_data && echo "Caddy volumes defined"
```

4. **Integration test (if Docker available):**
```bash
# Start stack and verify Caddy starts (localhost HTTP mode)
docker compose up -d
sleep 10
curl -f http://localhost/ && echo "Caddy serving on port 80"
docker compose down
```
</verification>

<success_criteria>
Phase 38 is complete when:
1. Caddyfile exists with `{$DOMAIN:localhost}` conditional HTTPS pattern
2. docker-compose.yml includes caddy service with proper volumes and networking
3. API service uses `expose` instead of `ports` (internal access only)
4. .env.example documents DOMAIN variable with clear instructions
5. `docker compose config` validates without errors
6. Stack starts and Caddy serves on port 80 in localhost mode
</success_criteria>

<output>
After completion, create `.planning/phases/38-caddy---https/38-01-SUMMARY.md`
</output>
