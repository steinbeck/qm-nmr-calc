---
phase: 39-cicd-ghcr-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/publish-images.yml
  - Dockerfile.api
  - Dockerfile.worker
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "Pre-built images exist on ghcr.io/[owner]/qm-nmr-calc-api"
    - "Pre-built images exist on ghcr.io/[owner]/qm-nmr-calc-worker"
    - "GitHub Actions workflow triggers on release tag push"
    - "Images are tagged with version (v*) and latest"
    - "API image supports both amd64 and arm64"
    - "Worker image supports amd64 (arm64 not available due to binary limitations)"
  artifacts:
    - path: ".github/workflows/publish-images.yml"
      provides: "GitHub Actions CI/CD workflow"
      min_lines: 50
      contains: "docker/build-push-action"
    - path: "Dockerfile.api"
      provides: "API container with OCI labels"
      contains: "org.opencontainers.image.source"
    - path: "Dockerfile.worker"
      provides: "Worker container with OCI labels"
      contains: "org.opencontainers.image.source"
  key_links:
    - from: ".github/workflows/publish-images.yml"
      to: "ghcr.io"
      via: "docker/login-action with GITHUB_TOKEN"
      pattern: "docker/login-action"
    - from: ".github/workflows/publish-images.yml"
      to: "Dockerfile.api"
      via: "matrix.dockerfile reference"
      pattern: "Dockerfile\\.api"
    - from: ".github/workflows/publish-images.yml"
      to: "Dockerfile.worker"
      via: "matrix.dockerfile reference"
      pattern: "Dockerfile\\.worker"
---

<objective>
Create GitHub Actions workflow to build and publish Docker images to GitHub Container Registry (GHCR) on release tags.

Purpose: Enable users to deploy qm-nmr-calc using pre-built images (`docker pull ghcr.io/.../qm-nmr-calc-api:latest`) instead of building from source, reducing deployment time from 15+ minutes to under 1 minute.

Output:
- GitHub Actions workflow file that triggers on v* tags
- OCI labels in Dockerfiles for GHCR repository linking
- Updated docker-compose.yml with pre-built image option
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-cicd-ghcr-publishing/39-RESEARCH.md
@Dockerfile.api
@Dockerfile.worker
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for multi-image publishing</name>
  <files>
    .github/workflows/publish-images.yml
  </files>
  <action>
Create `.github/workflows/` directory and `publish-images.yml` with:

1. **Trigger:** On push of tags matching `v*` (e.g., v2.4.0)

2. **Permissions:**
   - `contents: read` (checkout)
   - `packages: write` (push to GHCR)

3. **Matrix strategy:**
   ```yaml
   matrix:
     include:
       - image: qm-nmr-calc-api
         dockerfile: Dockerfile.api
         platforms: linux/amd64,linux/arm64
       - image: qm-nmr-calc-worker
         dockerfile: Dockerfile.worker
         platforms: linux/amd64  # arm64 not supported - CREST/xTB lack arm64 binaries
   ```

4. **Steps:**
   - `actions/checkout@v4`
   - `docker/setup-qemu-action@v3` (for arm64 emulation)
   - `docker/setup-buildx-action@v3`
   - `docker/login-action@v3` with GHCR using `secrets.GITHUB_TOKEN`
   - `docker/metadata-action@v5` to generate tags:
     - `type=semver,pattern={{version}}` (e.g., 2.4.0)
     - `type=semver,pattern={{major}}.{{minor}}` (e.g., 2.4)
     - `type=raw,value=latest`
   - `docker/build-push-action@v6` with:
     - `context: .`
     - `file: ${{ matrix.dockerfile }}`
     - `platforms: ${{ matrix.platforms }}`
     - `push: true`
     - `tags: ${{ steps.meta.outputs.tags }}`
     - `labels: ${{ steps.meta.outputs.labels }}`
     - `cache-from: type=gha,scope=${{ matrix.image }}`
     - `cache-to: type=gha,mode=max,scope=${{ matrix.image }}`

5. **Set `fail-fast: false`** so one image build doesn't block the other.

Use `env.REGISTRY: ghcr.io` at workflow level for consistency.
  </action>
  <verify>
```bash
# Check workflow file exists and has valid YAML
cat .github/workflows/publish-images.yml
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/publish-images.yml'))"
```
  </verify>
  <done>
- Workflow file exists at `.github/workflows/publish-images.yml`
- Contains trigger on `push.tags: ['v*']`
- Contains matrix with api (amd64+arm64) and worker (amd64-only)
- Contains all 6 required actions (checkout, qemu, buildx, login, metadata, build-push)
- Uses GITHUB_TOKEN for authentication (not PAT)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OCI labels to Dockerfiles for GHCR linking</name>
  <files>
    Dockerfile.api
    Dockerfile.worker
  </files>
  <action>
Add OCI labels to both Dockerfiles for GHCR repository linking and metadata display.

**Dockerfile.api** - Add after the FROM line in Stage 2 (runtime stage):
```dockerfile
# OCI labels for GHCR
LABEL org.opencontainers.image.source="https://github.com/OWNER/qm-nmr-calc"
LABEL org.opencontainers.image.description="QM NMR Calculator - API container"
LABEL org.opencontainers.image.licenses="MIT"
```

**Dockerfile.worker** - Add after the FROM line:
```dockerfile
# OCI labels for GHCR
LABEL org.opencontainers.image.source="https://github.com/OWNER/qm-nmr-calc"
LABEL org.opencontainers.image.description="QM NMR Calculator - Worker container with NWChem, CREST, xTB"
LABEL org.opencontainers.image.licenses="MIT"
```

**Important:** Replace `OWNER` with the actual GitHub username/org. Check git remote to determine:
```bash
git remote get-url origin
```

The `org.opencontainers.image.source` label is REQUIRED for GHCR to automatically link the package to the repository and enable permissions inheritance.
  </action>
  <verify>
```bash
# Check labels exist in both Dockerfiles
grep "org.opencontainers.image.source" Dockerfile.api
grep "org.opencontainers.image.source" Dockerfile.worker
grep "org.opencontainers.image.description" Dockerfile.api
grep "org.opencontainers.image.description" Dockerfile.worker
```
  </verify>
  <done>
- Dockerfile.api contains OCI source, description, and licenses labels
- Dockerfile.worker contains OCI source, description, and licenses labels
- Source URL matches actual GitHub repository URL
  </done>
</task>

<task type="auto">
  <name>Task 3: Document pre-built image usage in docker-compose.yml</name>
  <files>
    docker-compose.yml
  </files>
  <action>
Add comments to docker-compose.yml showing users how to use pre-built images from GHCR instead of building locally.

At the top of the file, add a comment block:
```yaml
# qm-nmr-calc Docker Compose Configuration
#
# DEPLOYMENT OPTIONS:
#
# Option 1: Use pre-built images from GHCR (recommended for deployment)
#   Replace the 'build' sections with 'image' lines:
#     api:
#       image: ghcr.io/OWNER/qm-nmr-calc-api:latest
#     worker:
#       image: ghcr.io/OWNER/qm-nmr-calc-worker:latest
#
# Option 2: Build from source (for development)
#   Keep the existing 'build' configuration (default)
#
# See: https://github.com/OWNER/qm-nmr-calc/pkgs/container/qm-nmr-calc-api
```

Replace `OWNER` with actual GitHub username/org (same as Task 2).

This documents the GHCR images without changing the default behavior (build from source), preserving backward compatibility.
  </action>
  <verify>
```bash
# Check comment block exists
head -20 docker-compose.yml | grep -i "pre-built"
grep "ghcr.io" docker-compose.yml
```
  </verify>
  <done>
- docker-compose.yml contains comment block explaining both deployment options
- Pre-built image URLs reference correct GHCR paths
- Default behavior (build from source) is preserved
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Workflow syntax valid:**
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/publish-images.yml'))"
   ```

2. **All files modified correctly:**
   ```bash
   # OCI labels in Dockerfiles
   grep -l "org.opencontainers.image" Dockerfile.api Dockerfile.worker

   # GHCR reference in docker-compose
   grep "ghcr.io" docker-compose.yml
   ```

3. **Git status shows expected changes:**
   ```bash
   git status --short
   # Expected:
   #   ?? .github/workflows/publish-images.yml
   #   M Dockerfile.api
   #   M Dockerfile.worker
   #   M docker-compose.yml
   ```

Note: Actual GHCR publishing can only be verified after pushing a release tag to GitHub. The workflow itself cannot be tested locally.
</verification>

<success_criteria>
1. `.github/workflows/publish-images.yml` exists with valid GitHub Actions syntax
2. Workflow triggers on `v*` tag push (not on every commit)
3. Workflow builds two images: api (amd64+arm64) and worker (amd64-only)
4. Workflow uses docker/metadata-action for automatic version+latest tagging
5. Workflow uses GITHUB_TOKEN for GHCR authentication (no manual PAT required)
6. Workflow uses cache (type=gha with scope) to speed up subsequent builds
7. Both Dockerfiles have OCI labels linking to GitHub repository
8. docker-compose.yml documents pre-built image usage option
</success_criteria>

<output>
After completion, create `.planning/phases/39-cicd-ghcr-publishing/39-01-SUMMARY.md`
</output>
