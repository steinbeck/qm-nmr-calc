---
phase: 54-benchmark-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/input_gen.py
  - src/qm_nmr_calc/benchmark/runner.py
  - src/qm_nmr_calc/benchmark/__main__.py
  - tests/test_nwchem_input.py
  - tests/test_benchmark.py
autonomous: true

must_haves:
  truths:
    - "Benchmark CLI accepts Methanol, Water, Acetone, Benzene as valid --solvents values"
    - "NWChem COSMO input files contain correct 'solvent benzene' directive for benzene"
    - "NWChem COSMO input files contain correct solvent directives for water, acetone, methanol (already supported but now reachable from benchmark CLI)"
    - "build_task_matrix with new solvents produces correct task count"
    - "All existing tests still pass (no regression)"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/input_gen.py"
      provides: "SUPPORTED_SOLVENTS with benzene added"
      contains: "benzene"
    - path: "src/qm_nmr_calc/benchmark/runner.py"
      provides: "SOLVENTS list with 4 new solvents"
      contains: "Methanol"
    - path: "src/qm_nmr_calc/benchmark/__main__.py"
      provides: "CLI --solvents choices with all 6 solvents"
      contains: "Benzene"
    - path: "tests/test_nwchem_input.py"
      provides: "Tests for benzene COSMO generation"
      contains: "benzene"
    - path: "tests/test_benchmark.py"
      provides: "Tests for expanded solvent list in benchmark runner"
      contains: "Methanol"
  key_links:
    - from: "src/qm_nmr_calc/benchmark/__main__.py"
      to: "src/qm_nmr_calc/benchmark/runner.py"
      via: "CLI choices must match runner SOLVENTS"
      pattern: "choices=.*Methanol.*Water.*Acetone.*Benzene"
    - from: "src/qm_nmr_calc/benchmark/runner.py"
      to: "src/qm_nmr_calc/nwchem/input_gen.py"
      via: "runner passes solvent.lower() to run_calculation which calls input_gen"
      pattern: "solvent=solvent\\.lower\\(\\)"
---

<objective>
Extend the benchmark CLI and NWChem input generation to accept 4 new solvents (methanol, water, acetone, benzene), enabling Phase 55 benchmark calculations.

Purpose: Phase 55 needs to dispatch 200 NWChem calculations across 4 new solvents. The CLI currently only allows CHCl3 and DMSO. This plan adds the 4 new solvents at every layer: input generation, benchmark runner, and CLI argument parser.

Output: Modified source files and updated tests that allow `python -m qm_nmr_calc.benchmark run --solvents Methanol --functionals B3LYP --headless` to be accepted without "invalid choice" errors.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/qm_nmr_calc/nwchem/input_gen.py
@src/qm_nmr_calc/benchmark/runner.py
@src/qm_nmr_calc/benchmark/__main__.py
@tests/test_nwchem_input.py
@tests/test_benchmark.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 4 new solvents to input_gen, benchmark runner, and CLI</name>
  <files>
    src/qm_nmr_calc/nwchem/input_gen.py
    src/qm_nmr_calc/benchmark/runner.py
    src/qm_nmr_calc/benchmark/__main__.py
  </files>
  <action>
Three files need changes:

1. **input_gen.py** (line 8): Add "benzene" to SUPPORTED_SOLVENTS set. Water, acetone, and methanol are already present. Only benzene is missing.
   - Change: `SUPPORTED_SOLVENTS = {"chcl3", "dmso", "water", "acetone", "methanol", "vacuum"}`
   - To: `SUPPORTED_SOLVENTS = {"chcl3", "dmso", "water", "acetone", "methanol", "benzene", "vacuum"}`

2. **runner.py** (line 24): Expand SOLVENTS list to include the 4 new solvents. Keep CHCl3 and DMSO, add Methanol, Water, Acetone, Benzene. Use title case to match existing convention (CHCl3 and DMSO are the established CLI format; new solvents use title case as specified in roadmap).
   - Change: `SOLVENTS = ["CHCl3", "DMSO"]`
   - To: `SOLVENTS = ["CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene"]`
   - Also update the show_status function (line 544) which hardcodes `total_tasks = 50 * len(FUNCTIONALS) * len(SOLVENTS)` -- this will automatically work correctly since it uses len(SOLVENTS), but verify the comment says "# 200" is removed or updated since 50*2*6=600 now. Change the comment from `# 200` to reflect the new count or remove the hardcoded comment.

3. **__main__.py** (line 280): Expand the choices list for the --solvents argument.
   - Change: `choices=["CHCl3", "DMSO"]`
   - To: `choices=["CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene"]`
   - Also update the help text on line 281 to reflect the expanded default: `help="Solvents to test (default: CHCl3 DMSO Methanol Water Acetone Benzene)"`

IMPORTANT: The runner converts solvent names to lowercase via `solvent=solvent.lower()` on line 234. This means CLI name "Benzene" becomes "benzene" when passed to run_calculation, which then passes to input_gen.py. This chain must work: Benzene -> benzene -> SUPPORTED_SOLVENTS lookup. Verify this chain is intact by reading the code path.

Do NOT change any other behavior. Do NOT modify the BENCHMARK_PRESETS, FUNCTIONALS, or any calculation logic.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem.input_gen import SUPPORTED_SOLVENTS; assert 'benzene' in SUPPORTED_SOLVENTS; print('benzene in SUPPORTED_SOLVENTS:', SUPPORTED_SOLVENTS)"`

Run: `python -c "from qm_nmr_calc.benchmark.runner import SOLVENTS; assert 'Methanol' in SOLVENTS; assert 'Water' in SOLVENTS; assert 'Acetone' in SOLVENTS; assert 'Benzene' in SOLVENTS; print('SOLVENTS:', SOLVENTS)"`

Run: `python -m qm_nmr_calc.benchmark run --solvents Methanol --functionals B3LYP --help` to verify no argparse error on the choices.

Run: `python -c "from qm_nmr_calc.nwchem.input_gen import generate_shielding_input; result = generate_shielding_input('C 0.0 0.0 0.0', 'b3lyp', '6-311+G(2d,p)', 'benzene'); assert 'solvent benzene' in result; print('Benzene COSMO block OK')"`
  </verify>
  <done>
SUPPORTED_SOLVENTS contains "benzene". SOLVENTS list contains all 6 solvents. CLI --solvents accepts Methanol, Water, Acetone, Benzene without error. NWChem input for benzene contains "solvent benzene" COSMO directive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for new solvent support</name>
  <files>
    tests/test_nwchem_input.py
    tests/test_benchmark.py
  </files>
  <action>
Add tests to verify the new solvent support works correctly.

1. **tests/test_nwchem_input.py**: Add a new test class `TestBenzeneSolvent` (or add tests to existing classes) with:
   - `test_benzene_optimization_has_cosmo`: Generate optimization input with solvent="benzene", assert "cosmo" in result and "solvent benzene" in result.
   - `test_benzene_shielding_has_cosmo`: Generate shielding input with solvent="benzene", assert "cosmo" in result and "solvent benzene" in result.
   - `test_benzene_case_insensitive`: Test that "Benzene", "BENZENE", "benzene" all work.
   - `test_all_supported_solvents_accepted`: Parametrize over all 7 solvents (chcl3, dmso, water, acetone, methanol, benzene, vacuum) and verify generate_optimization_input does not raise for any of them.

2. **tests/test_benchmark.py**: Update existing tests and add new ones:
   - Update `test_build_task_matrix_default` -- the expected count changes since SOLVENTS now has 6 entries. The test currently asserts `50 * len(FUNCTIONALS) * len(SOLVENTS)` which will automatically work since it uses the imported SOLVENTS constant. Verify this test still passes without modification.
   - Add `test_solvents_list_has_six_entries`: Assert `len(SOLVENTS) == 6` and verify each expected solvent is in the list.
   - Add `test_solvents_include_new_entries`: Assert "Methanol", "Water", "Acetone", "Benzene" are all in SOLVENTS.
   - Add `test_build_task_matrix_with_new_solvent`: Call `build_task_matrix(molecules=["compound_01"], functionals=["B3LYP"], solvents=["Benzene"])` and assert 1 task is returned with correct solvent.

Follow existing test patterns: use classes, descriptive docstrings, pytest style.
  </action>
  <verify>
Run: `python -m pytest tests/test_nwchem_input.py tests/test_benchmark.py -v`

All tests must pass. Expected: existing tests pass + new tests pass.

Run: `python -m pytest tests/ -v --tb=short` to verify no regressions across the full test suite.
  </verify>
  <done>
All new tests pass. All existing tests pass. Test count increased by at least 6 new test cases covering benzene COSMO generation, expanded solvent list validation, and task matrix with new solvents.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_nwchem_input.py tests/test_benchmark.py -v` -- all pass
2. `python -m pytest tests/ -v --tb=short` -- full suite passes, no regressions
3. `python -c "from qm_nmr_calc.nwchem.input_gen import SUPPORTED_SOLVENTS; print(SUPPORTED_SOLVENTS)"` -- shows benzene
4. `python -c "from qm_nmr_calc.benchmark.runner import SOLVENTS; print(SOLVENTS)"` -- shows all 6
5. `python -m qm_nmr_calc.benchmark run --solvents Benzene --functionals B3LYP --help` -- no argparse error
6. `python -c "from qm_nmr_calc.nwchem.input_gen import generate_shielding_input; r = generate_shielding_input('C 0 0 0', 'b3lyp', '6-311+G(2d,p)', 'benzene'); assert 'solvent benzene' in r"` -- benzene COSMO OK
</verification>

<success_criteria>
- BENCH-01 satisfied: CLI accepts Methanol, Water, Acetone, Benzene as --solvents values
- INTG-05 satisfied: NWChem COSMO generates correct solvation for all 4 new solvents (benzene added to input_gen.py; water, acetone, methanol were already there)
- No regressions: existing CHCl3/DMSO/vacuum behavior unchanged
- Test coverage: new tests verify benzene COSMO, expanded solvent lists, task matrix
</success_criteria>

<output>
After completion, create `.planning/phases/54-benchmark-infrastructure/54-01-SUMMARY.md`
</output>
