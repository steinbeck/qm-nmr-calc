---
phase: 20-submit-redesign
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/qm_nmr_calc/api/templates/submit.html
autonomous: false

must_haves:
  truths:
    - "Form displays in two-column layout with preview on right"
    - "Each fieldset has descriptive legend text"
    - "Required fields show red asterisk indicator"
    - "SMILES input triggers molecule preview update"
    - "Invalid SMILES shows error state in preview"
    - "Conformer method field has help text explaining options"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/submit.html"
      provides: "Redesigned submit form template"
      contains: "submit-layout"
    - path: "src/qm_nmr_calc/api/templates/submit.html"
      provides: "SmilesDrawer integration"
      contains: "smiles-drawer"
  key_links:
    - from: "src/qm_nmr_calc/api/templates/submit.html"
      to: "submit-page.css"
      via: "CSS class references"
      pattern: "class=\".*submit-layout"
    - from: "src/qm_nmr_calc/api/templates/submit.html"
      to: "SmilesDrawer CDN"
      via: "script src"
      pattern: "smiles-drawer"
---

<objective>
Update submit.html template with two-column layout, molecule preview, and SmilesDrawer integration

Purpose: Transform submit page into modern, accessible form with real-time molecule preview feedback
Output: Redesigned submit.html using new CSS classes and integrated SmilesDrawer for SMILES validation
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-submit-redesign/20-RESEARCH.md
@.planning/phases/20-submit-redesign/20-01-SUMMARY.md

# Existing template to update
@src/qm_nmr_calc/api/templates/submit.html
@src/qm_nmr_calc/api/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update submit.html with two-column layout and preview area</name>
  <files>src/qm_nmr_calc/api/templates/submit.html</files>
  <action>
Restructure submit.html to use new CSS classes. Preserve ALL existing form functionality and Jinja2 variables.

**1. Add page_css block after title block:**
```jinja2
{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/submit-page.css') }}">
{% endblock %}
```

**2. Replace article wrapper with submit-layout grid structure:**
```html
<div class="submit-layout">
    <div class="submit-form">
        <!-- Form content here -->
    </div>
    <div class="submit-layout__preview">
        <!-- Preview card here -->
    </div>
</div>
```

**3. Add form instructions at top of form:**
```html
<p class="form-instructions">
    Fields marked with <span class="required-indicator" aria-hidden="true">*</span> are required.
</p>
```

**4. Update each fieldset with form-group class and improved structure:**

For Molecule Input fieldset:
```html
<fieldset class="form-group">
    <legend>Molecule Input</legend>

    <div class="form-group__field">
        <label for="smiles">SMILES String</label>
        <input type="text" id="smiles" name="smiles"
               placeholder="e.g., CCO for ethanol"
               value="{{ form_data.smiles or '' }}"
               autocomplete="off">
        <small class="field-help">Enter the SMILES representation of your molecule</small>
    </div>

    <div class="form-group__field">
        <label for="file">Or Upload MOL/SDF File</label>
        <input type="file" id="file" name="file" accept=".mol,.sdf">
        <small class="field-help">Upload a .mol or .sdf file (single molecule)</small>
    </div>
</fieldset>
```

For Calculation Settings fieldset - add required indicators:
```html
<fieldset class="form-group">
    <legend>Calculation Settings</legend>

    <div class="form-group__field">
        <label for="solvent">
            Solvent
            <span class="required-indicator" aria-hidden="true">*</span>
        </label>
        <select id="solvent" name="solvent" required aria-required="true">
            <!-- existing options -->
        </select>
    </div>

    <div class="form-group__field">
        <label for="preset">Calculation Preset</label>
        <select id="preset" name="preset">
            <!-- existing options -->
        </select>
    </div>
</fieldset>
```

For Conformer Mode fieldset - add required indicator and field-help:
```html
<fieldset class="form-group">
    <legend>Conformer Settings</legend>

    <div class="form-group__field">
        <label for="conformer_mode">
            Calculation Mode
            <span class="required-indicator" aria-hidden="true">*</span>
        </label>
        <select id="conformer_mode" name="conformer_mode" required aria-required="true">
            <!-- existing options -->
        </select>
        <small class="field-help">Ensemble mode generates multiple conformers for more accurate predictions on flexible molecules.</small>
    </div>

    <div class="form-group__field">
        <label for="conformer_method">Conformer Method</label>
        <select id="conformer_method" name="conformer_method">
            <!-- existing options -->
        </select>
        <small class="field-help">RDKit is fast and always available. CREST provides better sampling for complex molecules.</small>
    </div>
</fieldset>
```

Move Advanced Options INSIDE the Conformer Settings fieldset (not nested fieldset):
```html
<details>
    <summary>Advanced Options</summary>
    <div class="form-group__field">
        <label for="max_conformers">Max Conformers (optional)</label>
        <input type="number" id="max_conformers" name="max_conformers"
               value="{{ form_data.get('max_conformers', '') }}"
               min="1" max="500" placeholder="Auto (based on flexibility)">
        <small class="field-help">Leave empty for automatic selection based on molecular flexibility.</small>
    </div>
</details>
```

For Optional Details fieldset:
```html
<fieldset class="form-group">
    <legend>Optional Details</legend>

    <div class="form-group__field">
        <label for="name">Molecule Name</label>
        <input type="text" id="name" name="name" placeholder="e.g., Caffeine" value="{{ form_data.name or '' }}">
    </div>

    <div class="form-group__field">
        <label for="notification_email">Email Notification</label>
        <input type="email" id="notification_email" name="notification_email" placeholder="your@email.com" value="{{ form_data.notification_email or '' }}">
        <small class="field-help">Leave blank if you don't want email notification</small>
    </div>
</fieldset>
```

**5. Add submit button with class:**
```html
<button type="submit" class="submit-form__button">Calculate NMR</button>
```

**6. Add preview card in right column:**
```html
<div class="submit-layout__preview">
    <div class="preview-card">
        <h3 class="preview-card__title">Molecule Preview</h3>
        <canvas id="molecule-preview" class="preview-card__canvas"></canvas>
        <p id="preview-status" class="preview-card__status preview-card__status--empty">
            Enter a SMILES string to preview
        </p>
    </div>
</div>
```

**7. Preserve error alert if present:**
```html
{% if error %}
<div role="alert" class="alert alert--error">{{ error }}</div>
{% endif %}
```

Keep ALL existing Jinja2 template variables (form_data, solvents, presets, crest_available).
  </action>
  <verify>
- Template renders without Jinja2 errors (run Flask app)
- Form structure uses .submit-layout, .form-group, .preview-card classes
- Required fields have aria-required="true" attribute
- All existing form fields preserved (smiles, file, solvent, preset, conformer_mode, conformer_method, max_conformers, name, notification_email)
  </verify>
  <done>
Submit template restructured with two-column layout, proper fieldset grouping, required field indicators, field help text, and molecule preview area.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SmilesDrawer integration with debounced preview</name>
  <files>src/qm_nmr_calc/api/templates/submit.html</files>
  <action>
Add SmilesDrawer CDN and JavaScript for real-time molecule preview.

**1. Add SmilesDrawer CDN in scripts block:**
```jinja2
{% block scripts %}
<script src="https://unpkg.com/smiles-drawer@1.2.0/dist/smiles-drawer.min.js"></script>
<script>
// ... JavaScript code ...
</script>
{% endblock %}
```

**2. Add SmilesDrawer initialization and preview function:**
```javascript
document.addEventListener('DOMContentLoaded', function() {
    // SmilesDrawer configuration
    const smilesDrawer = new SmilesDrawer.Drawer({
        width: 350,
        height: 350,
        bondThickness: 0.6,
        bondLength: 15,
        terminalCarbons: true,
        explicitHydrogens: false,
        themes: {
            light: {
                C: '#222',
                O: '#e74c3c',
                N: '#3498db',
                S: '#f1c40f',
                P: '#e67e22',
                F: '#1abc9c',
                CL: '#1abc9c',
                BR: '#e74c3c',
                I: '#9b59b6',
                H: '#aaa'
            }
        }
    });

    const canvas = document.getElementById('molecule-preview');
    const status = document.getElementById('preview-status');
    const smilesInput = document.getElementById('smiles');
    const fileInput = document.getElementById('file');

    // Handle canvas sizing for retina displays
    function setupCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
    }

    // Update molecule preview
    function updateMoleculePreview(smiles) {
        setupCanvas();

        if (!smiles || smiles.trim() === '') {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            status.textContent = 'Enter a SMILES string to preview';
            status.className = 'preview-card__status preview-card__status--empty';
            return;
        }

        SmilesDrawer.parse(smiles, function(tree) {
            // Valid SMILES - draw molecule
            smilesDrawer.draw(tree, 'molecule-preview', 'light', false);
            status.textContent = 'Valid SMILES';
            status.className = 'preview-card__status preview-card__status--valid';
        }, function(err) {
            // Invalid SMILES - show error
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            status.textContent = 'Invalid SMILES syntax';
            status.className = 'preview-card__status preview-card__status--invalid';
        });
    }

    // Debounce function
    let debounceTimer;
    function debounce(func, delay) {
        return function(...args) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Debounced preview update (400ms delay)
    const debouncedPreview = debounce(function(value) {
        updateMoleculePreview(value);
    }, 400);

    // EXISTING: Input mutual exclusion (preserve this functionality)
    function updateInputStates() {
        const smilesHasValue = smilesInput.value.trim().length > 0;
        const fileHasValue = fileInput.files && fileInput.files.length > 0;

        if (smilesHasValue) {
            fileInput.disabled = true;
            fileInput.style.opacity = '0.5';
        } else if (fileHasValue) {
            smilesInput.disabled = true;
            smilesInput.style.opacity = '0.5';
            // Clear preview when file selected
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            status.textContent = 'File selected (no preview available)';
            status.className = 'preview-card__status preview-card__status--empty';
        } else {
            smilesInput.disabled = false;
            fileInput.disabled = false;
            smilesInput.style.opacity = '1';
            fileInput.style.opacity = '1';
        }
    }

    // SMILES input handler - debounced preview + mutual exclusion
    smilesInput.addEventListener('input', function() {
        if (this.value.trim().length > 0) {
            fileInput.value = '';
        }
        updateInputStates();
        debouncedPreview(this.value);
    });

    // File input handler
    fileInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
            smilesInput.value = '';
        }
        updateInputStates();
    });

    // EXISTING: Conformer mode/method interaction (preserve this functionality)
    const modeSelect = document.getElementById('conformer_mode');
    const methodSelect = document.getElementById('conformer_method');

    function updateMethodState() {
        if (modeSelect.value === 'single') {
            methodSelect.disabled = true;
            methodSelect.value = 'rdkit_kdg';
            methodSelect.style.opacity = '0.5';
        } else {
            const crestOption = methodSelect.querySelector('option[value="crest"]');
            if (crestOption && !crestOption.disabled) {
                methodSelect.disabled = false;
            } else if (methodSelect.value === 'rdkit_kdg') {
                methodSelect.disabled = false;
            }
            methodSelect.style.opacity = '1';
        }
    }

    modeSelect.addEventListener('change', updateMethodState);

    // Initialize on page load
    setupCanvas();
    updateInputStates();
    updateMethodState();

    // Re-render preview if SMILES pre-filled (form resubmission)
    if (smilesInput.value.trim()) {
        updateMoleculePreview(smilesInput.value);
    }
});
```

**Key behaviors:**
- SmilesDrawer draws 2D molecule structure on canvas
- 400ms debounce prevents lag during typing
- devicePixelRatio handling for retina displays
- Status text shows: "Enter a SMILES..." (empty), "Valid SMILES" (success), "Invalid SMILES syntax" (error)
- File selection clears SMILES and shows "File selected (no preview available)"
- Pre-filled SMILES (from form resubmission) triggers preview on load
  </action>
  <verify>
- SmilesDrawer CDN loads (check network tab in browser)
- Typing valid SMILES (e.g., "CCO") shows molecule after 400ms
- Typing invalid SMILES shows "Invalid SMILES syntax" error
- Empty input shows "Enter a SMILES string to preview"
- File selection disables SMILES input and updates status
- Existing conformer mode/method interaction still works
  </verify>
  <done>
SmilesDrawer integration complete with real-time debounced preview, retina support, and preserved input mutual exclusion behavior.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Submit page redesign with two-column layout, molecule preview, and improved form organization</what-built>
  <how-to-verify>
1. Start the Flask app: `cd /home/chris/develop/qm-nmr-calc && python -m flask --app src.qm_nmr_calc.api.app run`
2. Open http://localhost:5000/ in browser
3. Verify layout:
   - Form on left, molecule preview on right (desktop)
   - Fieldsets have clear borders and legends
   - Required fields show red asterisk
   - Help text appears below relevant fields

4. Test molecule preview:
   - Type "CCO" in SMILES field - should show ethanol molecule after brief delay
   - Type "invalid" - should show "Invalid SMILES syntax" error
   - Clear input - should show "Enter a SMILES string to preview"

5. Test input mutual exclusion:
   - Enter SMILES - file input should become disabled
   - Select file - SMILES input should become disabled and clear

6. Test conformer settings:
   - Select "Single conformer" - method dropdown should become disabled
   - Select "Ensemble" - method dropdown should re-enable

7. Resize browser to mobile width (<900px):
   - Should collapse to single column
   - Preview should appear above form

8. Submit a test calculation to verify form still works
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Template renders without errors
2. Two-column layout works on desktop, collapses on mobile
3. SmilesDrawer loads and renders molecules
4. Debounce prevents lag during SMILES typing
5. Required field indicators present and accessible
6. All existing form functionality preserved
7. Form submission still works correctly
</verification>

<success_criteria>
- [ ] submit.html uses submit-page.css via page_css block
- [ ] Two-column layout with .submit-layout class
- [ ] All fieldsets use .form-group class
- [ ] Required fields have asterisk + required + aria-required
- [ ] SmilesDrawer CDN loaded
- [ ] Molecule preview updates with debounced SMILES input
- [ ] Invalid SMILES shows error state
- [ ] File selection shows "no preview available" state
- [ ] Conformer mode/method interaction preserved
- [ ] Mobile responsive (single column under 900px)
- [ ] Visual verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/20-submit-redesign/20-02-SUMMARY.md`
</output>
