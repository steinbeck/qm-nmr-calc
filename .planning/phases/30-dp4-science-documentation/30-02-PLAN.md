---
phase: 30-dp4-science-documentation
plan: 02
type: execute
wave: 2
depends_on:
  - 30-01
files_modified:
  - docs/science.md
autonomous: true

must_haves:
  truths:
    - "Reader can derive and understand the linear scaling formula"
    - "Reader understands how DELTA50 scaling factors were determined"
    - "Reader can derive Boltzmann weighting equation from statistical mechanics"
    - "Reader knows expected accuracy (MAE) and method limitations"
    - "Reader has access to complete literature citations with DOIs"
  artifacts:
    - path: "docs/science.md"
      provides: "Linear scaling methodology with derivation"
      contains: "## Linear Scaling Methodology"
    - path: "docs/science.md"
      provides: "DELTA50 benchmark documentation"
      contains: "## DELTA50 Benchmark"
    - path: "docs/science.md"
      provides: "Boltzmann weighting derivation"
      contains: "## Boltzmann Weighting"
    - path: "docs/science.md"
      provides: "Conformational sampling explanation"
      contains: "## Conformational Sampling"
    - path: "docs/science.md"
      provides: "Accuracy and limitations"
      contains: "## Expected Accuracy"
    - path: "docs/science.md"
      provides: "Literature references"
      contains: "## References"
  key_links:
    - from: "docs/science.md"
      to: "src/qm_nmr_calc/shifts.py"
      via: "Linear scaling implementation"
      pattern: "shifts\\.py"
    - from: "docs/science.md"
      to: "src/qm_nmr_calc/conformers/boltzmann.py"
      via: "Boltzmann implementation"
      pattern: "boltzmann\\.py"
    - from: "docs/science.md"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "Scaling factor values"
      pattern: "scaling_factors\\.json"
---

<objective>
Complete the DP4+ science documentation with linear scaling derivation, DELTA50 benchmark, Boltzmann weighting, conformational sampling, accuracy metrics, and full literature references.

Purpose: Provide the complete scientific methodology with mathematical derivations, enabling researchers to understand exactly how predictions are computed and to reproduce the approach. References enable readers to trace methodology to primary literature.

Output: Complete docs/science.md with all remaining sections: Linear Scaling, DELTA50, Boltzmann, Conformational Sampling, Accuracy, and References.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-dp4-science-documentation/30-RESEARCH.md
@.planning/phases/30-dp4-science-documentation/30-01-SUMMARY.md
@docs/science.md
@src/qm_nmr_calc/shifts.py
@src/qm_nmr_calc/conformers/boltzmann.py
@src/qm_nmr_calc/data/scaling_factors.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Linear Scaling and DELTA50 Benchmark sections</name>
  <files>docs/science.md</files>
  <action>
Continue docs/science.md with the linear scaling methodology and DELTA50 benchmark sections.

**Linear Scaling Methodology section (DP4-04):**

1. **The reference compound problem:**
   - Traditional approach: delta = sigma_ref - sigma_sample (TMS reference)
   - Problems: TMS shielding varies with method/basis/solvent
   - Systematic errors in DFT calculations accumulate

2. **Empirical regression approach:**
   - Instead of single reference, fit linear regression across many compounds
   - Use benchmark dataset with known experimental shifts
   - Derive method-specific scaling factors

3. **Full derivation:**
   - Given: calculated shielding sigma_calc, experimental shift delta_exp
   - Relationship: delta_calc = m * sigma_calc + b
   - Solve for m (slope) and b (intercept) by minimizing:

   $$\chi^2 = \sum_i \left(\delta_{exp,i} - (m \cdot \sigma_{calc,i} + b)\right)^2$$

   - Normal equations solution:

   $$m = \frac{n\sum(\sigma \cdot \delta) - \sum\sigma \sum\delta}{n\sum\sigma^2 - (\sum\sigma)^2}$$

   $$b = \frac{\sum\delta - m\sum\sigma}{n}$$

4. **Physical interpretation:**
   - Slope near -1.0: DFT reasonably accurate
   - Deviations from -1.0: systematic over/underestimation
   - Intercept: offset from TMS reference point
   - Example from project: 1H slope = -0.937, indicating ~6% systematic correction

5. **Implementation link:**
   - Reference [`shifts.py`](../src/qm_nmr_calc/shifts.py) showing: `shift = slope * shielding + intercept`

**DELTA50 Benchmark section (DP4-05):**

1. **Dataset description:**
   - 50 organic molecules with diverse functional groups
   - Known experimental 1H and 13C shifts in CHCl3/DMSO
   - From Grimblat et al. 2023 (DOI: 10.3390/molecules28062449)
   - Total data points: ~335 (1H), ~219 (13C)

2. **How scaling factors were derived:**
   - DFT calculations: B3LYP/6-311+G(2d,p) with COSMO solvation
   - Linear regression between calculated shielding and experimental shifts
   - Outlier removal: 3-sigma criterion (7 removed for 1H, 2 for 13C)

3. **Project's scaling factor values table:**

| Parameter | 1H (CHCl3) | 13C (CHCl3) | 1H (DMSO) | 13C (DMSO) | 1H (vacuum) | 13C (vacuum) |
|-----------|------------|-------------|-----------|------------|-------------|--------------|
| Slope | -0.9375 | -0.9497 | -0.9323 | -0.9429 | -0.9554 | -0.9726 |
| Intercept | 29.92 | 172.69 | 29.73 | 171.77 | 30.54 | 175.71 |
| R^2 | 0.9952 | 0.9978 | 0.9951 | 0.9974 | 0.9934 | 0.9980 |
| MAE | 0.12 ppm | 1.95 ppm | 0.13 ppm | 2.15 ppm | 0.15 ppm | 1.74 ppm |
| RMSD | 0.16 ppm | 2.69 ppm | 0.17 ppm | 2.92 ppm | 0.19 ppm | 2.56 ppm |

4. **Source reference:**
   - Link to [`scaling_factors.json`](../src/qm_nmr_calc/data/scaling_factors.json)
   - Citation: Grimblat et al. Molecules 2023 for DELTA50 dataset
  </action>
  <verify>
grep -c "## Linear Scaling Methodology" docs/science.md returns 1
grep -c "chi\\^2" docs/science.md returns 1 (chi-squared equation)
grep -c "## DELTA50 Benchmark" docs/science.md returns 1
grep -c "0.9375" docs/science.md returns >= 1 (slope value from project)
grep -c "10.3390/molecules28062449" docs/science.md returns 1 (DELTA50 citation)
grep -c "shifts.py" docs/science.md returns >= 1 (implementation link)
  </verify>
  <done>
docs/science.md contains Linear Scaling Methodology section with full mathematical derivation and physical interpretation. DELTA50 Benchmark section includes dataset description, derivation method, and complete scaling factor table with actual project values.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Boltzmann Weighting and Conformational Sampling sections</name>
  <files>docs/science.md</files>
  <action>
Continue docs/science.md with Boltzmann weighting and conformational sampling sections.

**Boltzmann Weighting section (DP4-06):**

1. **Statistical mechanics basis:**
   - Conformers in thermal equilibrium
   - Population governed by Boltzmann distribution
   - Lower energy conformers more populated

2. **Mathematical derivation:**
   - Canonical partition function:

   $$Z = \sum_i e^{-E_i/RT}$$

   - Probability of conformer i:

   $$p_i = \frac{e^{-E_i/RT}}{Z} = \frac{e^{-E_i/RT}}{\sum_j e^{-E_j/RT}}$$

   Where:
   - R = 0.001987 kcal/(molÂ·K) (gas constant)
   - T = temperature in Kelvin (default: 298.15 K)
   - E_i = conformer energy

3. **Exp-normalize trick for numerical stability:**
   - Problem: exp(-E/RT) can overflow/underflow for large energy differences
   - Solution: subtract minimum energy first

   $$p_i = \frac{e^{-(E_i - E_{min})/RT}}{\sum_j e^{-(E_j - E_{min})/RT}}$$

   - All exponent arguments now <= 0, no overflow risk

4. **Application to NMR shifts:**
   - Population-weighted average:

   $$\delta_{avg} = \sum_i p_i \cdot \delta_i$$

   - Applied independently to 1H and 13C shifts
   - Each atom's shift averaged across conformers

5. **Temperature dependence:**
   - Higher T: flatter distribution, more conformers contribute
   - Lower T: lowest energy conformer dominates
   - 298.15 K matches typical NMR experimental conditions

6. **Implementation link:**
   - Reference [`boltzmann.py`](../src/qm_nmr_calc/conformers/boltzmann.py)
   - Show key code snippet:
   ```python
   def calculate_boltzmann_weights(energies, temperature_k=298.15):
       rt = R_KCAL * temperature_k
       min_energy = min(energies)
       relative_energies = [e - min_energy for e in energies]
       unnormalized = [math.exp(-e_rel / rt) for e_rel in relative_energies]
       return [w / sum(unnormalized) for w in unnormalized]
   ```

**Conformational Sampling section (DP4-07):**

1. **Why conformers matter for NMR:**
   - Flexible molecules exist as ensemble of conformers
   - Each conformer has different geometry -> different shifts
   - Experimental NMR measures time-averaged spectrum
   - Single-conformer calculation may miss important conformers

2. **Energy window filtering:**
   - Pre-DFT filter: 6 kcal/mol (MMFF energies)
   - Post-DFT filter: 3 kcal/mol (DFT energies)
   - Rationale: conformers >3 kcal/mol have <1% population at 298 K

3. **RDKit vs CREST methods:**

| Feature | RDKit ETKDGv3 | CREST (GFN2-xTB) |
|---------|---------------|------------------|
| Speed | Fast (seconds) | Slower (minutes-hours) |
| Sampling | Distance geometry | Metadynamics |
| Quality | Good for rigid molecules | Best for flexible molecules |
| Solvation | None | ALPB implicit |
| When to use | <3 rotatable bonds | >3 rotatable bonds |

4. **Literature references:**
   - CREST: Pracht et al. PCCP 2020 (DOI: 10.1039/C9CP06869D)
   - Why thorough sampling matters: DP4+ accuracy depends on including all relevant conformers
  </action>
  <verify>
grep -c "## Boltzmann Weighting" docs/science.md returns 1
grep -c "partition function" docs/science.md returns >= 1
grep -c "e\\^{-E" docs/science.md returns >= 2 (Boltzmann equations)
grep -c "## Conformational Sampling" docs/science.md returns 1
grep -c "CREST" docs/science.md returns >= 3
grep -c "10.1039/C9CP06869D" docs/science.md returns 1 (CREST citation)
grep -c "boltzmann.py" docs/science.md returns >= 1 (implementation link)
  </verify>
  <done>
docs/science.md contains Boltzmann Weighting section with full statistical mechanics derivation, exp-normalize trick explanation, and implementation code snippet. Conformational Sampling section explains why conformers matter, energy filtering, and compares RDKit vs CREST methods with literature citations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Write Accuracy, Limitations, and References sections</name>
  <files>docs/science.md</files>
  <action>
Complete docs/science.md with accuracy metrics, limitations, and comprehensive references.

**Expected Accuracy and Limitations section (DP4-09):**

1. **Typical MAE values from project:**
   - 1H in CHCl3: 0.12 ppm (excellent)
   - 13C in CHCl3: 1.95 ppm (good)
   - 1H in DMSO: 0.13 ppm (excellent)
   - 13C in DMSO: 2.15 ppm (good)
   - Compare to literature: ISiCLE reports ~0.2 ppm (1H), ~2.5 ppm (13C)

2. **Factors affecting accuracy:**
   - Conformer sampling quality (most important for flexible molecules)
   - Basis set adequacy (6-311+G(2d,p) is well-validated)
   - Solvent model match to experiment
   - Heavy atom effects (not included in standard calculations)
   - Relativistic effects (negligible for H/C but important for heavier nuclei)

3. **Known problem cases:**
   - Highly strained ring systems
   - Strong intramolecular hydrogen bonds
   - Aromatic systems with unusual ring currents
   - Anisole (compound_48 outlier in DELTA50)
   - Molecules with significant charge separation

4. **When predictions may fail:**
   - Molecules requiring explicit solvent (protic solvents, H-bonding)
   - Dynamic systems (fast exchange, tautomerism)
   - Paramagnetic systems
   - Very large molecules (>50 heavy atoms) due to basis set limitations

5. **Interpreting results:**
   - 1H predictions reliable to ~0.2 ppm
   - 13C predictions reliable to ~3 ppm
   - Use for assignment assistance, not absolute structure proof
   - Multiple conformers: ensure adequate sampling

**References section (DP4-08):**

Create numbered reference list with full citations and DOIs:

1. **DP4 Original Method:**
   Smith, S. G.; Goodman, J. M. "Assigning Stereochemistry to Single Diastereoisomers by GIAO NMR Calculation: The DP4 Probability."
   *J. Am. Chem. Soc.* **2010**, 132, 12946-12959.
   DOI: [10.1021/ja105035r](https://doi.org/10.1021/ja105035r)

2. **DP4+ Enhancement:**
   Grimblat, N.; Zanardi, M. M.; Sarotti, A. M. "Beyond DP4: an Improved Probability for the Stereochemical Assignment of Isomeric Compounds using Quantum Chemical Calculations of NMR Shifts."
   *J. Org. Chem.* **2015**, 80, 12526-12534.
   DOI: [10.1021/acs.joc.5b02396](https://doi.org/10.1021/acs.joc.5b02396)

3. **DELTA50 Benchmark:**
   Grimblat, N.; Gavin, J. A.; Hernandez Daranas, A.; Sarotti, A. M. "Scaling Factor Databases for Quantum Chemical Calculations: Focus on Solvent Mixtures and Unusual Nuclei."
   *Molecules* **2023**, 28, 2449.
   DOI: [10.3390/molecules28062449](https://doi.org/10.3390/molecules28062449)

4. **ISiCLE NMR Framework:**
   Colby, S. M.; et al. "ISiCLE: A Quantum Chemistry Pipeline for Establishing in Silico Collision Cross Section Libraries."
   *J. Cheminform.* **2019**, 11, 65.
   DOI: [10.1186/s13321-018-0305-8](https://doi.org/10.1186/s13321-018-0305-8)

5. **CREST Conformer Search:**
   Pracht, P.; Bohle, F.; Grimme, S. "Automated exploration of the low-energy chemical space with fast quantum chemical methods."
   *Phys. Chem. Chem. Phys.* **2020**, 22, 7169-7192.
   DOI: [10.1039/C9CP06869D](https://doi.org/10.1039/C9CP06869D)

6. **GIAO Method:**
   Wolinski, K.; Hinton, J. F.; Pulay, P. "Efficient Implementation of the Gauge-Independent Atomic Orbital Method for NMR Chemical Shift Calculations."
   *J. Am. Chem. Soc.* **1990**, 112, 8251-8260.
   DOI: [10.1021/ja00179a005](https://doi.org/10.1021/ja00179a005)

7. **COSMO Solvation:**
   Klamt, A.; Schuurmann, G. "COSMO: a new approach to dielectric screening in solvents with explicit expressions for the screening energy and its gradient."
   *J. Chem. Soc., Perkin Trans. 2* **1993**, 799-805.
   DOI: [10.1039/P29930000799](https://doi.org/10.1039/P29930000799)

8. **B3LYP Functional:**
   Becke, A. D. "Density-functional thermochemistry. III. The role of exact exchange."
   *J. Chem. Phys.* **1993**, 98, 5648-5652.
   DOI: [10.1063/1.464913](https://doi.org/10.1063/1.464913)

9. **NMR Scaling Factors:**
   Pierens, G. K. "1H and 13C NMR Scaling Factors for the Calculation of Chemical Shifts in Commonly Used Solvents Using Density Functional Theory."
   *J. Comput. Chem.* **2014**, 35, 1388-1394.
   DOI: [10.1002/jcc.23638](https://doi.org/10.1002/jcc.23638)

**Add footer with document metadata:**
- Last updated date
- Link back to main documentation
  </action>
  <verify>
grep -c "## Expected Accuracy" docs/science.md returns 1
grep -c "0.12 ppm" docs/science.md returns >= 1 (1H MAE)
grep -c "## References" docs/science.md returns 1
grep -c "10.1021/ja105035r" docs/science.md returns 1 (DP4 citation)
grep -c "10.1021/acs.joc.5b02396" docs/science.md returns 1 (DP4+ citation)
grep -c "10.1186/s13321-018-0305-8" docs/science.md returns 1 (ISiCLE citation)
grep -c "10.1063/1.464913" docs/science.md returns 1 (B3LYP citation)
wc -l docs/science.md shows >400 lines (comprehensive document)
  </verify>
  <done>
docs/science.md complete with Expected Accuracy section documenting MAE values, factors affecting accuracy, known limitations, and when predictions may fail. References section contains all 9 required literature citations with full bibliographic data and DOIs (ISiCLE, DELTA50, CREST, Grimblat, Goodman, GIAO, COSMO, B3LYP, Pierens).
  </done>
</task>

</tasks>

<verification>
1. All 9 DP4 requirements covered:
   - DP4-01: NMR fundamentals (from Plan 01)
   - DP4-02: DFT theory (from Plan 01)
   - DP4-03: COSMO solvation (from Plan 01)
   - DP4-04: Linear scaling derivation (Task 1)
   - DP4-05: DELTA50 benchmark (Task 1)
   - DP4-06: Boltzmann weighting (Task 2)
   - DP4-07: Conformational sampling (Task 2)
   - DP4-08: Literature citations (Task 3)
   - DP4-09: Expected accuracy (Task 3)
2. Mathematical equations render with MathJax
3. All literature citations have DOIs
4. Implementation links to source code present
5. Document is comprehensive (>400 lines) and self-contained
</verification>

<success_criteria>
- docs/science.md contains all sections: Linear Scaling, DELTA50, Boltzmann, Conformational Sampling, Accuracy, References
- Requirements DP4-04 through DP4-09 addressed
- All 9 primary literature citations included with DOIs
- Actual scaling factor values from project included in tables
- Implementation links connect theory to code
- Document suitable for both academic researchers and developers
</success_criteria>

<output>
After completion, create `.planning/phases/30-dp4-science-documentation/30-02-SUMMARY.md`
</output>
