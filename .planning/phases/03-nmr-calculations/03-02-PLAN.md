---
phase: 03-nmr-calculations
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/qm_nmr_calc/models.py
  - src/qm_nmr_calc/api/schemas.py
autonomous: true

must_haves:
  truths:
    - "JobInput includes preset and solvent fields"
    - "JobStatus includes NMR results when calculation completes"
    - "API schemas expose preset/solvent in request and NMR shifts in response"
  artifacts:
    - path: "src/qm_nmr_calc/models.py"
      provides: "Extended models with AtomShift, NMRResults, preset/solvent/nmr_results fields"
      contains: "class AtomShift"
    - path: "src/qm_nmr_calc/api/schemas.py"
      provides: "Extended API schemas with preset/solvent/shifts"
      contains: "AtomShiftResponse"
  key_links:
    - from: "src/qm_nmr_calc/models.py"
      to: "src/qm_nmr_calc/presets.py"
      via: "JobInput.preset uses PresetName Literal values"
      pattern: "Literal.*draft.*production"
    - from: "src/qm_nmr_calc/api/schemas.py"
      to: "src/qm_nmr_calc/solvents.py"
      via: "JobSubmitRequest references supported solvents"
      pattern: "solvent.*Field"
---

<objective>
Extend the data models and API schemas to support NMR calculation parameters (preset, solvent) and results (1H/13C chemical shifts).

Purpose: The models define the data structures stored on disk and returned by the API. This plan adds preset/solvent to job input and NMR results to job output, enabling the calculation pipeline to store and return NMR data.

Output: Extended models.py with NMR result models, extended schemas.py with API request/response fields for NMR calculations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-nmr-calculations/03-CONTEXT.md
@.planning/phases/03-nmr-calculations/03-RESEARCH.md
@.planning/phases/03-nmr-calculations/03-01-SUMMARY.md
@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NMR result models to models.py</name>
  <files>src/qm_nmr_calc/models.py</files>
  <action>
Extend models.py with new Pydantic models for NMR results:

1. Add AtomShift model:
   - index: int (NWChem 1-based atom index)
   - atom: str (element symbol: 'H' or 'C')
   - shielding: float (raw isotropic shielding in ppm)
   - shift: float (chemical shift relative to TMS in ppm)

2. Add NMRResults model:
   - h1_shifts: list[AtomShift] (1H chemical shifts, sorted by shift descending)
   - c13_shifts: list[AtomShift] (13C chemical shifts, sorted by shift descending)
   - functional: str (DFT functional used)
   - basis_set: str (basis set used for NMR)
   - solvent: str (COSMO solvent used)

3. Extend JobInput model - add new fields (keep existing smiles, name):
   - preset: Literal["draft", "production"] = "production"
   - solvent: str (required field - no default, user must specify)

4. Extend JobStatus model - add new field:
   - nmr_results: Optional[NMRResults] = None (populated on completion)
   - optimized_geometry_file: Optional[str] = None (path to XYZ file)

Use Pydantic BaseModel with ConfigDict as existing pattern. Import Literal from typing.
  </action>
  <verify>python -c "from qm_nmr_calc.models import AtomShift, NMRResults, JobInput, JobStatus; ji = JobInput(smiles='CCO', solvent='chcl3'); print(ji.preset, ji.solvent)"</verify>
  <done>AtomShift and NMRResults models exist, JobInput has preset/solvent fields with correct defaults, JobStatus has nmr_results optional field</done>
</task>

<task type="auto">
  <name>Task 2: Extend API schemas for NMR</name>
  <files>src/qm_nmr_calc/api/schemas.py</files>
  <action>
Extend schemas.py with API request/response models for NMR:

1. Extend JobSubmitRequest - add new fields:
   - preset: Literal["draft", "production"] = Field(default="production", description="Calculation preset: draft (fast) or production (accurate)")
   - solvent: str = Field(..., description="NMR solvent for COSMO solvation model (e.g., chcl3, dmso)", examples=["chcl3", "dmso", "acetone"])

2. Add AtomShiftResponse model (API-friendly version of AtomShift):
   - index: int = Field(..., description="Atom index (1-based)")
   - atom: str = Field(..., description="Element symbol (H or C)")
   - shift: float = Field(..., description="Chemical shift in ppm (TMS reference)")

3. Add NMRResultsResponse model:
   - h1_shifts: list[AtomShiftResponse] = Field(..., description="1H chemical shifts sorted by ppm descending")
   - c13_shifts: list[AtomShiftResponse] = Field(..., description="13C chemical shifts sorted by ppm descending")
   - functional: str = Field(..., description="DFT functional used")
   - basis_set: str = Field(..., description="Basis set used for NMR calculation")
   - solvent: str = Field(..., description="Solvent used for COSMO solvation")

4. Extend JobStatusResponse - add new fields:
   - preset: str = Field(..., description="Calculation preset used")
   - solvent: str = Field(..., description="Solvent used for calculation")
   - nmr_results: Optional[NMRResultsResponse] = Field(None, description="NMR results (available when status is complete)")

Note: API response models are separate from internal models for flexibility. The router will convert between them.
  </action>
  <verify>python -c "from qm_nmr_calc.api.schemas import JobSubmitRequest, AtomShiftResponse, NMRResultsResponse, JobStatusResponse; req = JobSubmitRequest(smiles='CCO', solvent='chcl3'); print(req.preset, req.solvent)"</verify>
  <done>JobSubmitRequest has preset/solvent fields, NMR response models exist, JobStatusResponse includes NMR results field</done>
</task>

<task type="auto">
  <name>Task 3: Update jobs router conversion function</name>
  <files>src/qm_nmr_calc/api/routers/jobs.py</files>
  <action>
Update job_status_to_response() function in jobs.py to include new NMR fields:

1. Add to the returned dict:
   - "preset": job_status.input.preset
   - "solvent": job_status.input.solvent

2. Add nmr_results conversion:
   - If job_status.nmr_results is not None:
     - Convert each AtomShift to dict with index, atom, shift (omit shielding for API response)
     - Build nmr_results dict with h1_shifts, c13_shifts, functional, basis_set, solvent
   - Else: nmr_results = None

Do NOT change the endpoint implementations yet - that's in Plan 03. Only update the conversion function to handle the new fields when they exist.

The existing tests should still pass since the new fields have defaults or are optional.
  </action>
  <verify>cd /home/christoph_steinbeck_gmail_com/develop/qm-nmr-calc && python -m pytest tests/test_api.py -v --tb=short 2>&1 | tail -20</verify>
  <done>job_status_to_response includes preset, solvent, and nmr_results fields; existing tests still pass</done>
</task>

</tasks>

<verification>
Model imports and API tests pass:
```bash
python -c "
from qm_nmr_calc.models import AtomShift, NMRResults, JobInput, JobStatus
from qm_nmr_calc.api.schemas import JobSubmitRequest, AtomShiftResponse, NMRResultsResponse, JobStatusResponse

# Test JobInput with new fields
ji = JobInput(smiles='CCO', solvent='chcl3')
assert ji.preset == 'production'
assert ji.solvent == 'chcl3'

# Test NMRResults structure
shift = AtomShift(index=1, atom='H', shielding=29.0, shift=2.8)
results = NMRResults(
    h1_shifts=[shift],
    c13_shifts=[],
    functional='b3lyp',
    basis_set='6-311+G(2d,p)',
    solvent='chcl3'
)
assert len(results.h1_shifts) == 1

# Test API schemas
req = JobSubmitRequest(smiles='CCO', solvent='chcl3')
assert req.preset == 'production'

print('All model verifications passed')
"

# Run existing tests to ensure backward compatibility
cd /home/christoph_steinbeck_gmail_com/develop/qm-nmr-calc && python -m pytest tests/test_api.py -v
```
</verification>

<success_criteria>
- AtomShift and NMRResults models defined in models.py
- JobInput has preset (default: production) and solvent (required) fields
- JobStatus has optional nmr_results and optimized_geometry_file fields
- API schemas match internal models with appropriate Field descriptions
- Existing API tests pass (backward compatibility maintained)
</success_criteria>

<output>
After completion, create `.planning/phases/03-nmr-calculations/03-02-SUMMARY.md`
</output>
