---
phase: 41-arm64-dockerfile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - env-worker-arm64.yaml
  - Dockerfile.worker.arm64
  - scripts/validate-worker-arm64.sh
autonomous: true

must_haves:
  truths:
    - "Dockerfile.worker.arm64 exists with micromamba base image"
    - "Environment file defines NWChem, xTB, CREST, RDKit from conda-forge"
    - "Validation script checks all required binaries and environment variables"
    - "All Python dependencies from pyproject.toml are installable"
  artifacts:
    - path: "Dockerfile.worker.arm64"
      provides: "ARM64 worker container definition"
      contains: "mambaorg/micromamba"
    - path: "env-worker-arm64.yaml"
      provides: "Conda environment specification"
      contains: "nwchem"
    - path: "scripts/validate-worker-arm64.sh"
      provides: "ARM64 container validation"
      contains: "aarch64"
  key_links:
    - from: "Dockerfile.worker.arm64"
      to: "env-worker-arm64.yaml"
      via: "COPY and micromamba install"
      pattern: "COPY.*env-worker-arm64.yaml"
    - from: "Dockerfile.worker.arm64"
      to: "scripts/validate-worker-arm64.sh"
      via: "COPY for validation"
      pattern: "COPY.*validate-worker-arm64.sh"
---

<objective>
Create ARM64 Dockerfile and supporting files for the worker container using conda-forge packages.

Purpose: Enable native ARM64 execution for Apple Silicon Macs and ARM cloud instances (AWS Graviton) without QEMU emulation.

Output:
- `env-worker-arm64.yaml` - Conda environment with NWChem, xTB, CREST, RDKit
- `Dockerfile.worker.arm64` - Multi-stage build using micromamba base
- `scripts/validate-worker-arm64.sh` - Verification script for ARM64 environment
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-arm64-dockerfile/41-RESEARCH.md

# Existing files to reference for patterns
@Dockerfile.worker
@scripts/validate-worker.sh
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conda environment file</name>
  <files>env-worker-arm64.yaml</files>
  <action>
Create `env-worker-arm64.yaml` in project root with conda-forge packages for ARM64.

Required packages from conda-forge:
- python=3.11
- nwchem=7.3.1
- xtb=6.7.1
- crest=3.0.2
- rdkit>=2025.9
- xorg-libxrender (X11 for RDKit drawing)
- xorg-libxext (X11 for RDKit drawing)
- pip (for remaining dependencies)

pip dependencies (from pyproject.toml):
- fastapi>=0.128.0
- huey>=2.6.0
- uvicorn>=0.40.0
- aiosmtplib>=5.0.0
- email-validator>=2.3.0
- jinja2>=3.1.0
- matplotlib>=3.10.0
- orjson>=3.11.5
- pandas>=2.3.3
- pydantic>=2.12.5
- python-multipart>=0.0.21
- scipy>=1.17.0
- statsmodels>=0.14.0
- tqdm>=4.67.1

NOTE: rdkit is installed from conda-forge (not pip) because conda handles the C++ dependencies correctly. Do NOT include rdkit in pip section.

Use `name: base` (not a custom env name) since micromamba activates base by default.
  </action>
  <verify>
`cat env-worker-arm64.yaml` shows valid YAML with:
- channels: [conda-forge]
- nwchem, xtb, crest, rdkit in conda dependencies
- pip dependencies matching pyproject.toml (minus rdkit)
  </verify>
  <done>env-worker-arm64.yaml exists with all required packages and valid YAML syntax</done>
</task>

<task type="auto">
  <name>Task 2: Create ARM64 Dockerfile</name>
  <files>Dockerfile.worker.arm64</files>
  <action>
Create `Dockerfile.worker.arm64` in project root using micromamba base image.

Structure:
1. FROM mambaorg/micromamba:2.5.0-debian12-slim
2. OCI labels (match existing Dockerfile.worker)
3. COPY env-worker-arm64.yaml and run micromamba install
4. ARG MAMBA_DOCKERFILE_ACTIVATE=1 (CRITICAL - enables pip/python in RUN commands)
5. Copy pyproject.toml, README.md, src/ and pip install .
6. Set environment variables:
   - OMP_STACKSIZE="2G" (prevent stack overflow on large molecules)
   - OMP_NUM_THREADS="4"
   - OPENBLAS_NUM_THREADS="4" (explicit for OpenBLAS threading)
   - GFORTRAN_UNBUFFERED_ALL="1"
   - NWCHEM_NPROC="4"
7. Create /app/data directory
8. Copy validation script
9. Set WORKDIR /app
10. CMD for huey_consumer

Key differences from x86 Dockerfile.worker:
- Uses micromamba base instead of NWChem base image
- All packages from conda-forge (no wget for binaries)
- NO manual NWCHEM_BASIS_LIBRARY or XTBPATH - conda activation scripts handle this
- COPY uses --chown=$MAMBA_USER:$MAMBA_USER for proper permissions
- No USER root needed (micromamba image handles this)
- No ENTRYPOINT reset needed

Do NOT set:
- NWCHEM_BASIS_LIBRARY (conda activation handles it)
- NWCHEM_TOP (not needed with conda package)
- XTBPATH (conda activation handles it)
- OMPI_ALLOW_RUN_AS_ROOT (micromamba runs as non-root user by default)
  </action>
  <verify>
`cat Dockerfile.worker.arm64` shows:
- Base image: mambaorg/micromamba:2.5.0-debian12-slim
- References env-worker-arm64.yaml
- ARG MAMBA_DOCKERFILE_ACTIVATE=1 present
- OMP_STACKSIZE, OMP_NUM_THREADS, OPENBLAS_NUM_THREADS environment variables set
- huey_consumer CMD
  </verify>
  <done>Dockerfile.worker.arm64 exists with micromamba base and conda-forge package installation</done>
</task>

<task type="auto">
  <name>Task 3: Create ARM64 validation script</name>
  <files>scripts/validate-worker-arm64.sh</files>
  <action>
Create `scripts/validate-worker-arm64.sh` to verify ARM64 container configuration.

Script should check:
1. Architecture is aarch64 (with warning if not, not failure - allows testing on x86)
2. NWChem binary exists in PATH
3. NWCHEM_BASIS_LIBRARY environment variable is set (by conda activation)
4. Basis library directory exists and contains files
5. xTB binary exists and responds to --version
6. CREST binary exists and responds to --version
7. Python exists and matches version
8. RDKit imports and can parse SMILES
9. qm_nmr_calc.queue.huey imports successfully
10. qm_nmr_calc.tasks.run_nmr_task imports successfully

Script behavior:
- Use `set -e` for fail-fast
- Print clear PASS/FAIL for each check
- Exit 0 on success, exit 1 on any failure
- Print warning (not error) if not running on aarch64

Reference existing `scripts/validate-worker.sh` for structure but adapt for:
- Architecture check at start
- NWCHEM_BASIS_LIBRARY check (x86 version hardcodes path)
- No OMPI environment variable checks (not needed for conda package)
  </action>
  <verify>
`bash -n scripts/validate-worker-arm64.sh` passes (valid syntax)
`head -20 scripts/validate-worker-arm64.sh` shows:
- #!/bin/bash shebang
- Architecture check for aarch64
- set -e directive
  </verify>
  <done>scripts/validate-worker-arm64.sh exists with architecture-aware validation checks</done>
</task>

</tasks>

<verification>
All files created and syntactically valid:

```bash
# Check files exist
ls -la env-worker-arm64.yaml Dockerfile.worker.arm64 scripts/validate-worker-arm64.sh

# Validate YAML syntax (python -c approach)
python3 -c "import yaml; yaml.safe_load(open('env-worker-arm64.yaml'))"

# Check Dockerfile has required content
grep -q "mambaorg/micromamba" Dockerfile.worker.arm64
grep -q "MAMBA_DOCKERFILE_ACTIVATE" Dockerfile.worker.arm64
grep -q "OMP_STACKSIZE" Dockerfile.worker.arm64

# Check validation script syntax
bash -n scripts/validate-worker-arm64.sh

# Check validation script is executable-ready
grep -q "aarch64" scripts/validate-worker-arm64.sh
```
</verification>

<success_criteria>
Phase 41 Plan 01 is complete when:
1. `env-worker-arm64.yaml` exists with nwchem, xtb, crest, rdkit from conda-forge
2. `Dockerfile.worker.arm64` uses mambaorg/micromamba base image
3. `Dockerfile.worker.arm64` includes MAMBA_DOCKERFILE_ACTIVATE=1 ARG
4. `Dockerfile.worker.arm64` sets OMP_STACKSIZE, OMP_NUM_THREADS, OPENBLAS_NUM_THREADS
5. `scripts/validate-worker-arm64.sh` includes aarch64 architecture check
6. All files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/41-arm64-dockerfile/41-01-SUMMARY.md`
</output>
