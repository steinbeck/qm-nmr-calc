---
phase: 10-scaling-factors
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/qm_nmr_calc/benchmark/analysis.py
  - src/qm_nmr_calc/benchmark/__main__.py
  - data/benchmark/delta50/SCALING-FACTORS.md
  - data/benchmark/delta50/plots/
autonomous: true

must_haves:
  truths:
    - "Regression scatter plots visualize shielding vs shift relationship"
    - "Residual plots show error distribution"
    - "SCALING-FACTORS.md contains publication-quality tables"
    - "CLI analyze command generates complete report"
  artifacts:
    - path: "data/benchmark/delta50/SCALING-FACTORS.md"
      provides: "Human-readable scaling factor report"
      min_lines: 50
    - path: "data/benchmark/delta50/plots/"
      provides: "Regression and residual PNG plots"
  key_links:
    - from: "__main__.py"
      to: "analysis.py"
      via: "derive_all_factors and plot functions"
      pattern: "derive_all_factors|generate_report"
---

<objective>
Generate publication-quality reports and plots for the derived scaling factors.

Purpose: Create human-readable documentation of the scaling factor derivation process with statistical tables and visualizations suitable for publication or scientific reporting.

Output:
- SCALING-FACTORS.md with methodology, tables, and results
- Regression scatter plots (PNG)
- Residual distribution plots (PNG)
- CLI command to regenerate report
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-scaling-factors/10-CONTEXT.md
@.planning/phases/10-scaling-factors/10-RESEARCH.md
@.planning/phases/10-scaling-factors/10-01-SUMMARY.md
@src/qm_nmr_calc/benchmark/analysis.py
@src/qm_nmr_calc/benchmark/__main__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plot generation functions to analysis.py</name>
  <files>src/qm_nmr_calc/benchmark/analysis.py</files>
  <action>
Add matplotlib plot generation functions to analysis.py:

1. **plot_regression(df: pd.DataFrame, factor: ScalingFactor, nucleus: str, title: str, output_path: Path) -> None**
   - Set matplotlib backend to 'Agg' at module level (before pyplot import)
   - Create figure with 1 row, 2 columns (12x5 inches)
   - Left subplot: Scatter plot of shielding (X) vs exp_shift (Y) with regression line
     - Mark outliers in different color if factor.outliers_removed > 0
     - Add equation annotation: shift = slope * shielding + intercept
     - Add R^2 annotation
   - Right subplot: Residual plot (fitted values vs residuals)
     - Horizontal line at y=0
     - Mark +/- 3*std lines in dashed gray
   - Save to output_path with dpi=150, bbox_inches='tight'
   - Call plt.close(fig) to prevent memory leaks

2. **plot_residual_histogram(residuals: np.ndarray, title: str, output_path: Path) -> None**
   - Single histogram of residuals
   - Add vertical line at mean
   - Add MAE and RMSD in text box
   - Save with same settings

Import at top of file:
```python
import matplotlib
matplotlib.use('Agg')  # Headless backend
import matplotlib.pyplot as plt
```

Use existing visualization.py patterns for styling consistency.
  </action>
  <verify>
python -c "
from qm_nmr_calc.benchmark.analysis import aggregate_regression_data, fit_scaling_factors, plot_regression
from pathlib import Path
import tempfile

df = aggregate_regression_data('B3LYP', 'CHCl3')
factor = fit_scaling_factors(df, '1H')

with tempfile.TemporaryDirectory() as tmpdir:
    output = Path(tmpdir) / 'test_plot.png'
    plot_regression(df[df.nucleus=='1H'], factor, '1H', 'Test Plot', output)
    print(f'Plot created: {output.exists()}')
    print(f'Size: {output.stat().st_size} bytes')
"
  </verify>
  <done>
plot_regression and plot_residual_histogram functions exist and generate valid PNG files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add generate_report function and per-compound statistics</name>
  <files>src/qm_nmr_calc/benchmark/analysis.py</files>
  <action>
Add report generation functions:

1. **calculate_per_compound_stats(df: pd.DataFrame, factor: ScalingFactor) -> pd.DataFrame**
   - For each compound in df, calculate:
     - Predicted shift using factor (slope * shielding + intercept)
     - Residual (exp_shift - predicted)
     - Absolute error
   - Group by compound, calculate: mean_error, max_error, num_atoms
   - Return DataFrame with per-compound statistics

2. **generate_report(output_dir: Path) -> None**
   - Create output_dir/plots/ directory
   - Call derive_all_factors() to get all factors
   - For each factor:
     - Generate regression plot: plots/{functional}_{solvent}_{nucleus}_regression.png
     - Generate residual histogram: plots/{functional}_{solvent}_{nucleus}_residuals.png
   - Generate SCALING-FACTORS.md with:

     ## Methodology
     - Brief description of linear regression approach
     - Outlier removal method (3 std dev)
     - Note about DELTA50 training data

     ## Scaling Factors
     Table with columns: Nucleus, Solvent, Slope, Intercept, R^2, MAE (ppm), RMSD (ppm), n
     Include 95% CI for slope and intercept in parentheses

     ## Statistical Summary
     - For each factor set, table of per-compound statistics
     - List any compounds with unusually high errors (>2x MAE)

     ## Plots
     - Inline references to plot files: ![](plots/B3LYP_CHCl3_1H_regression.png)

     ## Usage
     - Example code showing how to apply factors
     - Note about future WP04 factors (not yet available)

3. **save_factors_json(factors: dict[str, ScalingFactor], output_path: Path) -> None**
   - Export factors dict to JSON for external tools
   - Use orjson with indent

Export generate_report in __init__.py.
  </action>
  <verify>
python -c "
from qm_nmr_calc.benchmark.analysis import generate_report
from pathlib import Path
import tempfile

with tempfile.TemporaryDirectory() as tmpdir:
    output = Path(tmpdir)
    generate_report(output)
    print(f'SCALING-FACTORS.md exists: {(output / \"SCALING-FACTORS.md\").exists()}')
    print(f'plots dir exists: {(output / \"plots\").exists()}')
    print(f'Number of plots: {len(list((output / \"plots\").glob(\"*.png\")))}')
"
  </verify>
  <done>
generate_report creates SCALING-FACTORS.md and plot files. Report contains methodology, tables, and plot references.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CLI analyze command and generate final report</name>
  <files>src/qm_nmr_calc/benchmark/__main__.py, data/benchmark/delta50/SCALING-FACTORS.md, data/benchmark/delta50/plots/</files>
  <action>
Update benchmark/__main__.py to add analyze subcommand:

1. Add new subparser for "analyze":
   - Description: "Derive scaling factors and generate report"
   - Optional --output-dir (default: data/benchmark/delta50)
   - Optional --factors-only flag (skip plots/report, just print factors)

2. Implement analyze command handler:
   ```python
   def handle_analyze(args):
       from .analysis import derive_all_factors, generate_report

       if args.factors_only:
           factors = derive_all_factors()
           for key, factor in factors.items():
               print(f"{key}:")
               print(f"  slope={factor.slope:.4f}, intercept={factor.intercept:.2f}")
               print(f"  R^2={factor.r_squared:.4f}, MAE={factor.mae:.3f}, RMSD={factor.rmsd:.3f}")
           return

       output_dir = Path(args.output_dir)
       generate_report(output_dir)
       print(f"Report generated: {output_dir / 'SCALING-FACTORS.md'}")
   ```

3. Run the command to generate the actual report:
   ```bash
   python -m qm_nmr_calc.benchmark analyze
   ```

4. Verify output files exist in data/benchmark/delta50/:
   - SCALING-FACTORS.md
   - plots/*.png (8 files: 4 regression + 4 residual)
   - scaling_factors.json
  </action>
  <verify>
python -m qm_nmr_calc.benchmark analyze --help && \
python -m qm_nmr_calc.benchmark analyze && \
ls -la /home/chris/develop/qm-nmr-calc/data/benchmark/delta50/SCALING-FACTORS.md && \
ls /home/chris/develop/qm-nmr-calc/data/benchmark/delta50/plots/
  </verify>
  <done>
CLI analyze command works. SCALING-FACTORS.md exists with publication-quality content. 8 PNG plot files generated.
  </done>
</task>

</tasks>

<verification>
1. `python -m qm_nmr_calc.benchmark analyze --help` shows analyze subcommand
2. `python -m qm_nmr_calc.benchmark analyze` generates report without errors
3. SCALING-FACTORS.md contains tables, methodology, and plot references
4. 8 PNG files exist in data/benchmark/delta50/plots/
5. scaling_factors.json exists with all 4 factor sets
</verification>

<success_criteria>
- SCALING-FACTORS.md is readable and contains all required sections
- All 8 plots render correctly (regression and residual for each factor)
- CLI analyze command executes without errors
- Report shows MAE values comparable to or better than literature (~0.1-0.2 ppm for 1H, ~2-3 ppm for 13C)
- Per-compound statistics table is included for publication supplementary material
</success_criteria>

<output>
After completion, create `.planning/phases/10-scaling-factors/10-02-SUMMARY.md`
</output>
