---
phase: 28-technical-architecture
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - docs/architecture.md
autonomous: true

must_haves:
  truths:
    - "Developer can understand the full conformer pipeline stages"
    - "Developer can understand CSS cascade layer order and purpose"
    - "Developer knows where to find CSS design tokens"
    - "Developer understands component naming conventions (BEM)"
  artifacts:
    - path: "docs/architecture.md"
      provides: "Complete architecture documentation with pipeline and CSS sections"
      contains: "## Conformer Pipeline"
      min_lines: 350
  key_links:
    - from: "docs/architecture.md"
      to: "src/qm_nmr_calc/conformers/pipeline.py"
      via: "pipeline stages reference"
      pattern: "pipeline.py|conformers/"
---

<objective>
Document the conformer ensemble pipeline stages and CSS architecture to complete the technical architecture documentation.

Purpose: Enable developers to understand the multi-conformer calculation workflow and the CSS design system for UI contributions.

Output: Completed docs/architecture.md with Conformer Pipeline and CSS Architecture sections.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-technical-architecture/28-RESEARCH.md
@.planning/phases/28-technical-architecture/28-01-SUMMARY.md

# Source files for conformer pipeline
@src/qm_nmr_calc/conformers/pipeline.py
@src/qm_nmr_calc/conformers/rdkit_generator.py
@src/qm_nmr_calc/conformers/clustering.py
@src/qm_nmr_calc/boltzmann.py

# CSS architecture files
@src/qm_nmr_calc/api/static/css/layers.css
@src/qm_nmr_calc/api/static/css/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Conformer Ensemble Pipeline Documentation</name>
  <files>docs/architecture.md</files>
  <action>
Append to docs/architecture.md (after content from Plan 01):

**Conformer Ensemble Pipeline** (~80 lines) - TECH-05

1. **Pipeline Overview**
   Brief explanation of why conformer sampling matters:
   - Flexible molecules have multiple low-energy conformations
   - NMR shifts depend on 3D geometry
   - Boltzmann averaging gives population-weighted shifts
   - More accurate for molecules with rotatable bonds

2. **Pipeline Stages Diagram** (Mermaid flowchart)
   Show the 9-stage pipeline:
   ```mermaid
   flowchart TB
       A[SMILES Input] --> B[Conformer Generation]
       B --> C[MMFF Optimization]
       C --> D[RMSD Deduplication]
       D --> E[Pre-DFT Energy Filter]
       E --> F[Diversity Clustering]
       F --> G[DFT Optimization]
       G --> H[Post-DFT Energy Filter]
       H --> I[NMR Calculation]
       I --> J[Boltzmann Averaging]
   ```

3. **Stage Descriptions Table**
   | Stage | Purpose | Method | Typical Output |
   |-------|---------|--------|----------------|
   | Conformer Generation | Generate initial ensemble | RDKit KDG or CREST | 50-500 conformers |
   | MMFF Optimization | Force field pre-optimization | RDKit MMFF94 | Same count |
   | RMSD Deduplication | Remove structurally similar | RDKit GetBestRMS | ~20-40 conformers |
   | Pre-DFT Energy Filter | Remove high-energy (6 kcal/mol) | MMFF energy | ~15-30 conformers |
   | Diversity Clustering | Select representative subset | Butina clustering | ~8-12 conformers |
   | DFT Optimization | Quantum mechanical geometry opt | NWChem B3LYP | ~8-12 conformers |
   | Post-DFT Energy Filter | Remove high-energy (3 kcal/mol) | DFT energy | ~4-8 conformers |
   | NMR Calculation | Compute shielding tensors | NWChem GIAO | Same count |
   | Boltzmann Averaging | Population-weighted shifts | exp(-E/kT) | 1 result set |

4. **Conformer State Machine** (Mermaid stateDiagram-v2)
   Individual conformer states:
   ```
   [*] --> pending
   pending --> optimizing: DFT starts
   optimizing --> optimized: DFT complete
   optimizing --> failed: DFT error
   optimized --> nmr_running: NMR starts
   nmr_running --> nmr_complete: NMR done
   nmr_running --> failed: NMR error
   nmr_complete --> [*]
   failed --> [*]
   ```

5. **RDKit vs CREST**
   | Feature | RDKit KDG | CREST |
   |---------|-----------|-------|
   | Availability | Always (bundled) | Optional (requires install) |
   | Speed | Fast (~seconds) | Slow (~minutes to hours) |
   | Quality | Good for rigid molecules | Best for flexible molecules |
   | Sampling | Distance geometry | Metadynamics |
   | Solvation | None | ALPB model |
   | Use when | CREST unavailable, quick results | Production, flexible molecules |

6. **Key Files**
   - conformers/pipeline.py: Main orchestration
   - conformers/rdkit_generator.py: RDKit KDG generation
   - conformers/crest_runner.py: CREST integration
   - conformers/clustering.py: Butina clustering
   - boltzmann.py: Boltzmann averaging
  </action>
  <verify>
```bash
# Verify conformer pipeline section
grep -E "## Conformer.*Pipeline|Ensemble Pipeline" docs/architecture.md

# Verify pipeline stages mentioned
grep -E "RMSD Deduplication|Diversity Clustering|Boltzmann Averaging" docs/architecture.md

# Verify conformer state diagram
grep -E "pending.*optimizing|nmr_running" docs/architecture.md

# Verify comparison table
grep -E "RDKit.*CREST|KDG.*Metadynamics" docs/architecture.md
```
  </verify>
  <done>
Conformer Ensemble Pipeline section added with:
- Pipeline overview explaining importance of conformer sampling
- 9-stage pipeline diagram (Mermaid flowchart)
- Stage descriptions table with methods and outputs
- Conformer state machine diagram
- RDKit vs CREST comparison table
- Key files reference
  </done>
</task>

<task type="auto">
  <name>Task 2: CSS Architecture Documentation</name>
  <files>docs/architecture.md</files>
  <action>
Append to docs/architecture.md:

**CSS Architecture** (~60 lines) - TECH-06

1. **Overview**
   The CSS uses modern cascade layers for predictable specificity:
   - No !important needed
   - Layer order determines cascade priority
   - Components use BEM naming convention
   - Design tokens for consistent theming

2. **Cascade Layers Diagram** (Mermaid flowchart or simple list)
   ```
   @layer reset, base, layout, components, utilities;

   Priority (lowest to highest):
   1. reset      - Browser normalization
   2. base       - Element defaults (body, headings, links)
   3. layout     - Page structure, grids, containers
   4. components - Reusable UI components (glass cards, buttons)
   5. utilities  - Single-purpose overrides (.sr-only, .hidden)
   ```

3. **Layer Descriptions**
   | Layer | Purpose | Example |
   |-------|---------|---------|
   | reset | Normalize browser defaults | box-sizing, margin reset |
   | base | Element styling | body font, link colors |
   | layout | Page structure | .container, .bento-grid |
   | components | Reusable UI | .glass-card, .btn |
   | utilities | Overrides | .sr-only, .hidden |

4. **Design Tokens** (tokens.css)
   Categories of CSS custom properties:
   - Spacing: --space-xs through --space-3xl (0.25rem to 4rem)
   - Colors: --color-primary, --color-surface, --color-text
   - Typography: --font-size-sm through --font-size-2xl
   - Glass effects: --glass-bg, --glass-blur, --glass-border
   - Shadows: --shadow-sm, --shadow-md, --shadow-lg
   - Transitions: --transition-fast, --transition-normal

5. **Component Naming (BEM)**
   Block__Element--Modifier pattern:
   - .glass-card (block)
   - .glass-card__header (element)
   - .glass-card--highlighted (modifier)

   Key components:
   - glass-card: Frosted glass container
   - btn: Button variants (primary, secondary, ghost)
   - form-group: Form field with label
   - result-grid: Bento layout for results page

6. **File Organization**
   ```
   static/css/
   ├── layers.css        # Layer order declaration (load first!)
   ├── tokens.css        # Design tokens
   ├── reset.css         # Browser normalization
   ├── base.css          # Element defaults
   ├── layout.css        # Page structure
   ├── components/       # Reusable components
   │   ├── glass-card.css
   │   ├── buttons.css
   │   └── forms.css
   ├── pages/            # Page-specific styles
   │   ├── submit.css
   │   ├── status.css
   │   └── result.css
   └── utilities.css     # Utility classes
   ```

7. **Adding New Components**
   - Create file in components/ folder
   - Wrap styles in @layer components { }
   - Use design tokens for spacing, colors
   - Follow BEM naming convention
   - Import in base template

Add final navigation section with links to:
- README.md for user documentation
- docs/usage.md for usage guide
- docs/installation.md for setup
- docs/libraries.md for library details
- docs/science.md for methodology
  </action>
  <verify>
```bash
# Verify CSS architecture section
grep -E "## CSS Architecture" docs/architecture.md

# Verify layers mentioned
grep -E "@layer|reset.*base.*layout.*components" docs/architecture.md

# Verify design tokens section
grep -E "Design Tokens|tokens.css|--space|--color" docs/architecture.md

# Verify BEM mentioned
grep -E "BEM|Block__Element" docs/architecture.md

# Total line count
wc -l docs/architecture.md
# Should be 350+ lines
```
  </verify>
  <done>
CSS Architecture section added with:
- Cascade layers explanation with priority order
- Layer descriptions table
- Design tokens categories
- BEM naming convention explanation
- File organization diagram
- Guide for adding new components
- Navigation links to related docs
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit Pipeline and CSS Architecture Documentation</name>
  <files>docs/architecture.md</files>
  <action>
Stage and commit the remaining architecture documentation:

```bash
git add docs/architecture.md
git commit -m "docs(28): add conformer pipeline and CSS architecture

- Document 9-stage conformer ensemble pipeline (TECH-05)
- Add conformer state machine diagram
- Compare RDKit KDG vs CREST methods
- Document CSS cascade layers architecture (TECH-06)
- Explain design tokens and BEM naming
- Include file organization and component guide

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
```bash
# Verify commit created
git log -1 --oneline

# Verify total content
wc -l docs/architecture.md
# Should be 350+ lines

# Verify all major sections
grep -E "^## " docs/architecture.md
# Should show: Technology Stack, Data Flow, Job Lifecycle, File Storage, Conformer Pipeline, CSS Architecture
```
  </verify>
  <done>
Conformer Pipeline and CSS Architecture documentation committed, completing TECH-05 and TECH-06 requirements. Phase 28 documentation complete.
  </done>
</task>

</tasks>

<verification>
- [ ] Conformer Pipeline section with 9 stages (TECH-05)
- [ ] Pipeline stages diagram (Mermaid flowchart)
- [ ] Stage descriptions table with methods
- [ ] Conformer state machine diagram
- [ ] RDKit vs CREST comparison table
- [ ] CSS Architecture section (TECH-06)
- [ ] Cascade layers explanation with priority
- [ ] Design tokens categories listed
- [ ] BEM naming convention explained
- [ ] File organization diagram
- [ ] Navigation links to related docs
- [ ] Total docs/architecture.md exceeds 350 lines
- [ ] Changes committed to git
</verification>

<success_criteria>
- TECH-05: Conformer ensemble pipeline fully documented with stages, state machine, and method comparison
- TECH-06: CSS architecture documented with layers, tokens, BEM, and file organization
- Complete architecture documentation ready for developer reference
</success_criteria>

<output>
After completion, create `.planning/phases/28-technical-architecture/28-02-SUMMARY.md`
</output>
