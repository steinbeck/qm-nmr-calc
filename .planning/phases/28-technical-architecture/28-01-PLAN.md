---
phase: 28-technical-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/architecture.md
autonomous: true

must_haves:
  truths:
    - "Developer can understand the full technology stack from documentation"
    - "Developer can trace data flow from job submission to results"
    - "Developer understands job state transitions and when they occur"
    - "Developer can find files in job directory structure"
  artifacts:
    - path: "docs/architecture.md"
      provides: "Core architecture documentation with diagrams"
      contains: "## Technology Stack"
      min_lines: 200
  key_links:
    - from: "docs/architecture.md"
      to: "README.md"
      via: "navigation cross-reference"
      pattern: "README.md"
---

<objective>
Document the core system architecture including technology stack, data flows, job lifecycle, and file storage structure.

Purpose: Enable developers and contributors to understand how the QM NMR Calculator works at the system level.

Output: Comprehensive docs/architecture.md with Mermaid diagrams covering stack overview, data flow, job states, and file storage.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-technical-architecture/28-RESEARCH.md

# Source files for accurate architecture documentation
@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/storage.py
@src/qm_nmr_calc/tasks.py
@src/qm_nmr_calc/queue.py
@src/qm_nmr_calc/api/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Technology Stack and Data Flow Documentation</name>
  <files>docs/architecture.md</files>
  <action>
Replace the placeholder content in docs/architecture.md with comprehensive architecture documentation:

**Introduction** (~10 lines)
- Brief overview of what this document covers
- Target audience: developers and contributors
- Link back to README for user-facing documentation

**Technology Stack** (~60 lines) - TECH-01
Create a section with:

1. **Stack Overview Diagram** (Mermaid flowchart)
   - Web layer: FastAPI (HTTP server, routes, templates)
   - Queue layer: Huey (SQLite backend, async job processing)
   - Compute layer: NWChem (DFT/NMR), RDKit (conformers, SMILES)
   - Frontend: Jinja2 templates, 3Dmol.js, SmilesDrawer, Chart.js

2. **Component Table**
   | Component | Purpose | Key Files |
   |-----------|---------|-----------|
   | FastAPI | HTTP server, REST API, templates | api/app.py, api/routers/ |
   | Huey | Task queue with SQLite backend | queue.py, tasks.py |
   | NWChem | DFT optimization, NMR shielding | nwchem/runner.py, nwchem/input.py |
   | RDKit | SMILES parsing, conformer generation | conformers/rdkit_generator.py |
   | 3Dmol.js | Interactive 3D molecule viewer | templates/result.html |
   | SmilesDrawer | 2D structure preview | templates/submit.html |

3. **Technology Choices**
   - Why Huey over Celery (simpler, SQLite backend, no Redis needed)
   - Why NWChem (open source, GIAO method, COSMO solvation)
   - Why RDKit (industry standard, Python bindings, conformer generation)

**Data Flow** (~60 lines) - TECH-02

1. **Request Flow Diagram** (Mermaid sequenceDiagram)
   Show the complete flow:
   - User submits SMILES via Web UI or REST API
   - FastAPI validates input with RDKit
   - Job directory created with status.json
   - Huey task enqueued
   - Worker picks up task
   - Conformer generation (RDKit or CREST)
   - DFT optimization loop (NWChem)
   - NMR calculation loop (NWChem)
   - Boltzmann averaging
   - Results written to status.json
   - User retrieves results

2. **Data Transformation Pipeline**
   Explain what happens to data at each stage:
   - SMILES -> RDKit Mol -> 3D coordinates (XYZ)
   - XYZ -> NWChem input -> optimized geometry
   - Optimized geometry -> NWChem NMR -> shielding tensors
   - Shielding -> scaled chemical shifts (ppm)
   - Shifts -> Boltzmann-averaged results (ensemble mode)

Use Mermaid LR flowchart style consistent with existing README diagrams.
  </action>
  <verify>
```bash
# Verify stack section exists
grep -E "## Technology Stack" docs/architecture.md

# Verify data flow section exists
grep -E "## Data Flow|## Request Flow" docs/architecture.md

# Verify Mermaid diagrams present
grep -c "```mermaid" docs/architecture.md
# Should have at least 2 diagrams

# Verify component table exists
grep -E "FastAPI.*HTTP server" docs/architecture.md
```
  </verify>
  <done>
Technology Stack and Data Flow sections added with:
- Stack overview diagram (Mermaid flowchart)
- Component table with key files
- Technology choice explanations
- Request flow sequence diagram
- Data transformation pipeline explanation
  </done>
</task>

<task type="auto">
  <name>Task 2: Job Lifecycle and File Storage Documentation</name>
  <files>docs/architecture.md</files>
  <action>
Append to docs/architecture.md:

**Job Lifecycle States** (~50 lines) - TECH-03

1. **State Machine Diagram** (Mermaid stateDiagram-v2)
   Show job states and transitions:
   ```
   [*] --> queued: Job submitted
   queued --> running: Consumer picks up task
   running --> complete: All calculations succeed
   running --> failed: Error occurs
   complete --> [*]
   failed --> [*]
   ```

2. **State Descriptions**
   | State | Meaning | Triggered By |
   |-------|---------|--------------|
   | queued | Job accepted, waiting for worker | POST /api/v1/jobs |
   | running | Worker executing calculations | Huey pre_execute signal |
   | complete | All calculations finished successfully | Task completion |
   | failed | Error during execution | Exception in task |

3. **Step Tracking**
   Explain the step progress system:
   - current_step: Active step identifier
   - current_step_label: Human-readable description
   - steps_completed: Array of completed steps with timing

   List common steps:
   - conformer_generation: Generating conformer ensemble
   - conformer_optimization: DFT optimization (X/N progress)
   - conformer_nmr: NMR calculation (X/N progress)
   - averaging: Computing Boltzmann-weighted shifts
   - visualization: Generating spectrum plots

**File Storage Structure** (~60 lines) - TECH-04

1. **Directory Layout Diagram** (Mermaid or ASCII tree)
   ```
   data/jobs/{job_id}/
   ├── status.json                    # Job metadata and results
   ├── output/
   │   ├── initial.xyz                # RDKit 3D geometry
   │   ├── optimized.xyz              # DFT-optimized geometry
   │   ├── nmr_results.json           # Chemical shifts (legacy)
   │   ├── spectrum_1H.svg            # 1H spectrum plot
   │   ├── spectrum_1H.png
   │   ├── spectrum_13C.svg           # 13C spectrum plot
   │   ├── spectrum_13C.png
   │   ├── structure_annotated.svg    # 2D structure with labels
   │   ├── structure_annotated.png
   │   ├── conformers/{conf_id}/      # Per-conformer outputs
   │   │   └── geometry.xyz
   │   └── optimized/                 # Optimized conformer geometries
   │       └── {conf_id}.xyz
   ├── scratch/
   │   ├── optimize.nw                # NWChem optimization input
   │   ├── optimize.out               # NWChem optimization output
   │   ├── shielding.nw               # NMR calculation input
   │   ├── shielding.out              # NMR calculation output
   │   └── conformers/{conf_id}/      # Per-conformer scratch (isolated)
   └── logs/
       └── *.log                      # NWChem process logs
   ```

2. **File Descriptions**
   - status.json: Complete job state including input, status, results, timing
   - output/: User-facing artifacts (geometries, plots, results)
   - scratch/: Intermediate NWChem files (useful for debugging)
   - logs/: Process output and error logs

3. **Why Isolated Scratch Directories**
   Explain that NWChem creates database files (.db, .movecs) that conflict when running parallel conformers. Each conformer gets its own scratch directory to prevent corruption.

Add navigation footer linking to README and other docs.
  </action>
  <verify>
```bash
# Verify job lifecycle section
grep -E "## Job Lifecycle|State Machine" docs/architecture.md

# Verify state diagram present
grep -E "stateDiagram" docs/architecture.md

# Verify file storage section
grep -E "## File Storage|Directory Layout" docs/architecture.md

# Verify key directories mentioned
grep -E "status.json|output/|scratch/|conformers/" docs/architecture.md

# Line count check
wc -l docs/architecture.md
# Should be around 200+ lines at this point
```
  </verify>
  <done>
Job Lifecycle and File Storage sections added with:
- State machine diagram with all transitions
- State descriptions table
- Step tracking system explanation
- Directory layout diagram
- File descriptions with purposes
- Explanation of isolated scratch directories
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit Core Architecture Documentation</name>
  <files>docs/architecture.md</files>
  <action>
Stage and commit the core architecture documentation:

```bash
git add docs/architecture.md
git commit -m "docs(28): add core architecture documentation

- Document technology stack with component diagram (TECH-01)
- Add data flow diagram from submission to results (TECH-02)
- Document job lifecycle states and transitions (TECH-03)
- Explain file storage structure and directory layout (TECH-04)
- Include Mermaid diagrams for visual clarity

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
```bash
# Verify commit created
git log -1 --oneline

# Verify content
wc -l docs/architecture.md
# Should be 200+ lines

# Verify all sections present
grep -E "^## " docs/architecture.md
```
  </verify>
  <done>
Core architecture documentation committed covering TECH-01, TECH-02, TECH-03, and TECH-04 requirements.
  </done>
</task>

</tasks>

<verification>
- [ ] Technology Stack section with component diagram (TECH-01)
- [ ] Data flow diagram showing submission to results (TECH-02)
- [ ] Job lifecycle state machine diagram (TECH-03)
- [ ] File storage structure with directory layout (TECH-04)
- [ ] At least 4 Mermaid diagrams included
- [ ] Component table with key files listed
- [ ] State descriptions with triggers
- [ ] Scratch directory isolation explained
- [ ] Changes committed to git
</verification>

<success_criteria>
- TECH-01: Full stack explained with component diagram and rationale
- TECH-02: Data flow documented with sequence diagram
- TECH-03: Job lifecycle states and transitions in state machine diagram
- TECH-04: File storage structure with directory layout
</success_criteria>

<output>
After completion, create `.planning/phases/28-technical-architecture/28-01-SUMMARY.md`
</output>
