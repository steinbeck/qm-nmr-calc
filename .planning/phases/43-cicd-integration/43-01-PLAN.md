---
phase: 43-cicd-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/publish-images.yml
autonomous: true

must_haves:
  truths:
    - "ARM64 worker image builds on native ubuntu-24.04-arm runner (not QEMU)"
    - "Multi-arch manifest exists combining amd64 and arm64 worker images"
    - "Single tag (latest, vX.Y.Z) auto-selects correct architecture on pull"
    - "API image continues building with existing QEMU pattern"
  artifacts:
    - path: ".github/workflows/publish-images.yml"
      provides: "Multi-arch CI/CD workflow with native ARM64 builds"
      contains: "ubuntu-24.04-arm"
  key_links:
    - from: "build-worker job"
      to: "merge-worker job"
      via: "artifact upload/download of digests"
      pattern: "digests-.*"
    - from: "merge-worker job"
      to: "GHCR"
      via: "docker buildx imagetools create"
      pattern: "imagetools create"
---

<objective>
Update GitHub Actions workflow to build ARM64 worker images using native runners and create multi-arch manifests.

Purpose: Enable automated publishing of ARM64 worker images alongside amd64, completing the multi-arch support for qm-nmr-calc deployment.

Output: Modified publish-images.yml that builds worker image on native ARM64 runner and merges into multi-arch manifest.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-cicd-integration/43-RESEARCH.md
@.github/workflows/publish-images.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure workflow for multi-arch worker builds</name>
  <files>.github/workflows/publish-images.yml</files>
  <action>
Rewrite publish-images.yml to implement native multi-arch worker builds while preserving API image pattern.

**Structure changes:**

1. **Remove worker from existing matrix** - The current `build-and-push` job becomes `build-api` (single image, QEMU pattern unchanged).

2. **Add `build-worker` job** with matrix strategy:
   ```yaml
   strategy:
     fail-fast: false
     matrix:
       platform:
         - linux/amd64
         - linux/arm64
   ```

   Key configuration:
   - Dynamic runner selection: `runs-on: ${{ matrix.platform == 'linux/amd64' && 'ubuntu-latest' || 'ubuntu-24.04-arm' }}`
   - Platform-specific Dockerfile: `file: ${{ matrix.platform == 'linux/amd64' && 'Dockerfile.worker' || 'Dockerfile.worker.arm64' }}`
   - Push by digest (NOT by tag): `outputs: type=image,name=${{ env.WORKER_IMAGE }},push-by-digest=true,name-canonical=true,push=true`
   - Platform-specific cache scopes to avoid conflicts
   - Export digest to file and upload as artifact with platform-specific name (`digests-linux-amd64`, `digests-linux-arm64`)

3. **Add `merge-worker` job** that:
   - `needs: [build-worker]`
   - Downloads all digest artifacts with `merge-multiple: true`
   - Runs `docker/metadata-action` to generate tags (semver, latest)
   - Uses `docker buildx imagetools create` to create manifest list from digests
   - Inspects final image to verify both platforms present

**Environment variables:**
```yaml
env:
  REGISTRY: ghcr.io
  WORKER_IMAGE: ghcr.io/${{ github.repository_owner }}/qm-nmr-calc-worker
```

**Permissions:** Each job needs `contents: read` and `packages: write`.

**Do NOT use:**
- QEMU for worker builds (too slow for 2.1GB image)
- Single artifact name for both platforms (v4 artifacts are immutable)
- Hardcoded digests

**Reference:** Follow pattern exactly from 43-RESEARCH.md "Complete Multi-Arch Workflow for Worker Image" section.
  </action>
  <verify>
Syntax validation:
```bash
# Validate YAML syntax
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/publish-images.yml'))"
```

Manual review checklist:
- [ ] `build-api` job uses QEMU for linux/amd64,linux/arm64 (unchanged pattern)
- [ ] `build-worker` job has matrix with linux/amd64 and linux/arm64
- [ ] Runner selection uses ternary for ubuntu-latest vs ubuntu-24.04-arm
- [ ] Dockerfile selection uses ternary for Dockerfile.worker vs Dockerfile.worker.arm64
- [ ] `push-by-digest=true` in build-worker outputs
- [ ] Artifact names are platform-specific (digests-linux-amd64, digests-linux-arm64)
- [ ] `merge-worker` job has `needs: [build-worker]`
- [ ] Download artifact uses `merge-multiple: true`
- [ ] `docker buildx imagetools create` command present
- [ ] All jobs have `packages: write` permission
  </verify>
  <done>publish-images.yml contains three jobs: build-api (QEMU multi-arch), build-worker (native per-platform), merge-worker (manifest creation)</done>
</task>

<task type="auto">
  <name>Task 2: Update workflow header comments and verify complete pattern</name>
  <files>.github/workflows/publish-images.yml</files>
  <action>
Update the workflow file header to reflect the new multi-arch support:

1. **Update header comment:**
   ```yaml
   # Publish Docker images to GitHub Container Registry (GHCR)
   # Triggered on release tags (v*) - builds and pushes api and worker images
   #
   # Images published:
   #   - ghcr.io/steinbeck/qm-nmr-calc-api:vX.Y.Z (amd64 + arm64 via QEMU)
   #   - ghcr.io/steinbeck/qm-nmr-calc-worker:vX.Y.Z (amd64 + arm64 via native runners)
   #
   # Architecture note:
   #   - API image: Small (~733MB), QEMU emulation acceptable
   #   - Worker image: Large (~2.1GB), requires native ARM64 runner
   #
   # ARM64 runner requirement: ubuntu-24.04-arm is FREE for PUBLIC repos only
   ```

2. **Add inline comments** explaining key patterns:
   - Before build-worker job: explain why native runners needed
   - Before merge-worker job: explain digest merge pattern
   - At dynamic runner selection: explain ternary

3. **Final verification** - ensure all required components present:
   - PLATFORM_PAIR environment variable set from matrix.platform
   - Digest export creates files named by digest hash
   - Download artifact pattern matches upload names
   - DOCKER_METADATA_OUTPUT_JSON used in imagetools create
  </action>
  <verify>
```bash
# Check key patterns exist in file
grep -q "ubuntu-24.04-arm" .github/workflows/publish-images.yml && echo "ARM64 runner: OK"
grep -q "push-by-digest=true" .github/workflows/publish-images.yml && echo "Push by digest: OK"
grep -q "merge-multiple: true" .github/workflows/publish-images.yml && echo "Merge multiple: OK"
grep -q "imagetools create" .github/workflows/publish-images.yml && echo "Imagetools: OK"
grep -q "PLATFORM_PAIR" .github/workflows/publish-images.yml && echo "Platform pair: OK"
```
  </verify>
  <done>Workflow file has updated comments documenting the multi-arch strategy and all key patterns are present</done>
</task>

</tasks>

<verification>
Phase 43 requirements verification:

**CICD-01: GitHub Actions builds ARM64 worker image with native runner**
- Check: `build-worker` job contains `ubuntu-24.04-arm` in runs-on expression

**CICD-02: Multi-arch manifest created combining amd64 and arm64**
- Check: `merge-worker` job uses `docker buildx imagetools create`

**CICD-03: Single image tag works on both architectures**
- Check: metadata-action generates same tags (latest, vX.Y.Z) applied to manifest

**CICD-04: ARM64 build uses native runner (not QEMU)**
- Check: `build-worker` job does NOT use `docker/setup-qemu-action`
- Check: `build-worker` job runs-on includes `ubuntu-24.04-arm` for arm64

Validation commands:
```bash
# YAML syntax valid
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/publish-images.yml'))"

# Key patterns present
grep "ubuntu-24.04-arm" .github/workflows/publish-images.yml
grep "push-by-digest=true" .github/workflows/publish-images.yml
grep "imagetools create" .github/workflows/publish-images.yml
grep "merge-multiple: true" .github/workflows/publish-images.yml
```
</verification>

<success_criteria>
1. publish-images.yml passes YAML validation
2. Workflow contains `build-api`, `build-worker`, and `merge-worker` jobs
3. `build-worker` uses native `ubuntu-24.04-arm` runner for ARM64 (not QEMU)
4. Platform-specific Dockerfiles selected (Dockerfile.worker vs Dockerfile.worker.arm64)
5. Digests uploaded as artifacts with platform-specific names
6. `merge-worker` creates manifest list combining both architectures
7. Header comments document the multi-arch strategy
</success_criteria>

<output>
After completion, create `.planning/phases/43-cicd-integration/43-01-SUMMARY.md`
</output>
