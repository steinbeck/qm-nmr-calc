---
phase: 37-docker-compose-integration
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - scripts/validate-compose.sh
autonomous: false

must_haves:
  truths:
    - "Stack starts with docker compose up -d"
    - "Job data persists after docker compose down && up"
    - "Huey queue state persists across restarts"
    - "Services restart after simulated failure"
    - "Worker completes current task on SIGTERM/SIGINT"
    - "User can view logs with docker compose logs"
  artifacts:
    - path: "scripts/validate-compose.sh"
      provides: "Integration testing script"
      min_lines: 50
  key_links:
    - from: "scripts/validate-compose.sh"
      to: "docker compose"
      via: "CLI commands"
      pattern: "docker compose"
---

<objective>
Validate Docker Compose integration with end-to-end testing of stack startup, data persistence, restart policies, and graceful shutdown.

Purpose: Ensure all phase 37 requirements are met with automated verification and human confirmation of critical behaviors.

Output: Validation script and confirmed working deployment.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-docker-compose-integration/37-RESEARCH.md
@.planning/phases/37-docker-compose-integration/37-01-SUMMARY.md

# Docker configuration
@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation script</name>
  <files>scripts/validate-compose.sh</files>
  <action>
Create scripts/validate-compose.sh to test Docker Compose integration.

Script structure:
1. **Preamble**: set -e, color codes, check_status helper function

2. **Test 1: Stack Startup**
   - docker compose up -d --build
   - Wait for health checks (timeout 120s)
   - docker compose ps shows both services healthy

3. **Test 2: API Health**
   - curl http://localhost:${API_PORT:-8000}/health returns 200

4. **Test 3: Worker Health**
   - docker compose exec worker pgrep -f huey_consumer

5. **Test 4: Volume Persistence**
   - Create marker file: docker compose exec api touch /app/data/test-marker
   - docker compose down
   - docker compose up -d
   - Verify marker exists: docker compose exec api ls /app/data/test-marker
   - Clean up marker

6. **Test 5: Restart Policy**
   - docker compose exec api pkill -9 uvicorn (simulate crash)
   - Wait 30s
   - Verify API is healthy again

7. **Test 6: Logs Accessible**
   - docker compose logs --tail 10 api (verify output)
   - docker compose logs --tail 10 worker (verify output)

8. **Cleanup** (optional --no-cleanup flag):
   - docker compose down -v (removes volumes)

Exit 0 on all tests pass, exit 1 on any failure.

Add usage message with --help flag.
  </action>
  <verify>
    1. chmod +x scripts/validate-compose.sh
    2. scripts/validate-compose.sh --help shows usage
    3. Script contains all 6 test sections
  </verify>
  <done>Validation script created and executable</done>
</task>

<task type="auto">
  <name>Task 2: Run validation suite</name>
  <files>None (execution only)</files>
  <action>
Execute the validation script to verify Docker Compose integration:

1. Ensure no containers from previous tests are running:
   docker compose down -v 2>/dev/null || true

2. Run validation:
   ./scripts/validate-compose.sh

3. Capture output for summary

If any test fails:
- Check docker compose logs for errors
- Review container status with docker compose ps
- Debug and fix issues before proceeding

After successful validation:
- Keep stack running for human verification
- Do NOT run docker compose down
  </action>
  <verify>
    1. All 6 tests in validation script pass
    2. docker compose ps shows both services "healthy"
    3. curl http://localhost:8000/health returns 200
  </verify>
  <done>Validation suite passes all tests, stack is running</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Docker Compose deployment with:
- API and worker services with health checks
- Shared named volume for data persistence
- SIGINT graceful shutdown for worker
- Restart policies (unless-stopped)
- Configurable via .env file
  </what-built>
  <how-to-verify>
**Quick verification (stack should already be running):**

1. Check services are healthy:
   ```bash
   docker compose ps
   ```
   Expected: Both api and worker show "healthy" status

2. Test API endpoint:
   ```bash
   curl http://localhost:8000/
   ```
   Expected: HTML response (submit page)

3. Test graceful shutdown signal:
   ```bash
   docker compose stop worker
   ```
   Expected: Worker stops within a few seconds (no job running)
   Watch logs: `docker compose logs worker --tail 20`
   Should see "Received SIGINT" or graceful shutdown message

4. Verify restart policy:
   ```bash
   docker compose start worker
   docker compose ps
   ```
   Expected: Worker restarts and becomes healthy

5. View combined logs:
   ```bash
   docker compose logs --tail 20
   ```
   Expected: Logs from both services visible

**Optional full test (if you want to verify a calculation):**
Submit a simple job via the UI at http://localhost:8000 and watch it complete.

**Cleanup when done:**
```bash
docker compose down -v  # Removes containers and volumes
```
  </how-to-verify>
  <resume-signal>Type "approved" if deployment works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 37 requirements verification:

| Requirement | Verification |
|-------------|--------------|
| DOCK-01: docker compose up -d | Validation Test 1 |
| DOCK-04: Job data persists | Validation Test 4 |
| DOCK-05: Huey queue persists | Validation Test 4 (shared volume) |
| DOCK-06: Health checks | Tests 2, 3 |
| DOCK-07: Restart policy | Test 5 |
| DOCK-08: .env configuration | Present in docker-compose.yml |
| DOCK-09: .env.example | Created in Plan 01 |
| OPS-01: Graceful SIGTERM | stop_signal: SIGINT in compose |
| OPS-02: Memory limits | deploy.resources in compose |
| OPS-03: NWCHEM_NPROC env | In compose + .env.example |
| OPS-04: docker compose logs | Test 6 |
</verification>

<success_criteria>
- Validation script passes all 6 tests
- Human verifies deployment works correctly
- All phase 37 requirements covered
</success_criteria>

<output>
After completion, create `.planning/phases/37-docker-compose-integration/37-02-SUMMARY.md`
</output>
