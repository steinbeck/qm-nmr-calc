---
phase: 37-docker-compose-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - .env.example
autonomous: true

must_haves:
  truths:
    - "User can start entire stack with docker compose up -d"
    - "Services communicate via shared named volume"
    - "Worker receives SIGINT for graceful shutdown"
    - "All services have health checks configured"
    - "User can configure deployment via .env file"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Multi-service orchestration"
      contains: "stop_signal: SIGINT"
    - path: ".env.example"
      provides: "Configuration documentation"
      contains: "NWCHEM_NPROC"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile.api"
      via: "build.dockerfile"
      pattern: "dockerfile: Dockerfile\\.api"
    - from: "docker-compose.yml"
      to: "Dockerfile.worker"
      via: "build.dockerfile"
      pattern: "dockerfile: Dockerfile\\.worker"
    - from: "docker-compose.yml"
      to: ".env"
      via: "env_file"
      pattern: "env_file:"
---

<objective>
Create Docker Compose configuration for complete qm-nmr-calc deployment with proper service orchestration, persistent storage, and graceful shutdown handling.

Purpose: Enable single-command deployment (`docker compose up -d`) with production-ready defaults and configurable options.

Output: docker-compose.yml and .env.example files ready for deployment.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-docker-compose-integration/37-RESEARCH.md

# Existing Docker files
@Dockerfile.api
@Dockerfile.worker
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Create docker-compose.yml following Compose Specification (no version key needed).

Services:
1. **api** service:
   - build: context: ., dockerfile: Dockerfile.api
   - ports: "${API_PORT:-8000}:8000"
   - volumes: app-data:/app/data
   - environment: PYTHONUNBUFFERED=1
   - env_file: path: .env, required: false
   - restart: unless-stopped
   - healthcheck: test curl -f http://localhost:8000/health, interval 30s, timeout 5s, start_period 10s, retries 3

2. **worker** service:
   - build: context: ., dockerfile: Dockerfile.worker
   - volumes: app-data:/app/data
   - environment:
     - PYTHONUNBUFFERED=1
     - NWCHEM_NPROC=${NWCHEM_NPROC:-4}
     - OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}
   - env_file: path: .env, required: false
   - depends_on: api with condition: service_healthy
   - restart: unless-stopped
   - CRITICAL: stop_signal: SIGINT (Huey requires SIGINT for graceful shutdown, not SIGTERM)
   - stop_grace_period: 300s (5 minutes for long NMR calculations)
   - shm_size: 512m (MPI shared memory requirement)
   - deploy.resources.limits.memory: ${WORKER_MEMORY_LIMIT:-8g}
   - healthcheck: test pgrep -f huey_consumer, interval 30s, timeout 5s, start_period 30s, retries 3

Named volume:
- app-data with name: qm-nmr-calc-data

Add header comment explaining purpose and usage.
  </action>
  <verify>
    1. docker compose config (validates syntax)
    2. grep -q "stop_signal: SIGINT" docker-compose.yml
    3. grep -q "stop_grace_period: 300s" docker-compose.yml
    4. grep -q "shm_size:" docker-compose.yml
  </verify>
  <done>docker-compose.yml exists with both services, shared volume, SIGINT signal handling, and health checks</done>
</task>

<task type="auto">
  <name>Task 2: Create .env.example</name>
  <files>.env.example</files>
  <action>
Create .env.example documenting all configuration options with helpful comments.

Sections:
1. **API Configuration**
   - API_PORT: Port to expose (default: 8000)

2. **Worker Configuration**
   - NWCHEM_NPROC: Number of MPI processes for NWChem (default: 4)
   - OMP_NUM_THREADS: Number of OpenMP threads for CREST/xTB (default: 4)
   - WORKER_MEMORY_LIMIT: Container memory limit (default: 8g)

3. **Optional Email Notifications** (placeholder for future)
   - SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM

4. **Advanced Options**
   - Comments explaining stop_grace_period can be increased for very long calculations

Include guidance on:
- How to use: copy to .env and customize
- Default values are suitable for most deployments
- NWCHEM_NPROC should match available CPU cores
  </action>
  <verify>
    1. File exists with documented sections
    2. grep -q "NWCHEM_NPROC" .env.example
    3. grep -q "API_PORT" .env.example
    4. grep -q "WORKER_MEMORY_LIMIT" .env.example
  </verify>
  <done>.env.example exists with all configurable options documented</done>
</task>

<task type="auto">
  <name>Task 3: Update .gitignore for .env</name>
  <files>.gitignore</files>
  <action>
Add .env to .gitignore if not already present to prevent secrets from being committed.

Add entry:
```
# Docker environment configuration (may contain secrets)
.env
```

Keep .env.example tracked (it's documentation, not secrets).
  </action>
  <verify>grep -q "^\.env$" .gitignore</verify>
  <done>.env is gitignored to protect secrets</done>
</task>

</tasks>

<verification>
1. `docker compose config` validates syntax without errors
2. docker-compose.yml contains stop_signal: SIGINT for worker
3. docker-compose.yml contains shm_size for MPI
4. docker-compose.yml contains healthchecks for both services
5. .env.example documents all environment variables
6. .env is in .gitignore
</verification>

<success_criteria>
- docker compose config completes without errors
- All requirements from 37-RESEARCH.md implemented (SIGINT, grace period, shm_size, health checks)
- Configuration is well-documented for users
</success_criteria>

<output>
After completion, create `.planning/phases/37-docker-compose-integration/37-01-SUMMARY.md`
</output>
