---
phase: 06-web-ui
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/qm_nmr_calc/api/templates/submit.html
  - src/qm_nmr_calc/api/templates/status.html
  - src/qm_nmr_calc/api/routers/web.py
autonomous: true

must_haves:
  truths:
    - "User can enter SMILES in text field and submit form"
    - "User can upload MOL/SDF file and submit form"
    - "User can select solvent from dropdown (required)"
    - "User can select preset from dropdown (defaults to production)"
    - "User can optionally enter email for notifications"
    - "Successful submission redirects to status page"
    - "Status page shows job status and elapsed time"
    - "Status page auto-refreshes via polling"
    - "Status page auto-redirects to results on completion"
    - "Status page shows error message on failure"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/submit.html"
      provides: "Submission form with all input fields"
      contains: "enctype=\"multipart/form-data\""
    - path: "src/qm_nmr_calc/api/templates/status.html"
      provides: "Status display with polling JavaScript"
      contains: "setTimeout"
    - path: "src/qm_nmr_calc/api/routers/web.py"
      provides: "Submit and status routes"
      contains: "/submit"
  key_links:
    - from: "src/qm_nmr_calc/api/templates/submit.html"
      to: "/submit"
      via: "form action"
      pattern: "action=\"/submit\""
    - from: "src/qm_nmr_calc/api/templates/status.html"
      to: "/api/v1/jobs/{job_id}"
      via: "fetch in polling function"
      pattern: "fetch.*api/v1/jobs"
    - from: "src/qm_nmr_calc/api/routers/web.py"
      to: "API submission endpoints"
      via: "form processing logic"
      pattern: "validate_smiles|validate_mol_file"
---

<objective>
Create the submission form and job status pages with auto-refresh polling.

Purpose: Allow users to submit molecules via browser and monitor calculation progress with automatic updates and redirects.
Output: Working submission form at / and status page at /status/{job_id} with live polling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-web-ui/06-CONTEXT.md
@.planning/phases/06-web-ui/06-RESEARCH.md
@src/qm_nmr_calc/api/routers/web.py
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/solvents.py
@src/qm_nmr_calc/presets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submission form template</name>
  <files>src/qm_nmr_calc/api/templates/submit.html</files>
  <action>
Replace the placeholder submit.html with full submission form:

1. Extend base.html, set title to "Submit Job | QM NMR Calculator"

2. Create form with:
   - action="/submit" method="post" enctype="multipart/form-data"
   - Wrap in article element for Pico CSS card styling

3. SMILES input section:
   - Label "SMILES String"
   - Text input name="smiles" with placeholder "e.g., CCO for ethanol"
   - Small helper text explaining SMILES

4. File upload section:
   - Label "Or Upload MOL/SDF File"
   - File input name="file" accept=".mol,.sdf"
   - Small helper text about supported formats

5. Add JavaScript to handle mutual exclusion:
   - When SMILES input has value, disable file input (and vice versa)
   - Clear the opposite field when user types/selects
   - Add visual indication of which mode is active

6. Solvent dropdown (required):
   - Label "Solvent"
   - Select name="solvent" required
   - First option disabled+selected: "Select a solvent..."
   - Loop through solvents from context: `{% for key, desc in solvents.items() %}`
   - Option value is key, display text is description

7. Preset dropdown:
   - Label "Calculation Preset"
   - Select name="preset"
   - Options: production (default, "Production (accurate)"), draft ("Draft (fast)")

8. Optional name field:
   - Label "Molecule Name (optional)"
   - Text input name="name" placeholder="e.g., Caffeine"

9. Email notification field:
   - Label "Email Notification (optional)"
   - Email input name="notification_email" placeholder="your@email.com"
   - Small text: "Leave blank if you don't want email notification"

10. Submit button:
    - type="submit" text "Calculate NMR"
    - Full width using Pico CSS default

11. Error display area (hidden by default):
    - div with role="alert" class for showing validation errors
    - Will be populated by JavaScript if client-side validation fails
  </action>
  <verify>Template file exists and contains form with all required fields: `grep -c 'name="smiles"\|name="file"\|name="solvent"\|name="preset"' src/qm_nmr_calc/api/templates/submit.html`</verify>
  <done>Submit form has SMILES input, file upload, solvent dropdown, preset dropdown, optional email, and mutual exclusion JS</done>
</task>

<task type="auto">
  <name>Task 2: Create status page template with polling</name>
  <files>src/qm_nmr_calc/api/templates/status.html</files>
  <action>
Create status.html template:

1. Extend base.html, set title to "Job Status | QM NMR Calculator"

2. Article wrapper with:
   - Header: h2 "Job Status: {{ job.job_id }}"

3. Status display div (id="status-display"):
   - Status line: "Status: <span id="job-status">{{ job.status }}</span>"
   - Elapsed time: "Elapsed: <span id="elapsed-time">--</span>"
   - Molecule name if present: "Molecule: {{ job.input_name }}"
   - SMILES: "<code>{{ job.input_smiles }}</code>"
   - Solvent: "{{ job.solvent }}"
   - Preset: "{{ job.preset }}"

4. Error display div (id="error-display", hidden by default):
   - paragraph with role="alert" for error message
   - Styled with Pico CSS error colors

5. Footer:
   - Small text: "Page refreshes automatically while job is running"
   - Link back to submit new job: "Submit another job"

6. JavaScript in scripts block:
   - Constants: JOB_ID from template, CREATED_AT as Date object, POLL_INTERVAL = 3000

   - updateElapsedTime() function:
     - Calculate seconds since CREATED_AT
     - Format as "Xm Ys"
     - Update #elapsed-time text

   - checkStatus() async function (recursive setTimeout pattern):
     - fetch `/api/v1/jobs/${JOB_ID}`
     - Update #job-status with data.status
     - Call updateElapsedTime()
     - If status === 'complete': redirect to `/results/${JOB_ID}`
     - If status === 'failed': show error div with data.error_message
     - Else: setTimeout(checkStatus, POLL_INTERVAL)
     - Catch block: log error, retry with POLL_INTERVAL * 2

   - DOMContentLoaded listener:
     - Call checkStatus() to start polling
     - setInterval(updateElapsedTime, 1000) for live elapsed time
  </action>
  <verify>Template contains polling JS: `grep -c 'setTimeout\|checkStatus\|fetch' src/qm_nmr_calc/api/templates/status.html`</verify>
  <done>Status page displays job info, polls API, shows elapsed time, auto-redirects on completion, shows errors on failure</done>
</task>

<task type="auto">
  <name>Task 3: Add submit and status routes to web router</name>
  <files>src/qm_nmr_calc/api/routers/web.py</files>
  <action>
Update web.py router:

1. Add imports:
   - Form, UploadFile from fastapi
   - RedirectResponse from fastapi.responses
   - Annotated, Optional from typing
   - validate_smiles, validate_mol_file from ...validation
   - validate_solvent from ...solvents
   - get_versions from ...isicle_wrapper
   - create_job_directory, load_job_status from ...storage
   - run_nmr_task from ...tasks
   - Chem from rdkit
   - SUPPORTED_SOLVENTS from ...solvents

2. Update home route (/):
   - Pass solvents=SUPPORTED_SOLVENTS to template context
   - Pass presets with human-readable descriptions

3. Add POST /submit route:
   - Accept form data: smiles (str, optional), file (UploadFile, optional), solvent (str), preset (str), name (str, optional), notification_email (str, optional)
   - Validate that at least one of smiles or file is provided
   - If smiles provided: validate with validate_smiles()
   - If file provided: read content, validate with validate_mol_file(), convert to SMILES
   - Validate solvent with validate_solvent()
   - Get versions, create job directory, queue task (reuse logic from jobs.py)
   - On success: RedirectResponse to /status/{job_id} with status_code=303
   - On validation error: Re-render submit.html with error message in context

4. Add GET /status/{job_id} route:
   - Load job status
   - If not found: return 404 error page (or redirect to home with error)
   - Render status.html with job context

5. Add GET /results/{job_id} route (placeholder for now - will be completed in Plan 03):
   - Load job status
   - Return placeholder "Results page coming soon" or minimal template
  </action>
  <verify>
Routes exist: `python -c "from qm_nmr_calc.api.routers.web import router; print([r.path for r in router.routes])"`
Should show: /, /submit, /status/{job_id}, /results/{job_id}
  </verify>
  <done>Web router has home, submit, status, and results routes; form submission creates job and redirects to status page</done>
</task>

</tasks>

<verification>
1. Start dev server if not running
2. Load home page: curl http://localhost:8000/ - should show form HTML
3. Check form has all fields: solvent dropdown populated, preset dropdown present
4. Test form submission (requires running Huey consumer for full test):
   - Submit with SMILES: verify redirect to /status/{job_id}
   - Check status page shows job info and starts polling
5. Test validation errors:
   - Submit empty form: should show error
   - Submit invalid SMILES: should show error
   - Submit invalid solvent: should show error
</verification>

<success_criteria>
- Form displays with SMILES input, file upload, solvent/preset dropdowns, email field
- SMILES and file inputs have mutual exclusion behavior
- Form submission with valid SMILES redirects to status page
- Status page shows job ID, status, elapsed time
- Status page polls /api/v1/jobs/{job_id} every 3 seconds
- Status auto-redirects to /results/{job_id} on completion
- Status shows error message on failure (stays on page)
- Form validation errors displayed without losing input
</success_criteria>

<output>
After completion, create `.planning/phases/06-web-ui/06-02-SUMMARY.md`
</output>
