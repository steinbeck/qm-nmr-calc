---
phase: 06-web-ui
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/qm_nmr_calc/api/templates/results.html
  - src/qm_nmr_calc/api/routers/web.py
  - src/qm_nmr_calc/api/static/css/custom.css
autonomous: true

must_haves:
  truths:
    - "User can view calculation metadata (preset, solvent, functional, basis set)"
    - "User can see annotated structure image"
    - "User can see 1H NMR spectrum image"
    - "User can see 13C NMR spectrum image"
    - "User can click any image to enlarge in modal"
    - "User can download geometry (XYZ and SDF)"
    - "User can download raw output (ZIP)"
    - "User can navigate back to submit new job"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/results.html"
      provides: "Results display with images, metadata, downloads, and modal"
      contains: "dialog"
    - path: "src/qm_nmr_calc/api/routers/web.py"
      provides: "Complete results route with job loading"
      contains: "/results/{job_id}"
  key_links:
    - from: "src/qm_nmr_calc/api/templates/results.html"
      to: "/api/v1/jobs/{job_id}/spectrum/1h.png"
      via: "img src"
      pattern: "src.*spectrum/1h.png"
    - from: "src/qm_nmr_calc/api/templates/results.html"
      to: "/api/v1/jobs/{job_id}/structure.png"
      via: "img src"
      pattern: "src.*structure.png"
    - from: "src/qm_nmr_calc/api/routers/web.py"
      to: "load_job_status"
      via: "function call"
      pattern: "load_job_status"
---

<objective>
Create the results page with image grid, calculation metadata, download links, and image lightbox modal.

Purpose: Provide users a comprehensive view of completed NMR calculations with visualizations, metadata, and easy access to all downloadable files.
Output: Working results page at /results/{job_id} with side-by-side images, metadata card, download section, and click-to-enlarge modal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-web-ui/06-CONTEXT.md
@.planning/phases/06-web-ui/06-RESEARCH.md
@src/qm_nmr_calc/api/routers/web.py
@src/qm_nmr_calc/api/routers/jobs.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create results page template</name>
  <files>src/qm_nmr_calc/api/templates/results.html</files>
  <action>
Create results.html template:

1. Extend base.html, set title to "Results: {{ job.input_name or job.job_id }} | QM NMR Calculator"

2. Page header:
   - h2 "NMR Calculation Results"
   - Subheading with molecule name or job ID

3. Calculation Metadata article:
   - Header: "Calculation Details"
   - Grid layout (Pico CSS grid class) with 2 columns:
     - Preset: {{ job.preset }}
     - Solvent: {{ job.solvent }}
     - Functional: {{ results.functional }}
     - Basis Set: {{ results.basis_set }}
   - Also show SMILES as code block

4. Visualizations article:
   - Header: "Visualizations"
   - Small text: "Click any image to enlarge"
   - Grid with 3 columns (using Pico CSS grid):

   - Figure 1: Annotated Structure
     - img src="/api/v1/jobs/{{ job.job_id }}/structure.png"
     - alt="Annotated molecular structure"
     - onclick="openModal(this.src)"
     - style="cursor: pointer"
     - figcaption: "Annotated Structure"

   - Figure 2: 1H NMR Spectrum
     - img src="/api/v1/jobs/{{ job.job_id }}/spectrum/1h.png"
     - alt="1H NMR spectrum"
     - onclick="openModal(this.src)"
     - figcaption: "1H NMR Spectrum"

   - Figure 3: 13C NMR Spectrum
     - img src="/api/v1/jobs/{{ job.job_id }}/spectrum/13c.png"
     - alt="13C NMR spectrum"
     - onclick="openModal(this.src)"
     - figcaption: "13C NMR Spectrum"

5. Downloads article:
   - Header: "Downloads"
   - Grid with download buttons (using role="button" links):
     - "Geometry (XYZ)" -> /api/v1/jobs/{{ job.job_id }}/geometry
     - "Geometry (SDF)" -> /api/v1/jobs/{{ job.job_id }}/geometry.sdf
     - "Raw Output (ZIP)" -> /api/v1/jobs/{{ job.job_id }}/output
     - "1H Spectrum (PNG)" -> /api/v1/jobs/{{ job.job_id }}/spectrum/1h.png (download attribute)
     - "13C Spectrum (PNG)" -> /api/v1/jobs/{{ job.job_id }}/spectrum/13c.png (download attribute)
     - "Structure (PNG)" -> /api/v1/jobs/{{ job.job_id }}/structure.png (download attribute)
   - Use secondary button style (class="secondary") for downloads

6. Navigation:
   - Link back to home: "Submit another job"

7. Image Modal (native HTML dialog):
   - dialog id="image-modal"
   - article wrapper with header containing close button (aria-label="Close", rel="prev")
   - img id="modal-image" with max-width: 100%, max-height: 80vh

8. Scripts block with modal JavaScript:
   - const modal = document.getElementById('image-modal')

   - openModal(src) function:
     - Set modal-image src to provided src
     - modal.showModal()
     - document.body.classList.add('modal-is-open')

   - closeModal() function:
     - modal.close()
     - document.body.classList.remove('modal-is-open')

   - Backdrop click handler (close when clicking outside):
     - modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); })

   - Cancel event handler (Escape key):
     - modal.addEventListener('cancel', closeModal)
  </action>
  <verify>Template has images, downloads, modal: `grep -c 'spectrum/1h.png\|structure.png\|dialog\|openModal' src/qm_nmr_calc/api/templates/results.html`</verify>
  <done>Results page shows metadata, three images in grid, download section, and working image modal</done>
</task>

<task type="auto">
  <name>Task 2: Complete results route in web router</name>
  <files>src/qm_nmr_calc/api/routers/web.py</files>
  <action>
Update the /results/{job_id} route in web.py (replace placeholder from Plan 02):

1. GET /results/{job_id} route:
   - response_class=HTMLResponse

2. Load job status using load_job_status(job_id)

3. If job not found:
   - Return error template or redirect to home with error message
   - Could create a simple error.html template or re-render submit.html with error

4. If job status is not 'complete':
   - Redirect to /status/{job_id} (let status page handle non-complete jobs)

5. If job is complete but nmr_results is None:
   - Show error: "Job completed but no results available"

6. Build context for template:
   - job: dict with job_id, input_smiles, input_name, preset, solvent, status
   - results: dict with functional, basis_set, solvent (from nmr_results)

7. Return TemplateResponse with results.html and context

Note: The template accesses images via API endpoints which already exist and handle all error cases. No need to pre-check image existence.
  </action>
  <verify>`python -c "from qm_nmr_calc.api.routers.web import router; [print(r.path, r.methods) for r in router.routes]"` - shows /results/{job_id} with GET</verify>
  <done>Results route loads job, checks completion, renders results.html with job and results context</done>
</task>

<task type="auto">
  <name>Task 3: Add CSS for results page layout</name>
  <files>src/qm_nmr_calc/api/static/css/custom.css</files>
  <action>
Update custom.css with results page styles:

1. Image grid styling:
   - .results-images figure img should have max-height to fit nicely
   - cursor: pointer on clickable images
   - hover effect (slight scale or shadow)

2. Modal image styling:
   - #modal-image max-height: 80vh, object-fit: contain
   - Ensure modal article has appropriate max-width for large images

3. Download button grid:
   - Ensure download buttons wrap nicely on smaller screens
   - gap between buttons

4. Metadata grid:
   - Label styling (bold or muted color)
   - Value styling

5. General adjustments:
   - figure elements should have text-align: center for captions
   - figcaption styling (smaller text, muted color)

Keep styles minimal - Pico CSS handles most of the heavy lifting.
  </action>
  <verify>CSS file updated: `cat src/qm_nmr_calc/api/static/css/custom.css`</verify>
  <done>Custom CSS provides clean layout for results page images, downloads, and modal</done>
</task>

</tasks>

<verification>
1. Start dev server if not running
2. Need a completed job to test results page:
   - Either use existing completed job from test runs
   - Or submit new job and wait for completion (if Huey consumer running)
3. Load results page: GET /results/{job_id}
   - Verify metadata card shows preset, solvent, functional, basis set
   - Verify three images display side by side
   - Click image: verify modal opens with enlarged image
   - Click backdrop or press Escape: verify modal closes
   - Click download buttons: verify files download
4. Test edge cases:
   - /results/nonexistent-id: should show error or redirect
   - /results/{incomplete-job}: should redirect to status page
</verification>

<success_criteria>
- Results page shows calculation metadata (preset, solvent, functional, basis set)
- Three images (structure, 1H spectrum, 13C spectrum) display side by side
- Clicking image opens modal with enlarged view
- Modal closes on backdrop click or Escape key
- All six download links work (XYZ, SDF, ZIP, 3 PNGs)
- Navigation link back to home page works
- Non-existent job returns appropriate error
- Incomplete job redirects to status page
</success_criteria>

<output>
After completion, create `.planning/phases/06-web-ui/06-03-SUMMARY.md`
</output>
