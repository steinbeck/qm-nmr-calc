---
phase: 15-multi-conformer-nwchem-integration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/output_parser.py
  - src/qm_nmr_calc/nwchem/__init__.py
  - tests/test_nwchem_output.py
autonomous: true

must_haves:
  truths:
    - "extract_dft_energy() returns float energy in Hartree from NWChem optimization output"
    - "extract_dft_energy() finds the LAST 'Total DFT energy' line (final optimization cycle)"
    - "extract_dft_energy() raises RuntimeError when energy line is missing from output"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/output_parser.py"
      provides: "extract_dft_energy function"
      contains: "def extract_dft_energy"
    - path: "tests/test_nwchem_output.py"
      provides: "Tests for DFT energy extraction"
      contains: "test_extract_dft_energy"
  key_links:
    - from: "src/qm_nmr_calc/nwchem/output_parser.py"
      to: "tests/fixtures/nwchem_optimization_output.txt"
      via: "Regex parsing 'Total DFT energy:' line"
      pattern: "Total\\s+DFT\\s+energy"
    - from: "src/qm_nmr_calc/nwchem/__init__.py"
      to: "src/qm_nmr_calc/nwchem/output_parser.py"
      via: "Re-export extract_dft_energy"
      pattern: "extract_dft_energy"
---

<objective>
Add DFT energy extraction to NWChem output parser for Boltzmann weighting.

Purpose: Phase 15 needs DFT energies from geometry optimization output to calculate Boltzmann weights. NWChem outputs "Total DFT energy: -40.51864189" in Hartree units (confirmed at line 109 of test fixture). This function extracts that value.

Output: `extract_dft_energy()` function in output_parser.py, tested against existing fixture, exported from nwchem package.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/qm_nmr_calc/nwchem/output_parser.py
@src/qm_nmr_calc/nwchem/__init__.py
@tests/test_nwchem_output.py
@tests/fixtures/nwchem_optimization_output.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for extract_dft_energy</name>
  <files>tests/test_nwchem_output.py</files>
  <action>
Add test cases to the existing test_nwchem_output.py file:

1. `test_extract_dft_energy_from_fixture()` - Load `tests/fixtures/nwchem_optimization_output.txt`, call `extract_dft_energy()`, assert returns `-40.51864189` (float, Hartree). Use `pytest.approx()` for float comparison.

2. `test_extract_dft_energy_from_inline_text()` - Test with inline string containing a "Total DFT energy:" line. Verify correct float extraction.

3. `test_extract_dft_energy_last_occurrence()` - NWChem optimization output may contain multiple "Total DFT energy:" lines (one per optimization cycle). Test with inline text containing multiple occurrences; assert the LAST one is returned (final optimized energy).

4. `test_extract_dft_energy_missing_raises()` - Test with text that has no energy line. Assert `RuntimeError` is raised with descriptive message.

5. `test_extract_dft_energy_negative_value()` - DFT energies are always negative for bound molecules. Verify negative value extracted correctly.

Import `extract_dft_energy` from `qm_nmr_calc.nwchem.output_parser`.

Run tests - they MUST fail (function doesn't exist yet).
  </action>
  <verify>Run `cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_nwchem_output.py -v --tb=short` - all new tests should FAIL with ImportError or AttributeError.</verify>
  <done>5 failing test cases exist covering: fixture extraction, inline extraction, last-occurrence behavior, missing-energy error, negative value handling.</done>
</task>

<task type="auto">
  <name>Task 2: Implement extract_dft_energy and export</name>
  <files>src/qm_nmr_calc/nwchem/output_parser.py, src/qm_nmr_calc/nwchem/__init__.py</files>
  <action>
Add `extract_dft_energy()` to output_parser.py:

```python
def extract_dft_energy(output_text: str) -> float:
    """Extract total DFT energy from NWChem optimization output.

    Finds the LAST occurrence of "Total DFT energy:" in the output,
    which corresponds to the final optimization cycle energy.

    Args:
        output_text: Full NWChem output file content as string.

    Returns:
        Total DFT energy in Hartree (atomic units). Always negative for bound molecules.

    Raises:
        RuntimeError: If no "Total DFT energy:" line found in output.
    """
```

Implementation notes:
- Use `re.findall()` (not `re.search()`) to find ALL occurrences, then take the LAST one. This handles multi-cycle optimization output where intermediate energies also appear.
- Pattern: `r"Total\s+DFT\s+energy:\s+([-+]?\d+\.\d+)"` with `re.IGNORECASE`
- Return `float(match_group)`
- Raise RuntimeError with clear message if no matches found

Then update `src/qm_nmr_calc/nwchem/__init__.py`:
- Import `extract_dft_energy` from `output_parser`
- Add to `__all__` list

Run all tests - new tests MUST pass, existing tests MUST still pass.
  </action>
  <verify>Run `cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_nwchem_output.py -v --tb=short` - all tests pass including new ones. Then run `cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/ -v --tb=short` - full suite passes.</verify>
  <done>extract_dft_energy() implemented, exported from nwchem package, all tests green. Returns -40.51864189 from fixture. Handles multiple occurrences by returning last. Raises RuntimeError on missing energy line.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_nwchem_output.py -v` -- all tests pass
2. `python -c "from qm_nmr_calc.nwchem import extract_dft_energy; print(extract_dft_energy.__doc__[:50])"` -- function importable from package
3. `python -m pytest tests/ -v` -- full suite green, no regressions
</verification>

<success_criteria>
- extract_dft_energy() parses "Total DFT energy:" from NWChem output
- Returns float in Hartree (e.g., -40.51864189)
- Takes LAST occurrence for multi-cycle optimization
- Raises RuntimeError on missing energy line
- Exported from qm_nmr_calc.nwchem package
- 5+ tests covering fixture, inline, multi-occurrence, missing, negative
</success_criteria>

<output>
After completion, create `.planning/phases/15-multi-conformer-nwchem-integration/15-01-SUMMARY.md`
</output>
