---
phase: 11.2-vacuum-benchmark-calculations
plan: 01
subsystem: nwchem
tags: [vacuum, gas-phase, cosmo, benchmark, scaling-factors]

# Dependency graph
requires:
  - phase: 09-benchmark-calculations
    provides: DELTA50 benchmark infrastructure and runner
  - phase: 10-scaling-factors
    provides: shielding_to_shift() function and scaling factor loading
provides:
  - Vacuum (gas-phase) input generation without COSMO block
  - Benchmark runner vacuum support with graceful missing-factor handling
  - Foundation for vacuum benchmark execution in Plan 02
affects: [11.2-02, 11.2-03, scaling-factors, production-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Conditional COSMO block generation based on solvent value
    - Graceful ValueError handling for missing scaling factors

key-files:
  created: []
  modified:
    - src/qm_nmr_calc/nwchem/input_gen.py
    - src/qm_nmr_calc/nwchem/runner.py
    - src/qm_nmr_calc/benchmark/runner.py
    - tests/test_nwchem_input.py

key-decisions:
  - "Vacuum as special solvent value (not separate parameter)"
  - "COSMO block omitted entirely for vacuum (not do_gasphase True)"
  - "Save shielding data even without shift conversion for factor derivation"

patterns-established:
  - "Solvent validation returns normalized name, including 'vacuum'"
  - "Try/except for optional scaling factor lookup with info logging"

# Metrics
duration: 8min
completed: 2026-01-25
---

# Phase 11.2 Plan 01: Enable Vacuum Calculations Summary

**Gas-phase NMR calculation support via vacuum solvent option, omitting COSMO block from NWChem input and handling missing scaling factors gracefully in benchmark runner**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-25T14:30:00Z
- **Completed:** 2026-01-25T14:38:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- NWChem input generation accepts "vacuum" and produces gas-phase input without COSMO block
- Benchmark runner handles missing scaling factors gracefully (saves shielding data for later factor derivation)
- Updated tests to match current implementation and added vacuum-specific test suite
- All existing CHCl3/DMSO functionality preserved

## Task Commits

Each task was committed atomically:

1. **Task 1: Add vacuum support to input_gen.py** - `3660300` (feat)
2. **Task 2: Update runner.py to support vacuum** - `20c911f` (docs)
3. **Task 3: Add vacuum to benchmark runner configuration** - `b334953` (feat)

## Files Created/Modified
- `src/qm_nmr_calc/nwchem/input_gen.py` - Added vacuum to SUPPORTED_SOLVENTS, conditional COSMO block generation
- `src/qm_nmr_calc/nwchem/runner.py` - Updated docstring to document vacuum support
- `src/qm_nmr_calc/benchmark/runner.py` - Handle missing scaling factors, updated docstrings
- `tests/test_nwchem_input.py` - Fixed outdated tests, added TestVacuumSupport class

## Decisions Made
- **Vacuum as solvent value:** Treat vacuum as a special solvent rather than adding a separate `use_cosmo` flag. Simpler API, clear intent.
- **Complete COSMO omission:** When vacuum, omit entire COSMO block rather than using `do_gasphase True`. Cleaner NWChem input.
- **Graceful factor handling:** Save shielding data even when scaling factors unavailable. This allows benchmark to collect data for deriving vacuum factors in Plan 03.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed outdated test assertions**
- **Found during:** Task 3 verification
- **Issue:** Tests expected `dielec X.X` syntax but implementation uses NWChem's `solvent name` format
- **Fix:** Updated tests to check for `solvent chcl3` instead of `dielec 4.8`, added vacuum test class
- **Files modified:** tests/test_nwchem_input.py
- **Verification:** All 90 unit tests pass
- **Committed in:** b334953 (Task 3 commit)

---

**Total deviations:** 1 auto-fixed (1 bug fix)
**Impact on plan:** Tests were out of sync with implementation. Fix necessary for CI to pass.

## Issues Encountered
- Integration test `test_methane_optimization` fails due to NWChem geometry handling error (pre-existing, unrelated to this plan)

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Vacuum input generation ready for benchmark execution (Plan 02)
- Benchmark runner can process vacuum calculations
- Shielding data will be saved for scaling factor derivation (Plan 03)

---
*Phase: 11.2-vacuum-benchmark-calculations*
*Completed: 2026-01-25*
