---
phase: 11.2-vacuum-benchmark-calculations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/input_gen.py
  - src/qm_nmr_calc/nwchem/runner.py
  - src/qm_nmr_calc/benchmark/runner.py
autonomous: true

must_haves:
  truths:
    - "NWChem input generation accepts vacuum as solvent (no COSMO block)"
    - "Benchmark runner can execute vacuum calculations"
    - "Existing CHCl3/DMSO functionality remains intact"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/input_gen.py"
      provides: "Vacuum-aware input generation"
      contains: "vacuum"
    - path: "src/qm_nmr_calc/nwchem/runner.py"
      provides: "Vacuum-aware calculation execution"
      contains: "vacuum"
    - path: "src/qm_nmr_calc/benchmark/runner.py"
      provides: "Vacuum as solvent option in benchmark matrix"
      contains: "vacuum"
  key_links:
    - from: "src/qm_nmr_calc/benchmark/runner.py"
      to: "src/qm_nmr_calc/nwchem/runner.py"
      via: "run_calculation(solvent='vacuum')"
      pattern: "solvent.*vacuum"
    - from: "src/qm_nmr_calc/nwchem/runner.py"
      to: "src/qm_nmr_calc/nwchem/input_gen.py"
      via: "generate_*_input(solvent='vacuum')"
      pattern: "solvent.*vacuum"
---

<objective>
Enable vacuum (gas-phase) calculations by modifying input generation and benchmark runner

Purpose: Allow NMR benchmark calculations without COSMO solvation to derive gas-phase scaling factors
Output: Modified input_gen.py, runner.py, and benchmark/runner.py that support vacuum as a solvent option
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/qm_nmr_calc/nwchem/input_gen.py
@src/qm_nmr_calc/nwchem/runner.py
@src/qm_nmr_calc/benchmark/runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vacuum support to input_gen.py</name>
  <files>src/qm_nmr_calc/nwchem/input_gen.py</files>
  <action>
Modify input_gen.py to support vacuum (no COSMO block):

1. Add "vacuum" to SUPPORTED_SOLVENTS set (or handle it specially)

2. Modify `_validate_solvent()`:
   - Accept "vacuum" as a valid solvent value
   - Return "vacuum" when vacuum is requested

3. Modify `generate_optimization_input()`:
   - Check if solvent == "vacuum"
   - If vacuum: omit the entire COSMO block from the template
   - If not vacuum: include COSMO block as before
   - Use conditional template construction (simple string building, not Jinja2)

4. Modify `generate_shielding_input()`:
   - Same logic: if vacuum, omit COSMO block; otherwise include it

Example vacuum output (no COSMO block):
```
start molecule
title "Geometry Optimization"

memory global 1600 mb heap 100 mb stack 600 mb

geometry units angstrom noautoz noautosym
...
end

basis spherical
  * library 6-31G*
end

dft
  xc b3lyp
end

driver
  maxiter 150
  xyz molecule_geom
end

task dft optimize
```

For non-vacuum, keep existing COSMO block:
```
cosmo
  do_gasphase False
  solvent chcl3
end
```

IMPORTANT: Do not break existing CHCl3/DMSO functionality. Vacuum is additive.
  </action>
  <verify>
Run existing tests to ensure no regression:
```bash
cd /home/chris/develop/qm-nmr-calc && uv run pytest tests/test_nwchem_input.py -v
```

Manually verify vacuum input generation:
```python
from qm_nmr_calc.nwchem.input_gen import generate_optimization_input, generate_shielding_input

# Test vacuum
opt_input = generate_optimization_input("H 0 0 0\nH 0 0 1", "b3lyp", "6-31G*", "vacuum")
assert "cosmo" not in opt_input.lower()
assert "task dft optimize" in opt_input

shielding_input = generate_shielding_input("H 0 0 0\nH 0 0 1", "b3lyp", "6-31G*", "vacuum")
assert "cosmo" not in shielding_input.lower()
assert "task dft property" in shielding_input

# Test CHCl3 still works
opt_chcl3 = generate_optimization_input("H 0 0 0\nH 0 0 1", "b3lyp", "6-31G*", "chcl3")
assert "cosmo" in opt_chcl3.lower()
assert "solvent chcl3" in opt_chcl3.lower()
```
  </verify>
  <done>
- generate_optimization_input accepts "vacuum" and produces NWChem input without COSMO block
- generate_shielding_input accepts "vacuum" and produces NWChem input without COSMO block
- Existing CHCl3/DMSO inputs unchanged (COSMO block present)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update runner.py to support vacuum</name>
  <files>src/qm_nmr_calc/nwchem/runner.py</files>
  <action>
The runner.py file calls generate_optimization_input() and generate_shielding_input() with the solvent parameter. Since Task 1 modified input_gen.py to accept "vacuum", runner.py should work without changes.

However, verify that:
1. run_calculation() passes solvent through correctly
2. No validation in runner.py blocks "vacuum" as a solvent value

If any validation exists that blocks vacuum, update it.

The function signature is already:
```python
def run_calculation(
    smiles: str,
    job_dir: Path,
    preset: dict,
    solvent: str,  # This accepts any string, passed to input_gen
    ...
)
```

This should work as-is if input_gen.py accepts vacuum. Verify by inspection.
  </action>
  <verify>
Read runner.py and confirm:
1. No hardcoded solvent validation that would block "vacuum"
2. Solvent is passed through to generate_*_input() without modification

If runner.py needs no changes, document that in the summary.
  </verify>
  <done>
- runner.py supports vacuum by virtue of passing solvent string to input_gen.py
- No blocking validation prevents vacuum usage
  </done>
</task>

<task type="auto">
  <name>Task 3: Add vacuum to benchmark runner configuration</name>
  <files>src/qm_nmr_calc/benchmark/runner.py</files>
  <action>
Modify benchmark/runner.py to support vacuum:

1. Add "vacuum" to SOLVENTS list (currently ["CHCl3", "DMSO"]):
   ```python
   SOLVENTS = ["CHCl3", "DMSO", "vacuum"]
   ```

   WAIT - this would run vacuum for ALL benchmarks by default. Instead, keep SOLVENTS as-is and allow vacuum to be passed via CLI.

2. Better approach: Leave SOLVENTS default unchanged, but ensure vacuum can be passed via the `solvents` parameter to `run_benchmark()` and `build_task_matrix()`.

3. Verify run_single_calculation() handles vacuum:
   - It calls `run_calculation(..., solvent=solvent.lower(), ...)`
   - For vacuum, this passes "vacuum" (already lowercase)
   - This should work with Task 1 changes

4. Verify shielding_to_shift() call in run_single_calculation():
   - Currently calls `shielding_to_shift(..., solvent=solvent, ...)`
   - For vacuum, scaling factors won't exist yet (created in Plan 03)
   - The benchmark runner will fail on shift conversion until factors exist

   SOLUTION: Modify run_single_calculation() to skip shift conversion if no scaling factor exists for the combination. Instead, just save raw shielding data.

   Updated logic:
   ```python
   try:
       shifts_data = shielding_to_shift(...)
       h1_shifts = [s["shift"] for s in shifts_data["1H"]]
       c13_shifts = [s["shift"] for s in shifts_data["13C"]]
   except ValueError:
       # No scaling factor for this combination - save raw shielding only
       h1_shifts = []
       c13_shifts = []
   ```

   This allows benchmarks to complete even without scaling factors (factors derived later).

5. Update show_status() to not hardcode total_tasks = 50 * len(FUNCTIONALS) * len(SOLVENTS).
   Instead, read actual completed files dynamically.

Actually, re-reading the code, show_status() already counts files dynamically, so no change needed there.
  </action>
  <verify>
```bash
cd /home/chris/develop/qm-nmr-calc && uv run pytest tests/test_benchmark_runner.py -v 2>/dev/null || echo "No specific tests"
```

Verify benchmark runner can be invoked with vacuum:
```python
from qm_nmr_calc.benchmark.runner import build_task_matrix

# Build matrix with vacuum only
tasks = build_task_matrix(
    molecules=["compound_01"],
    functionals=["B3LYP"],
    solvents=["vacuum"]
)
assert len(tasks) == 1
assert tasks[0]["solvent"] == "vacuum"
```
  </verify>
  <done>
- build_task_matrix() accepts "vacuum" in solvents list
- run_single_calculation() handles missing scaling factors gracefully (saves shielding data without shift conversion)
- Benchmark runner can execute vacuum calculations
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Unit test existing functionality unchanged:
   ```bash
   cd /home/chris/develop/qm-nmr-calc && uv run pytest tests/ -v -x
   ```

2. Manual integration test (dry run without actual NWChem):
   ```python
   from qm_nmr_calc.nwchem.input_gen import generate_optimization_input
   from qm_nmr_calc.benchmark.runner import build_task_matrix

   # Input gen works for vacuum
   inp = generate_optimization_input("H 0 0 0", "b3lyp", "6-31G*", "vacuum")
   assert "cosmo" not in inp.lower()

   # Task matrix works for vacuum
   tasks = build_task_matrix(molecules=["compound_01"], functionals=["B3LYP"], solvents=["vacuum"])
   assert tasks[0]["solvent"] == "vacuum"
   ```
</verification>

<success_criteria>
- [ ] generate_optimization_input accepts "vacuum" and omits COSMO block
- [ ] generate_shielding_input accepts "vacuum" and omits COSMO block
- [ ] Existing CHCl3/DMSO functionality unchanged
- [ ] build_task_matrix accepts vacuum in solvents list
- [ ] run_single_calculation handles missing scaling factors gracefully
- [ ] All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11.2-vacuum-benchmark-calculations/11.2-01-SUMMARY.md`
</output>
