---
phase: 11.2-vacuum-benchmark-calculations
plan: 03
type: execute
wave: 3
depends_on: ["11.2-02"]
files_modified:
  - src/qm_nmr_calc/data/scaling_factors.json
  - src/qm_nmr_calc/shifts.py
  - data/benchmark/delta50/SCALING-FACTORS.md
  - data/benchmark/delta50/scaling_factors.json
autonomous: true

must_haves:
  truths:
    - "Vacuum scaling factors derived via linear regression"
    - "Production system accepts vacuum as solvent"
    - "Vacuum scaling factors have comparable R^2 to solvated factors"
  artifacts:
    - path: "src/qm_nmr_calc/data/scaling_factors.json"
      provides: "Production scaling factors including vacuum"
      contains: "vacuum"
    - path: "data/benchmark/delta50/scaling_factors.json"
      provides: "Benchmark scaling factors with vacuum entries"
      contains: "vacuum"
    - path: "data/benchmark/delta50/SCALING-FACTORS.md"
      provides: "Updated report with vacuum factor statistics"
      contains: "vacuum"
  key_links:
    - from: "src/qm_nmr_calc/shifts.py"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "load_scaling_factors() reads JSON with vacuum entries"
      pattern: "vacuum"
    - from: "src/qm_nmr_calc/nwchem/input_gen.py"
      to: "src/qm_nmr_calc/shifts.py"
      via: "vacuum solvent flows through calculation to shift conversion"
      pattern: "vacuum"
---

<objective>
Derive vacuum scaling factors and integrate into production system

Purpose: Complete vacuum benchmark by deriving scaling factors and enabling vacuum NMR predictions
Output: Vacuum scaling factors in production JSON, updated analysis report
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11.2-vacuum-benchmark-calculations/11.2-02-SUMMARY.md

@src/qm_nmr_calc/benchmark/analysis.py
@src/qm_nmr_calc/shifts.py
@src/qm_nmr_calc/data/scaling_factors.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Derive vacuum scaling factors</name>
  <files>data/benchmark/delta50/scaling_factors.json, data/benchmark/delta50/SCALING-FACTORS.md</files>
  <action>
Run scaling factor analysis for vacuum:

1. First, update analysis.py to support vacuum in derive_all_factors():
   - Modify derive_all_factors() to accept vacuum as a solvent
   - Or call it directly with solvents=["vacuum"]

2. Derive factors using existing analysis infrastructure:

```python
from qm_nmr_calc.benchmark.analysis import (
    aggregate_regression_data,
    fit_scaling_factors,
    get_factor_key,
    save_factors_json,
    BENCHMARK_PRESETS,
)
from pathlib import Path

# Aggregate vacuum data
df = aggregate_regression_data("B3LYP", "vacuum")
print(f"Vacuum data points: {len(df)}")
print(f"1H points: {len(df[df['nucleus'] == '1H'])}")
print(f"13C points: {len(df[df['nucleus'] == '13C'])}")

# Fit scaling factors
h1_factor = fit_scaling_factors(df, "1H")
c13_factor = fit_scaling_factors(df, "13C")

print(f"1H vacuum: slope={h1_factor.slope:.4f}, intercept={h1_factor.intercept:.2f}, R^2={h1_factor.r_squared:.4f}, MAE={h1_factor.mae:.3f}")
print(f"13C vacuum: slope={c13_factor.slope:.4f}, intercept={c13_factor.intercept:.2f}, R^2={c13_factor.r_squared:.4f}, MAE={c13_factor.mae:.3f}")

# Build factor dict
basis_set = BENCHMARK_PRESETS["B3LYP"]["nmr_basis_set"]
factors = {
    get_factor_key("B3LYP", basis_set, "1H", "vacuum"): h1_factor,
    get_factor_key("B3LYP", basis_set, "13C", "vacuum"): c13_factor,
}

# Save to benchmark directory (will be copied to production in Task 2)
output_dir = Path("data/benchmark/delta50")
save_factors_json(factors, output_dir / "vacuum_scaling_factors.json")
```

3. Regenerate full report with vacuum included:

Either modify derive_all_factors() to include vacuum, or manually merge vacuum factors and regenerate report.

Option A - Quick: Just derive vacuum factors separately and merge:
```python
import orjson
from pathlib import Path

# Load existing factors
existing = orjson.loads(Path("data/benchmark/delta50/scaling_factors.json").read_bytes())

# Add vacuum factors
existing["B3LYP/6-311+G(2d,p)/1H/vacuum"] = {
    "slope": h1_factor.slope,
    "intercept": h1_factor.intercept,
    "r_squared": h1_factor.r_squared,
    "mae": h1_factor.mae,
    "rmsd": h1_factor.rmsd,
    "n_points": h1_factor.n_points,
    "ci_slope": list(h1_factor.ci_slope),
    "ci_intercept": list(h1_factor.ci_intercept),
    "outliers_removed": h1_factor.outliers_removed,
}
existing["B3LYP/6-311+G(2d,p)/13C/vacuum"] = {
    "slope": c13_factor.slope,
    "intercept": c13_factor.intercept,
    "r_squared": c13_factor.r_squared,
    "mae": c13_factor.mae,
    "rmsd": c13_factor.rmsd,
    "n_points": c13_factor.n_points,
    "ci_slope": list(c13_factor.ci_slope),
    "ci_intercept": list(c13_factor.ci_intercept),
    "outliers_removed": c13_factor.outliers_removed,
}

# Save updated factors
Path("data/benchmark/delta50/scaling_factors.json").write_bytes(
    orjson.dumps(existing, option=orjson.OPT_INDENT_2)
)
```

Option B - Full: Modify analysis.py derive_all_factors() to include vacuum in default solvents list, then regenerate report.

Use Option A for speed, or Option B if you want the full report regenerated with vacuum plots.
  </action>
  <verify>
Verify vacuum factors derived:
```bash
cat /home/chris/develop/qm-nmr-calc/data/benchmark/delta50/scaling_factors.json | python -m json.tool | grep -A 15 "vacuum"
```

Check factor quality (R^2 should be > 0.99):
```python
import orjson
from pathlib import Path

factors = orjson.loads(Path("data/benchmark/delta50/scaling_factors.json").read_bytes())
for key in factors:
    if "vacuum" in key:
        f = factors[key]
        print(f"{key}: R^2={f['r_squared']:.4f}, MAE={f['mae']:.3f} ppm")
```
  </verify>
  <done>
- Vacuum scaling factors derived for 1H and 13C
- R^2 > 0.99 for both nuclei (comparable to solvated factors)
- Factors saved to data/benchmark/delta50/scaling_factors.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Update production scaling factors</name>
  <files>src/qm_nmr_calc/data/scaling_factors.json</files>
  <action>
Copy vacuum factors to production data directory:

1. Load benchmark factors with vacuum entries
2. Update production scaling_factors.json

```python
import orjson
from pathlib import Path

# Load benchmark factors (now includes vacuum)
benchmark_factors = orjson.loads(
    Path("data/benchmark/delta50/scaling_factors.json").read_bytes()
)

# Load production factors
production_path = Path("src/qm_nmr_calc/data/scaling_factors.json")
production_factors = orjson.loads(production_path.read_bytes())

# Add vacuum factors
for key in benchmark_factors:
    if "vacuum" in key:
        production_factors[key] = benchmark_factors[key]

# Write updated production factors
production_path.write_bytes(
    orjson.dumps(production_factors, option=orjson.OPT_INDENT_2)
)

print(f"Production factors now has {len(production_factors)} entries")
for key in sorted(production_factors.keys()):
    print(f"  {key}")
```

Expected entries after update:
- B3LYP/6-311+G(2d,p)/1H/CHCl3
- B3LYP/6-311+G(2d,p)/13C/CHCl3
- B3LYP/6-311+G(2d,p)/1H/DMSO
- B3LYP/6-311+G(2d,p)/13C/DMSO
- B3LYP/6-311+G(2d,p)/1H/vacuum (NEW)
- B3LYP/6-311+G(2d,p)/13C/vacuum (NEW)
  </action>
  <verify>
Verify production factors include vacuum:
```bash
cat /home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/data/scaling_factors.json | python -m json.tool | grep -c "vacuum"
```
Expected: 2 (one for 1H, one for 13C)

Test factor lookup:
```python
from qm_nmr_calc.shifts import get_scaling_factor

# Should work without error
h1_vacuum = get_scaling_factor("B3LYP", "6-311+G(2d,p)", "1H", "vacuum")
c13_vacuum = get_scaling_factor("B3LYP", "6-311+G(2d,p)", "13C", "vacuum")

print(f"1H vacuum: MAE={h1_vacuum['mae']:.3f} ppm")
print(f"13C vacuum: MAE={c13_vacuum['mae']:.3f} ppm")
```
  </verify>
  <done>
- Production scaling_factors.json contains vacuum entries
- get_scaling_factor() successfully retrieves vacuum factors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update shifts.py solvent normalization</name>
  <files>src/qm_nmr_calc/shifts.py</files>
  <action>
Update get_scaling_factor() to handle vacuum solvent:

The current solvent_map only handles chcl3 and dmso:
```python
solvent_map = {"chcl3": "CHCl3", "dmso": "DMSO"}
```

Add vacuum:
```python
solvent_map = {"chcl3": "CHCl3", "dmso": "DMSO", "vacuum": "vacuum"}
```

Or use a more general approach that passes through unrecognized solvents:
```python
def get_scaling_factor(functional, basis_set, nucleus, solvent):
    # Normalize solvent name to match scaling factors format
    solvent_map = {"chcl3": "CHCl3", "dmso": "DMSO", "vacuum": "vacuum"}
    normalized_solvent = solvent_map.get(solvent.lower(), solvent)
    ...
```

This ensures "vacuum" -> "vacuum" mapping works correctly.
  </action>
  <verify>
Test full shift conversion with vacuum:
```python
from qm_nmr_calc.shifts import shielding_to_shift

# Sample shielding data (typical values)
shielding_data = {
    "index": [1, 2, 3],
    "atom": ["H", "H", "C"],
    "shielding": [30.5, 31.2, 155.0],
}

# Convert with vacuum
shifts = shielding_to_shift(
    shielding_data,
    functional="B3LYP",
    basis_set="6-311+G(2d,p)",
    solvent="vacuum",
)

print("1H shifts:", [s["shift"] for s in shifts["1H"]])
print("13C shifts:", [s["shift"] for s in shifts["13C"]])
```

Run tests:
```bash
cd /home/chris/develop/qm-nmr-calc && uv run pytest tests/test_shifts.py -v
```
  </verify>
  <done>
- shifts.py normalizes "vacuum" solvent correctly
- shielding_to_shift() works with vacuum solvent
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
End-to-end verification after all tasks:

1. Factor derivation quality:
   ```python
   from qm_nmr_calc.shifts import get_scaling_factor

   h1 = get_scaling_factor("B3LYP", "6-311+G(2d,p)", "1H", "vacuum")
   c13 = get_scaling_factor("B3LYP", "6-311+G(2d,p)", "13C", "vacuum")

   assert h1["r_squared"] > 0.99, f"1H R^2 too low: {h1['r_squared']}"
   assert c13["r_squared"] > 0.99, f"13C R^2 too low: {c13['r_squared']}"
   print(f"Vacuum 1H: R^2={h1['r_squared']:.4f}, MAE={h1['mae']:.3f} ppm")
   print(f"Vacuum 13C: R^2={c13['r_squared']:.4f}, MAE={c13['mae']:.3f} ppm")
   ```

2. Full pipeline test:
   ```python
   from qm_nmr_calc.shifts import shielding_to_shift

   shielding_data = {
       "index": [1, 2, 3, 4, 5],
       "atom": ["H", "H", "H", "C", "C"],
       "shielding": [30.0, 31.0, 29.5, 150.0, 180.0],
   }

   # Should work for all supported solvents
   for solvent in ["CHCl3", "DMSO", "vacuum"]:
       shifts = shielding_to_shift(shielding_data, "B3LYP", "6-311+G(2d,p)", solvent)
       print(f"{solvent}: 1H shifts={[s['shift'] for s in shifts['1H']]}")
   ```

3. Run all tests:
   ```bash
   cd /home/chris/develop/qm-nmr-calc && uv run pytest tests/ -v
   ```
</verification>

<success_criteria>
- [ ] Vacuum scaling factors derived with R^2 > 0.99
- [ ] Production scaling_factors.json contains vacuum entries
- [ ] get_scaling_factor() works with vacuum solvent
- [ ] shielding_to_shift() works with vacuum solvent
- [ ] All existing tests pass
- [ ] Vacuum MAE comparable to solvated factors (within 2x)
</success_criteria>

<output>
After completion, create `.planning/phases/11.2-vacuum-benchmark-calculations/11.2-03-SUMMARY.md`
</output>
