---
phase: 21-status-redesign
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/qm_nmr_calc/api/templates/status.html
autonomous: false

must_haves:
  truths:
    - "Job progress displayed with visual progress indicators (step tracker with icons)"
    - "Step tracking shows completed, active, and pending steps with distinct visual states"
    - "3D molecule preview displayed during calculation using viewer-card component"
    - "Ensemble progress (X/N conformers) clearly visible in dedicated card with progress bar"
    - "Error states displayed in red error card with icon and actionable message"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/status.html"
      provides: "Status page with bento grid layout, glass cards, step tracker"
      contains: "bento-grid"
  key_links:
    - from: "status.html"
      to: "status-page.css"
      via: "page_css block link element"
      pattern: "status-page\\.css"
    - from: "status.html JavaScript"
      to: "step-tracker component"
      via: "innerHTML assignment building step list"
      pattern: "step-tracker__list"
---

<objective>
Update the status.html template to use the new bento grid layout with glass cards, integrate the step tracker component, and update JavaScript to build the step tracker dynamically.

Purpose: Transform the status page from basic styling to the modern glassmorphic design established in Phase 18, providing clear visual feedback during job execution with proper progress visualization.

Output: Updated status.html with bento grid layout, glass-card containers, viewer-card for 3D preview, step tracker populated by JavaScript, and human-verified visual design.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-status-redesign/21-RESEARCH.md
@.planning/phases/21-status-redesign/21-01-SUMMARY.md

# Template to update
@src/qm_nmr_calc/api/templates/status.html

# CSS components available
@src/qm_nmr_calc/api/static/css/pages/status-page.css
@src/qm_nmr_calc/api/static/css/components/glass-card.css
@src/qm_nmr_calc/api/static/css/layout.css
@src/qm_nmr_calc/api/static/css/pages/results-page.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update status.html template structure</name>
  <files>src/qm_nmr_calc/api/templates/status.html</files>
  <action>
Rewrite the status.html template to use the new CSS architecture. Key changes:

1. **Add page_css block** (after title block):
   ```jinja2
   {% block page_css %}
   <link rel="stylesheet" href="{{ url_for('static', path='/css/pages/results-page.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', path='/css/pages/status-page.css') }}">
   {% endblock %}
   ```
   Note: Include results-page.css for viewer-card and conformer-table components.

2. **Remove inline styles** - Delete the entire `<style>` block in `{% block head %}`. Keep only the 3Dmol.js script.

3. **Update content structure** to use bento grid:
   - Wrap everything in `<div class="page-wrapper">`
   - Add status header: `<header class="status-header">` with h1 and status badge
   - Status badge: `<span class="status-badge" id="status-badge" data-status="{{ job.status }}">{{ job.status }}</span>`

4. **Create bento grid layout**:
   ```html
   <div class="bento-grid">
       <!-- Job Details Card (span-3) -->
       <div class="bento-grid__item bento-grid__item--span-3">
           <article class="glass-card">
               <header class="glass-card__header">
                   <h2 class="glass-card__title">Job Details</h2>
               </header>
               <div class="glass-card__body">
                   <dl class="metadata-list">
                       <!-- Job ID, Elapsed Time, Molecule, SMILES, Solvent, Preset -->
                   </dl>
               </div>
           </article>
       </div>

       <!-- 3D Molecule Preview (span-3) -->
       <div class="bento-grid__item bento-grid__item--span-3">
           <div class="viewer-card viewer-card--compact">
               <header class="viewer-card__header">
                   <h3 class="viewer-card__title">Molecular Structure</h3>
               </header>
               <div id="viewer-container-3d" class="viewer-card__canvas"></div>
               <footer class="viewer-card__footer">
                   <small class="muted">RDKit-generated geometry</small>
               </footer>
           </div>
       </div>

       <!-- Step Progress Tracker (span-6) -->
       <div class="bento-grid__item bento-grid__item--span-6" id="progress-section">
           <article class="glass-card">
               <header class="glass-card__header">
                   <h3 class="glass-card__title">Calculation Progress</h3>
               </header>
               <div class="glass-card__body">
                   <div class="step-tracker" id="step-tracker">
                       <!-- Populated by JavaScript -->
                   </div>
               </div>
           </article>
       </div>

       <!-- Conformer Progress (span-6) - ONLY for ensemble -->
       {% if job.conformer_mode == 'ensemble' %}
       <div class="bento-grid__item bento-grid__item--span-6" id="conformer-progress-section">
           <article class="glass-card">
               <!-- Header + conformer-progress div + details -->
           </article>
       </div>
       {% endif %}

       <!-- Error Display (span-6) - Hidden by default -->
       <div class="bento-grid__item bento-grid__item--span-6" id="error-section" style="display: none;">
           <article class="glass-card glass-card--error">
               <header class="glass-card__header">
                   <h3 class="glass-card__title">
                       <span class="error-icon" aria-hidden="true">!</span>
                       Job Failed
                   </h3>
               </header>
               <div class="glass-card__body">
                   <p class="error-message" id="error-message"></p>
                   <div class="error-actions">
                       <a href="/" class="btn">Submit New Job</a>
                   </div>
               </div>
           </article>
       </div>
   </div>
   ```

5. **Update metadata list** - Use `<dl class="metadata-list">` with `<div class="metadata-list__item">` wrappers

6. **Update conformer progress** section inside glass card:
   - conformer-progress div with header, progress bar, ETA
   - conformer-details for collapsible table
   - Add data-status attribute to table rows in JS

7. **Update footer** with status-footer class

See 21-RESEARCH.md "Complete Status Page HTML Structure" section for full template example.
  </action>
  <verify>
Check template structure:
```bash
grep -c "bento-grid" src/qm_nmr_calc/api/templates/status.html
# Should be >= 2

grep -c "glass-card" src/qm_nmr_calc/api/templates/status.html
# Should be >= 4

grep -c "viewer-card" src/qm_nmr_calc/api/templates/status.html
# Should be >= 1

grep -c "step-tracker" src/qm_nmr_calc/api/templates/status.html
# Should be >= 1

grep "status-page.css" src/qm_nmr_calc/api/templates/status.html
# Should return the link tag
```

Verify no inline styles remain (except display: none for error section):
```bash
grep -c "<style>" src/qm_nmr_calc/api/templates/status.html
# Should be 0
```
  </verify>
  <done>status.html updated with bento-grid layout, glass-card containers, viewer-card, and step-tracker placeholder</done>
</task>

<task type="auto">
  <name>Task 2: Update JavaScript for step tracker and status updates</name>
  <files>src/qm_nmr_calc/api/templates/status.html</files>
  <action>
Update the JavaScript in the scripts block to:

1. **Add updateStepTracker function** that builds step tracker HTML:
   ```javascript
   function updateStepTracker(data) {
       const tracker = document.getElementById('step-tracker');
       if (!tracker) return;

       // Define all possible steps in order (based on conformer mode)
       const allSteps = data.conformer_mode === 'ensemble' ? [
           { id: 'conformer_generation', label: 'Conformer Generation' },
           { id: 'geometry_optimization', label: 'Geometry Optimization' },
           { id: 'nmr_calculation', label: 'NMR Calculation' },
           { id: 'averaging', label: 'Averaging' }
       ] : [
           { id: 'geometry_optimization', label: 'Geometry Optimization' },
           { id: 'nmr_calculation', label: 'NMR Calculation' },
           { id: 'post_processing', label: 'Post-processing' }
       ];

       const completedIds = (data.steps_completed || []).map(s => s.step);

       let html = '<ol class="step-tracker__list">';
       allSteps.forEach(step => {
           let stateClass = 'step-tracker__item--pending';
           let duration = '';

           if (completedIds.includes(step.id)) {
               stateClass = 'step-tracker__item--complete';
               const completed = data.steps_completed.find(s => s.step === step.id);
               if (completed) {
                   duration = formatDuration(completed.duration_seconds);
               }
           } else if (data.current_step === step.id) {
               stateClass = 'step-tracker__item--active';
               duration = 'Running...';
           }

           html += `
               <li class="step-tracker__item ${stateClass}">
                   <span class="step-tracker__icon" aria-hidden="true"></span>
                   <span class="step-tracker__label">${step.label}</span>
                   ${duration ? `<span class="step-tracker__duration">${duration}</span>` : ''}
               </li>
           `;
       });
       html += '</ol>';
       tracker.innerHTML = html;
   }
   ```

2. **Update status badge** in checkStatus to set data-status:
   ```javascript
   // Update status badge
   const statusBadge = document.getElementById('status-badge');
   if (statusBadge) {
       statusBadge.textContent = data.status;
       statusBadge.setAttribute('data-status', data.status);
   }
   ```

3. **Update error display** to show/hide error section:
   ```javascript
   const errorSection = document.getElementById('error-section');
   // In failed branch:
   if (errorSection) {
       errorSection.style.display = 'block';
   }
   ```

4. **Update conformer table rows** to include data-status attribute:
   ```javascript
   // In updateConformerProgress:
   conformerTableBody.innerHTML = data.conformer_progress.map(c => {
       // ... existing code ...
       return `<tr data-status="${c.status}">
           <td>${c.conformer_id}</td>
           <td>${formatConformerStatus(c.status)}</td>
           <td>${energyStr}</td>
           <td>${popStr}</td>
       </tr>`;
   }).join('');
   ```

5. **Call updateStepTracker** from checkStatus:
   ```javascript
   // After updateConformerProgress(data):
   updateStepTracker(data);
   ```

6. **Remove old step progress code** - Delete updateStepProgress function and related elements (currentStepDisplay, completedStepsDiv, etc.) since step tracker replaces them.

7. **Get progress section reference** and show it when steps exist:
   ```javascript
   const progressSection = document.getElementById('progress-section');
   // Show when running
   if (data.status === 'running' || data.steps_completed.length > 0) {
       progressSection.style.display = 'block';
   }
   ```
   Note: Actually the progress section should always be visible in bento grid, no need to hide/show.
  </action>
  <verify>
Check JavaScript has step tracker function:
```bash
grep -c "updateStepTracker" src/qm_nmr_calc/api/templates/status.html
# Should be >= 2 (definition + call)

grep -c "step-tracker__list" src/qm_nmr_calc/api/templates/status.html
# Should be >= 1

grep "data-status" src/qm_nmr_calc/api/templates/status.html | grep -c "setAttribute\|data-status="
# Should be >= 2
```
  </verify>
  <done>JavaScript updated to build step tracker dynamically and set data-status attributes for CSS styling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Status page redesign with:
- Bento grid layout with glass cards
- Job details card with metadata list
- 3D molecule preview in viewer-card
- Step tracker showing calculation progress with icons
- Conformer progress bar (for ensemble jobs)
- Error display card styling
  </what-built>
  <how-to-verify>
1. Start the dev server if not running:
   ```bash
   cd /home/chris/develop/qm-nmr-calc
   # Server should be running
   ```

2. Submit a new job from the submit page (http://localhost:8000/)
   - Enter a simple SMILES like CCO (ethanol)
   - Select any preset
   - Click Submit

3. On the status page, verify:
   - [ ] Page has bento grid layout with cards in glass styling
   - [ ] Job details card shows: Job ID, Elapsed Time, SMILES, Solvent, Preset
   - [ ] 3D molecule preview shows the molecule structure
   - [ ] Step tracker shows progress steps with icons (pending = empty circle, active = pulsing blue, complete = green checkmark)
   - [ ] Status badge in header shows "running" with pulsing dot

4. For ensemble job testing (if time permits):
   - Submit with "Ensemble (RDKIT KDG)" conformer mode
   - Verify conformer progress bar appears below step tracker
   - Verify X/N conformer count updates

5. Error state testing (optional - requires a failing job):
   - Submit invalid input to trigger error
   - Verify error card appears with red styling and exclamation icon

6. Mobile responsive (resize browser or use dev tools):
   - [ ] Step tracker switches to vertical layout on narrow screens
   - [ ] Cards stack in single column on mobile

**Expected appearance:** Similar to results page glass styling, with clear visual distinction between completed (green check), active (blue pulse), and pending (gray circle) steps.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Template renders without errors:
   - Start server and navigate to status page with existing job ID
   - No Python template errors in console

2. CSS loads correctly:
   - Browser dev tools shows status-page.css loaded
   - No 404 errors for CSS files

3. Step tracker displays:
   - Steps show with icons (not just text)
   - Active step has pulsing animation
   - Completed steps have green checkmarks

4. 3D viewer works:
   - Molecule renders in viewer-card
   - Rotation/zoom still functional
</verification>

<success_criteria>
- Status page uses bento grid layout with glass cards
- Job details displayed in glass-card with metadata-list
- 3D molecule preview in viewer-card component
- Step tracker shows progress with visual state indicators (icons + colors)
- Conformer progress bar visible for ensemble jobs
- Error card displays with red styling when job fails
- Mobile responsive layout (vertical step tracker)
- No inline styles remaining (except display: none for error)
- User has visually verified the design matches expectations
</success_criteria>

<output>
After completion, create `.planning/phases/21-status-redesign/21-02-SUMMARY.md`
</output>
