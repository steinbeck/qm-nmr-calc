---
phase: 46-vm-deployment-script
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gcp/startup.sh
  - gcp/shutdown.sh
  - gcp/docker-compose.gcp.yml
  - gcp/deploy-vm.sh
autonomous: true

must_haves:
  truths:
    - "User runs one command and gets a working qm-nmr-calc VM"
    - "Startup script installs Docker, mounts disk, pulls images, starts containers"
    - "Containers shut down gracefully within 25 seconds during preemption"
    - "User can select region, zone, and machine type with sensible defaults"
    - "Cost estimate displayed before VM creation with cancel option"
  artifacts:
    - path: "gcp/startup.sh"
      provides: "VM initialization: Docker install, disk mount, container deployment"
      contains: "docker compose"
      min_lines: 50
    - path: "gcp/shutdown.sh"
      provides: "Graceful container shutdown during preemption"
      contains: "docker compose stop --timeout 25"
      min_lines: 15
    - path: "gcp/docker-compose.gcp.yml"
      provides: "GCP-specific volume paths and environment overrides"
      contains: "/mnt/disks/data"
      min_lines: 15
    - path: "gcp/deploy-vm.sh"
      provides: "One-command Spot VM creation with prompts"
      contains: "--provisioning-model=SPOT"
      min_lines: 100
  key_links:
    - from: "gcp/deploy-vm.sh"
      to: "gcp/startup.sh"
      via: "--metadata-from-file=startup-script"
      pattern: "metadata-from-file.*startup"
    - from: "gcp/deploy-vm.sh"
      to: "gcp/shutdown.sh"
      via: "--metadata-from-file=shutdown-script"
      pattern: "metadata-from-file.*shutdown"
    - from: "gcp/startup.sh"
      to: "gcp/docker-compose.gcp.yml"
      via: "creates docker-compose.gcp.yml in /opt/qm-nmr-calc"
      pattern: "docker-compose.gcp.yml"
---

<objective>
Create VM deployment scripts for one-command GCP Spot VM deployment with interactive prompts, cost estimation, Docker installation, and graceful preemption handling.

Purpose: Enable users to deploy qm-nmr-calc to a cost-effective GCP Spot VM (~60-91% discount) with a single command that handles all infrastructure setup, Docker deployment, and HTTPS configuration.

Output:
- gcp/startup.sh - Installs Docker, mounts persistent disk, deploys containers
- gcp/shutdown.sh - Graceful 25s container shutdown on preemption
- gcp/docker-compose.gcp.yml - GCP volume paths and production settings
- gcp/deploy-vm.sh - Interactive deployment with prompts and cost display
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-vm-deployment-script/46-RESEARCH.md
@.planning/phases/45-gcp-infrastructure-setup/45-01-SUMMARY.md
@gcp/config.sh.example
@gcp/setup-infrastructure.sh
@docker-compose.yml
@Caddyfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VM helper scripts and Docker Compose override</name>
  <files>gcp/startup.sh, gcp/shutdown.sh, gcp/docker-compose.gcp.yml</files>
  <action>
Create three files that handle VM lifecycle and Docker configuration:

**gcp/startup.sh** (VM initialization script):
- Set `#!/bin/bash` with `set -euo pipefail`
- Log all output to `/var/log/startup-script.log` using exec redirection
- Install Docker and Docker Compose v2: `apt-get install -y docker.io docker-compose-v2 curl git`
- Enable and start Docker service with systemd
- Wait for Docker to be ready with retry loop (up to 10 attempts, 2s sleep)
- Mount persistent disk:
  - Device: `/dev/disk/by-id/google-data-disk`
  - Mount point: `/mnt/disks/data`
  - Format with ext4 ONLY if no filesystem exists (`if ! blkid "$DEVICE_NAME"`)
  - Add to `/etc/fstab` if not already present (check with grep)
- Create `/opt/qm-nmr-calc` directory
- Fetch DOMAIN from instance metadata using curl to metadata server
- Create `.env` file with DOMAIN
- Clone docker-compose.yml and Caddyfile from GitHub repo (or download release assets)
- Create docker-compose.gcp.yml inline using heredoc (embed the override content)
- Pull images from GHCR: `docker compose pull`
- Start services: `docker compose -f docker-compose.yml -f docker-compose.gcp.yml up -d`
- Log completion timestamp

**gcp/shutdown.sh** (preemption handler):
- Set `#!/bin/bash` with `set -euo pipefail`
- Log to `/var/log/shutdown-script.log`
- Change to `/opt/qm-nmr-calc` directory (exit 0 if not exists)
- Check if containers are running with `docker compose ps -q`
- Stop containers with `docker compose stop --timeout 25` (25s to stay within 30s preemption window)
- Log completion timestamp

**gcp/docker-compose.gcp.yml** (GCP overrides):
- Override volumes for api and worker to use `/mnt/disks/data:/app/data`
- Set ENVIRONMENT=production for api and worker
- Set LOG_LEVEL=info
- Caddy DOMAIN comes from .env (already in base compose)
- Do NOT override the named volumes (app-data, caddy_data, caddy_config) - the bind mounts in services section handle data persistence

Follow patterns from Phase 45 scripts:
- Color-coded output with echo_info/echo_warn/echo_error functions
- Timestamps in log messages
- Idempotent operations (check before creating/formatting)
  </action>
  <verify>
Run shellcheck on both scripts:
```bash
shellcheck gcp/startup.sh gcp/shutdown.sh
```
Verify docker-compose.gcp.yml syntax:
```bash
docker compose -f docker-compose.yml -f gcp/docker-compose.gcp.yml config --quiet
```
  </verify>
  <done>
- startup.sh installs Docker, mounts disk, deploys containers
- shutdown.sh stops containers within 25s timeout
- docker-compose.gcp.yml provides GCP volume paths
- All scripts pass shellcheck and compose config validates
  </done>
</task>

<task type="auto">
  <name>Task 2: Create main VM deployment script</name>
  <files>gcp/deploy-vm.sh</files>
  <action>
Create the main deployment script that creates a Spot VM with interactive prompts:

**gcp/deploy-vm.sh**:
- Set `#!/bin/bash` with `set -euo pipefail`
- Source `./config.sh` (require it exists with helpful error message like setup-infrastructure.sh)
- Validate GCP_PROJECT_ID is set and not default value
- Check gcloud authentication (reuse pattern from setup-infrastructure.sh)

**Interactive prompts (DEPLOY-05)**:
- Prompt for region with default from config: `read -p "Select region [${GCP_REGION}]: " INPUT_REGION`
- Prompt for zone with default: `read -p "Select zone [${GCP_ZONE}]: " INPUT_ZONE`
- Display machine type options with descriptions and estimated Spot costs:
  ```
  Available machine types (Spot pricing ~60-91% discount):
    e2-standard-2   (2 vCPU, 8 GB)   ~$15-25/month  - Light workloads
    e2-standard-4   (4 vCPU, 16 GB)  ~$30-50/month  - Recommended
    n2-standard-4   (4 vCPU, 16 GB)  ~$50-80/month  - Higher performance
    c2-standard-4   (4 vCPU, 16 GB)  ~$70-100/month - Compute-optimized
  ```
- Prompt for machine type with default e2-standard-4
- Prompt for DOMAIN (required for HTTPS): `read -p "Enter domain for HTTPS (e.g., nmr.example.com): " DOMAIN`
- Validate DOMAIN is provided (not empty)

**Cost estimation display (DEPLOY-06)**:
- Display summary with selected configuration
- Show estimated monthly cost based on machine type selection
- Include note about Spot pricing variability
- Prompt for confirmation: `read -p "Continue with VM creation? (yes/no) [yes]: " CONFIRM`
- Exit if user doesn't confirm

**VM creation (DEPLOY-01)**:
- Get static IP address value (not name) using `gcloud compute addresses describe`
- Check if VM already exists; if so, warn and offer to delete/recreate or abort
- Create Spot VM with gcloud:
  ```bash
  gcloud compute instances create "${RESOURCE_PREFIX}-vm" \
      --zone="$SELECTED_ZONE" \
      --machine-type="$MACHINE_TYPE" \
      --provisioning-model=SPOT \
      --instance-termination-action=STOP \
      --tags="${RESOURCE_PREFIX}-vm" \
      --network-interface=address="$STATIC_IP" \
      --boot-disk-size=20GB \
      --boot-disk-type=pd-balanced \
      --image-family=debian-12 \
      --image-project=debian-cloud \
      --disk="name=${RESOURCE_PREFIX}-data,mode=rw,device-name=data-disk,boot=no,auto-delete=no" \
      --metadata-from-file=startup-script=startup.sh,shutdown-script=shutdown.sh \
      --metadata=DOMAIN="$DOMAIN"
  ```
- Note: Use `--network-interface=address=` not `--address=` for static IP assignment

**Post-creation output**:
- Display VM creation success
- Show static IP for DNS configuration reminder
- Estimate startup time (~2-3 minutes for Docker install + image pull)
- Provide next steps:
  1. Point DNS A record to static IP
  2. Wait for startup script to complete
  3. Verify with: `gcloud compute ssh ${RESOURCE_PREFIX}-vm --zone=$ZONE --command="docker compose -f /opt/qm-nmr-calc/docker-compose.yml ps"`
  4. Access at https://$DOMAIN

Make script executable: `chmod +x gcp/deploy-vm.sh`
  </action>
  <verify>
Run shellcheck:
```bash
shellcheck gcp/deploy-vm.sh
```
Verify script sources config.sh correctly by checking syntax:
```bash
bash -n gcp/deploy-vm.sh
```
Verify all required gcloud commands are syntactically correct.
  </verify>
  <done>
- deploy-vm.sh prompts for region, zone, machine type, domain
- Cost estimation displayed with monthly estimates
- Confirmation required before VM creation
- Spot VM created with startup/shutdown scripts attached
- Static IP assigned correctly using address value
- Persistent disk attached with auto-delete=no
- Script passes shellcheck and bash syntax check
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full solution:

1. **All files exist with correct permissions:**
   ```bash
   ls -la gcp/startup.sh gcp/shutdown.sh gcp/deploy-vm.sh gcp/docker-compose.gcp.yml
   ```

2. **Scripts are executable:**
   ```bash
   test -x gcp/startup.sh && echo "startup.sh executable"
   test -x gcp/shutdown.sh && echo "shutdown.sh executable"
   test -x gcp/deploy-vm.sh && echo "deploy-vm.sh executable"
   ```

3. **All scripts pass shellcheck:**
   ```bash
   shellcheck gcp/*.sh
   ```

4. **Docker Compose override validates:**
   ```bash
   docker compose -f docker-compose.yml -f gcp/docker-compose.gcp.yml config --quiet && echo "Compose config valid"
   ```

5. **Key patterns present:**
   - startup.sh contains `docker compose` and `blkid` (disk format check)
   - shutdown.sh contains `--timeout 25`
   - deploy-vm.sh contains `--provisioning-model=SPOT`
   - docker-compose.gcp.yml contains `/mnt/disks/data`
</verification>

<success_criteria>
Phase 46 requirements satisfied:
- DEPLOY-01: deploy-vm.sh creates Spot VM with single command
- DEPLOY-02: startup.sh installs Docker and deploys containers
- DEPLOY-03: startup.sh pulls images from GHCR
- DEPLOY-04: shutdown.sh stops containers within 25s timeout
- DEPLOY-05: deploy-vm.sh prompts for region, zone, machine type with defaults
- DEPLOY-06: deploy-vm.sh displays cost estimation before creation
- DEPLOY-07: docker-compose.gcp.yml provides GCP-specific overrides
</success_criteria>

<output>
After completion, create `.planning/phases/46-vm-deployment-script/46-01-SUMMARY.md`
</output>
