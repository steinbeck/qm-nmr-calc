---
phase: 17-api-integration
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - src/qm_nmr_calc/api/templates/submit.html
  - src/qm_nmr_calc/api/templates/status.html
  - src/qm_nmr_calc/api/routers/web.py
autonomous: false

must_haves:
  truths:
    - "Submission form shows mode dropdown (Ensemble/Single) with Ensemble as default"
    - "Submission form shows method dropdown (RDKit KDG/CREST) with CREST disabled if unavailable"
    - "Status page shows conformer progress for ensemble jobs (X/N conformers)"
    - "Status page shows current stage (generating_conformers, optimizing_conformers, etc.)"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/submit.html"
      provides: "Form with mode and method dropdowns"
      contains: "conformer_mode"
    - path: "src/qm_nmr_calc/api/templates/status.html"
      provides: "Conformer progress display"
      contains: "conformer-progress"
    - path: "src/qm_nmr_calc/api/routers/web.py"
      provides: "Form handler with conformer parameters"
      contains: "conformer_mode"
  key_links:
    - from: "src/qm_nmr_calc/api/templates/submit.html"
      to: "src/qm_nmr_calc/api/routers/web.py"
      via: "form submission"
      pattern: "name=\"conformer_mode\""
    - from: "src/qm_nmr_calc/api/templates/status.html"
      to: "/api/v1/jobs/{job_id}"
      via: "JavaScript fetch for polling"
      pattern: "conformer_progress"
---

<objective>
Update web UI forms and status page to support ensemble mode selection and progress tracking.

Purpose: Users need to select conformer mode and method when submitting jobs, and see conformer-specific progress during calculation.

Output: Updated submit.html with mode/method dropdowns, updated status.html with conformer progress display, updated web.py to handle new form parameters.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-api-integration/17-CONTEXT.md
@.planning/phases/17-api-integration/17-RESEARCH.md
@.planning/phases/17-api-integration/17-01-SUMMARY.md
@.planning/phases/17-api-integration/17-02-SUMMARY.md

# Key source files
@src/qm_nmr_calc/api/templates/submit.html
@src/qm_nmr_calc/api/templates/status.html
@src/qm_nmr_calc/api/templates/base.html
@src/qm_nmr_calc/api/routers/web.py
@src/qm_nmr_calc/api/routers/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update submit.html with mode and method dropdowns</name>
  <files>
    src/qm_nmr_calc/api/templates/submit.html
    src/qm_nmr_calc/api/routers/web.py
  </files>
  <action>
1. **Update web.py _get_form_context()** to include CREST availability:
```python
def _get_form_context() -> dict:
    """Build common form context with solvents, presets, and CREST availability."""
    from ...conformers import detect_crest_available

    # ... existing solvent and preset code ...

    # Check CREST availability for form display
    crest_available = detect_crest_available()

    return {
        "solvents": solvents,
        "presets": presets,
        "crest_available": crest_available,
    }
```

2. **Update submit.html** to add conformer mode and method dropdowns after the preset dropdown:

```html
<!-- After preset select, before the submit button -->

<fieldset>
    <legend>Conformer Mode</legend>

    <label for="conformer_mode">Calculation Mode</label>
    <select id="conformer_mode" name="conformer_mode" required>
        <option value="ensemble" {% if form_data.get('conformer_mode', 'ensemble') == 'ensemble' %}selected{% endif %}>
            Ensemble (multi-conformer, recommended)
        </option>
        <option value="single" {% if form_data.get('conformer_mode') == 'single' %}selected{% endif %}>
            Single conformer (faster, v1.x behavior)
        </option>
    </select>
    <small>Ensemble mode generates multiple conformers for more accurate predictions on flexible molecules.</small>

    <label for="conformer_method">Conformer Method</label>
    <select id="conformer_method" name="conformer_method">
        <option value="rdkit_kdg" {% if form_data.get('conformer_method', 'rdkit_kdg') == 'rdkit_kdg' %}selected{% endif %}>
            RDKit KDG (fast, always available)
        </option>
        <option value="crest" {% if not crest_available %}disabled{% endif %}
                {% if form_data.get('conformer_method') == 'crest' %}selected{% endif %}>
            CREST/xTB (thorough){% if not crest_available %} - not installed{% endif %}
        </option>
    </select>
    <small>CREST provides better conformer sampling for complex molecules but requires external installation.</small>
</fieldset>

<details>
    <summary>Advanced Options</summary>
    <fieldset>
        <label for="max_conformers">Max Conformers (optional)</label>
        <input type="number" id="max_conformers" name="max_conformers"
               value="{{ form_data.get('max_conformers', '') }}"
               min="1" max="500" placeholder="Auto (based on flexibility)">
        <small>Leave empty for automatic selection based on molecular flexibility.</small>
    </fieldset>
</details>
```

3. **Add JavaScript** to disable method select when mode is "single":
```html
<script>
document.getElementById('conformer_mode').addEventListener('change', function() {
    const methodSelect = document.getElementById('conformer_method');
    if (this.value === 'single') {
        methodSelect.disabled = true;
        methodSelect.value = 'rdkit_kdg';
    } else {
        methodSelect.disabled = false;
    }
});
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const modeSelect = document.getElementById('conformer_mode');
    if (modeSelect.value === 'single') {
        document.getElementById('conformer_method').disabled = true;
    }
});
</script>
```

4. **Update web.py submit_job()** to accept new form parameters:
```python
async def submit_job(
    request: Request,
    smiles: Annotated[Optional[str], Form()] = None,
    file: Optional[UploadFile] = None,
    solvent: Annotated[str, Form()] = "",
    preset: Annotated[str, Form()] = "production",
    name: Annotated[Optional[str], Form()] = None,
    notification_email: Annotated[Optional[str], Form()] = None,
    conformer_mode: Annotated[str, Form()] = "ensemble",  # Default per CONTEXT.md
    conformer_method: Annotated[Optional[str], Form()] = None,
    max_conformers: Annotated[Optional[str], Form()] = None,  # String from form, convert to int
):
    # ... validation code ...

    # Convert max_conformers from string to int if provided
    max_conformers_int = None
    if max_conformers and max_conformers.strip():
        try:
            max_conformers_int = int(max_conformers)
        except ValueError:
            return render_error("Max conformers must be a number")

    # If mode is single, ignore conformer_method
    if conformer_mode == "single":
        conformer_method = None

    job_status = create_job_directory(
        # ... existing params ...
        conformer_mode=conformer_mode,
        conformer_method=conformer_method,
        max_conformers=max_conformers_int,
    )

    # Dispatch to correct task
    if conformer_mode == "ensemble":
        from ...tasks import run_ensemble_nmr_task
        run_ensemble_nmr_task(job_status.job_id)
    else:
        run_nmr_task(job_status.job_id)
```
  </action>
  <verify>
```bash
cd /home/chris/develop/qm-nmr-calc
grep -n "conformer_mode" src/qm_nmr_calc/api/templates/submit.html
grep -n "conformer_method" src/qm_nmr_calc/api/templates/submit.html
grep -n "crest_available" src/qm_nmr_calc/api/routers/web.py
```
  </verify>
  <done>Submit form has mode and method dropdowns with CREST availability check and proper form handling.</done>
</task>

<task type="auto">
  <name>Task 2: Update status.html for conformer progress display</name>
  <files>
    src/qm_nmr_calc/api/templates/status.html
  </files>
  <action>
Update status.html to show conformer-specific progress for ensemble jobs:

1. **Add conformer progress section** (hidden for single-conformer jobs):
```html
<!-- After the existing step progress display -->

<div id="conformer-progress" style="display: none;">
    <h3>Conformer Progress</h3>
    <div id="conformer-stage"></div>
    <progress id="conformer-progress-bar" value="0" max="100"></progress>
    <p id="conformer-count"></p>
    <p id="eta-display"></p>

    <!-- Per-conformer status table (collapsible) -->
    <details>
        <summary>Conformer Details</summary>
        <table id="conformer-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Status</th>
                    <th>Energy (kcal/mol)</th>
                    <th>Population</th>
                </tr>
            </thead>
            <tbody id="conformer-table-body">
            </tbody>
        </table>
    </details>
</div>
```

2. **Update the JavaScript polling function** to handle ensemble progress:
```javascript
function updateStatus(data) {
    // ... existing status update code ...

    // Handle ensemble-specific progress
    if (data.conformer_mode === 'ensemble') {
        const progressDiv = document.getElementById('conformer-progress');
        progressDiv.style.display = 'block';

        // Update stage display
        const stageDiv = document.getElementById('conformer-stage');
        if (data.current_step_label) {
            stageDiv.textContent = data.current_step_label;
        }

        // Update conformer count and progress
        if (data.conformer_progress && data.conformer_progress.length > 0) {
            const total = data.conformer_progress.length;
            const completed = data.conformer_progress.filter(c =>
                c.status === 'nmr_complete' || c.status === 'optimized'
            ).length;
            const failed = data.conformer_progress.filter(c =>
                c.status === 'failed'
            ).length;

            document.getElementById('conformer-count').textContent =
                `Conformers: ${completed}/${total}` + (failed > 0 ? ` (${failed} failed)` : '');

            // Update progress bar
            const progress = (completed / total) * 100;
            document.getElementById('conformer-progress-bar').value = progress;

            // Update per-conformer table
            const tbody = document.getElementById('conformer-table-body');
            tbody.innerHTML = data.conformer_progress.map(c => `
                <tr class="status-${c.status}">
                    <td>${c.conformer_id}</td>
                    <td>${formatStatus(c.status)}</td>
                    <td>${c.energy_kcal !== null ? c.energy_kcal.toFixed(2) : '-'}</td>
                    <td>${c.population !== null ? (c.population * 100).toFixed(1) + '%' : '-'}</td>
                </tr>
            `).join('');
        }

        // Update ETA
        if (data.eta_seconds) {
            document.getElementById('eta-display').textContent =
                'Estimated time remaining: ' + formatEta(data.eta_seconds);
        } else {
            document.getElementById('eta-display').textContent = '';
        }
    }
}

function formatStatus(status) {
    const labels = {
        'pending': 'Pending',
        'optimizing': 'Optimizing...',
        'optimized': 'Optimized',
        'nmr_running': 'NMR running...',
        'nmr_complete': 'Complete',
        'failed': 'Failed'
    };
    return labels[status] || status;
}

function formatEta(seconds) {
    if (seconds < 60) return `~${seconds} seconds`;
    if (seconds < 3600) return `~${Math.ceil(seconds / 60)} minutes`;
    return `~${(seconds / 3600).toFixed(1)} hours`;
}
```

3. **Add CSS for status coloring:**
```html
<style>
    .status-nmr_complete td:nth-child(2) { color: green; }
    .status-failed td:nth-child(2) { color: red; }
    .status-optimizing td:nth-child(2),
    .status-nmr_running td:nth-child(2) { color: orange; }
    #conformer-progress-bar {
        width: 100%;
        margin: 1rem 0;
    }
</style>
```
  </action>
  <verify>
```bash
cd /home/chris/develop/qm-nmr-calc
grep -n "conformer-progress" src/qm_nmr_calc/api/templates/status.html
grep -n "conformer_mode" src/qm_nmr_calc/api/templates/status.html
```
  </verify>
  <done>Status page shows conformer progress section for ensemble jobs with progress bar, counts, and per-conformer table.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Web form with mode/method dropdowns and status page with conformer progress display</what-built>
  <how-to-verify>
1. Start the development server:
   ```bash
   cd /home/chris/develop/qm-nmr-calc
   ./run_dev.sh
   ```

2. Open http://localhost:8000 in browser

3. **Verify submit form:**
   - See "Conformer Mode" section with Ensemble/Single dropdown
   - Ensemble is selected by default
   - See "Conformer Method" dropdown with RDKit KDG and CREST options
   - CREST option shows "not installed" if CREST is not available
   - Selecting "Single conformer" disables the method dropdown
   - "Advanced Options" expands to show max conformers input

4. **Submit a test job in ensemble mode:**
   - Enter SMILES: CCO (ethanol)
   - Select solvent: CHCl3
   - Keep mode as Ensemble
   - Submit

5. **Verify status page:**
   - See "Conformer Progress" section
   - Progress bar updates as conformers complete
   - Per-conformer table shows status of each conformer
   - Stage label updates (Generating conformers -> Optimizing -> NMR -> Averaging)

Note: The job will take several minutes with NWChem. Can also verify with a mock by checking the HTML structure renders correctly.
  </how-to-verify>
  <resume-signal>Type "approved" if UI looks correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Form structure: `grep -n "conformer_mode" src/qm_nmr_calc/api/templates/submit.html`
2. Status progress: `grep -n "conformer-progress" src/qm_nmr_calc/api/templates/status.html`
3. Web handler: `grep -n "conformer_mode" src/qm_nmr_calc/api/routers/web.py`
4. Visual verification: Manual check of form and status page
</verification>

<success_criteria>
- [ ] Submit form shows mode dropdown with Ensemble as default
- [ ] Submit form shows method dropdown with CREST disabled if unavailable
- [ ] Single conformer mode disables method dropdown via JavaScript
- [ ] Advanced options section shows max conformers input
- [ ] web.py handles new form parameters correctly
- [ ] web.py dispatches to correct task based on mode
- [ ] Status page shows conformer progress section for ensemble jobs
- [ ] Progress bar updates based on conformer completion
- [ ] Per-conformer table shows status, energy, and population
- [ ] Visual verification confirms UI works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/17-api-integration/17-03-SUMMARY.md`
</output>
