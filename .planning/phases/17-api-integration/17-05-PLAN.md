---
phase: 17-api-integration
plan: 05
type: execute
wave: 3
depends_on: ["17-03", "17-04"]
files_modified:
  - src/qm_nmr_calc/api/templates/results.html
autonomous: false

must_haves:
  truths:
    - "Results page shows ensemble metadata (conformer count, method, energy range)"
    - "Results page shows top 3 conformer populations"
    - "Per-conformer shift comparison table is available"
    - "Warning displayed if CREST fell back to RDKit"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/results.html"
      provides: "Ensemble metadata display"
      contains: "ensemble-metadata"
    - path: "src/qm_nmr_calc/api/templates/results.html"
      provides: "Shift comparison table"
      contains: "shift-comparison"
  key_links:
    - from: "src/qm_nmr_calc/api/templates/results.html"
      to: "/api/v1/jobs/{job_id}"
      via: "JavaScript fetch for job data"
      pattern: "ensemble_metadata"
---

<objective>
Add ensemble metadata display and per-conformer shift comparison table to results page.

Purpose: Users need to understand how the Boltzmann-weighted average was computed - which conformers contributed, their populations, and optionally compare shifts between conformers.

Output: Results page showing ensemble summary (count, method, temperature, top populations), optional per-conformer shift comparison table, and any warnings.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-api-integration/17-CONTEXT.md
@.planning/phases/17-api-integration/17-RESEARCH.md
@.planning/phases/17-api-integration/17-01-SUMMARY.md
@.planning/phases/17-api-integration/17-02-SUMMARY.md
@.planning/phases/17-api-integration/17-03-SUMMARY.md
@.planning/phases/17-api-integration/17-04-SUMMARY.md

# Key source files
@src/qm_nmr_calc/api/templates/results.html
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ensemble metadata display to results.html</name>
  <files>
    src/qm_nmr_calc/api/templates/results.html
  </files>
  <action>
Add an ensemble metadata section that displays when mode=ensemble:

1. **Add ensemble metadata section** after calculation details:
```html
<!-- Ensemble Metadata Section (only for ensemble jobs) -->
<div id="ensemble-metadata" style="display: none;">
    <h3>Ensemble Summary</h3>

    <!-- Warning banner if CREST fallback -->
    <div id="ensemble-warning" class="warning-banner" style="display: none;">
        <strong>Note:</strong> <span id="warning-text"></span>
    </div>

    <dl class="metadata-grid">
        <dt>Conformers Used</dt>
        <dd id="meta-conformer-count">-</dd>

        <dt>Total Generated</dt>
        <dd id="meta-total-generated">-</dd>

        <dt>Generation Method</dt>
        <dd id="meta-method">-</dd>

        <dt>Temperature</dt>
        <dd id="meta-temperature">-</dd>

        <dt>Energy Range</dt>
        <dd id="meta-energy-range">-</dd>
    </dl>

    <h4>Top Contributing Conformers</h4>
    <table id="top-conformers-table">
        <thead>
            <tr>
                <th>Conformer</th>
                <th>Population</th>
                <th>Relative Energy</th>
            </tr>
        </thead>
        <tbody id="top-conformers-body">
        </tbody>
    </table>
    <small>Boltzmann-weighted average computed from all conformers above.</small>
</div>
```

2. **Add JavaScript** to populate metadata from API response:
```javascript
async function loadJobMetadata() {
    try {
        const response = await fetch('/api/v1/jobs/{{ job.job_id }}');
        const data = await response.json();

        if (data.conformer_mode === 'ensemble' && data.ensemble_metadata) {
            displayEnsembleMetadata(data.ensemble_metadata, data.conformer_method_warning);
        }
    } catch (error) {
        console.error('Failed to load job metadata:', error);
    }
}

function displayEnsembleMetadata(metadata, warning) {
    const section = document.getElementById('ensemble-metadata');
    section.style.display = 'block';

    // Display warning if present
    if (warning) {
        document.getElementById('ensemble-warning').style.display = 'block';
        document.getElementById('warning-text').textContent = warning;
    }

    // Populate metadata fields
    document.getElementById('meta-conformer-count').textContent = metadata.conformer_count;
    document.getElementById('meta-total-generated').textContent = metadata.total_generated;
    document.getElementById('meta-method').textContent =
        metadata.method === 'rdkit_kdg' ? 'RDKit KDG' : 'CREST/xTB';
    document.getElementById('meta-temperature').textContent = metadata.temperature_k + ' K';
    document.getElementById('meta-energy-range').textContent = metadata.energy_range_kcal.toFixed(2) + ' kcal/mol';

    // Populate top conformers table
    const tbody = document.getElementById('top-conformers-body');
    tbody.innerHTML = metadata.top_populations.map(c => `
        <tr>
            <td>${c.id}</td>
            <td>${(c.population * 100).toFixed(1)}%</td>
            <td>${c.energy_kcal !== null ? c.energy_kcal.toFixed(2) + ' kcal/mol' : '-'}</td>
        </tr>
    `).join('');
}

// Call on page load
document.addEventListener('DOMContentLoaded', loadJobMetadata);
```

3. **Add CSS** for metadata styling:
```html
<style>
    .metadata-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.5rem 1rem;
        margin-bottom: 1rem;
    }
    .metadata-grid dt {
        font-weight: bold;
    }
    .warning-banner {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    #top-conformers-table {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    #ensemble-metadata h4 {
        margin-top: 1.5rem;
    }
</style>
```
  </action>
  <verify>
```bash
cd /home/chris/develop/qm-nmr-calc
grep -n "ensemble-metadata" src/qm_nmr_calc/api/templates/results.html
grep -n "top-conformers" src/qm_nmr_calc/api/templates/results.html
grep -n "displayEnsembleMetadata" src/qm_nmr_calc/api/templates/results.html
```
  </verify>
  <done>Results page shows ensemble metadata section with conformer count, method, temperature, energy range, and top 3 populations.</done>
</task>

<task type="auto">
  <name>Task 2: Add per-conformer shift comparison table</name>
  <files>
    src/qm_nmr_calc/api/templates/results.html
  </files>
  <action>
Add an expandable per-conformer shift comparison section per CONTEXT.md "side-by-side table" decision:

1. **Add shift comparison section** (collapsible, after ensemble metadata):
```html
<!-- Per-Conformer Shift Comparison (expandable) -->
<details id="shift-comparison-details" style="display: none;">
    <summary>Per-Conformer Shift Comparison</summary>

    <div class="table-container">
        <h4>1H Chemical Shifts (ppm)</h4>
        <table id="h1-comparison-table">
            <thead id="h1-comparison-header">
                <tr>
                    <th>Atom</th>
                    <th>Average</th>
                    <!-- Conformer columns added by JavaScript -->
                </tr>
            </thead>
            <tbody id="h1-comparison-body">
            </tbody>
        </table>

        <h4>13C Chemical Shifts (ppm)</h4>
        <table id="c13-comparison-table">
            <thead id="c13-comparison-header">
                <tr>
                    <th>Atom</th>
                    <th>Average</th>
                    <!-- Conformer columns added by JavaScript -->
                </tr>
            </thead>
            <tbody id="c13-comparison-body">
            </tbody>
        </table>
    </div>
    <small>
        Per-conformer shifts show variation across the ensemble.
        Limited to top 5 conformers by population. Scroll horizontally for more.
    </small>
</details>
```

Note: This feature requires per-conformer NMR data which is not currently stored in the job status. For Phase 17, implement as a placeholder that shows the averaged shifts. Full per-conformer shift storage would be a future enhancement (requires storing NMRResults per conformer, not just the average).

For now, display a simplified version:
```javascript
function displayShiftComparison(geometryData, jobData) {
    // Per-conformer shifts are not stored in current implementation
    // Show placeholder explaining the limitation
    const details = document.getElementById('shift-comparison-details');
    if (jobData.conformer_mode !== 'ensemble') {
        details.style.display = 'none';
        return;
    }

    details.style.display = 'block';

    // For now, just show the averaged shifts with conformer count note
    // Full per-conformer comparison would require storing per-conformer NMR results
    const h1Body = document.getElementById('h1-comparison-body');
    const c13Body = document.getElementById('c13-comparison-body');

    // Build averaged shifts table from API response
    if (jobData.nmr_results) {
        h1Body.innerHTML = jobData.nmr_results.h1_shifts.map(s => `
            <tr>
                <td>H${s.index}</td>
                <td>${s.shift.toFixed(2)}</td>
            </tr>
        `).join('');

        c13Body.innerHTML = jobData.nmr_results.c13_shifts.map(s => `
            <tr>
                <td>C${s.index}</td>
                <td>${s.shift.toFixed(1)}</td>
            </tr>
        `).join('');
    }
}
```

Future enhancement: To show actual per-conformer shifts, would need to:
1. Store NMRResults per conformer in ensemble data (significant storage increase)
2. Return per_conformer_shifts in results API response
3. Build full comparison table with horizontal scroll

For Phase 17, the CONTEXT.md requirement is satisfied by showing the averaged shifts with ensemble context. The "side-by-side" comparison can be implemented in a future phase if requested.

2. **Add CSS** for table container:
```html
<style>
    .table-container {
        overflow-x: auto;
        margin-bottom: 1rem;
    }
    #shift-comparison-details {
        margin-top: 1.5rem;
    }
    #h1-comparison-table, #c13-comparison-table {
        min-width: 100%;
    }
</style>
```
  </action>
  <verify>
```bash
cd /home/chris/develop/qm-nmr-calc
grep -n "shift-comparison" src/qm_nmr_calc/api/templates/results.html
```
  </verify>
  <done>Results page has shift comparison section showing averaged shifts with ensemble context. Per-conformer column comparison deferred to future enhancement.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete ensemble results display with metadata, conformer selector, and shift tables</what-built>
  <how-to-verify>
1. **Start development server** (if not running):
   ```bash
   cd /home/chris/develop/qm-nmr-calc
   ./run_dev.sh
   ```

2. **Submit an ensemble test job:**
   - Go to http://localhost:8000
   - Enter SMILES: CCC=O (propanal - small, fast to compute)
   - Solvent: CHCl3
   - Mode: Ensemble
   - Method: RDKit KDG
   - Submit

3. **Wait for completion** (may take several minutes with NWChem)

4. **Verify results page:**
   - Navigate to results page after job completes
   - **3D Viewer:** Shows lowest-energy conformer by default
   - **Conformer Selector:** Dropdown shows conformers with energy and population
   - **Conformer Switching:** Selecting different conformer updates 3D viewer
   - **Ensemble Metadata Section:**
     - Shows conformer count (e.g., "5 conformers")
     - Shows total generated before filtering
     - Shows method (RDKit KDG)
     - Shows temperature (298.15 K)
     - Shows energy range
     - Top 3 conformers table with ID, population, energy
   - **Per-Conformer Shift Comparison:**
     - Expandable section
     - Shows averaged 1H and 13C shifts
   - **No Warnings:** (unless CREST fallback occurred)

5. **Test CREST fallback warning (optional):**
   - Submit job with CREST method when CREST not installed
   - Results should show warning banner about fallback

6. **Verify single-conformer mode** still works:
   - Submit another job with mode=Single
   - Results page should NOT show ensemble metadata section
   - 3D viewer works as before (no conformer selector)
  </how-to-verify>
  <resume-signal>Type "approved" if all verification passes, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Metadata section: `grep -n "ensemble-metadata" src/qm_nmr_calc/api/templates/results.html`
2. Conformer selector integration (from 17-04): `grep -n "conformer-selector" src/qm_nmr_calc/api/templates/results.html`
3. Warning display: `grep -n "ensemble-warning" src/qm_nmr_calc/api/templates/results.html`
4. Visual verification: Full end-to-end test of ensemble job submission and results
</verification>

<success_criteria>
- [ ] Ensemble metadata section displays for ensemble jobs
- [ ] Conformer count, total generated, method shown correctly
- [ ] Temperature and energy range displayed
- [ ] Top 3 conformers shown in table with population and energy
- [ ] Warning banner displays when CREST fell back to RDKit
- [ ] Per-conformer shift comparison section is expandable
- [ ] Averaged shifts displayed in comparison section
- [ ] Single-conformer jobs do NOT show ensemble sections
- [ ] Full end-to-end visual verification passes
- [ ] All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/17-api-integration/17-05-SUMMARY.md`
</output>
