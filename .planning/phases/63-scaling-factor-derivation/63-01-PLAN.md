---
phase: 63-scaling-factor-derivation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/benchmark/analysis.py
  - src/qm_nmr_calc/data/scaling_factors.json
  - data/benchmark/delta50/scaling_factors.json
  - data/benchmark/delta50/SCALING-FACTORS.md
autonomous: true

must_haves:
  truths:
    - "analyze command produces scaling factors for all 12 B3LYP solvents (CHCl3, DMSO, Methanol, Water, Acetone, Benzene, Pyridine, THF, Toluene, DCM, Acetonitrile, DMF)"
    - "All 12 new factor sets (6 solvents x 2 nuclei) have R-squared > 0.99"
    - "1H MAE is below 0.2 ppm for each of the 6 new solvents"
    - "13C MAE is below 3.0 ppm for each of the 6 new solvents"
    - "Package scaling_factors.json contains 26 total factor sets (14 existing + 12 new)"
  artifacts:
    - path: "src/qm_nmr_calc/benchmark/analysis.py"
      provides: "Updated default solvents list including all 12 solvents"
      contains: "Pyridine.*THF.*Toluene.*DCM.*Acetonitrile.*DMF"
    - path: "src/qm_nmr_calc/data/scaling_factors.json"
      provides: "Package scaling factors with all 26 factor sets"
      contains: "Pyridine"
    - path: "data/benchmark/delta50/scaling_factors.json"
      provides: "Analysis output with all 24 solvent factor sets"
      contains: "Pyridine"
    - path: "data/benchmark/delta50/SCALING-FACTORS.md"
      provides: "Updated report with all 12 solvents"
      contains: "Pyridine"
  key_links:
    - from: "src/qm_nmr_calc/benchmark/analysis.py"
      to: "data/benchmark/results/compound_XX/B3LYP_{Solvent}/shifts.json"
      via: "aggregate_regression_data reads shielding values per solvent"
      pattern: "results_dir.*functional.*solvent"
    - from: "data/benchmark/delta50/scaling_factors.json"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "merge from analysis output to package data, preserving vacuum entries"
      pattern: "scaling_factors.json"
    - from: "src/qm_nmr_calc/shifts.py"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "load_scaling_factors reads package data at runtime"
      pattern: "scaling_factors.json"
---

<objective>
Derive OLS scaling factors for all 6 new solvents (Pyridine, THF, Toluene, DCM, Acetonitrile, DMF), validate they pass quality gates, and update the package scaling_factors.json with all 26 factor sets.

Purpose: Phases 60-62 produced 300 benchmark calculations (shielding values) across 6 new solvents. This phase converts those raw shielding values into usable scaling factors via linear regression, enabling accurate NMR shift prediction for the 6 new solvents. Without this step, the benchmark data is useless -- scaling factors are what the application actually uses at runtime.

Output: Updated scaling_factors.json (26 entries), regenerated SCALING-FACTORS.md report with plots, all quality gates validated.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@src/qm_nmr_calc/benchmark/analysis.py
@src/qm_nmr_calc/benchmark/__main__.py
@src/qm_nmr_calc/data/scaling_factors.json
@src/qm_nmr_calc/shifts.py

# Phase 56 reference (exact same pattern)
@.planning/phases/56-scaling-factor-derivation/56-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update default solvents and run analysis to derive all scaling factors</name>
  <files>
    src/qm_nmr_calc/benchmark/analysis.py
    data/benchmark/delta50/scaling_factors.json
    data/benchmark/delta50/SCALING-FACTORS.md
  </files>
  <action>
    1. In `src/qm_nmr_calc/benchmark/analysis.py`, update the `derive_all_factors` function's default solvents parameter (line ~213) from:
       ```python
       solvents = ["CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene"]
       ```
       to:
       ```python
       solvents = [
           "CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene",
           "Pyridine", "THF", "Toluene", "DCM", "Acetonitrile", "DMF",
       ]
       ```
       Use EXACT casing shown above -- it must match the benchmark results directory names (e.g., `B3LYP_Pyridine`, `B3LYP_THF`). Do NOT use COSMO names (e.g., "acetntrl") -- those are only for NWChem input generation.

    2. Run the analysis command to derive factors and generate the report:
       ```
       cd /home/chris/develop/qm-nmr-calc
       python -m qm_nmr_calc.benchmark analyze --output-dir data/benchmark/delta50
       ```
       This will:
       - Call `derive_all_factors()` which now processes all 12 solvents
       - Fit OLS regression for each solvent x nucleus combination (24 total factor sets)
       - Save `data/benchmark/delta50/scaling_factors.json` with all 24 factors
       - Generate regression and residual plots in `data/benchmark/delta50/plots/`
       - Generate `data/benchmark/delta50/SCALING-FACTORS.md` report

    3. After the command completes, examine the output to verify:
       - All 24 factor sets derived (12 solvents x 2 nuclei)
       - Check each new solvent's R-squared, MAE values against quality gates
       - Quick test: `python -m qm_nmr_calc.benchmark analyze --factors-only` should print 24 factor sets

    NOTE: The vacuum factors (2 entries) are NOT in the benchmark results directory (they came from Phase 11.2's separate vacuum benchmark). They will NOT be regenerated by this command. They must be preserved when merging into the package scaling_factors.json in Task 2.
  </action>
  <verify>
    - `python -m qm_nmr_calc.benchmark analyze --factors-only` completes without error and prints 24 factor sets
    - Output includes entries for Pyridine, THF, Toluene, DCM, Acetonitrile, DMF (both 1H and 13C)
    - `data/benchmark/delta50/scaling_factors.json` exists and contains 24 entries
    - `data/benchmark/delta50/SCALING-FACTORS.md` exists and references all 12 solvents
  </verify>
  <done>
    - 24 scaling factor sets derived (12 solvents x 2 nuclei)
    - All 12 new factor sets have R-squared > 0.99
    - All 6 new solvent 1H MAE < 0.2 ppm
    - All 6 new solvent 13C MAE < 3.0 ppm
    - SCALING-FACTORS.md report generated with tables and plots
  </done>
</task>

<task type="auto">
  <name>Task 2: Merge factors into package data and validate end-to-end</name>
  <files>
    src/qm_nmr_calc/data/scaling_factors.json
  </files>
  <action>
    1. The delta50 analysis output (`data/benchmark/delta50/scaling_factors.json`) contains 24 factor sets (12 solvents x 2 nuclei). The package data file (`src/qm_nmr_calc/data/scaling_factors.json`) currently has 14 entries (CHCl3, DMSO, Methanol, Water, Acetone, Benzene, vacuum -- 2 nuclei each). We need 26 total.

    2. Merge strategy: Start from the newly generated delta50 scaling_factors.json (24 entries for all 12 solvents). Then add the 2 vacuum entries from the current package scaling_factors.json. This ensures all solvent factors are re-derived from the same analysis run (consistency), and vacuum factors are preserved from Phase 11.2.

    3. Write a short Python script to merge:
       ```python
       import orjson
       from pathlib import Path

       # Load newly derived factors (24 entries)
       new_factors = orjson.loads(Path("data/benchmark/delta50/scaling_factors.json").read_bytes())

       # Load existing package factors to get vacuum entries
       pkg_factors = orjson.loads(Path("src/qm_nmr_calc/data/scaling_factors.json").read_bytes())

       # Add vacuum entries
       for key, value in pkg_factors.items():
           if "vacuum" in key:
               new_factors[key] = value

       # Should have 26 entries total
       assert len(new_factors) == 26, f"Expected 26, got {len(new_factors)}"

       # Write merged file
       Path("src/qm_nmr_calc/data/scaling_factors.json").write_bytes(
           orjson.dumps(new_factors, option=orjson.OPT_INDENT_2)
       )
       print(f"Merged {len(new_factors)} factors into package data")
       ```

    4. Validate the merged file:
       - Confirm 26 entries (14 existing keys + 12 new keys)
       - Confirm each entry has slope, intercept, r_squared, mae, rmsd, n_points, ci_slope, ci_intercept, outliers_removed
       - Confirm the vacuum entries are unchanged (compare slope/intercept to known values: 1H slope=-0.955379905689472, 13C slope=-0.9726389627459856)

    5. Run the existing test suite to verify nothing breaks:
       ```
       python -m pytest tests/ -x -q
       ```

    6. Verify the shifts module can load the new factors:
       ```python
       from qm_nmr_calc.shifts import load_scaling_factors
       factors = load_scaling_factors()
       print(f"Total factors: {len(factors)}")  # Should be 26

       # Verify all 6 new solvents are accessible
       for solvent in ["Pyridine", "THF", "Toluene", "DCM", "Acetonitrile", "DMF"]:
           for nucleus in ["1H", "13C"]:
               key = f"B3LYP/6-311+G(2d,p)/{nucleus}/{solvent}"
               assert key in factors, f"Missing: {key}"
               f = factors[key]
               print(f"{nucleus}/{solvent}: slope={f['slope']:.4f}, R2={f['r_squared']:.4f}, MAE={f['mae']:.3f}")
       ```

    NOTE: Do NOT update shifts.py `solvent_map` -- that is deferred to Phase 64 (Solvent Integration). The `get_scaling_factor()` function will not work for these new solvents yet because the solvent_map needs updating, but the raw factors are available in the JSON and via `load_scaling_factors()`.
  </action>
  <verify>
    - `src/qm_nmr_calc/data/scaling_factors.json` contains exactly 26 entries
    - `python -m pytest tests/ -x -q` passes (all 441 tests, 382 passing, 2 skipped)
    - `load_scaling_factors()` returns dict with 26 keys
    - All 6 new solvent keys present for both 1H and 13C
    - Vacuum factors unchanged (slope values match to 10+ decimal places)
  </verify>
  <done>
    - Package scaling_factors.json has 26 factor sets (14 existing + 12 new)
    - Each entry contains slope, intercept, r_squared, mae fields
    - All existing tests pass with no regressions
    - load_scaling_factors() returns all 26 entries including 6 new solvents
  </done>
</task>

</tasks>

<verification>
Run the full quality gate validation:

1. Factor count: `scaling_factors.json` has exactly 26 keys
2. R-squared gate: All 12 new factors have `r_squared > 0.99`
3. 1H MAE gate: Pyridine, THF, Toluene, DCM, Acetonitrile, DMF 1H MAE < 0.2 ppm
4. 13C MAE gate: Pyridine, THF, Toluene, DCM, Acetonitrile, DMF 13C MAE < 3.0 ppm
5. Test suite: `python -m pytest tests/ -x -q` passes
6. Runtime load: `from qm_nmr_calc.shifts import load_scaling_factors; assert len(load_scaling_factors()) == 26`
</verification>

<success_criteria>
- 26 scaling factor sets in package data (14 prior + 12 new)
- All 12 new factor sets pass R-squared > 0.99
- All 6 new solvent 1H MAE < 0.2 ppm
- All 6 new solvent 13C MAE < 3.0 ppm
- Existing test suite passes with no regressions
- Report and plots generated in data/benchmark/delta50/
</success_criteria>

<output>
After completion, create `.planning/phases/63-scaling-factor-derivation/63-01-SUMMARY.md`
</output>
