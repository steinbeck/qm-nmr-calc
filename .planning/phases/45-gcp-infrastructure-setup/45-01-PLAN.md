---
phase: 45-gcp-infrastructure-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gcp/setup-infrastructure.sh
  - gcp/teardown-infrastructure.sh
  - gcp/config.sh.example
autonomous: false

user_setup:
  - service: google-cloud
    why: "GCP Spot VM deployment"
    env_vars:
      - name: GCP_PROJECT_ID
        source: "GCP Console -> Project selector -> copy project ID"
    dashboard_config:
      - task: "Enable Compute Engine API"
        location: "GCP Console -> APIs & Services -> Enable Compute Engine API"
      - task: "gcloud CLI authenticated"
        location: "Run: gcloud auth login && gcloud config set project YOUR_PROJECT_ID"

must_haves:
  truths:
    - "Static external IP is reserved and can be used for DNS configuration"
    - "Firewall rules allow HTTP (80), HTTPS (443), and SSH (22) traffic"
    - "Persistent disk exists for job data and Let's Encrypt certificates"
    - "Persistent disk survives VM deletion (verified by delete/recreate cycle)"
  artifacts:
    - path: "gcp/setup-infrastructure.sh"
      provides: "Infrastructure provisioning script"
      contains: "gcloud compute addresses create"
    - path: "gcp/setup-infrastructure.sh"
      provides: "Firewall rule creation"
      contains: "gcloud compute firewall-rules create"
    - path: "gcp/setup-infrastructure.sh"
      provides: "Persistent disk creation"
      contains: "gcloud compute disks create"
    - path: "gcp/teardown-infrastructure.sh"
      provides: "Infrastructure cleanup script"
      contains: "gcloud compute addresses delete"
    - path: "gcp/config.sh.example"
      provides: "Configuration template"
      contains: "GCP_PROJECT_ID"
  key_links:
    - from: "gcp/setup-infrastructure.sh"
      to: "gcp/config.sh.example"
      via: "source ./config.sh"
      pattern: "source.*config\\.sh"
    - from: "gcp/teardown-infrastructure.sh"
      to: "gcp/config.sh.example"
      via: "source ./config.sh"
      pattern: "source.*config\\.sh"
---

<objective>
Create GCP infrastructure setup scripts that provision the networking and storage prerequisites for Spot VM deployment.

Purpose: Phase 46 (VM Deployment) requires static IP, firewall rules, and persistent disk to already exist. This phase ensures the foundation is in place before any VM is created.

Output:
- `gcp/setup-infrastructure.sh` - creates static IP, firewall rules, and persistent disk
- `gcp/teardown-infrastructure.sh` - removes infrastructure (for cleanup/reset)
- `gcp/config.sh.example` - configuration template for user customization
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GCP infrastructure setup script</name>
  <files>gcp/setup-infrastructure.sh, gcp/config.sh.example</files>
  <action>
Create `gcp/` directory and infrastructure scripts.

**gcp/config.sh.example:**
```bash
# GCP Configuration - copy to config.sh and customize
GCP_PROJECT_ID="your-project-id"
GCP_REGION="us-central1"
GCP_ZONE="us-central1-a"
RESOURCE_PREFIX="qm-nmr-calc"
DISK_SIZE_GB="100"
```

**gcp/setup-infrastructure.sh:**
Create a bash script that:

1. **Source configuration:**
   - Source `./config.sh` (fail if not exists)
   - Validate GCP_PROJECT_ID is set
   - Set gcloud project: `gcloud config set project $GCP_PROJECT_ID`

2. **Check gcloud authentication:**
   - Run `gcloud auth list --filter=status:ACTIVE --format="value(account)"`
   - Exit with helpful message if not authenticated

3. **Reserve static external IP (INFRA-01):**
   - Name: `${RESOURCE_PREFIX}-ip`
   - Region: `$GCP_REGION`
   - Command: `gcloud compute addresses create ${RESOURCE_PREFIX}-ip --region=$GCP_REGION`
   - Check if already exists first (idempotent)
   - Print the IP address after creation for DNS configuration

4. **Create firewall rules (INFRA-02):**
   - Name pattern: `${RESOURCE_PREFIX}-allow-{http,https,ssh}`
   - Allow ingress from 0.0.0.0/0
   - Target tags: `${RESOURCE_PREFIX}-vm`
   - Rules:
     - HTTP: tcp:80
     - HTTPS: tcp:443
     - SSH: tcp:22
   - Check if already exists first (idempotent)

5. **Create persistent disk (INFRA-03):**
   - Name: `${RESOURCE_PREFIX}-data`
   - Zone: `$GCP_ZONE`
   - Type: pd-ssd
   - Size: `$DISK_SIZE_GB` GB
   - Command: `gcloud compute disks create ${RESOURCE_PREFIX}-data --zone=$GCP_ZONE --type=pd-ssd --size=${DISK_SIZE_GB}GB`
   - Check if already exists first (idempotent)

6. **Print summary:**
   - Static IP address (for DNS configuration)
   - Firewall rules created
   - Persistent disk name and size

Make script executable and use `set -euo pipefail` for safety.
Use `--format="value(address)"` to extract just the IP address.
  </action>
  <verify>
Run `bash -n gcp/setup-infrastructure.sh` to verify syntax.
Run `bash -n gcp/config.sh.example` to verify syntax.
Confirm both files exist and are executable.
  </verify>
  <done>
Scripts exist at gcp/setup-infrastructure.sh and gcp/config.sh.example with correct structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create teardown script</name>
  <files>gcp/teardown-infrastructure.sh</files>
  <action>
Create `gcp/teardown-infrastructure.sh` that removes all created infrastructure.

**Script requirements:**

1. **Source configuration:**
   - Source `./config.sh`
   - Set gcloud project

2. **Delete in reverse order:**
   - Delete persistent disk (with confirmation prompt): `gcloud compute disks delete ${RESOURCE_PREFIX}-data --zone=$GCP_ZONE`
   - Delete firewall rules: `gcloud compute firewall-rules delete ${RESOURCE_PREFIX}-allow-http ${RESOURCE_PREFIX}-allow-https ${RESOURCE_PREFIX}-allow-ssh`
   - Release static IP: `gcloud compute addresses delete ${RESOURCE_PREFIX}-ip --region=$GCP_REGION`

3. **Safety features:**
   - Prompt "Are you sure? This will delete the persistent disk with ALL job data." before proceeding
   - Allow `--force` flag to skip confirmation
   - Print each deletion as it happens
   - Continue on error (some resources may not exist)

Make script executable.
  </action>
  <verify>
Run `bash -n gcp/teardown-infrastructure.sh` to verify syntax.
Confirm file exists and is executable.
  </verify>
  <done>
Teardown script exists at gcp/teardown-infrastructure.sh with safety prompts and force flag.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
GCP infrastructure setup and teardown scripts:
- `gcp/setup-infrastructure.sh` - provisions static IP, firewall rules, persistent disk
- `gcp/teardown-infrastructure.sh` - removes all infrastructure
- `gcp/config.sh.example` - configuration template
  </what-built>
  <how-to-verify>
1. Copy config template and set your project:
   ```bash
   cd gcp
   cp config.sh.example config.sh
   # Edit config.sh with your GCP_PROJECT_ID
   ```

2. Run setup script:
   ```bash
   ./setup-infrastructure.sh
   ```
   Expected: Static IP printed, firewall rules created, persistent disk created

3. Verify resources in GCP Console or CLI:
   ```bash
   # Check static IP
   gcloud compute addresses list --filter="name:qm-nmr-calc-ip"

   # Check firewall rules
   gcloud compute firewall-rules list --filter="name~qm-nmr-calc"

   # Check persistent disk
   gcloud compute disks list --filter="name:qm-nmr-calc-data"
   ```

4. Verify INFRA-04 (disk survives VM deletion):
   - Create a test VM attached to the disk
   - Delete the VM
   - Verify disk still exists:
   ```bash
   # Quick test VM (delete immediately after)
   gcloud compute instances create test-vm \
     --zone=us-central1-a \
     --machine-type=e2-micro \
     --disk=name=qm-nmr-calc-data,auto-delete=no

   # Delete test VM
   gcloud compute instances delete test-vm --zone=us-central1-a

   # Verify disk still exists
   gcloud compute disks describe qm-nmr-calc-data --zone=us-central1-a
   ```

5. Note the static IP address for DNS configuration in Phase 48.
  </how-to-verify>
  <resume-signal>Type "approved" if all infrastructure created successfully, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 45 success criteria:
1. Static external IP reserved: `gcloud compute addresses describe qm-nmr-calc-ip --region=$GCP_REGION`
2. Firewall rules exist for HTTP, HTTPS, SSH: `gcloud compute firewall-rules list --filter="name~qm-nmr-calc"`
3. Persistent disk exists: `gcloud compute disks describe qm-nmr-calc-data --zone=$GCP_ZONE`
4. Disk survives VM deletion: Create and delete test VM, verify disk remains
</verification>

<success_criteria>
- [ ] `gcp/setup-infrastructure.sh` creates static IP, firewall rules, and persistent disk
- [ ] `gcp/teardown-infrastructure.sh` removes all infrastructure with safety prompt
- [ ] `gcp/config.sh.example` provides configuration template
- [ ] Scripts are idempotent (can run multiple times safely)
- [ ] User has verified infrastructure exists in GCP Console
- [ ] User has verified persistent disk survives VM deletion
- [ ] Static IP address noted for DNS configuration
</success_criteria>

<output>
After completion, create `.planning/phases/45-gcp-infrastructure-setup/45-01-SUMMARY.md`
</output>
