---
phase: 51-deployment-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gcp/lib/infra.sh
autonomous: true

must_haves:
  truths:
    - "Logging functions (log_info, log_warn, log_error) output timestamped messages with log level"
    - "Dry-run wrapper (execute) echoes command instead of running when DRY_RUN=true"
    - "Cleanup trap tracks created resources and deletes VMs on failure (never disks)"
    - "create_static_ip() returns existing IP if present, creates and returns new IP if missing"
    - "create_firewall_rules() creates HTTP/SSH firewall rules idempotently (skips if exists)"
    - "create_persistent_disk() creates disk if missing, reuses if exists, verifying zone match"
    - "display_cost_estimate() shows itemized cost breakdown with spot hourly rate and monthly total"
    - "create_vm() creates Spot VM with correct machine type, static IP, disk, and startup script"
  artifacts:
    - path: "gcp/lib/infra.sh"
      provides: "Infrastructure library with idempotent operations, logging, dry-run, cleanup, cost display, VM creation"
      min_lines: 200
  key_links:
    - from: "gcp/lib/infra.sh"
      to: "gcloud compute"
      via: "execute() wrapper for all gcloud commands"
      pattern: "execute.*gcloud"
---

<objective>
Create the infrastructure library (gcp/lib/infra.sh) that provides all building blocks for the deployment orchestrator.

Purpose: This library contains all idempotent infrastructure operations, logging utilities, dry-run support, cleanup trap, cost estimation display, and VM creation. The orchestrator (Plan 02) will source this library and call its functions in sequence.

Output: gcp/lib/infra.sh with functions for logging, dry-run, cleanup, static IP, firewall rules, persistent disk, cost estimation, and VM creation.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-deployment-orchestration/51-RESEARCH.md
@gcp/setup-infrastructure.sh
@gcp/deploy-vm.sh
@gcp/startup.sh
@gcp/lib/config.sh
@gcp/lib/pricing.sh
@gcp/lib/machine.sh
@gcp/select_machine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gcp/lib/infra.sh with logging, dry-run, and cleanup utilities</name>
  <files>gcp/lib/infra.sh</files>
  <action>
Create gcp/lib/infra.sh with the following structure. This file will be sourced by deploy-auto.sh (Plan 02).

**Header and globals:**
```bash
#!/bin/bash
# Infrastructure library for v2.7 automated deployment
# Provides idempotent operations, logging, dry-run, cleanup, cost display, and VM creation
#
# Usage:
#   source gcp/lib/infra.sh
#   # Functions available: log_info, log_warn, log_error, execute,
#   # register_resource, cleanup_on_failure, create_static_ip,
#   # create_firewall_rules, create_persistent_disk, display_cost_estimate,
#   # create_vm
```

Set globals at top of file:
- `DRY_RUN="${DRY_RUN:-false}"` (can be overridden before sourcing)
- `CREATED_RESOURCES=()` (tracks resources for cleanup)

**Logging functions (log_info, log_warn, log_error):**
- Format: `[YYYY-MM-DD HH:MM:SS] [LEVEL] message`
- Use date +"%Y-%m-%d %H:%M:%S" for timestamps
- Colors: GREEN for INFO, YELLOW for WARN, RED for ERROR
- NC for color reset
- Example: `[2026-02-06 14:30:15] [INFO] Creating static IP...`

**Dry-run wrapper (execute):**
```bash
execute() {
    local description="$1"
    shift
    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "[DRY-RUN] $description"
        log_info "  Command: $*"
        return 0
    fi
    log_info "$description"
    "$@"
}
```

**Resource tracking and cleanup:**
```bash
register_resource() {
    # Format: "type:name:location"
    CREATED_RESOURCES+=("$1")
}

cleanup_on_failure() {
    local exit_code=$?
    if [[ $exit_code -ne 0 && ${#CREATED_RESOURCES[@]} -gt 0 ]]; then
        log_error "Deployment failed (exit code $exit_code). Cleaning up..."
        for resource in "${CREATED_RESOURCES[@]}"; do
            IFS=':' read -r type name location <<< "$resource"
            case "$type" in
                vm)
                    log_info "Deleting VM $name in $location..."
                    gcloud compute instances delete "$name" --zone="$location" --quiet 2>/dev/null || true
                    ;;
                # Never delete disks (data loss risk) or IPs (reusable)
            esac
        done
        log_info "Cleanup complete"
    fi
}
```
Note: The trap is NOT set in the library. The orchestrator (deploy-auto.sh) will call `trap cleanup_on_failure EXIT` after sourcing. This keeps the library composable.

**Idempotent infrastructure functions:**

`create_static_ip()` - Takes ip_name and region as args:
- Check existence: `gcloud compute addresses describe "$ip_name" --region="$region" --format="value(address)" --quiet 2>/dev/null || true`
- If exists: log_info "Static IP already exists: $existing_ip", echo the IP
- If not: use `execute` wrapper to create, then describe to get IP, echo it
- Returns IP via stdout (caller captures with `$()`)

`create_firewall_rules()` - Takes resource_prefix as arg:
- VM tag: "${resource_prefix}-vm"
- Create HTTP rule (port 80) and SSH rule (port 22) idempotently
- For each: check with `gcloud compute firewall-rules describe "$rule_name" --quiet &>/dev/null`
- If exists: log_info "already exists"
- If not: use `execute` wrapper to create with --quiet flag
- DO NOT create HTTPS (port 443) rule -- v2.7 is HTTP-only (RPL-03)

`create_persistent_disk()` - Takes disk_name, zone, and disk_size_gb as args:
- Check existence: `gcloud compute disks describe "$disk_name" --zone="$zone" --quiet &>/dev/null`
- If exists: log_info "already exists" with size
- If not: use `execute` wrapper to create with --type=pd-ssd --size="${disk_size_gb}GB" --quiet

**Cost estimation display:**

`display_cost_estimate()` - Takes machine_type, spot_price_hourly, and disk_size_gb as args:
- Calculate monthly_spot: `spot_price_hourly * 730` (use bc for math)
- Calculate disk_cost: `disk_size_gb * 0.17` (pd-ssd per-GB monthly, use bc)
- Calculate total: `monthly_spot + disk_cost`
- Display itemized breakdown:
  ```
  Cost Estimate:
    VM (Spot):              $X.XXXX/hour    ~$XX.XX/month (730 hours)
    Persistent disk (SSD):  $0.17/GB/month  ~$XX.XX/month (XXX GB)
    Static IP (in use):     Free
    ──────────────────────────────────────────
    Estimated total:                         ~$XX.XX/month

  Note: Spot pricing fluctuates. VM may be preempted with 30s notice.
  ```
- Use printf for aligned formatting

**VM creation:**

`create_vm()` - Takes vm_name, zone, machine_type, static_ip, disk_name, startup_script_path, shutdown_script_path, resource_prefix:
- Check if VM exists: `gcloud compute instances describe "$vm_name" --zone="$zone" --quiet &>/dev/null`
- If exists: log_error "VM already exists" and return 1
- Use `execute` wrapper to create with:
  - `--provisioning-model=SPOT`
  - `--instance-termination-action=STOP`
  - `--tags="${resource_prefix}-vm"`
  - `--network-interface="address=$static_ip"`
  - `--boot-disk-size=20GB --boot-disk-type=pd-balanced`
  - `--image-family=debian-12 --image-project=debian-cloud`
  - `--disk="name=${disk_name},mode=rw,device-name=data-disk,boot=no,auto-delete=no"`
  - `--metadata-from-file=startup-script=${startup_script_path},shutdown-script=${shutdown_script_path}`
  - `--quiet`
- After creation: `register_resource "vm:$vm_name:$zone"`
- log_info "VM created successfully"

**Important patterns to follow:**
- All gcloud commands use --quiet for non-interactive execution (DEP-02)
- All gcloud create commands go through execute() wrapper for dry-run support (DEP-09)
- All gcloud describe commands for existence checks do NOT go through execute() -- they always run even in dry-run
- Use `|| true` only for existence checks, not for create operations
  </action>
  <verify>
Run: `bash -n gcp/lib/infra.sh` to verify syntax.
Run: `grep -c 'execute\|log_info\|log_warn\|log_error\|DRY_RUN\|CREATED_RESOURCES\|create_static_ip\|create_firewall_rules\|create_persistent_disk\|display_cost_estimate\|create_vm\|cleanup_on_failure' gcp/lib/infra.sh` to confirm all functions present (should be many matches).
Run: `grep -c 'gcloud.*--quiet' gcp/lib/infra.sh` to confirm --quiet on all gcloud commands.
Run: `grep 'port.*443\|HTTPS\|https\|Caddy\|caddy' gcp/lib/infra.sh` should return nothing (HTTP-only, no HTTPS).
  </verify>
  <done>
gcp/lib/infra.sh exists with all utility functions (logging, dry-run, cleanup) and all idempotent infrastructure functions (static IP, firewall rules, disk, cost display, VM creation). All gcloud commands use --quiet. No HTTPS/443/Caddy references. Syntax validates cleanly.
  </done>
</task>

</tasks>

<verification>
1. `bash -n gcp/lib/infra.sh` exits 0 (valid syntax)
2. File contains: log_info, log_warn, log_error, execute, register_resource, cleanup_on_failure, create_static_ip, create_firewall_rules, create_persistent_disk, display_cost_estimate, create_vm
3. All gcloud commands include --quiet flag
4. No HTTPS/443/Caddy references (HTTP-only deployment)
5. DRY_RUN variable respected in execute() wrapper
6. CREATED_RESOURCES array used for cleanup tracking
7. Cleanup only deletes VMs, never disks or IPs
</verification>

<success_criteria>
- gcp/lib/infra.sh is a valid bash script (syntax checks pass)
- Contains all 11 functions listed in must_haves
- All gcloud create commands go through execute() wrapper
- Existence checks use describe || true pattern
- No interactive prompts (--quiet everywhere)
- HTTP-only (no port 443, no HTTPS references)
- Cleanup only removes VMs on failure
</success_criteria>

<output>
After completion, create `.planning/phases/51-deployment-orchestration/51-01-SUMMARY.md`
</output>
