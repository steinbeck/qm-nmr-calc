---
phase: 09-benchmark-calculations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/benchmark/runner.py
  - src/qm_nmr_calc/benchmark/__main__.py
autonomous: true

must_haves:
  truths:
    - "Status file shows progress (completed/total/failed)"
    - "Runner stops gracefully when STOP file exists"
    - "Runner pauses if >5 failures (10% threshold)"
    - "Headless mode disables tqdm and logs to file"
  artifacts:
    - path: "src/qm_nmr_calc/benchmark/runner.py"
      provides: "Status tracking, graceful stop, failure threshold"
      contains: "update_status|check_stop_requested|FAILURE_THRESHOLD"
    - path: "src/qm_nmr_calc/benchmark/__main__.py"
      provides: "Enhanced status display from status.json"
      contains: "format_status"
  key_links:
    - from: "runner.py:run_benchmark"
      to: "status.json"
      via: "update_status() call after each calculation"
      pattern: "update_status\\("
    - from: "runner.py:run_benchmark"
      to: "STOP file"
      via: "check_stop_requested() in loop"
      pattern: "check_stop_requested\\("
---

<objective>
Enhance benchmark runner with status monitoring, graceful stop, and headless execution support

Purpose: Enable long-running (20-30 hour) benchmark execution with reliable monitoring and clean shutdown
Output: Enhanced runner.py with status.json tracking, STOP file support, and CLI improvements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-benchmark-calculations/09-CONTEXT.md
@.planning/phases/09-benchmark-calculations/09-RESEARCH.md
@.planning/phases/08-delta50-setup/08-02-SUMMARY.md
@src/qm_nmr_calc/benchmark/runner.py
@src/qm_nmr_calc/benchmark/__main__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status tracking and control mechanisms to runner</name>
  <files>src/qm_nmr_calc/benchmark/runner.py</files>
  <action>
Enhance runner.py with status monitoring and control:

1. **Add status.json tracking:**
   - Create `update_status()` function that writes atomic JSON using orjson + temp file rename pattern
   - Status schema: run_id, started_at, updated_at, state (running/stopped/complete/failed), total_tasks, completed, failed, current_task (molecule_id/functional/solvent/started_at), failures (last 10), estimated_remaining_hours, avg_calc_time_seconds
   - Use rolling average of last 10 calculation times for ETA (not overall average)
   - Write status.json to results_dir after each calculation completes

2. **Add graceful stop via marker file:**
   - Create `check_stop_requested()` that checks for STOP file in results_dir
   - Create `clear_stop_file()` to remove STOP file after acknowledging
   - Check for STOP file between calculations in main loop, not during
   - If STOP found: set state to "stopped", write final status, return early

3. **Add failure threshold enforcement:**
   - Define FAILURE_THRESHOLD = 5 (10% of 50 molecules)
   - Track unique molecule failures (same molecule failing in multiple conditions counts as 1)
   - After each failure, check if threshold exceeded
   - If exceeded: set state to "paused", write status with message, return early

4. **Modify run_benchmark() to use these features:**
   - Initialize status.json at start (state: "running")
   - Track calculation start times for individual tasks
   - Call update_status() after each task completes
   - Check stop/threshold conditions between tasks
   - Set final state on completion (complete/stopped/paused)
   - Return state string in addition to results list (tuple return or add to results)

5. **Add headless mode detection:**
   - Add `headless: bool = False` parameter to run_benchmark()
   - When headless=True: disable tqdm (pass disable=True), configure file logging
   - Configure logging to write to results_dir / "benchmark.log" in headless mode
   - Use logger.info instead of tqdm.write for progress messages

Use orjson with OPT_INDENT_2 for status.json (project standard).
  </action>
  <verify>
Run unit tests: `pytest tests/test_benchmark.py -v`
Check status file schema: Verify orjson imports and atomic write pattern present
  </verify>
  <done>
- update_status() writes atomic status.json with all required fields
- check_stop_requested() checks for STOP marker file
- FAILURE_THRESHOLD = 5 enforced in main loop
- run_benchmark() has headless parameter
- All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI status command with rich display</name>
  <files>src/qm_nmr_calc/benchmark/__main__.py</files>
  <action>
Enhance CLI with better status display:

1. **Update cmd_status() to read status.json:**
   - Read status.json from results_dir (if exists)
   - Fall back to existing show_status() if no status.json (backwards compat)
   - Handle JSONDecodeError gracefully (file being written)

2. **Create format_status() for human-readable output:**
   - Display: State, Progress (X/Y, Z%), Failed count
   - Current task: molecule/functional/solvent (if running)
   - ETA: hours or "X minutes" if <1 hour
   - Started: timestamp
   - Last update: timestamp
   - Recent failures: last 3 failures with error messages (if any)

3. **Add --headless flag to run subcommand:**
   - Pass headless=True to run_benchmark()
   - Print message about checking status with `benchmark status`
   - Print message about stopping with `touch data/benchmark/results/STOP`

4. **Add stop subcommand:**
   - Create STOP marker file in results_dir
   - Print message: "Stop requested. Runner will stop after current calculation."
   - Idempotent: if STOP already exists, print "Stop already requested"

5. **Document headless usage in help text:**
   - Update run command help to mention nohup pattern
   - Example: `nohup python -m qm_nmr_calc.benchmark run --headless > /dev/null 2>&1 &`
  </action>
  <verify>
Test CLI commands work:
- `python -m qm_nmr_calc.benchmark status` (reads status.json if exists, falls back to counting)
- `python -m qm_nmr_calc.benchmark run --help` (shows --headless flag)
- `python -m qm_nmr_calc.benchmark stop` (creates STOP file)
  </verify>
  <done>
- cmd_status() reads and formats status.json
- format_status() produces human-readable output
- --headless flag added to run subcommand
- stop subcommand creates STOP marker file
- Help text documents headless usage
  </done>
</task>

</tasks>

<verification>
- [ ] `pytest tests/test_benchmark.py -v` passes
- [ ] `python -m qm_nmr_calc.benchmark status` works (shows 0/200 or reads status.json)
- [ ] `python -m qm_nmr_calc.benchmark run --help` shows --headless flag
- [ ] `python -m qm_nmr_calc.benchmark stop` creates STOP file
- [ ] Status.json follows schema from RESEARCH.md
</verification>

<success_criteria>
Runner is ready for long-running headless execution:
- Status monitoring via status.json
- Graceful stop via STOP marker file
- 10% failure threshold enforcement
- Headless mode with file logging
- CLI commands for monitoring and control
</success_criteria>

<output>
After completion, create `.planning/phases/09-benchmark-calculations/09-01-SUMMARY.md`
</output>
