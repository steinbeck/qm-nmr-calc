---
phase: 59-benchmark-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/input_gen.py
  - src/qm_nmr_calc/benchmark/__main__.py
  - tests/test_nwchem_input.py
autonomous: true

must_haves:
  truths:
    - "Benchmark CLI accepts Pyridine, THF, Toluene, DCM, Acetonitrile, DMF as valid --solvents values"
    - "NWChem input for acetonitrile contains 'solvent acetntrl' (COSMO mapping applied)"
    - "NWChem input for pyridine, thf, toluene, dcm, dmf contains 'solvent {name}' (direct names)"
    - "Parametrized test covers all 13 non-vacuum solvents without failure"
    - "All existing tests still pass (no regression)"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/input_gen.py"
      provides: "SUPPORTED_SOLVENTS with 6 new solvents + COSMO_NAME_MAP + _get_cosmo_solvent_name()"
      contains: "acetntrl"
    - path: "src/qm_nmr_calc/benchmark/__main__.py"
      provides: "CLI --solvents choices with all 12 solvents"
      contains: "Acetonitrile"
    - path: "tests/test_nwchem_input.py"
      provides: "COSMO name mapping tests and updated parametrized solvent tests"
      contains: "acetntrl"
  key_links:
    - from: "src/qm_nmr_calc/benchmark/__main__.py"
      to: "src/qm_nmr_calc/nwchem/input_gen.py"
      via: "CLI Title-case names lowered by runner.py, then validated against SUPPORTED_SOLVENTS"
      pattern: "choices=.*Pyridine.*THF.*Toluene.*DCM.*Acetonitrile.*DMF"
    - from: "src/qm_nmr_calc/nwchem/input_gen.py"
      to: "NWChem COSMO block"
      via: "_get_cosmo_solvent_name maps acetonitrile to acetntrl before writing COSMO block"
      pattern: "COSMO_NAME_MAP.*acetntrl"
---

<objective>
Add 6 new solvents (pyridine, THF, toluene, DCM, acetonitrile, DMF) to the NWChem input generation and benchmark CLI, with a COSMO name mapping layer for the acetonitrile -> acetntrl special case.

Purpose: Phase 60-62 needs to dispatch 300 NWChem benchmark calculations across 6 new solvents. The CLI currently only allows CHCl3, DMSO, Methanol, Water, Acetone, Benzene. This plan adds the 6 new solvents to input generation and CLI choices. It does NOT add them to the default SOLVENTS list in runner.py (those solvents lack scaling factors until Phase 63) -- users opt-in via `--solvents`.

Output: Modified source files and tests that allow `python -m qm_nmr_calc.benchmark run --solvents Pyridine --functionals B3LYP --headless` to be accepted and generate valid NWChem COSMO input.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/qm_nmr_calc/nwchem/input_gen.py
@src/qm_nmr_calc/benchmark/__main__.py
@tests/test_nwchem_input.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 6 new solvents to input_gen.py with COSMO name mapping</name>
  <files>
    src/qm_nmr_calc/nwchem/input_gen.py
    src/qm_nmr_calc/benchmark/__main__.py
  </files>
  <action>
Two files need changes:

1. **input_gen.py**: Three changes in this file:

   a. Add 6 new solvents to SUPPORTED_SOLVENTS set (line 8):
   - Change: `SUPPORTED_SOLVENTS = {"chcl3", "dmso", "water", "acetone", "methanol", "benzene", "vacuum"}`
   - To: `SUPPORTED_SOLVENTS = {"chcl3", "dmso", "water", "acetone", "methanol", "benzene", "vacuum", "pyridine", "thf", "toluene", "dcm", "acetonitrile", "dmf"}`

   b. Add COSMO name mapping dict and helper function AFTER the SUPPORTED_SOLVENTS line and BEFORE `_validate_solvent`:
   ```python
   # Map user-friendly solvent names to NWChem COSMO names.
   # Most solvents use the same name; acetonitrile is the exception.
   COSMO_NAME_MAP: dict[str, str] = {
       "acetonitrile": "acetntrl",  # NWChem uses abbreviated name
   }


   def _get_cosmo_solvent_name(solvent: str) -> str:
       """Map user-friendly solvent name to NWChem COSMO name.

       Most solvents pass through unchanged. Acetonitrile maps to 'acetntrl'
       which is the name NWChem recognizes in its COSMO parameter tables.

       Args:
           solvent: Normalized solvent name (lowercase).

       Returns:
           NWChem COSMO solvent name.
       """
       return COSMO_NAME_MAP.get(solvent, solvent)
   ```

   c. In BOTH `generate_optimization_input` and `generate_shielding_input`, apply the COSMO name mapping. In each function, after `solvent_name = _validate_solvent(solvent)`, the COSMO block construction for non-vacuum uses `solvent_name` directly. Change the COSMO block to use `_get_cosmo_solvent_name(solvent_name)` instead:
   - In the `else` branch where `cosmo_block` is built, change `solvent {solvent_name}` to use a mapped name:
     ```python
     cosmo_name = _get_cosmo_solvent_name(solvent_name)
     cosmo_block = f"""
     cosmo
       do_gasphase False
       solvent {cosmo_name}
     end
     """
     ```
   - Apply this change in BOTH `generate_optimization_input` (around line 67) and `generate_shielding_input` (around line 133).

2. **__main__.py** (line 280): Expand the choices list for the --solvents argument to include the 6 new solvents in Title-case.
   - Change: `choices=["CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene"]`
   - To: `choices=["CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene", "Pyridine", "THF", "Toluene", "DCM", "Acetonitrile", "DMF"]`
   - Update help text on line 281: `help="Solvents to test (default: CHCl3 DMSO Methanol Water Acetone Benzene)"`
   - NOTE: Keep the existing help text referencing the DEFAULT solvents (6 original). The 6 new solvents are opt-in only.

IMPORTANT: Do NOT modify runner.py SOLVENTS list. The 6 new solvents should NOT be in the default SOLVENTS constant because scaling factors don't exist yet. Users opt-in via `--solvents Pyridine` etc.

IMPORTANT: The runner converts Title-case CLI names to lowercase via `solvent=solvent.lower()` on line 234 of runner.py. This chain must work: e.g., Acetonitrile -> acetonitrile -> SUPPORTED_SOLVENTS -> _get_cosmo_solvent_name -> acetntrl in COSMO block.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem.input_gen import SUPPORTED_SOLVENTS; assert 'pyridine' in SUPPORTED_SOLVENTS; assert 'acetonitrile' in SUPPORTED_SOLVENTS; assert 'dmf' in SUPPORTED_SOLVENTS; print('All 6 new solvents in SUPPORTED_SOLVENTS'); print(sorted(SUPPORTED_SOLVENTS))"`

Run: `python -c "from qm_nmr_calc.nwchem.input_gen import generate_optimization_input; r = generate_optimization_input('C 0.0 0.0 0.0', 'b3lyp', '6-31G*', 'acetonitrile'); assert 'solvent acetntrl' in r; assert 'acetonitrile' not in r; print('Acetonitrile COSMO mapping OK')"`

Run: `python -c "from qm_nmr_calc.nwchem.input_gen import generate_shielding_input; r = generate_shielding_input('C 0.0 0.0 0.0', 'b3lyp', '6-311+G(2d,p)', 'pyridine'); assert 'solvent pyridine' in r; print('Pyridine COSMO OK')"`

Run: `python -m qm_nmr_calc.benchmark run --solvents Pyridine --functionals B3LYP --help` to verify no argparse error.
  </verify>
  <done>
SUPPORTED_SOLVENTS contains all 6 new solvents. COSMO_NAME_MAP maps acetonitrile to acetntrl. Both generate_optimization_input and generate_shielding_input use the mapping. CLI --solvents accepts all 6 new Title-case names. NWChem input for acetonitrile contains "solvent acetntrl", not "solvent acetonitrile".
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for COSMO name mapping and new solvent acceptance</name>
  <files>
    tests/test_nwchem_input.py
  </files>
  <action>
Add a new test class `TestCOSMONameMapping` to tests/test_nwchem_input.py with tests for the acetonitrile -> acetntrl mapping and direct-name solvents. Also verify the existing parametrized test `test_all_supported_solvents_accepted` handles the COSMO name mapping correctly.

1. **Add import** for `_get_cosmo_solvent_name` and `COSMO_NAME_MAP`:
   ```python
   from qm_nmr_calc.nwchem.input_gen import SUPPORTED_SOLVENTS, COSMO_NAME_MAP, _get_cosmo_solvent_name
   ```

2. **Add TestCOSMONameMapping class** after the existing TestBenzeneSolvent class:
   ```python
   class TestCOSMONameMapping:
       """Tests for NWChem COSMO solvent name mapping."""

       def test_acetonitrile_maps_to_acetntrl(self):
           """Acetonitrile should use 'acetntrl' in COSMO block."""
           result = generate_optimization_input(
               geometry_xyz="C 0.0 0.0 0.0",
               functional="b3lyp",
               basis_set="6-31G*",
               solvent="acetonitrile",
           )
           assert "cosmo" in result.lower()
           assert "solvent acetntrl" in result
           assert "acetonitrile" not in result

       def test_acetonitrile_shielding_maps_to_acetntrl(self):
           """Acetonitrile mapping should work for shielding input too."""
           result = generate_shielding_input(
               geometry_xyz="C 0.0 0.0 0.0",
               functional="b3lyp",
               basis_set="6-311+G(2d,p)",
               solvent="acetonitrile",
           )
           assert "solvent acetntrl" in result
           assert "acetonitrile" not in result

       def test_acetonitrile_case_insensitive(self):
           """COSMO mapping should work with any case input."""
           for name in ["acetonitrile", "Acetonitrile", "ACETONITRILE"]:
               result = generate_optimization_input(
                   geometry_xyz="C 0.0 0.0 0.0",
                   functional="b3lyp",
                   basis_set="6-31G*",
                   solvent=name,
               )
               assert "solvent acetntrl" in result

       @pytest.mark.parametrize(
           "solvent",
           ["pyridine", "thf", "toluene", "dcm", "dmf"],
       )
       def test_direct_name_solvents(self, solvent):
           """Non-mapped solvents should use their name directly in COSMO block."""
           result = generate_optimization_input(
               geometry_xyz="C 0.0 0.0 0.0",
               functional="b3lyp",
               basis_set="6-31G*",
               solvent=solvent,
           )
           assert f"solvent {solvent}" in result

       def test_get_cosmo_solvent_name_mapping(self):
           """_get_cosmo_solvent_name should map acetonitrile, pass others through."""
           assert _get_cosmo_solvent_name("acetonitrile") == "acetntrl"
           assert _get_cosmo_solvent_name("pyridine") == "pyridine"
           assert _get_cosmo_solvent_name("chcl3") == "chcl3"

       def test_cosmo_name_map_only_has_acetonitrile(self):
           """Only acetonitrile should need mapping (others are direct)."""
           assert len(COSMO_NAME_MAP) == 1
           assert "acetonitrile" in COSMO_NAME_MAP
   ```

3. **Update the existing parametrized test** `test_all_supported_solvents_accepted` in the TestBenzeneSolvent class (around line 267-281). The current assertion `assert f"solvent {solvent}" in result` will FAIL for acetonitrile because the COSMO block will contain "solvent acetntrl" not "solvent acetonitrile". Fix the assertion to account for the COSMO name mapping:
   ```python
   @pytest.mark.parametrize(
       "solvent",
       sorted(SUPPORTED_SOLVENTS - {"vacuum"}),
   )
   def test_all_supported_solvents_accepted(self, solvent):
       """All supported solvents should generate valid optimization input."""
       result = generate_optimization_input(
           geometry_xyz="C 0.0 0.0 0.0",
           functional="b3lyp",
           basis_set="6-31G*",
           solvent=solvent,
       )
       assert "cosmo" in result.lower()
       expected_cosmo_name = _get_cosmo_solvent_name(solvent)
       assert f"solvent {expected_cosmo_name}" in result
   ```

   Also update the import at the top of the file to include `_get_cosmo_solvent_name`.

Follow existing test patterns: use classes, descriptive docstrings, pytest style.
  </action>
  <verify>
Run: `python -m pytest tests/test_nwchem_input.py -v` -- all tests pass, including new COSMO mapping tests and updated parametrized test.

Run: `python -m pytest tests/ -v --tb=short` -- full suite passes, no regressions.
  </verify>
  <done>
All new tests pass. Updated parametrized test handles COSMO name mapping for acetonitrile. TestCOSMONameMapping class covers: acetonitrile -> acetntrl in both optimization and shielding, case insensitivity, direct-name solvents (pyridine, thf, toluene, dcm, dmf), helper function unit test, and COSMO_NAME_MAP contents validation. No test regressions.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_nwchem_input.py -v` -- all pass including new COSMO mapping tests
2. `python -m pytest tests/ -v --tb=short` -- full suite passes, no regressions
3. `python -c "from qm_nmr_calc.nwchem.input_gen import SUPPORTED_SOLVENTS; print(sorted(SUPPORTED_SOLVENTS))"` -- shows all 13 solvents
4. `python -c "from qm_nmr_calc.nwchem.input_gen import generate_optimization_input; r = generate_optimization_input('C 0 0 0', 'b3lyp', '6-31G*', 'acetonitrile'); assert 'solvent acetntrl' in r"` -- COSMO mapping works
5. `python -m qm_nmr_calc.benchmark run --solvents Pyridine THF Toluene DCM Acetonitrile DMF --functionals B3LYP --help` -- no argparse error
6. Verify runner.py SOLVENTS list is UNCHANGED (still 6 entries, no new solvents in defaults)
</verification>

<success_criteria>
- BENCH-01 satisfied: Benchmark CLI accepts pyridine, thf, toluene, dcm, acetonitrile, dmf as valid --solvents values
- COSMO name mapping: acetonitrile correctly maps to acetntrl in NWChem input
- Direct names: pyridine, thf, toluene, dcm, dmf pass through unchanged to COSMO block
- No regressions: existing CHCl3/DMSO/vacuum/methanol/water/acetone/benzene behavior unchanged
- Test coverage: COSMO name mapping tests, parametrized test covers all 12 non-vacuum solvents
- runner.py SOLVENTS unchanged: new solvents are opt-in only (no scaling factors until Phase 63)
</success_criteria>

<output>
After completion, create `.planning/phases/59-benchmark-infrastructure/59-01-SUMMARY.md`
</output>
