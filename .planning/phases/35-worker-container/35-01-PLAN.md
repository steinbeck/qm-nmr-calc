---
phase: 35-worker-container
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile.worker
  - scripts/validate-worker.sh
autonomous: true

must_haves:
  truths:
    - "User can build worker image with docker build -f Dockerfile.worker"
    - "NWChem DFT calculation completes successfully inside container"
    - "CREST conformer search completes successfully inside container"
    - "xTB energy calculation completes successfully inside container"
    - "Huey consumer starts and can import tasks"
  artifacts:
    - path: "Dockerfile.worker"
      provides: "Multi-stage Docker build for worker"
      contains: "FROM ghcr.io/nwchemgit/nwchem-dev"
    - path: "scripts/validate-worker.sh"
      provides: "Validation script for all components"
      contains: "nwchem"
  key_links:
    - from: "Dockerfile.worker"
      to: "pyproject.toml"
      via: "uv sync copies dependencies"
      pattern: "uv sync"
    - from: "Dockerfile.worker"
      to: "src/qm_nmr_calc/tasks.py"
      via: "huey_consumer import path"
      pattern: "huey_consumer.*qm_nmr_calc"
---

<objective>
Create and validate the worker Docker container with NWChem, CREST, xTB, and Huey consumer.

Purpose: The worker container is the foundation for v2.4 Docker deployment. It packages all scientific computation dependencies (NWChem for DFT, CREST for conformer search, xTB for semiempirical methods) and the Huey task consumer into a single, reproducible image. This eliminates the complex manual installation process.

Output: A working Dockerfile.worker that builds successfully and passes all validation tests for the computational tools and Huey consumer.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-worker-container/35-RESEARCH.md

# Key source files for understanding current patterns
@pyproject.toml
@src/qm_nmr_calc/queue.py
@src/qm_nmr_calc/tasks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile.worker with multi-stage build</name>
  <files>Dockerfile.worker</files>
  <action>
Create `Dockerfile.worker` in the project root with a multi-stage build:

**Stage 1: Python dependencies (builder)**
- Base: `ghcr.io/astral-sh/uv:python3.12-bookworm`
- WORKDIR /app
- Copy `pyproject.toml` and `uv.lock`
- Run `uv sync --frozen --no-dev` to create .venv

**Stage 2: Final image with all tools**
- Base: `ghcr.io/nwchemgit/nwchem-dev/amd64:latest`
- Install wget, xz-utils if not present (for binary downloads)
- Download and install xTB 6.7.1:
  ```
  wget https://github.com/grimme-lab/xtb/releases/download/v6.7.1/xtb-6.7.1-linux-x86_64.tar.xz
  tar xf xtb-6.7.1-linux-x86_64.tar.xz -C /opt
  mv /opt/xtb-6.7.1 /opt/xtb
  ```
- Download and install CREST:
  ```
  wget https://github.com/crest-lab/crest/releases/download/v3.0.2/crest-gnu-12-ubuntu-latest.tar.xz
  tar xf crest-gnu-12-ubuntu-latest.tar.xz
  mv crest /opt/crest/crest
  ```
  (Note: CREST extracts as a single binary, put in /opt/crest/)
- Copy Python from uv image (copy both python and the virtual environment)
- Copy application source: `COPY src/ /app/src/`

**Environment variables (CRITICAL):**
```dockerfile
# NWChem (verify these are set in base, add if not)
ENV NWCHEM_TOP="/opt/nwchem"
ENV NWCHEM_BASIS_LIBRARY="${NWCHEM_TOP}/src/basis/libraries/"

# xTB
ENV XTBPATH="/opt/xtb/share/xtb"

# PATH for all binaries
ENV PATH="/opt/xtb/bin:/opt/crest:${PATH}"

# OpenMP for CREST/xTB (CRITICAL - prevents stack overflow on large molecules)
ENV OMP_STACKSIZE="2G"
ENV OMP_NUM_THREADS="4"
ENV GFORTRAN_UNBUFFERED_ALL="1"

# Python virtual environment
ENV VIRTUAL_ENV="/app/.venv"
ENV PATH="${VIRTUAL_ENV}/bin:${PATH}"

# NWChem process count (configurable)
ENV NWCHEM_NPROC="4"

# Working directory
WORKDIR /app
```

**Data directory:**
- Create /app/data directory for Huey database and job files
- `RUN mkdir -p /app/data`

**Entrypoint:**
- CMD: `["huey_consumer", "qm_nmr_calc.queue.huey", "-w", "1", "-k", "process"]`
- (Single worker, process-based for isolation)

**Important notes:**
- Do NOT create a non-root user yet (Phase 36 handles API container security, Phase 37 will address worker if needed)
- The NWChem base image is Debian-based, so use apt-get for any additional packages
- Clean up downloaded archives after extraction to reduce image size
  </action>
  <verify>
Run `docker build -f Dockerfile.worker -t qm-nmr-calc-worker:test .` - build must complete without errors.
  </verify>
  <done>
Dockerfile.worker exists and builds successfully, producing a ~3-4GB image with all dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validation script and test all components</name>
  <files>scripts/validate-worker.sh</files>
  <action>
Create `scripts/validate-worker.sh` that tests all computational tools inside the container:

```bash
#!/bin/bash
# Validation script for qm-nmr-calc worker container
# Run inside container: docker run --rm qm-nmr-calc-worker:test /app/scripts/validate-worker.sh

set -e  # Exit on first error

echo "=== Worker Container Validation ==="
echo ""

# 1. NWChem validation
echo "--- Testing NWChem ---"
which nwchem || { echo "FAIL: nwchem not in PATH"; exit 1; }
echo "NWChem found at: $(which nwchem)"

# NWChem returns exit code 1 even for --version, so check output instead
if nwchem 2>&1 | grep -q "Northwest Computational Chemistry Package"; then
    echo "PASS: NWChem responds"
else
    echo "FAIL: NWChem not responding correctly"
    exit 1
fi

# 2. xTB validation
echo ""
echo "--- Testing xTB ---"
which xtb || { echo "FAIL: xtb not in PATH"; exit 1; }
echo "xTB found at: $(which xtb)"
xtb --version || { echo "FAIL: xtb --version failed"; exit 1; }
echo "PASS: xTB responds"

# 3. CREST validation
echo ""
echo "--- Testing CREST ---"
which crest || { echo "FAIL: crest not in PATH"; exit 1; }
echo "CREST found at: $(which crest)"
crest --version || { echo "FAIL: crest --version failed"; exit 1; }
echo "PASS: CREST responds"

# 4. Python environment validation
echo ""
echo "--- Testing Python Environment ---"
which python || { echo "FAIL: python not in PATH"; exit 1; }
echo "Python found at: $(which python)"
python --version

# 5. Huey import validation
echo ""
echo "--- Testing Huey Import ---"
python -c "from qm_nmr_calc.queue import huey; print('Huey instance:', huey.name)" || {
    echo "FAIL: Cannot import Huey from qm_nmr_calc.queue"
    exit 1
}
echo "PASS: Huey imports successfully"

# 6. Task import validation
echo ""
echo "--- Testing Task Import ---"
python -c "from qm_nmr_calc.tasks import run_nmr_task; print('Task:', run_nmr_task)" || {
    echo "FAIL: Cannot import tasks from qm_nmr_calc.tasks"
    exit 1
}
echo "PASS: Tasks import successfully"

# 7. RDKit validation (needed for conformer generation)
echo ""
echo "--- Testing RDKit ---"
python -c "from rdkit import Chem; m = Chem.MolFromSmiles('CCO'); print('Atoms:', m.GetNumAtoms())" || {
    echo "FAIL: RDKit not working"
    exit 1
}
echo "PASS: RDKit works"

echo ""
echo "=== All Validations Passed ==="
```

Make the script executable and copy it into the container by adding to Dockerfile.worker:
```dockerfile
COPY scripts/validate-worker.sh /app/scripts/
RUN chmod +x /app/scripts/validate-worker.sh
```

After creating the script, rebuild the image and run validation:
```bash
docker build -f Dockerfile.worker -t qm-nmr-calc-worker:test .
docker run --rm qm-nmr-calc-worker:test /app/scripts/validate-worker.sh
```
  </action>
  <verify>
Run `docker run --rm qm-nmr-calc-worker:test /app/scripts/validate-worker.sh` - all validations must pass, outputting "All Validations Passed" at the end.
  </verify>
  <done>
Validation script exists at scripts/validate-worker.sh and passes all checks when run inside the container: NWChem, xTB, CREST, Python, Huey import, task import, and RDKit all work.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full DFT calculation test inside container</name>
  <files>scripts/test-nwchem-container.sh</files>
  <action>
Create a test script that runs an actual NWChem DFT calculation inside the container to verify the full stack works:

Create `scripts/test-nwchem-container.sh`:
```bash
#!/bin/bash
# Full NWChem DFT test inside container
# This verifies NWChem can actually run calculations, not just respond to --version

set -e

echo "=== Full NWChem DFT Test ==="

# Create a simple test input for water molecule optimization
WORKDIR=$(mktemp -d)
cd "$WORKDIR"

cat > water.nw << 'EOF'
start water
title "Water geometry optimization"
memory total 1 gb

geometry units angstrom
  O  0.000  0.000  0.117
  H  0.000  0.756 -0.469
  H  0.000 -0.756 -0.469
end

basis
  * library 6-31g*
end

driver
  maxiter 50
end

task dft optimize
EOF

echo "Running NWChem optimization on water molecule..."
echo "Input file: water.nw"
echo ""

# Run with MPI (single process for test, using --bind-to none for container compatibility)
mpirun --bind-to none -n 1 nwchem water.nw > water.out 2> water.err || {
    echo "FAIL: NWChem calculation failed"
    echo "=== STDERR ==="
    cat water.err
    echo "=== STDOUT (last 50 lines) ==="
    tail -50 water.out
    exit 1
}

# Check for successful completion
if grep -q "Total DFT energy" water.out; then
    echo "PASS: NWChem DFT calculation completed"
    grep "Total DFT energy" water.out
else
    echo "FAIL: DFT energy not found in output"
    tail -50 water.out
    exit 1
fi

# Check geometry optimization converged
if grep -q "Optimization converged" water.out; then
    echo "PASS: Geometry optimization converged"
else
    echo "WARNING: Optimization may not have converged (check output)"
fi

# Cleanup
cd /
rm -rf "$WORKDIR"

echo ""
echo "=== NWChem DFT Test Passed ==="
```

Make executable and add to Dockerfile:
```dockerfile
COPY scripts/test-nwchem-container.sh /app/scripts/
RUN chmod +x /app/scripts/test-nwchem-container.sh
```

Run the test with sufficient shared memory (CRITICAL for MPI):
```bash
docker build -f Dockerfile.worker -t qm-nmr-calc-worker:test .
docker run --rm --shm-size=512m qm-nmr-calc-worker:test /app/scripts/test-nwchem-container.sh
```

The `--shm-size=512m` is CRITICAL - without it, NWChem MPI will segfault. This is the minimum for NWChem to function.
  </action>
  <verify>
Run `docker run --rm --shm-size=512m qm-nmr-calc-worker:test /app/scripts/test-nwchem-container.sh` - must output "NWChem DFT Test Passed" with a "Total DFT energy" value.
  </verify>
  <done>
NWChem DFT calculation completes successfully inside the container with proper MPI configuration. The water molecule optimization test runs to completion and reports DFT energy.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   docker build -f Dockerfile.worker -t qm-nmr-calc-worker:test .
   # Must complete without errors
   ```

2. **Basic validation:**
   ```bash
   docker run --rm qm-nmr-calc-worker:test /app/scripts/validate-worker.sh
   # Must output "All Validations Passed"
   ```

3. **Full DFT test:**
   ```bash
   docker run --rm --shm-size=512m qm-nmr-calc-worker:test /app/scripts/test-nwchem-container.sh
   # Must output "NWChem DFT Test Passed"
   ```

4. **Huey consumer startup test:**
   ```bash
   docker run --rm -d --name huey-test qm-nmr-calc-worker:test
   sleep 5
   docker logs huey-test 2>&1 | grep -i "consumer"
   docker stop huey-test
   # Must show Huey consumer starting (may show "no results" which is expected with empty queue)
   ```
</verification>

<success_criteria>
Phase 35 is complete when:
- [ ] `docker build -f Dockerfile.worker` succeeds
- [ ] All validation checks pass (NWChem, xTB, CREST, Python, Huey, RDKit)
- [ ] NWChem DFT calculation completes inside container with --shm-size=512m
- [ ] Huey consumer starts and can import task definitions
</success_criteria>

<output>
After completion, create `.planning/phases/35-worker-container/35-01-SUMMARY.md`
</output>
