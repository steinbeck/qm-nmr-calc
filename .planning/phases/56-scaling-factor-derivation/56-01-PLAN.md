---
phase: 56-scaling-factor-derivation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/benchmark/analysis.py
  - src/qm_nmr_calc/data/scaling_factors.json
  - data/benchmark/delta50/scaling_factors.json
  - data/benchmark/delta50/SCALING-FACTORS.md
autonomous: true

must_haves:
  truths:
    - "analyze command produces scaling factors for all 6 B3LYP solvents (CHCl3, DMSO, Methanol, Water, Acetone, Benzene)"
    - "All 8 new factor sets (4 solvents x 2 nuclei) have R-squared > 0.99"
    - "1H MAE is below 0.2 ppm for each of the 4 new solvents"
    - "13C MAE is below 3.0 ppm for each of the 4 new solvents"
    - "Package scaling_factors.json contains 14 total factor sets (6 existing + 8 new)"
  artifacts:
    - path: "src/qm_nmr_calc/benchmark/analysis.py"
      provides: "Updated default solvents list including 4 new solvents"
      contains: "Methanol.*Water.*Acetone.*Benzene"
    - path: "src/qm_nmr_calc/data/scaling_factors.json"
      provides: "Package scaling factors with all 14 factor sets"
      contains: "Methanol"
    - path: "data/benchmark/delta50/scaling_factors.json"
      provides: "Analysis output with all 14 factor sets"
      contains: "Methanol"
    - path: "data/benchmark/delta50/SCALING-FACTORS.md"
      provides: "Updated report with all solvents"
      contains: "Methanol"
  key_links:
    - from: "src/qm_nmr_calc/benchmark/analysis.py"
      to: "data/benchmark/results/compound_XX/B3LYP_{Solvent}/shifts.json"
      via: "aggregate_regression_data reads shielding values per solvent"
      pattern: "results_dir.*functional.*solvent"
    - from: "data/benchmark/delta50/scaling_factors.json"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "copy from analysis output to package data"
      pattern: "scaling_factors.json"
    - from: "src/qm_nmr_calc/shifts.py"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "load_scaling_factors reads package data at runtime"
      pattern: "scaling_factors.json"
---

<objective>
Derive OLS scaling factors for all 4 new solvents (Methanol, Water, Acetone, Benzene), validate they pass quality gates, and update the package scaling_factors.json with all 14 factor sets.

Purpose: Phase 55 produced 200 benchmark calculations (shielding values). This phase converts those raw shielding values into usable scaling factors via linear regression, enabling accurate NMR shift prediction for the 4 new solvents. Without this step, the benchmark data is useless -- scaling factors are what the application actually uses at runtime.

Output: Updated scaling_factors.json (14 entries), regenerated SCALING-FACTORS.md report with plots, all quality gates validated.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@src/qm_nmr_calc/benchmark/analysis.py
@src/qm_nmr_calc/benchmark/__main__.py
@src/qm_nmr_calc/data/scaling_factors.json
@src/qm_nmr_calc/shifts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update default solvents and run analysis to derive all scaling factors</name>
  <files>
    src/qm_nmr_calc/benchmark/analysis.py
    data/benchmark/delta50/scaling_factors.json
    data/benchmark/delta50/SCALING-FACTORS.md
  </files>
  <action>
    1. In `src/qm_nmr_calc/benchmark/analysis.py`, update the `derive_all_factors` function's default solvents parameter from `["CHCl3", "DMSO"]` to `["CHCl3", "DMSO", "Methanol", "Water", "Acetone", "Benzene"]` (line ~213). This makes the analyze command process all 6 solvents by default.

    2. Run the analysis command to derive factors and generate the report:
       ```
       cd /home/chris/develop/qm-nmr-calc
       python -m qm_nmr_calc.benchmark analyze --output-dir data/benchmark/delta50
       ```
       This will:
       - Call `derive_all_factors()` which now processes all 6 solvents
       - Fit OLS regression for each solvent x nucleus combination (12 total factor sets)
       - Save `data/benchmark/delta50/scaling_factors.json` with all factors
       - Generate regression and residual plots in `data/benchmark/delta50/plots/`
       - Generate `data/benchmark/delta50/SCALING-FACTORS.md` report

    3. After the command completes, examine the output to verify:
       - All 12 factor sets derived (6 solvents x 2 nuclei, but vacuum is separate, so we expect 12 from the 6 solvents in results dir)
       - Print the factors summary: `python -m qm_nmr_calc.benchmark analyze --factors-only`
       - Check each new solvent's R-squared, MAE values against quality gates

    NOTE: The vacuum factors (2 entries) are NOT in the benchmark results directory (they came from Phase 11.2's separate vacuum benchmark). They will NOT be regenerated by this command. They must be preserved when merging into the package scaling_factors.json in Task 2.
  </action>
  <verify>
    - `python -m qm_nmr_calc.benchmark analyze --factors-only` completes without error and prints 12 factor sets
    - Output includes entries for Methanol, Water, Acetone, Benzene (both 1H and 13C)
    - `data/benchmark/delta50/scaling_factors.json` exists and contains 12 entries
    - `data/benchmark/delta50/SCALING-FACTORS.md` exists and references all 6 solvents
  </verify>
  <done>
    - 12 scaling factor sets derived (6 solvents x 2 nuclei)
    - All 8 new factor sets have R-squared > 0.99
    - All 4 new solvent 1H MAE < 0.2 ppm
    - All 4 new solvent 13C MAE < 3.0 ppm
    - SCALING-FACTORS.md report generated with tables and plots
  </done>
</task>

<task type="auto">
  <name>Task 2: Merge factors into package data and validate end-to-end</name>
  <files>
    src/qm_nmr_calc/data/scaling_factors.json
  </files>
  <action>
    1. The delta50 analysis output (`data/benchmark/delta50/scaling_factors.json`) contains 12 factor sets (6 solvents x 2 nuclei). The package data file (`src/qm_nmr_calc/data/scaling_factors.json`) currently has 6 entries (CHCl3, DMSO, vacuum -- 2 nuclei each). We need 14 total.

    2. Merge strategy: Start from the newly generated delta50 scaling_factors.json (12 entries for CHCl3, DMSO, Methanol, Water, Acetone, Benzene). Then add the 2 vacuum entries from the current package scaling_factors.json. This ensures CHCl3 and DMSO factors are re-derived from the same analysis run as the new solvents (consistency), and vacuum factors are preserved.

    3. Write a short Python script to merge:
       ```python
       import orjson
       from pathlib import Path

       # Load newly derived factors (12 entries)
       new_factors = orjson.loads(Path("data/benchmark/delta50/scaling_factors.json").read_bytes())

       # Load existing package factors to get vacuum entries
       pkg_factors = orjson.loads(Path("src/qm_nmr_calc/data/scaling_factors.json").read_bytes())

       # Add vacuum entries
       for key, value in pkg_factors.items():
           if "vacuum" in key:
               new_factors[key] = value

       # Should have 14 entries total
       assert len(new_factors) == 14, f"Expected 14, got {len(new_factors)}"

       # Write merged file
       Path("src/qm_nmr_calc/data/scaling_factors.json").write_bytes(
           orjson.dumps(new_factors, option=orjson.OPT_INDENT_2)
       )
       ```

    4. Validate the merged file:
       - Confirm 14 entries (6 existing keys + 8 new keys)
       - Confirm each entry has slope, intercept, r_squared, mae, rmsd, n_points, ci_slope, ci_intercept, outliers_removed
       - Confirm the vacuum entries are unchanged

    5. Run the existing test suite to verify nothing breaks:
       ```
       python -m pytest tests/ -x -q
       ```

    6. Verify the shifts module can load the new factors:
       ```python
       from qm_nmr_calc.shifts import get_scaling_factor
       # Test each new solvent
       for solvent in ["Methanol", "Water", "Acetone", "Benzene"]:
           for nucleus in ["1H", "13C"]:
               factor = get_scaling_factor("B3LYP", "6-311+G(2d,p)", nucleus, solvent)
               print(f"{nucleus}/{solvent}: slope={factor['slope']:.4f}, R2={factor['r_squared']:.4f}")
       ```
  </action>
  <verify>
    - `src/qm_nmr_calc/data/scaling_factors.json` contains exactly 14 entries
    - `python -m pytest tests/ -x -q` passes (all 430+ tests)
    - `get_scaling_factor("B3LYP", "6-311+G(2d,p)", "1H", "Methanol")` returns valid factor dict
    - `get_scaling_factor("B3LYP", "6-311+G(2d,p)", "13C", "Benzene")` returns valid factor dict
    - Vacuum factors unchanged from before
  </verify>
  <done>
    - Package scaling_factors.json has 14 factor sets (6 existing + 8 new)
    - Each entry contains slope, intercept, r_squared, mae fields
    - All existing tests pass
    - shifts.py can look up factors for all 4 new solvents
  </done>
</task>

</tasks>

<verification>
Run the full quality gate validation:

1. Factor count: `scaling_factors.json` has exactly 14 keys
2. R-squared gate: All 8 new factors have `r_squared > 0.99`
3. 1H MAE gate: Methanol, Water, Acetone, Benzene 1H MAE < 0.2 ppm
4. 13C MAE gate: Methanol, Water, Acetone, Benzene 13C MAE < 3.0 ppm
5. Test suite: `python -m pytest tests/ -x -q` passes
6. Runtime load: `from qm_nmr_calc.shifts import load_scaling_factors; assert len(load_scaling_factors()) == 14`
</verification>

<success_criteria>
- 14 scaling factor sets in package data (6 prior + 8 new)
- All 8 new factor sets pass R-squared > 0.99
- All 4 new solvent 1H MAE < 0.2 ppm
- All 4 new solvent 13C MAE < 3.0 ppm
- Existing test suite passes with no regressions
- Report and plots generated in data/benchmark/delta50/
</success_criteria>

<output>
After completion, create `.planning/phases/56-scaling-factor-derivation/56-01-SUMMARY.md`
</output>
