# Phase 11.1: 3D Molecule Visualization - Research

**Researched:** 2026-01-24
**Domain:** 3Dmol.js WebGL molecular visualization, FastAPI template integration
**Confidence:** HIGH

## Summary

This phase adds interactive 3D molecule visualization to the job status and results pages, porting the proven 3Dmol.js implementation from the Phase 8.1 DELTA50 benchmark viewer. The existing codebase provides complete, working patterns for viewer initialization, XYZ loading, atom label annotation, and styling.

The implementation is straightforward because:
1. **3Dmol.js patterns are already established** in `benchmark_viewer.html` with working viewer setup, label positioning, and color coding
2. **CSS styling exists** in `custom.css` for viewer containers, shift badges, and legends
3. **API patterns exist** in `benchmark.py` for serving XYZ data with shift assignments

The key additions required are: (1) storing RDKit-generated XYZ at job submission time, (2) a new API endpoint for job geometry data, and (3) template modifications to add the 3D viewer alongside existing visualizations.

**Primary recommendation:** Port the DELTA50 viewer JavaScript directly, add geometry storage at submission time, create `/api/v1/jobs/{job_id}/geometry.json` endpoint returning XYZ + shift assignments, and modify status.html and results.html templates to include the 3D viewer.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| 3Dmol.js | 2.5.3 | WebGL molecular visualization | Already in use in DELTA50 viewer, verified working |
| Pico CSS | 2.x (blue theme) | Styling | Project standard, CDN loaded |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| RDKit | existing | 3D coordinate generation | Already used for geometry optimization |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| 3Dmol.js 2.5.3 | 3Dmol.js 2.5.4 | 2.5.4 available (Jan 22, 2025) with aromatic bond improvements - minor update, stay with 2.5.3 for consistency |

**CDN Script (already in base.html pattern):**
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>
```

Note: Do NOT use `3Dmol-min.min.js` - use `3Dmol-min.js` (already minified).

## Architecture Patterns

### Recommended Changes to Project Structure
```
src/qm_nmr_calc/
├── api/
│   ├── routers/
│   │   └── jobs.py            # Add geometry.json endpoint
│   └── templates/
│       ├── status.html        # Add 3D viewer for running jobs
│       └── results.html       # Add 3D viewer alongside spectrum plots
├── storage.py                 # Add get_initial_geometry_file()
└── tasks.py                   # Store RDKit XYZ at submission time
```

### Pattern 1: 3D Viewer Initialization (from benchmark_viewer.html)
**What:** Create reusable viewer with XYZ loading and label annotation
**When to use:** On status/results page load
**Example:**
```javascript
// Source: benchmark_viewer.html lines 104-111, 163-199
let viewer = null;

function initViewer() {
    const container = document.getElementById('viewer-container-3d');
    viewer = $3Dmol.createViewer(container, {
        backgroundColor: 'white'
    });
}

async function loadGeometry(jobId, showLabels = false) {
    viewer.removeAllModels();
    viewer.removeAllLabels();

    const response = await fetch(`/api/v1/jobs/${jobId}/geometry.json`);
    const data = await response.json();

    const model = viewer.addModel(data.xyz, 'xyz', {assignBonds: true});

    viewer.setStyle({}, {
        stick: {radius: 0.12, colorscheme: 'Jmol'},
        sphere: {scale: 0.25, colorscheme: 'Jmol'}
    });

    if (showLabels && data.h1_assignments) {
        addShiftLabels(model, data.h1_assignments, data.c13_assignments);
    }

    viewer.zoomTo();
    viewer.render();
}
```

### Pattern 2: Shift Label Annotation (from benchmark_viewer.html)
**What:** Add colored labels at atom positions showing shift values
**When to use:** When calculation is complete and shifts are available
**Example:**
```javascript
// Source: benchmark_viewer.html lines 201-235
function addShiftLabels(model, h1Assignments, c13Assignments) {
    const atoms = model.selectedAtoms({});

    atoms.forEach(atom => {
        // CRITICAL: 3Dmol.js uses 0-based serial, NWChem uses 1-based indices
        const atomIndex = String(atom.serial + 1);

        if (atom.elem === 'H' && h1Assignments && h1Assignments[atomIndex]) {
            const shift = h1Assignments[atomIndex];
            viewer.addLabel(shift.toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#3498db',  // Blue for 1H
                backgroundOpacity: 0.85,
                inFront: true
            });
        }

        if (atom.elem === 'C' && c13Assignments && c13Assignments[atomIndex]) {
            const shift = c13Assignments[atomIndex];
            viewer.addLabel(shift.toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#27ae60',  // Green for 13C (orange in CONTEXT.md)
                backgroundOpacity: 0.85,
                inFront: true
            });
        }
    });
}
```

**Note on colors:** CONTEXT.md specifies "blue for 1H, orange for 13C" - consider using `#e67e22` (orange) instead of `#27ae60` (green) for 13C to match user decision.

### Pattern 3: API Endpoint for Geometry Data
**What:** JSON endpoint returning XYZ and shift assignments
**When to use:** Called by 3D viewer JavaScript
**Example:**
```python
# Pattern from benchmark.py lines 49-127

@router.get("/{job_id}/geometry.json")
async def get_geometry_data(job_id: str):
    """Get geometry and shift data for 3D visualization."""
    job_status = load_job_status(job_id)
    if job_status is None:
        raise HTTPException(status_code=404, detail=f"Job '{job_id}' not found")

    # Determine which geometry to return
    # Running: initial RDKit geometry
    # Complete: optimized NWChem geometry
    if job_status.status == "complete":
        geometry_file = get_geometry_file(job_id)  # optimized.xyz
    else:
        geometry_file = get_initial_geometry_file(job_id)  # initial.xyz

    if geometry_file is None:
        raise HTTPException(status_code=404, detail="Geometry not available")

    xyz_content = geometry_file.read_text()

    # Build shift assignments if complete
    h1_assignments = {}
    c13_assignments = {}
    if job_status.status == "complete" and job_status.nmr_results:
        for s in job_status.nmr_results.h1_shifts:
            h1_assignments[str(s.index)] = s.shift
        for s in job_status.nmr_results.c13_shifts:
            c13_assignments[str(s.index)] = s.shift

    return {
        "job_id": job_id,
        "status": job_status.status,
        "xyz": xyz_content,
        "h1_assignments": h1_assignments if h1_assignments else None,
        "c13_assignments": c13_assignments if c13_assignments else None,
    }
```

### Pattern 4: Store Initial Geometry at Submission
**What:** Save RDKit-generated XYZ when job is created
**When to use:** In storage.py create_job_directory() or early in task execution
**Example:**
```python
# Generate 3D coords and save XYZ
from rdkit import Chem
from rdkit.Chem import AllChem

def save_initial_geometry(job_id: str, smiles: str) -> Path:
    """Generate and save RDKit 3D geometry for immediate visualization."""
    mol = Chem.MolFromSmiles(smiles)
    mol = Chem.AddHs(mol)

    # ETKDGv3 with deterministic seed (project standard: 0xF00D)
    params = AllChem.ETKDGv3()
    params.randomSeed = 0xF00D
    AllChem.EmbedMolecule(mol, params)
    AllChem.MMFFOptimizeMoleculeConfs(mol)

    # Generate XYZ
    xyz_lines = [str(mol.GetNumAtoms()), smiles]
    conf = mol.GetConformer()
    for atom in mol.GetAtoms():
        pos = conf.GetAtomPosition(atom.GetIdx())
        xyz_lines.append(f"{atom.GetSymbol()} {pos.x:.6f} {pos.y:.6f} {pos.z:.6f}")

    xyz_content = "\n".join(xyz_lines)

    # Save to job directory
    output_path = get_job_dir(job_id) / "output" / "initial.xyz"
    output_path.write_text(xyz_content)
    return output_path
```

### Anti-Patterns to Avoid
- **Creating new viewer on each update:** Memory leaks. Use `viewer.removeAllModels()` and `viewer.removeAllLabels()` then add new model.
- **Not calling viewer.render():** Changes won't display until render() is called.
- **Using wrong atom index convention:** 3Dmol.js serial is 0-based, NWChem indices are 1-based. Always add +1 offset.
- **Loading 3Dmol.js from 3dmol.org directly:** Use cdnjs for stability.
- **Forgetting inFront: true on labels:** Labels will render behind atoms and be invisible.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| 3D molecular visualization | WebGL renderer | 3Dmol.js | Complex rendering, bond detection, interaction |
| Bond inference from XYZ | Distance-based algorithm | `{assignBonds: true}` | 3Dmol.js uses proper covalent radii |
| 3D coordinate generation | Custom conformer search | RDKit ETKDGv3 | Industry standard, deterministic |
| Atom selection by element | Manual filtering | `model.selectedAtoms({elem: 'H'})` | Built-in, optimized |

**Key insight:** All hard problems are solved by existing code. This phase is primarily integration and template work.

## Common Pitfalls

### Pitfall 1: Atom Index Mismatch
**What goes wrong:** Shifts appear on wrong atoms or not at all
**Why it happens:** 3Dmol.js uses 0-based serial numbers, NWChem uses 1-based indices
**How to avoid:** Always use `atom.serial + 1` when matching against NWChem indices
**Warning signs:** Labels on hydrogen atoms showing carbon shifts or vice versa

### Pitfall 2: Viewer Memory Leaks
**What goes wrong:** Browser becomes slow after multiple geometry loads
**Why it happens:** Creating new viewer or not clearing old models
**How to avoid:** Create viewer once. On geometry change: `removeAllModels()`, `removeAllLabels()`, then add new model
**Warning signs:** Browser memory usage climbing steadily

### Pitfall 3: XYZ Format Issues
**What goes wrong:** Molecule displays as disconnected atoms or fails to load
**Why it happens:** XYZ format requires proper header (atom count + comment line)
**How to avoid:** Always include: `{atom_count}\n{comment}\n{coordinates}`
**Warning signs:** Stick style shows nothing, only sphere style works

### Pitfall 4: Labels Obscured by Atoms
**What goes wrong:** Labels invisible or flash when rotating
**Why it happens:** Default label rendering order
**How to avoid:** Always set `inFront: true` in label options
**Warning signs:** Labels disappear during rotation

### Pitfall 5: Responsive Viewer Container
**What goes wrong:** Viewer doesn't resize with window
**Why it happens:** 3Dmol.js viewer size is set at creation time
**How to avoid:** Set container CSS `width: 100%; height: 500px;` and let viewer fill it
**Warning signs:** Viewer too small on mobile or doesn't resize

### Pitfall 6: Status Page Auto-Refresh and Geometry Swap
**What goes wrong:** Viewer doesn't update when job completes
**Why it happens:** Polling updates status but not viewer
**How to avoid:** In polling callback, check if status changed to complete and call `loadGeometry()` with showLabels=true
**Warning signs:** RDKit geometry persists even after job completes

## Code Examples

Verified patterns from existing codebase:

### Complete Viewer JavaScript for Status Page
```javascript
// Source: Adapted from benchmark_viewer.html
let viewer = null;
let currentJobStatus = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize 3Dmol viewer
    const container = document.getElementById('viewer-container-3d');
    if (container) {
        viewer = $3Dmol.createViewer(container, {
            backgroundColor: 'white'
        });
        // Load initial geometry
        loadGeometry(JOB_ID, false);
    }
});

async function loadGeometry(jobId, showLabels) {
    if (!viewer) return;

    try {
        const response = await fetch(`/api/v1/jobs/${jobId}/geometry.json`);
        if (!response.ok) return;

        const data = await response.json();

        viewer.removeAllModels();
        viewer.removeAllLabels();

        const model = viewer.addModel(data.xyz, 'xyz', {assignBonds: true});

        viewer.setStyle({}, {
            stick: {radius: 0.12, colorscheme: 'Jmol'},
            sphere: {scale: 0.25, colorscheme: 'Jmol'}
        });

        if (showLabels && data.h1_assignments) {
            addShiftLabels(model, data.h1_assignments, data.c13_assignments);
        }

        viewer.zoomTo();
        viewer.render();
    } catch (error) {
        console.error('Error loading geometry:', error);
    }
}

function addShiftLabels(model, h1Assignments, c13Assignments) {
    const atoms = model.selectedAtoms({});

    atoms.forEach(atom => {
        const atomIndex = String(atom.serial + 1);

        if (atom.elem === 'H' && h1Assignments && h1Assignments[atomIndex]) {
            viewer.addLabel(h1Assignments[atomIndex].toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#3498db',
                backgroundOpacity: 0.85,
                inFront: true
            });
        }

        if (atom.elem === 'C' && c13Assignments && c13Assignments[atomIndex]) {
            viewer.addLabel(c13Assignments[atomIndex].toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#e67e22',  // Orange for 13C per CONTEXT.md
                backgroundOpacity: 0.85,
                inFront: true
            });
        }
    });
}
```

### CSS for 3D Viewer Container (existing in custom.css)
```css
/* Source: custom.css lines 339-347 */
#viewer-container {
    position: relative;
    width: 100%;
    height: 500px;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: 0.25rem;
    background: white;
}
```

### Legend HTML (existing pattern from benchmark_viewer.html)
```html
<!-- Source: benchmark_viewer.html lines 63-72 -->
<div class="legend">
    <div class="legend-item">
        <span class="legend-color h1"></span>
        <span><sup>1</sup>H shifts (blue)</span>
    </div>
    <div class="legend-item">
        <span class="legend-color c13"></span>
        <span><sup>13</sup>C shifts (orange)</span>
    </div>
</div>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Server-side rendering | Client-side WebGL | 2015+ | Interactive, responsive |
| JSmol (Java port) | 3Dmol.js (native WebGL) | 2015+ | Better performance |
| Static images | Interactive 3D | This phase | User can rotate/zoom |

**Current in project:**
- 3Dmol.js 2.5.3 (latest is 2.5.4 from Jan 2025)
- Pattern fully established in DELTA50 viewer

## Open Questions

Things that were resolved through research:

1. **API design for geometry data**
   - What we decided: New endpoint `/api/v1/jobs/{job_id}/geometry.json`
   - Rationale: Clean separation, matches existing pattern, allows status page to poll geometry separately
   - Alternative considered: Embed in status response - rejected as it bloats polling responses

2. **Label colors for 1H vs 13C**
   - CONTEXT.md specifies: blue for 1H, orange for 13C
   - DELTA50 viewer uses: blue for 1H, green for 13C
   - Recommendation: Use CONTEXT.md colors (#3498db blue, #e67e22 orange)

3. **When to store initial geometry**
   - Options: At job creation vs at task start
   - Recommendation: At task start (after SMILES validated, in same RDKit session)
   - Rationale: Avoids duplicate RDKit calls, geometry generation is fast

## Sources

### Primary (HIGH confidence)
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/api/templates/benchmark_viewer.html` - Working 3Dmol.js implementation
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/api/routers/benchmark.py` - API pattern for molecule data
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/api/static/css/custom.css` - Existing viewer CSS
- [3Dmol.js Official Documentation](https://3dmol.csb.pitt.edu/doc/GLViewer.html) - API reference
- [3Dmol.js LabelSpec](https://3dmol.csb.pitt.edu/doc/LabelSpec.html) - Label configuration

### Secondary (MEDIUM confidence)
- [3Dmol.js GitHub releases](https://github.com/3dmol/3Dmol.js/releases) - Version 2.5.4 available (Jan 2025)
- [3Dmol.js XYZ Parser source](https://3dmol.org/doc/parsers_XYZ.ts.html) - Confirmed 0-based serial numbering

### Project Context (HIGH confidence)
- `.planning/phases/11.1-3d-molecule-visualization/11.1-CONTEXT.md` - User decisions
- `.planning/phases/08.1-delta50-data-viewer/08.1-RESEARCH.md` - Original 3Dmol.js research
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/models.py` - NMR results data model
- `/home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/storage.py` - Job directory structure

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - 3Dmol.js already proven in DELTA50 viewer
- Architecture: HIGH - Patterns exist, this is integration work
- Pitfalls: HIGH - Based on working code and official docs

**Research date:** 2026-01-24
**Valid until:** 2026-02-24 (3Dmol.js is stable, patterns are established)
