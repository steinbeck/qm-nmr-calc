---
phase: 11.1-3d-molecule-visualization
plan: 02
type: execute
wave: 2
depends_on: ["11.1-01"]
files_modified:
  - src/qm_nmr_calc/api/templates/base.html
  - src/qm_nmr_calc/api/templates/status.html
  - src/qm_nmr_calc/api/templates/results.html
  - src/qm_nmr_calc/api/static/css/custom.css
autonomous: false

must_haves:
  truths:
    - "Status page displays 3D molecule viewer while job is running"
    - "Results page displays 3D molecule viewer with shift labels"
    - "3D viewer updates from RDKit to NWChem geometry when job completes"
    - "User can rotate and zoom the 3D molecule"
    - "1H shifts shown in blue, 13C shifts shown in orange"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/base.html"
      provides: "3Dmol.js script include"
      contains: "3Dmol-min.js"
    - path: "src/qm_nmr_calc/api/templates/status.html"
      provides: "3D viewer for running jobs"
      contains: "viewer-container-3d"
    - path: "src/qm_nmr_calc/api/templates/results.html"
      provides: "3D viewer with shift labels"
      contains: "viewer-container-3d"
    - path: "src/qm_nmr_calc/api/static/css/custom.css"
      provides: "Styling for 3D viewer container and legend"
      contains: "viewer-container-3d"
  key_links:
    - from: "src/qm_nmr_calc/api/templates/status.html"
      to: "/api/v1/jobs/{job_id}/geometry.json"
      via: "fetch in loadGeometry()"
      pattern: "geometry\\.json"
    - from: "src/qm_nmr_calc/api/templates/results.html"
      to: "/api/v1/jobs/{job_id}/geometry.json"
      via: "fetch on page load"
      pattern: "geometry\\.json"
---

<objective>
Add interactive 3D molecule visualization to status and results pages using 3Dmol.js, porting patterns from the DELTA50 benchmark viewer.

Purpose: Users can see their molecule structure immediately while calculation runs (with RDKit geometry), and view the optimized structure with chemical shift labels when complete.

Output: 3Dmol.js integrated into status.html (no labels) and results.html (with shift labels), styled to match existing Pico CSS theme.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.1-3d-molecule-visualization/11.1-CONTEXT.md
@.planning/phases/11.1-3d-molecule-visualization/11.1-RESEARCH.md

# Templates to modify
@src/qm_nmr_calc/api/templates/base.html
@src/qm_nmr_calc/api/templates/status.html
@src/qm_nmr_calc/api/templates/results.html
@src/qm_nmr_calc/api/static/css/custom.css

# Reference implementation (port from here)
@src/qm_nmr_calc/api/templates/benchmark_viewer.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3Dmol.js to base.html and CSS for viewer container</name>
  <files>
    src/qm_nmr_calc/api/templates/base.html
    src/qm_nmr_calc/api/static/css/custom.css
  </files>
  <action>
1. In base.html, add 3Dmol.js CDN script in head block (follow benchmark_viewer.html pattern):
   - Add `{% block head %}{% endblock %}` in the `<head>` section if not present
   - Child templates can then include: `{% block head %}<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>{% endblock %}`

2. In custom.css, add styling for 3D viewer container (adapt from benchmark_viewer.html):

```css
/* 3D Molecule Viewer */
#viewer-container-3d {
    position: relative;
    width: 100%;
    height: 400px;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: 0.25rem;
    background: white;
    margin-bottom: 1rem;
}

/* Viewer legend for shift colors */
.viewer-legend {
    display: flex;
    gap: 1.5rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.viewer-legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.viewer-legend-color {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 2px;
}

.viewer-legend-color.h1 {
    background-color: #3498db;  /* Blue for 1H */
}

.viewer-legend-color.c13 {
    background-color: #e67e22;  /* Orange for 13C per CONTEXT.md */
}
```
  </action>
  <verify>
Check base.html has head block: `grep "block head" src/qm_nmr_calc/api/templates/base.html`
Check CSS has viewer styles: `grep "viewer-container-3d" src/qm_nmr_calc/api/static/css/custom.css`
  </verify>
  <done>
- base.html has `{% block head %}` block for child template script includes
- custom.css has styling for #viewer-container-3d, legend, and color indicators
- Blue (#3498db) for 1H, orange (#e67e22) for 13C per CONTEXT.md
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 3D viewer to status.html (no labels while running)</name>
  <files>
    src/qm_nmr_calc/api/templates/status.html
  </files>
  <action>
Add 3D viewer section to status.html that:
1. Includes 3Dmol.js script via head block
2. Shows viewer container below metadata
3. Loads initial geometry on page load (no labels - job not complete)
4. On status change to complete, viewer is refreshed (page redirects anyway)

Add this section after the metadata dl and before progress section:

```html
<!-- 3D Molecule Viewer -->
<div id="viewer-section" style="margin-top: 1.5rem;">
    <h4>Molecular Structure</h4>
    <div id="viewer-container-3d"></div>
    <small class="muted">RDKit-generated geometry. Final optimized structure available when complete.</small>
</div>
```

Add head block:
```html
{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>
{% endblock %}
```

Add JavaScript in scripts block (after existing script, or integrate into IIFE):

```javascript
// 3D Viewer
let viewer = null;

function initViewer() {
    const container = document.getElementById('viewer-container-3d');
    if (!container) return;

    viewer = $3Dmol.createViewer(container, {
        backgroundColor: 'white'
    });
    loadGeometry(false);  // No labels for running job
}

async function loadGeometry(showLabels) {
    if (!viewer) return;

    try {
        const response = await fetch(`/api/v1/jobs/${JOB_ID}/geometry.json`);
        if (!response.ok) return;

        const data = await response.json();

        viewer.removeAllModels();
        viewer.removeAllLabels();

        const model = viewer.addModel(data.xyz, 'xyz', {assignBonds: true});

        viewer.setStyle({}, {
            stick: {radius: 0.12, colorscheme: 'Jmol'},
            sphere: {scale: 0.25, colorscheme: 'Jmol'}
        });

        viewer.zoomTo();
        viewer.render();
    } catch (error) {
        console.error('Error loading geometry:', error);
    }
}

// Initialize viewer when DOM ready (add to existing DOMContentLoaded handler)
```

Integrate `initViewer()` call into the existing DOMContentLoaded event listener.
  </action>
  <verify>
Start dev server: `uv run python -m qm_nmr_calc.api.main` (or existing start command)
Submit a job and visit status page - should see 3D viewer with molecule
Viewer should be interactive (rotate/zoom works)
  </verify>
  <done>
- Status page includes 3Dmol.js script
- 3D viewer container visible on status page
- Viewer loads initial geometry via geometry.json endpoint
- No shift labels shown (job is running)
- Viewer is interactive (rotation, zoom)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add 3D viewer to results.html (with shift labels)</name>
  <files>
    src/qm_nmr_calc/api/templates/results.html
  </files>
  <action>
Add 3D viewer section to results.html that:
1. Includes 3Dmol.js script via head block
2. Shows viewer alongside existing visualizations (before spectra grid)
3. Loads optimized geometry with shift labels on page load
4. Uses color coding: blue for 1H, orange for 13C (per CONTEXT.md)

Add head block:
```html
{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>
{% endblock %}
```

Add 3D viewer section in results-container article (alongside 2D structure):

```html
<!-- Add this section before or after the existing structure-container -->
<div class="structure-3d-container">
    <h4>Interactive 3D Structure</h4>
    <div id="viewer-container-3d"></div>
    <div class="viewer-legend">
        <div class="viewer-legend-item">
            <span class="viewer-legend-color h1"></span>
            <span><sup>1</sup>H shifts (ppm)</span>
        </div>
        <div class="viewer-legend-item">
            <span class="viewer-legend-color c13"></span>
            <span><sup>13</sup>C shifts (ppm)</span>
        </div>
    </div>
    <small class="muted">Click and drag to rotate. Scroll to zoom.</small>
</div>
```

Add JavaScript in scripts block:

```javascript
// 3D Viewer with shift labels
const JOB_ID = "{{ job.job_id }}";
let viewer = null;

document.addEventListener('DOMContentLoaded', function() {
    initViewer();
});

function initViewer() {
    const container = document.getElementById('viewer-container-3d');
    if (!container) return;

    viewer = $3Dmol.createViewer(container, {
        backgroundColor: 'white'
    });
    loadGeometry();
}

async function loadGeometry() {
    if (!viewer) return;

    try {
        const response = await fetch(`/api/v1/jobs/${JOB_ID}/geometry.json`);
        if (!response.ok) {
            console.error('Failed to load geometry');
            return;
        }

        const data = await response.json();

        viewer.removeAllModels();
        viewer.removeAllLabels();

        const model = viewer.addModel(data.xyz, 'xyz', {assignBonds: true});

        viewer.setStyle({}, {
            stick: {radius: 0.12, colorscheme: 'Jmol'},
            sphere: {scale: 0.25, colorscheme: 'Jmol'}
        });

        // Add shift labels for complete jobs
        if (data.h1_assignments || data.c13_assignments) {
            addShiftLabels(model, data.h1_assignments, data.c13_assignments);
        }

        viewer.zoomTo();
        viewer.render();
    } catch (error) {
        console.error('Error loading geometry:', error);
    }
}

function addShiftLabels(model, h1Assignments, c13Assignments) {
    const atoms = model.selectedAtoms({});

    atoms.forEach(atom => {
        // CRITICAL: 3Dmol.js uses 0-based serial, NWChem uses 1-based indices
        const atomIndex = String(atom.serial + 1);

        if (atom.elem === 'H' && h1Assignments && h1Assignments[atomIndex]) {
            viewer.addLabel(h1Assignments[atomIndex].toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#3498db',  // Blue for 1H
                backgroundOpacity: 0.85,
                inFront: true
            });
        }

        if (atom.elem === 'C' && c13Assignments && c13Assignments[atomIndex]) {
            viewer.addLabel(c13Assignments[atomIndex].toFixed(2), {
                position: {x: atom.x, y: atom.y, z: atom.z},
                fontSize: 11,
                fontColor: 'white',
                backgroundColor: '#e67e22',  // Orange for 13C
                backgroundOpacity: 0.85,
                inFront: true
            });
        }
    });
}
```
  </action>
  <verify>
Visit results page for a completed job
- 3D viewer should display optimized geometry
- Blue labels on H atoms showing 1H shifts
- Orange labels on C atoms showing 13C shifts
- Legend shows color coding
- Viewer is interactive (rotation, zoom)
  </verify>
  <done>
- Results page includes 3Dmol.js script
- 3D viewer container shows optimized geometry
- Shift labels displayed with correct colors (blue 1H, orange 13C)
- Legend explains color coding
- Viewer interactive (rotation, zoom)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete 3D molecule visualization on job status and results pages:
- Status page: Shows RDKit geometry while job runs (no labels)
- Results page: Shows optimized NWChem geometry with shift labels (blue 1H, orange 13C)
- Both viewers are interactive (rotation, zoom)
  </what-built>
  <how-to-verify>
1. Start the development server: `uv run python -m qm_nmr_calc.api.main` (or existing command)
2. Visit http://localhost:8000/
3. Submit a new job with SMILES "c1ccccc1" (benzene), solvent CHCl3
4. On status page:
   - Verify 3D viewer shows benzene structure immediately
   - Try rotating/zooming the molecule
   - No shift labels should appear (job running)
5. Wait for job to complete (auto-redirects to results)
6. On results page:
   - Verify 3D viewer shows molecule with shift labels
   - Blue labels on H atoms (1H shifts)
   - Orange labels on C atoms (13C shifts)
   - Legend visible below viewer
   - Viewer still interactive
7. Compare 3D view to 2D annotated structure - shifts should match
  </how-to-verify>
  <resume-signal>Type "approved" if visualization works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. 3Dmol.js included: `grep "3Dmol-min.js" src/qm_nmr_calc/api/templates/*.html`
2. Viewer container: `grep "viewer-container-3d" src/qm_nmr_calc/api/templates/*.html`
3. CSS styles: `grep "viewer-container-3d\|viewer-legend" src/qm_nmr_calc/api/static/css/custom.css`
4. Geometry fetch: `grep "geometry.json" src/qm_nmr_calc/api/templates/*.html`
5. Label colors (blue 1H, orange 13C): `grep -E "#3498db|#e67e22" src/qm_nmr_calc/api/templates/results.html`
</verification>

<success_criteria>
- [ ] base.html has `{% block head %}` for script includes
- [ ] custom.css has viewer container and legend styling
- [ ] status.html shows 3D viewer with initial geometry (no labels)
- [ ] results.html shows 3D viewer with shift labels (blue 1H, orange 13C)
- [ ] Both viewers are interactive (rotation, zoom)
- [ ] Human verification confirms visual functionality
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-3d-molecule-visualization/11.1-02-SUMMARY.md`
</output>
