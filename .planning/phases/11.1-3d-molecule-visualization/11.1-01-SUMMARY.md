---
phase: 11.1-3d-molecule-visualization
plan: 01
subsystem: api
tags: [rdkit, xyz, 3dmol, geometry, visualization]

# Dependency graph
requires:
  - phase: 07-nwchem-integration
    provides: NWChem calculation pipeline with geometry optimization
  - phase: 11-production-integration
    provides: Production-ready API with job status endpoints
provides:
  - Initial RDKit geometry saved at job start (initial.xyz)
  - Geometry API endpoint for 3D visualization
  - Shift assignments included when job complete
affects: [11.1-3d-molecule-visualization, web-ui, visualization]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Initial geometry generation before optimization starts"
    - "Conditional geometry return (initial vs optimized) based on job status"
    - "Shift assignments as optional data (only when complete)"

key-files:
  created:
    - "data/jobs/{job_id}/output/initial.xyz"
  modified:
    - "src/qm_nmr_calc/storage.py"
    - "src/qm_nmr_calc/tasks.py"
    - "src/qm_nmr_calc/api/routers/jobs.py"

key-decisions:
  - "Initial geometry generated immediately after job validation, before first calculation step"
  - "geometry.json endpoint returns initial.xyz for running jobs, optimized.xyz for complete jobs"
  - "Shift assignments (h1_assignments, c13_assignments) returned as null for running jobs"

patterns-established:
  - "get_*_file() pattern for storage helpers returning Optional[Path]"
  - "_generate_initial_xyz() helper in tasks.py for RDKit geometry generation"
  - "Conditional data return based on job status in API endpoints"

# Metrics
duration: 6min
completed: 2026-01-24
---

# Phase 11.1 Plan 01: Backend Infrastructure for 3D Visualization Summary

**Initial RDKit geometry storage and geometry.json API endpoint for progressive 3D molecule visualization**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-24T11:04:48Z
- **Completed:** 2026-01-24T11:10:49Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Initial RDKit geometry (ETKDGv3) saved at job start for immediate 3D visualization
- New geometry.json API endpoint returns appropriate geometry based on job status
- Shift assignments included only when job is complete (progressive enhancement)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add storage helper and save initial geometry in task** - `61b5aa3` (feat)
2. **Task 2: Create geometry.json API endpoint** - `fa4ac28` (feat)

## Files Created/Modified
- `src/qm_nmr_calc/storage.py` - Added get_initial_geometry_file() helper
- `src/qm_nmr_calc/tasks.py` - Added _generate_initial_xyz() and initial geometry generation
- `src/qm_nmr_calc/api/routers/jobs.py` - Added GET /api/v1/jobs/{job_id}/geometry.json endpoint

## Decisions Made

1. **Initial geometry generation timing:** Generate initial.xyz immediately after job validation but before any calculation steps start. This ensures the geometry is available as soon as the job enters "running" state.

2. **Conditional geometry return:** geometry.json endpoint returns initial.xyz for running jobs (status != complete) and optimized.xyz for complete jobs. This enables progressive visualization - users can see the molecule structure immediately while calculation runs.

3. **Shift assignments as optional:** h1_assignments and c13_assignments are only populated when job is complete. For running jobs, these fields are null. This matches the data availability pattern.

4. **XYZ format for 3Dmol.js:** Use full XYZ format (atom count, comment line with SMILES, coordinates) rather than just coordinate block. This matches 3Dmol.js expectations and provides molecule context.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation followed existing patterns (get_geometry_file, RDKit ETKDGv3, API endpoint structure).

## Next Phase Readiness

Ready for frontend 3D visualization implementation:
- Backend provides geometry data via /api/v1/jobs/{job_id}/geometry.json
- Initial geometry available immediately when job starts running
- Optimized geometry available when job completes
- Shift assignments available for labeling atoms when complete

No blockers for phase 11.1-02 (3Dmol.js viewer integration).

---
*Phase: 11.1-3d-molecule-visualization*
*Completed: 2026-01-24*
