---
phase: 64-solvent-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/solvents.py
  - src/qm_nmr_calc/shifts.py
  - src/qm_nmr_calc/nmredata.py
  - tests/test_nmredata.py
autonomous: true

must_haves:
  truths:
    - "API accepts solvent=pyridine and returns shifts using Pyridine scaling factors"
    - "API accepts solvent=thf and returns shifts using THF scaling factors"
    - "API accepts solvent=toluene and returns shifts using Toluene scaling factors"
    - "API accepts solvent=dcm and returns shifts using DCM scaling factors"
    - "API accepts solvent=acetonitrile and returns shifts using Acetonitrile scaling factors"
    - "API accepts solvent=dmf and returns shifts using DMF scaling factors"
    - "Web UI solvent dropdown lists all 13 solvents (12 visible + vacuum)"
    - "Existing CHCl3, DMSO, vacuum, methanol, water, acetone, benzene solvents still work identically"
    - "NMReData export works for all 13 solvents with correct deuterated formulas"
  artifacts:
    - path: "src/qm_nmr_calc/solvents.py"
      provides: "13-solvent SUPPORTED_SOLVENTS dict"
      contains: "pyridine"
    - path: "src/qm_nmr_calc/shifts.py"
      provides: "13-solvent solvent_map for scaling factor lookup"
      contains: "pyridine"
    - path: "src/qm_nmr_calc/nmredata.py"
      provides: "13-solvent NMReData solvent mapping"
      contains: "pyridine"
    - path: "tests/test_nmredata.py"
      provides: "6 new solvent mapping tests + updated unknown solvent test"
      contains: "test_pyridine_maps_to_c5d5n"
  key_links:
    - from: "src/qm_nmr_calc/solvents.py"
      to: "src/qm_nmr_calc/api/routers/web.py"
      via: "SUPPORTED_SOLVENTS import drives dropdown rendering"
      pattern: "SUPPORTED_SOLVENTS"
    - from: "src/qm_nmr_calc/shifts.py"
      to: "src/qm_nmr_calc/data/scaling_factors.json"
      via: "solvent_map normalizes keys to match JSON keys"
      pattern: "solvent_map.get"
    - from: "src/qm_nmr_calc/solvents.py"
      to: "src/qm_nmr_calc/api/routers/jobs.py"
      via: "validate_solvent gates API submission"
      pattern: "validate_solvent"
---

<objective>
Add 6 new solvents (pyridine, THF, toluene, DCM, acetonitrile, DMF) to the 3 gatekeeper modules so users can select them in the web UI and API for NMR predictions.

Purpose: This is the final wiring step for v2.9. The scaling factors (Phase 63) and NWChem COSMO support (Phase 59) already exist. These 3 files are the only remaining gatekeepers preventing users from accessing the 6 new solvents.

Output: All 13 solvents selectable in UI and API, with correct scaling factor lookup and NMReData export.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-solvent-integration/64-RESEARCH.md

@src/qm_nmr_calc/solvents.py
@src/qm_nmr_calc/shifts.py
@src/qm_nmr_calc/nmredata.py
@tests/test_nmredata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 6 new solvents to solvents.py and shifts.py</name>
  <files>
    src/qm_nmr_calc/solvents.py
    src/qm_nmr_calc/shifts.py
  </files>
  <action>
    **solvents.py** - Add 6 entries to the `SUPPORTED_SOLVENTS` dict (after existing 7 entries):
    ```python
    SUPPORTED_SOLVENTS: dict[str, str] = {
        "chcl3": "Chloroform (CDCl3)",
        "dmso": "Dimethylsulfoxide (DMSO-d6)",
        "vacuum": "Gas phase (no solvent)",
        "methanol": "Methanol (Methanol-d4)",
        "water": "Water (D2O)",
        "acetone": "Acetone (Acetone-d6)",
        "benzene": "Benzene (Benzene-d6)",
        "pyridine": "Pyridine (Pyridine-d5)",
        "thf": "Tetrahydrofuran (THF-d8)",
        "toluene": "Toluene (Toluene-d8)",
        "dcm": "Dichloromethane (CD2Cl2)",
        "acetonitrile": "Acetonitrile (CD3CN)",
        "dmf": "N,N-Dimethylformamide (DMF-d7)",
    }
    ```
    Keep all existing entries unchanged. Display names follow existing pattern: "Full name (Deuterated form)". The parenthesized text is extracted by `get_solvent_display_name()` for display in job results.

    **shifts.py** - Add 6 entries to the `solvent_map` dict in `get_scaling_factor()` (after existing 7 entries):
    ```python
    solvent_map = {
        "chcl3": "CHCl3",
        "dmso": "DMSO",
        "vacuum": "vacuum",
        "methanol": "Methanol",
        "water": "Water",
        "acetone": "Acetone",
        "benzene": "Benzene",
        "pyridine": "Pyridine",
        "thf": "THF",
        "toluene": "Toluene",
        "dcm": "DCM",
        "acetonitrile": "Acetonitrile",
        "dmf": "DMF",
    }
    ```
    These Title-case values MUST match the keys in `scaling_factors.json` exactly. Verified keys:
    - "B3LYP/6-311+G(2d,p)/1H/Pyridine"
    - "B3LYP/6-311+G(2d,p)/1H/THF"
    - "B3LYP/6-311+G(2d,p)/1H/Toluene"
    - "B3LYP/6-311+G(2d,p)/1H/DCM"
    - "B3LYP/6-311+G(2d,p)/1H/Acetonitrile"
    - "B3LYP/6-311+G(2d,p)/1H/DMF"
    Keep all existing entries unchanged.
  </action>
  <verify>
    Run: `python -c "from qm_nmr_calc.solvents import SUPPORTED_SOLVENTS, validate_solvent, get_solvent_display_name; print(len(SUPPORTED_SOLVENTS)); assert len(SUPPORTED_SOLVENTS) == 13; assert validate_solvent('pyridine') == 'pyridine'; assert validate_solvent('thf') == 'thf'; assert validate_solvent('toluene') == 'toluene'; assert validate_solvent('dcm') == 'dcm'; assert validate_solvent('acetonitrile') == 'acetonitrile'; assert validate_solvent('dmf') == 'dmf'; assert get_solvent_display_name('pyridine') == 'Pyridine-d5'; assert get_solvent_display_name('thf') == 'THF-d8'; assert get_solvent_display_name('toluene') == 'Toluene-d8'; assert get_solvent_display_name('dcm') == 'CD2Cl2'; assert get_solvent_display_name('acetonitrile') == 'CD3CN'; assert get_solvent_display_name('dmf') == 'DMF-d7'; print('solvents OK')"`

    Run: `python -c "from qm_nmr_calc.shifts import get_scaling_factor; f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'pyridine'); print(f'Pyridine 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'thf'); print(f'THF 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'toluene'); print(f'Toluene 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'dcm'); print(f'DCM 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'acetonitrile'); print(f'Acetonitrile 1H: slope={f[\"slope\"]:.4f}'); f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'dmf'); print(f'DMF 1H: slope={f[\"slope\"]:.4f}'); print('shifts OK')"`

    Run: `python -c "from qm_nmr_calc.shifts import get_scaling_factor; f = get_scaling_factor('B3LYP', '6-311+G(2d,p)', '1H', 'chcl3'); print(f'CHCl3 1H: slope={f[\"slope\"]:.4f}'); print('regression OK')"`
  </verify>
  <done>
    - SUPPORTED_SOLVENTS has 13 entries (was 7)
    - validate_solvent() accepts all 6 new solvents
    - get_solvent_display_name() returns correct deuterated forms for all 6 new solvents
    - get_scaling_factor() resolves all 6 new solvents to correct JSON keys
    - Existing CHCl3/DMSO/vacuum/methanol/water/acetone/benzene lookups unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 6 new solvents to nmredata.py and update tests</name>
  <files>
    src/qm_nmr_calc/nmredata.py
    tests/test_nmredata.py
  </files>
  <action>
    **nmredata.py** - Add 6 entries to the `solvent_map` dict in `map_solvent_to_nmredata()` (after existing 7 entries):
    ```python
    solvent_map = {
        "chcl3": "CDCl3",
        "dmso": "(CD3)2SO",
        "vacuum": "vacuum",
        "methanol": "CD3OD",
        "water": "D2O",
        "acetone": "(CD3)2CO",
        "benzene": "C6D6",
        "pyridine": "C5D5N",
        "thf": "C4D8O",
        "toluene": "C7D8",
        "dcm": "CD2Cl2",
        "acetonitrile": "CD3CN",
        "dmf": "(CD3)2NCDO",
    }
    ```
    These are standard NMReData deuterated chemical formulas (H replaced with D). Keep existing entries unchanged.

    **tests/test_nmredata.py** - Three changes:

    1. **Fix `test_unknown_solvent_raises_error`** (line 70): Change `"toluene"` to `"ethanol"` since toluene is now a valid solvent:
    ```python
    def test_unknown_solvent_raises_error(self):
        """Unknown solvent should raise ValueError."""
        with pytest.raises(ValueError, match="Unknown solvent"):
            map_solvent_to_nmredata("ethanol")
    ```

    2. **Add 6 new test methods** to `TestSolventMapping` class (insert after `test_benzene_maps_to_c6d6` on line 65, before `test_unknown_solvent_raises_error`):
    ```python
    def test_pyridine_maps_to_c5d5n(self):
        """Pyridine maps to deuterated form C5D5N."""
        assert map_solvent_to_nmredata("pyridine") == "C5D5N"

    def test_thf_maps_to_c4d8o(self):
        """THF maps to deuterated form C4D8O."""
        assert map_solvent_to_nmredata("thf") == "C4D8O"

    def test_toluene_maps_to_c7d8(self):
        """Toluene maps to deuterated form C7D8."""
        assert map_solvent_to_nmredata("toluene") == "C7D8"

    def test_dcm_maps_to_cd2cl2(self):
        """DCM maps to deuterated form CD2Cl2."""
        assert map_solvent_to_nmredata("dcm") == "CD2Cl2"

    def test_acetonitrile_maps_to_cd3cn(self):
        """Acetonitrile maps to deuterated form CD3CN."""
        assert map_solvent_to_nmredata("acetonitrile") == "CD3CN"

    def test_dmf_maps_to_deuterated_form(self):
        """DMF maps to NMReData convention (CD3)2NCDO."""
        assert map_solvent_to_nmredata("dmf") == "(CD3)2NCDO"
    ```

    3. Insert new tests in the correct location: after line 65 (`test_benzene_maps_to_c6d6`), before the unknown solvent test.
  </action>
  <verify>
    Run: `python -c "from qm_nmr_calc.nmredata import map_solvent_to_nmredata; assert map_solvent_to_nmredata('pyridine') == 'C5D5N'; assert map_solvent_to_nmredata('thf') == 'C4D8O'; assert map_solvent_to_nmredata('toluene') == 'C7D8'; assert map_solvent_to_nmredata('dcm') == 'CD2Cl2'; assert map_solvent_to_nmredata('acetonitrile') == 'CD3CN'; assert map_solvent_to_nmredata('dmf') == '(CD3)2NCDO'; assert map_solvent_to_nmredata('chcl3') == 'CDCl3'; print('nmredata OK')"`

    Run full test suite: `python -m pytest tests/ -x -q`

    Verify test count is 456 (450 existing + 6 new tests).
  </verify>
  <done>
    - map_solvent_to_nmredata() resolves all 13 solvents correctly
    - test_unknown_solvent_raises_error uses "ethanol" instead of "toluene"
    - 6 new test methods cover pyridine, THF, toluene, DCM, acetonitrile, DMF NMReData mappings
    - All existing tests pass without modification
    - Total test count is 456
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` -- All tests pass (456)
2. `python -c "from qm_nmr_calc.solvents import get_supported_solvents; s = get_supported_solvents(); print(s); assert len(s) == 13"` -- 13 solvents listed
3. `python -c "from qm_nmr_calc.shifts import get_scaling_factor; [get_scaling_factor('B3LYP', '6-311+G(2d,p)', n, s) for n in ['1H', '13C'] for s in ['chcl3', 'dmso', 'vacuum', 'methanol', 'water', 'acetone', 'benzene', 'pyridine', 'thf', 'toluene', 'dcm', 'acetonitrile', 'dmf']]; print('All 26 factor lookups succeed')"` -- All 26 scaling factor keys resolve
4. `python -c "from qm_nmr_calc.nmredata import map_solvent_to_nmredata; [map_solvent_to_nmredata(s) for s in ['chcl3', 'dmso', 'vacuum', 'methanol', 'water', 'acetone', 'benzene', 'pyridine', 'thf', 'toluene', 'dcm', 'acetonitrile', 'dmf']]; print('All 13 NMReData mappings work')"` -- All NMReData mappings work
</verification>

<success_criteria>
- SUPPORTED_SOLVENTS has exactly 13 entries (was 7)
- shifts.py solvent_map has exactly 13 entries (was 7)
- nmredata.py solvent_map has exactly 13 entries (was 7)
- All 26 scaling factor lookups succeed (13 solvents x 2 nuclei)
- All tests pass (456)
- No changes to any other files (API routes, templates, input_gen auto-propagate)
</success_criteria>

<output>
After completion, create `.planning/phases/64-solvent-integration/64-01-SUMMARY.md`
</output>
