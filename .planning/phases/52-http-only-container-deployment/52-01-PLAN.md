---
phase: 52-http-only-container-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gcp/start-vm.sh
  - gcp/stop-vm.sh
  - gcp/delete-vm.sh
  - gcp/status-vm.sh
  - gcp/ssh-vm.sh
  - gcp/logs-vm.sh
autonomous: true

must_haves:
  truths:
    - "start-vm.sh starts a VM deployed to any zone (not hardcoded)"
    - "stop-vm.sh stops a VM deployed to any zone"
    - "delete-vm.sh deletes a VM deployed to any zone, preserving disk"
    - "status-vm.sh shows HTTP URL (not HTTPS/domain) for running VM"
    - "ssh-vm.sh connects to a VM deployed to any zone"
    - "logs-vm.sh streams container logs without caddy option"
    - "All scripts load config from TOML via lib/config.sh, not config.sh"
    - "All deploy-vm.sh references updated to deploy-auto.sh"
  artifacts:
    - path: "gcp/start-vm.sh"
      provides: "VM start with runtime zone detection"
      contains: "load_config"
    - path: "gcp/stop-vm.sh"
      provides: "VM stop with runtime zone detection"
      contains: "load_config"
    - path: "gcp/delete-vm.sh"
      provides: "VM delete with runtime zone detection"
      contains: "load_config"
    - path: "gcp/status-vm.sh"
      provides: "VM status with HTTP URL display"
      contains: "http://"
    - path: "gcp/ssh-vm.sh"
      provides: "VM SSH with runtime zone detection"
      contains: "load_config"
    - path: "gcp/logs-vm.sh"
      provides: "Container log streaming without caddy"
      contains: "load_config"
  key_links:
    - from: "gcp/start-vm.sh"
      to: "gcp/lib/config.sh"
      via: "source and load_config call"
      pattern: "source.*lib/config\\.sh"
    - from: "gcp/status-vm.sh"
      to: "HTTP access URL"
      via: "echo with http:// prefix"
      pattern: "http://\\$"
    - from: "all 6 scripts"
      to: "gcloud compute instances list"
      via: "runtime zone detection"
      pattern: "gcloud compute instances list.*filter.*name"
---

<objective>
Migrate all 6 lifecycle scripts from v2.6 config.sh (hardcoded zone) to v2.7 TOML config + runtime zone detection.

Purpose: Lifecycle scripts must work with v2.7's dynamic zone selection. v2.7 picks the cheapest zone at deployment time, so lifecycle scripts cannot hardcode a zone -- they must discover it at runtime via gcloud. Also removes all HTTPS/domain/Caddy references since v2.7 is HTTP-only.

Output: 6 updated lifecycle scripts that source lib/config.sh for TOML config, detect the VM's zone dynamically via gcloud, and reference deploy-auto.sh instead of deploy-vm.sh.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gcp/lib/config.sh
@gcp/config.toml.example
@gcp/start-vm.sh
@gcp/stop-vm.sh
@gcp/delete-vm.sh
@gcp/status-vm.sh
@gcp/ssh-vm.sh
@gcp/logs-vm.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate start-vm.sh, stop-vm.sh, and ssh-vm.sh to v2.7</name>
  <files>gcp/start-vm.sh, gcp/stop-vm.sh, gcp/ssh-vm.sh</files>
  <action>
For each of the 3 scripts, apply this identical config migration pattern:

**Replace the config.sh loading block** (the `if [[ ! -f "config.sh" ]]` block through `source ./config.sh` and the `GCP_PROJECT_ID` validation) with:

```bash
# ============================================================================
# Load configuration
# ============================================================================
source "$SCRIPT_DIR/lib/config.sh"
load_config "$SCRIPT_DIR/config.toml" || exit 1

# Validate project is set (load_config ensures this, but be explicit)
if [[ -z "${GCP_PROJECT_ID:-}" ]]; then
    echo_error "GCP_PROJECT_ID not set after loading config"
    exit 1
fi
```

**Replace hardcoded zone usage** with runtime zone detection. After `VM_NAME="${RESOURCE_PREFIX}-vm"`, add:

```bash
# Detect VM zone dynamically (v2.7 selects zone at deployment time)
GCP_ZONE=$(gcloud compute instances list --project="$GCP_PROJECT_ID" \
    --filter="name=${VM_NAME}" --format="value(zone)" --quiet 2>/dev/null | head -1)
if [[ -z "$GCP_ZONE" ]]; then
    echo_error "VM '$VM_NAME' not found in any zone"
    echo "Create the VM first with ./deploy-auto.sh"
    exit 1
fi
echo_info "Found VM '$VM_NAME' in zone '$GCP_ZONE'"
```

Remove the old `echo_info "Checking VM '$VM_NAME' in zone '$GCP_ZONE'..."` line and the old `gcloud compute instances describe ... --zone="$GCP_ZONE"` existence check (the zone detection above replaces both -- if zone is found, VM exists).

**Script-specific changes:**

start-vm.sh:
- Line 69: Change `"Create the VM first with ./deploy-vm.sh"` to `"Create the VM first with ./deploy-auto.sh"` (this line is now in the zone detection block above)
- Line 125: Change `"Once ready, access your deployment at your configured domain."` to `"Once ready, access your deployment at http://$EXTERNAL_IP"`

stop-vm.sh:
- Line 69: Change `"Create the VM first with ./deploy-vm.sh"` to `"Create the VM first with ./deploy-auto.sh"` (now in zone detection block)

ssh-vm.sh:
- Line 67: Change `"Create the VM first with ./deploy-vm.sh"` to `"Create the VM first with ./deploy-auto.sh"` (now in zone detection block)

Keep all echo_info/echo_warn/echo_error functions (DO NOT replace with infra.sh logging -- lifecycle scripts stay standalone). Keep the color definitions. Keep set -euo pipefail. Keep SCRIPT_DIR and cd "$SCRIPT_DIR". Keep the gcloud authentication check block (lines checking ACTIVE_ACCOUNT). Keep all existing functional logic (start, stop, SSH behavior) unchanged.
  </action>
  <verify>
Run `bash -n gcp/start-vm.sh && bash -n gcp/stop-vm.sh && bash -n gcp/ssh-vm.sh` to verify syntax.
Run `grep -c "config\.sh\b" gcp/start-vm.sh gcp/stop-vm.sh gcp/ssh-vm.sh` -- should show only the `lib/config.sh` source line (1 per file), not the old `source ./config.sh`.
Run `grep "deploy-vm.sh" gcp/start-vm.sh gcp/stop-vm.sh gcp/ssh-vm.sh` -- should return nothing (all replaced with deploy-auto.sh).
Run `grep "load_config" gcp/start-vm.sh gcp/stop-vm.sh gcp/ssh-vm.sh` -- should show load_config call in each.
Run `grep "instances list" gcp/start-vm.sh gcp/stop-vm.sh gcp/ssh-vm.sh` -- should show zone detection in each.
  </verify>
  <done>
Three scripts load TOML config, detect zone at runtime via gcloud instances list, and reference deploy-auto.sh. Syntax checks pass. No hardcoded zone references. No deploy-vm.sh references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate delete-vm.sh, status-vm.sh, and logs-vm.sh to v2.7</name>
  <files>gcp/delete-vm.sh, gcp/status-vm.sh, gcp/logs-vm.sh</files>
  <action>
Apply the same config migration and zone detection pattern from Task 1 to all 3 scripts (replace config.sh loading with TOML loading, replace hardcoded zone with runtime detection).

**delete-vm.sh specific changes:**
- Apply config migration and zone detection (same pattern as Task 1)
- For the "VM not found" case: the zone detection block handles this (if zone empty, VM doesn't exist). After zone detection succeeds, proceed directly to the describe call for status. The old `gcloud compute instances describe` existence check can be removed since zone detection already confirmed the VM exists.
- Line 97: Change `"You can recreate the VM later with ./deploy-vm.sh"` to `"You can recreate the VM later with ./deploy-auto.sh"`
- Lines 128-129: Change `"./deploy-vm.sh"` to `"./deploy-auto.sh"`
- KEEP the `read -p "Are you sure..."` confirmation prompt -- this is intentional for destructive operations
- KEEP the delete logic and summary output unchanged

**status-vm.sh specific changes:**
- Apply config migration and zone detection (same pattern as Task 1)
- For the "VM not found" case: when zone detection returns empty, show the "VM Not Found" message block, but change `"./deploy-vm.sh"` (line 77) to `"./deploy-auto.sh"` and remove the `"Zone: $GCP_ZONE"` line from the "not found" display (we don't know the zone if VM doesn't exist)
- Remove lines 101-104 (DOMAIN metadata fetch): Delete the entire block that fetches DOMAIN from VM metadata
- Remove lines 143-146 (Domain display): Delete the `if [[ -n "$DOMAIN" ]]` block that shows "Domain: $DOMAIN"
- Lines 158-161 (Web UI display): Replace the entire `if [[ -n "$DOMAIN" ]]` block with a simple unconditional line:
  ```bash
  echo "Web UI:  http://$EXTERNAL_IP"
  echo ""
  ```
  This should appear in the "Access Information" section for RUNNING VMs, right before the SSH commands. Only show this when EXTERNAL_IP is non-empty (which it will be since VM is running).
- Keep the BLUE color definition (it's used for status display)
- Keep all status display logic, machine type parsing, creation time, etc.

**logs-vm.sh specific changes:**
- Apply config migration and zone detection (same pattern as Task 1)
- Line 10: Remove `#   ./logs-vm.sh caddy        # Stream only Caddy (reverse proxy) logs` from the usage comment
- Line 70: Change `"Create the VM first with ./deploy-vm.sh"` to `"Create the VM first with ./deploy-auto.sh"` (now in zone detection block)
- Keep the SERVICE argument handling, compose command building, and SSH streaming unchanged

For all 3 scripts: Keep echo_info/echo_warn/echo_error functions, color definitions, set -euo pipefail, SCRIPT_DIR, gcloud auth check. Do NOT source infra.sh.
  </action>
  <verify>
Run `bash -n gcp/delete-vm.sh && bash -n gcp/status-vm.sh && bash -n gcp/logs-vm.sh` to verify syntax.
Run `grep "deploy-vm.sh" gcp/delete-vm.sh gcp/status-vm.sh gcp/logs-vm.sh` -- should return nothing.
Run `grep "load_config" gcp/delete-vm.sh gcp/status-vm.sh gcp/logs-vm.sh` -- should show load_config in each.
Run `grep "instances list" gcp/delete-vm.sh gcp/status-vm.sh gcp/logs-vm.sh` -- should show zone detection in each.
Run `grep -i "domain" gcp/status-vm.sh` -- should return nothing (all DOMAIN references removed).
Run `grep -i "caddy" gcp/logs-vm.sh` -- should return nothing (caddy reference removed from usage comment).
Run `grep "https://" gcp/status-vm.sh` -- should return nothing (HTTPS references removed).
Run `grep "http://" gcp/status-vm.sh` -- should show the HTTP URL line.
Run `grep "source.*config\.sh\b" gcp/delete-vm.sh gcp/status-vm.sh gcp/logs-vm.sh` -- each should show only `lib/config.sh`.
  </verify>
  <done>
Three scripts load TOML config, detect zone at runtime, and have all v2.6 references cleaned up. delete-vm.sh keeps its confirmation prompt. status-vm.sh shows HTTP URL instead of HTTPS/domain. logs-vm.sh has no caddy reference. No deploy-vm.sh references remain. Syntax checks pass.
  </done>
</task>

</tasks>

<verification>
Across all 6 lifecycle scripts:
1. `bash -n gcp/{start,stop,delete,status,ssh,logs}-vm.sh` -- all pass syntax check
2. `grep -r "source.*\./config\.sh" gcp/{start,stop,delete,status,ssh,logs}-vm.sh` -- returns nothing (old config.sh sourcing removed)
3. `grep -r "deploy-vm\.sh" gcp/{start,stop,delete,status,ssh,logs}-vm.sh` -- returns nothing
4. `grep -r "load_config" gcp/{start,stop,delete,status,ssh,logs}-vm.sh` -- 6 matches (one per script)
5. `grep -r "instances list" gcp/{start,stop,delete,status,ssh,logs}-vm.sh` -- 6 matches (zone detection in each)
6. `grep -ri "caddy\|https://\|domain" gcp/{start,stop,delete,status,ssh,logs}-vm.sh` -- returns nothing
7. `grep "http://" gcp/status-vm.sh` -- returns HTTP URL display line
</verification>

<success_criteria>
All 6 lifecycle scripts use TOML config loading via lib/config.sh, detect VM zone at runtime via gcloud compute instances list, reference deploy-auto.sh, and have zero HTTPS/domain/Caddy references. Bash syntax checks pass for all scripts.
</success_criteria>

<output>
After completion, create `.planning/phases/52-http-only-container-deployment/52-01-SUMMARY.md`
</output>
