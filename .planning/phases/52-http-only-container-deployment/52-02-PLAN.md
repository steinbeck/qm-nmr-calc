---
phase: 52-http-only-container-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gcp/teardown-infrastructure.sh
autonomous: true

must_haves:
  truths:
    - "teardown-infrastructure.sh loads config from TOML, not config.sh"
    - "teardown-infrastructure.sh detects zone at runtime for disk deletion"
    - "teardown-infrastructure.sh derives region from detected zone for IP release"
    - "teardown-infrastructure.sh does not try to delete HTTPS firewall rule"
    - "teardown-infrastructure.sh does not mention DNS records"
    - "teardown-infrastructure.sh keeps confirmation prompt for destructive operation"
  artifacts:
    - path: "gcp/teardown-infrastructure.sh"
      provides: "Complete infrastructure teardown with TOML config and runtime zone/region detection"
      contains: "load_config"
  key_links:
    - from: "gcp/teardown-infrastructure.sh"
      to: "gcp/lib/config.sh"
      via: "source and load_config call"
      pattern: "source.*lib/config\\.sh"
    - from: "gcp/teardown-infrastructure.sh"
      to: "gcloud compute instances list"
      via: "runtime zone detection for disk deletion"
      pattern: "gcloud compute instances list.*filter"
---

<objective>
Migrate teardown-infrastructure.sh from v2.6 config.sh to v2.7 TOML config with runtime zone/region detection and HTTPS cleanup removal.

Purpose: The teardown script must work with v2.7's dynamic zone selection. It needs the zone to delete the persistent disk (zone-scoped resource) and the region to release the static IP (region-scoped resource). Since v2.7 no longer creates HTTPS firewall rules, the teardown should not list them. DNS reminders are irrelevant for HTTP-only deployment.

Output: Updated teardown-infrastructure.sh that loads TOML config, discovers zone from existing VM or disk, derives region from zone, deletes only HTTP+SSH firewall rules, and omits DNS notes.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gcp/lib/config.sh
@gcp/config.toml.example
@gcp/teardown-infrastructure.sh
@gcp/deploy-auto.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate teardown-infrastructure.sh to v2.7 TOML config</name>
  <files>gcp/teardown-infrastructure.sh</files>
  <action>
Edit gcp/teardown-infrastructure.sh with these changes:

**1. Replace config.sh loading with TOML config loading.**

Replace the `if [[ ! -f "config.sh" ]]` block through `source ./config.sh` and `GCP_PROJECT_ID` validation with:

```bash
# ============================================================================
# Load configuration
# ============================================================================
source "$SCRIPT_DIR/lib/config.sh"
load_config "$SCRIPT_DIR/config.toml" || exit 1

if [[ -z "${GCP_PROJECT_ID:-}" ]]; then
    echo_error "GCP_PROJECT_ID not set after loading config"
    exit 1
fi
```

**2. Replace static zone/region display with dynamic detection.**

After `gcloud config set project "$GCP_PROJECT_ID" --quiet`, add zone/region detection:

```bash
# ============================================================================
# Detect zone and region
# ============================================================================
VM_NAME="${RESOURCE_PREFIX}-vm"
DISK_NAME="${RESOURCE_PREFIX}-data"

# Try to detect zone from existing VM first, then from disk
GCP_ZONE=$(gcloud compute instances list --project="$GCP_PROJECT_ID" \
    --filter="name=${VM_NAME}" --format="value(zone)" --quiet 2>/dev/null | head -1)

if [[ -z "$GCP_ZONE" ]]; then
    # VM might already be deleted, try to find zone from the persistent disk
    GCP_ZONE=$(gcloud compute disks list --project="$GCP_PROJECT_ID" \
        --filter="name=${DISK_NAME}" --format="value(zone)" --quiet 2>/dev/null | head -1)
fi

if [[ -z "$GCP_ZONE" ]]; then
    echo_warn "Could not detect zone from VM or disk (resources may already be deleted)"
    echo_warn "Proceeding with firewall rules and IP cleanup only..."
    ZONE_AVAILABLE=false
else
    # Derive region from zone (e.g., us-central1-a -> us-central1)
    GCP_REGION="${GCP_ZONE%-*}"
    ZONE_AVAILABLE=true
    echo_info "Detected zone: $GCP_ZONE"
    echo_info "Derived region: $GCP_REGION"
fi
```

**3. Update the teardown configuration display.**

Replace the static display block (lines 56-59 showing Project, Region, Zone, Prefix) with:

```bash
echo_info "Teardown configuration:"
echo "  Project:  $GCP_PROJECT_ID"
if [[ "$ZONE_AVAILABLE" == "true" ]]; then
    echo "  Region:   $GCP_REGION"
    echo "  Zone:     $GCP_ZONE"
fi
echo "  Prefix:   $RESOURCE_PREFIX"
echo ""
```

**4. Update the confirmation warning.**

Change the warning text to remove HTTPS firewall rule mention. Replace:
```
echo "  - Firewall rules for HTTP, HTTPS, SSH"
```
With:
```
echo "  - Firewall rules for HTTP and SSH"
```

**5. Make disk deletion conditional on zone availability.**

Wrap the disk deletion block with a zone check:

```bash
# ============================================================================
# Delete persistent disk (requires zone)
# ============================================================================
if [[ "$ZONE_AVAILABLE" == "true" ]]; then
    DISK_NAME="${RESOURCE_PREFIX}-data"
    echo ""
    echo_info "Deleting persistent disk '$DISK_NAME'..."
    if gcloud compute disks describe "$DISK_NAME" --zone="$GCP_ZONE" &>/dev/null; then
        gcloud compute disks delete "$DISK_NAME" --zone="$GCP_ZONE" --quiet || echo_warn "Failed to delete disk (may be attached to VM)"
        echo_info "Persistent disk '$DISK_NAME' deleted"
    else
        echo_warn "Persistent disk '$DISK_NAME' does not exist, skipping"
    fi
else
    echo ""
    echo_warn "Skipping disk deletion (zone unknown)"
fi
```

Note: DISK_NAME is already set in the zone detection block above, but re-declaring it here is fine for clarity within the section.

**6. Remove HTTPS firewall rule from deletion loop.**

Replace the firewall rules section. Remove the HTTPS_RULE variable and only delete HTTP and SSH:

```bash
# ============================================================================
# Delete firewall rules
# ============================================================================
echo ""
echo_info "Deleting firewall rules..."

HTTP_RULE="${RESOURCE_PREFIX}-allow-http"
SSH_RULE="${RESOURCE_PREFIX}-allow-ssh"

for RULE in "$HTTP_RULE" "$SSH_RULE"; do
    if gcloud compute firewall-rules describe "$RULE" &>/dev/null; then
        gcloud compute firewall-rules delete "$RULE" --quiet || echo_warn "Failed to delete firewall rule '$RULE'"
        echo_info "Firewall rule '$RULE' deleted"
    else
        echo_warn "Firewall rule '$RULE' does not exist, skipping"
    fi
done
```

**7. Make IP release conditional on region availability.**

Wrap the IP release block with a region check (region is only available if zone was detected):

```bash
# ============================================================================
# Release static IP (requires region)
# ============================================================================
echo ""
echo_info "Releasing static IP..."

IP_NAME="${RESOURCE_PREFIX}-ip"
if [[ "$ZONE_AVAILABLE" == "true" ]]; then
    if gcloud compute addresses describe "$IP_NAME" --region="$GCP_REGION" &>/dev/null; then
        gcloud compute addresses delete "$IP_NAME" --region="$GCP_REGION" --quiet || echo_warn "Failed to release IP (may be in use)"
        echo_info "Static IP '$IP_NAME' released"
    else
        echo_warn "Static IP '$IP_NAME' does not exist in region $GCP_REGION, skipping"
    fi
else
    # Try to find IP in any region
    local_ip_region=$(gcloud compute addresses list --project="$GCP_PROJECT_ID" \
        --filter="name=${IP_NAME}" --format="value(region)" --quiet 2>/dev/null | head -1 | rev | cut -d'/' -f1 | rev)
    if [[ -n "$local_ip_region" ]]; then
        gcloud compute addresses delete "$IP_NAME" --region="$local_ip_region" --quiet || echo_warn "Failed to release IP"
        echo_info "Static IP '$IP_NAME' released from region $local_ip_region"
    else
        echo_warn "Static IP '$IP_NAME' not found in any region, skipping"
    fi
fi
```

**8. Update the summary section.**

Replace the summary to remove HTTPS rule and DNS note:

```bash
# ============================================================================
# Summary
# ============================================================================
echo ""
echo "=============================================="
echo_info "Infrastructure Teardown Complete!"
echo "=============================================="
echo ""
echo "Removed resources:"
echo "  - Persistent disk: ${RESOURCE_PREFIX}-data"
echo "  - Firewall rules:  ${RESOURCE_PREFIX}-allow-http, ${RESOURCE_PREFIX}-allow-ssh"
echo "  - Static IP:       ${RESOURCE_PREFIX}-ip"
echo ""
```

Remove the DNS note line entirely (`"Note: Remember to update your DNS records..."`).

**Keep unchanged:** set -uo pipefail (note: NOT set -euo pipefail -- teardown intentionally omits -e to continue on errors), SCRIPT_DIR, cd, color definitions, echo_info/echo_warn/echo_error functions, --force argument parsing, confirmation prompt with `read -p`.
  </action>
  <verify>
Run `bash -n gcp/teardown-infrastructure.sh` to verify syntax.
Run `grep "source.*\./config\.sh" gcp/teardown-infrastructure.sh` -- should return nothing (old config.sh removed).
Run `grep "load_config" gcp/teardown-infrastructure.sh` -- should show load_config call.
Run `grep -i "https" gcp/teardown-infrastructure.sh` -- should return nothing (no HTTPS rule reference).
Run `grep -i "dns" gcp/teardown-infrastructure.sh` -- should return nothing (DNS note removed).
Run `grep "allow-https" gcp/teardown-infrastructure.sh` -- should return nothing.
Run `grep "instances list\|disks list" gcp/teardown-infrastructure.sh` -- should show zone detection from VM and disk.
Run `grep 'GCP_REGION.*GCP_ZONE' gcp/teardown-infrastructure.sh` -- should show region derived from zone.
Run `grep "read -p" gcp/teardown-infrastructure.sh` -- should show confirmation prompt is kept.
  </verify>
  <done>
teardown-infrastructure.sh loads TOML config, detects zone from VM or disk at runtime, derives region from zone, deletes only HTTP+SSH firewall rules (no HTTPS), releases static IP using derived region, and omits DNS note. Confirmation prompt preserved for destructive operation. Syntax check passes.
  </done>
</task>

</tasks>

<verification>
1. `bash -n gcp/teardown-infrastructure.sh` -- passes syntax check
2. `grep "source.*\./config\.sh" gcp/teardown-infrastructure.sh` -- returns nothing
3. `grep "load_config" gcp/teardown-infrastructure.sh` -- shows TOML loading
4. `grep -i "https\|caddy\|domain\|dns" gcp/teardown-infrastructure.sh` -- returns nothing
5. `grep "allow-https" gcp/teardown-infrastructure.sh` -- returns nothing
6. `grep "read -p" gcp/teardown-infrastructure.sh` -- confirms prompt retained
7. `grep "instances list\|disks list" gcp/teardown-infrastructure.sh` -- shows dual zone detection strategy
8. `grep "ZONE_AVAILABLE" gcp/teardown-infrastructure.sh` -- shows graceful handling when zone unknown
</verification>

<success_criteria>
teardown-infrastructure.sh uses TOML config, detects zone/region dynamically from VM or disk, only deletes HTTP+SSH firewall rules, has no HTTPS/domain/DNS references, handles missing zone gracefully, and preserves the confirmation prompt. Syntax check passes.
</success_criteria>

<output>
After completion, create `.planning/phases/52-http-only-container-deployment/52-02-SUMMARY.md`
</output>
