---
phase: 11-production-integration
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - src/qm_nmr_calc/api/schemas.py
  - src/qm_nmr_calc/api/routers/jobs.py
  - src/qm_nmr_calc/api/app.py
  - src/qm_nmr_calc/api/templates/base.html
autonomous: true

must_haves:
  truths:
    - "API response includes scaling factor metadata (source, expected MAE)"
    - "Expected accuracy shown as +/- X.XX ppm format"
    - "API description references NWChem without ISiCLE"
    - "Footer credits NWChem only (not ISiCLE)"
  artifacts:
    - path: "src/qm_nmr_calc/api/schemas.py"
      provides: "NMRResultsResponse with factor metadata fields"
      contains: "scaling_factor_source"
    - path: "src/qm_nmr_calc/api/app.py"
      provides: "FastAPI app with updated description"
    - path: "src/qm_nmr_calc/api/templates/base.html"
      provides: "Base template with NWChem credit"
  key_links:
    - from: "src/qm_nmr_calc/api/routers/jobs.py"
      to: "src/qm_nmr_calc/shifts.py"
      via: "get_scaling_factor import"
      pattern: "from.*shifts import.*get_scaling_factor"
---

<objective>
Add scaling factor metadata to API responses and update branding

Purpose: Enhance API transparency by including scaling factor provenance (DELTA50 source, expected accuracy metrics) in NMR results. Also complete the ISiCLE-to-NWChem branding transition in UI and API documentation.

Output: Updated API schemas with factor metadata, enhanced results endpoint, clean branding throughout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-production-integration/11-CONTEXT.md
@.planning/phases/11-production-integration/11-RESEARCH.md
@src/qm_nmr_calc/api/schemas.py
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/api/app.py
@src/qm_nmr_calc/api/templates/base.html
@src/qm_nmr_calc/shifts.py
@src/qm_nmr_calc/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add factor metadata to NMRResultsResponse schema</name>
  <files>
    src/qm_nmr_calc/api/schemas.py
  </files>
  <action>
Update NMRResultsResponse class to include scaling factor metadata:

```python
class NMRResultsResponse(BaseModel):
    """API response model for NMR calculation results."""

    h1_shifts: list[AtomShiftResponse] = Field(
        ..., description="1H chemical shifts sorted by ppm descending"
    )
    c13_shifts: list[AtomShiftResponse] = Field(
        ..., description="13C chemical shifts sorted by ppm descending"
    )
    functional: str = Field(..., description="DFT functional used")
    basis_set: str = Field(..., description="Basis set used for NMR calculation")
    solvent: str = Field(..., description="Solvent used for COSMO solvation")
    # Scaling factor metadata (new fields)
    scaling_factor_source: str = Field(
        default="DELTA50",
        description="Source of scaling factors used for shift calculation"
    )
    h1_expected_mae: str = Field(
        ...,
        description="Expected mean absolute error for 1H shifts (e.g., '+/- 0.12 ppm')",
        examples=["+/- 0.12 ppm"]
    )
    c13_expected_mae: str = Field(
        ...,
        description="Expected mean absolute error for 13C shifts (e.g., '+/- 1.95 ppm')",
        examples=["+/- 1.95 ppm"]
    )
```

Note: Use string format for expected_mae to include "+/- X.XX ppm" formatting, which is more user-friendly than raw float.
  </action>
  <verify>
    Run: `python -c "
from qm_nmr_calc.api.schemas import NMRResultsResponse

fields = NMRResultsResponse.model_fields.keys()
assert 'scaling_factor_source' in fields
assert 'h1_expected_mae' in fields
assert 'c13_expected_mae' in fields
print('NMRResultsResponse fields:', list(fields))
"`
  </verify>
  <done>
    - NMRResultsResponse includes scaling_factor_source field
    - NMRResultsResponse includes h1_expected_mae and c13_expected_mae fields
    - Fields have appropriate descriptions for OpenAPI docs
  </done>
</task>

<task type="auto">
  <name>Task 2: Update jobs router to include factor metadata in response</name>
  <files>
    src/qm_nmr_calc/api/routers/jobs.py
  </files>
  <action>
1. Add import at top:
   ```python
   from qm_nmr_calc.shifts import get_scaling_factor
   ```

2. Find where NMRResultsResponse is constructed (in the results endpoint, likely GET /jobs/{job_id}/results).

3. **Data sources for factor lookup:**
   The NMR results stored in job_status contain the calculation parameters:
   - `job_status.nmr_results.functional` - DFT functional (e.g., "b3lyp")
   - `job_status.nmr_results.basis_set` - NMR basis set (e.g., "6-311+G(2d,p)")
   - `job_status.nmr_results.solvent` - Solvent name (e.g., "CHCl3")

   These are populated from the NMRResults model (see models.py lines 27-29).

4. When building NMRResultsResponse, add the factor metadata:
   ```python
   # Get the NMR results from job status
   nmr_results = job_status.nmr_results

   # Get factor metadata for MAE display
   # Note: functional stored lowercase, get_scaling_factor expects uppercase
   h1_factor = get_scaling_factor(
       nmr_results.functional.upper(),
       nmr_results.basis_set,
       "1H",
       nmr_results.solvent
   )
   c13_factor = get_scaling_factor(
       nmr_results.functional.upper(),
       nmr_results.basis_set,
       "13C",
       nmr_results.solvent
   )

   return NMRResultsResponse(
       h1_shifts=[...],
       c13_shifts=[...],
       functional=nmr_results.functional,
       basis_set=nmr_results.basis_set,
       solvent=nmr_results.solvent,
       scaling_factor_source="DELTA50",
       h1_expected_mae=f"+/- {h1_factor['mae']:.2f} ppm",
       c13_expected_mae=f"+/- {c13_factor['mae']:.2f} ppm",
   )
   ```

5. **Error handling assumption:** get_scaling_factor() raises ValueError if the combination is not supported. We assume only valid combinations reach this point because:
   - Job submission validates solvent against supported list (solvents.py)
   - Preset selection constrains functional to supported values (presets.py)
   - If somehow an unsupported combination reaches here, the ValueError will surface as a 500 error which is appropriate (data integrity issue)

   No try/except needed - let ValueError propagate to indicate a bug in the pipeline.

   Note: Error handling for unsupported factor combinations is covered by integration testing of the full job submission and validation pipeline.

6. If there's also a JobStatusResponse that includes nmr_results, ensure the NMRResultsResponse is properly constructed there too.

Note: The existing code may build NMRResultsResponse differently. Adapt the pattern to fit - the key is adding the three new fields with proper values from job_status.nmr_results.
  </action>
  <verify>
    Run: `grep -n "scaling_factor_source\|expected_mae" src/qm_nmr_calc/api/routers/jobs.py`
    Should show lines where these fields are set.

    Run: `grep -n "get_scaling_factor" src/qm_nmr_calc/api/routers/jobs.py`
    Should show import and usage of get_scaling_factor.
  </verify>
  <done>
    - jobs.py imports get_scaling_factor from shifts module
    - NMRResultsResponse construction includes factor metadata
    - Expected MAE formatted as "+/- X.XX ppm" string
    - Values pulled from job_status.nmr_results (functional, basis_set, solvent)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API description and UI branding</name>
  <files>
    src/qm_nmr_calc/api/app.py
    src/qm_nmr_calc/api/templates/base.html
  </files>
  <action>
**app.py:**
Update the FastAPI app description to remove ISiCLE reference:

Find:
```python
description="Asynchronous NMR quantum mechanical calculations via ISiCLE/NWChem"
```

Replace with:
```python
description="Asynchronous NMR quantum mechanical calculations via NWChem"
```

**base.html:**
Update the footer credit to remove ISiCLE reference:

Find:
```html
<small>Powered by ISiCLE and NWChem</small>
```

Replace with:
```html
<small>Powered by NWChem</small>
```
  </action>
  <verify>
    Run: `grep -n "ISiCLE\|isicle" src/qm_nmr_calc/api/app.py src/qm_nmr_calc/api/templates/base.html || echo "No ISiCLE references in app.py or base.html - OK"`

    Run: `grep "Powered by" src/qm_nmr_calc/api/templates/base.html`
    Should show "Powered by NWChem" (not ISiCLE).
  </verify>
  <done>
    - app.py description says "via NWChem" without ISiCLE
    - base.html footer says "Powered by NWChem" only
    - No ISiCLE branding visible to users
  </done>
</task>

</tasks>

<verification>
1. Schema has new fields: NMRResultsResponse includes scaling_factor_source, h1_expected_mae, c13_expected_mae
2. API response includes metadata: Start server and GET /api/v1/jobs/{completed_job}/results shows factor fields
3. Branding updated: No "ISiCLE" appears in API docs or web UI
4. Tests pass: `pytest tests/ -q`
5. Comprehensive ISiCLE check: `grep -ri "isicle" src/qm_nmr_calc/ --include="*.py" --include="*.html" | grep -v __pycache__ | grep -v "ISiCLE removed\|ISiCLE dependency\|ISiCLE wrapper\|replacing.*ISiCLE"` returns only attribution comments
</verification>

<success_criteria>
- NMRResultsResponse schema includes scaling_factor_source, h1_expected_mae, c13_expected_mae
- Jobs router constructs response with factor metadata from get_scaling_factor()
- Expected MAE shown in "+/- X.XX ppm" format
- API description and UI footer reference NWChem only
- ISiCLE branding removed from user-facing elements
</success_criteria>

<output>
After completion, create `.planning/phases/11-production-integration/11-03-SUMMARY.md`
</output>
