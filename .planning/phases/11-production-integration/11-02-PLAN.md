---
phase: 11-production-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/models.py
  - src/qm_nmr_calc/storage.py
  - src/qm_nmr_calc/api/routers/jobs.py
  - src/qm_nmr_calc/api/routers/web.py
autonomous: true

must_haves:
  truths:
    - "JobStatus model no longer has isicle_version field"
    - "Old job status.json files with isicle_version field still load without error"
    - "API responses no longer include isicle_version"
    - "create_job_directory() no longer requires isicle_version parameter"
  artifacts:
    - path: "src/qm_nmr_calc/models.py"
      provides: "Job models without ISiCLE references"
      contains: 'extra="ignore"'
    - path: "src/qm_nmr_calc/storage.py"
      provides: "Job storage without isicle_version parameter"
    - path: "src/qm_nmr_calc/api/routers/jobs.py"
      provides: "Jobs API without isicle_version"
    - path: "src/qm_nmr_calc/api/routers/web.py"
      provides: "Web router without isicle_version"
  key_links:
    - from: "src/qm_nmr_calc/storage.py"
      to: "src/qm_nmr_calc/models.py"
      via: "JobStatus model import"
      pattern: "from .models import.*JobStatus"
---

<objective>
Remove ISiCLE version tracking from models and storage layer

Purpose: Complete the ISiCLE removal by eliminating the isicle_version field from job status tracking. ISiCLE was replaced with direct NWChem integration in Phase 7, but version tracking persisted for backwards compatibility. Now we remove it completely.

Output: Clean models and storage code without ISiCLE references, while maintaining ability to load old job files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-production-integration/11-CONTEXT.md
@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/storage.py
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/api/routers/web.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove isicle_version from JobStatus model</name>
  <files>
    src/qm_nmr_calc/models.py
  </files>
  <action>
1. In JobStatus class, update model_config to allow extra fields (for backwards compat with old job files):
   ```python
   model_config = ConfigDict(
       ser_json_timedelta="iso8601",
       extra="ignore",  # Allow old files with isicle_version to load
   )
   ```

2. Remove the isicle_version field from the class body:
   ```python
   # DELETE THIS LINE:
   # isicle_version: str
   ```

3. Keep nwchem_version field as-is.

4. Update the comment "# Versions (for reproducibility)" to "# Version (for reproducibility)" (singular).
  </action>
  <verify>
    Run: `python -c "
from qm_nmr_calc.models import JobStatus
from datetime import datetime

# Check isicle_version is gone
fields = JobStatus.model_fields.keys()
assert 'isicle_version' not in fields, 'isicle_version still in model'
assert 'nwchem_version' in fields, 'nwchem_version missing'
print('Model fields:', list(fields))

# Check we can load old data with isicle_version
old_data = {
    'job_id': '123456789abc',
    'status': 'complete',
    'created_at': datetime.now().isoformat(),
    'input': {'smiles': 'CCO', 'preset': 'production', 'solvent': 'CHCl3'},
    'isicle_version': '0.4.0',  # Old field
    'nwchem_version': '7.2.3',
}
job = JobStatus.model_validate(old_data)
print('Old data loads OK, nwchem_version:', job.nwchem_version)
"`
  </verify>
  <done>
    - JobStatus no longer has isicle_version field
    - Old job JSON with isicle_version loads without error (extra="ignore")
    - nwchem_version field preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Update storage.py and API routers</name>
  <files>
    src/qm_nmr_calc/storage.py
    src/qm_nmr_calc/api/routers/jobs.py
    src/qm_nmr_calc/api/routers/web.py
  </files>
  <action>
**storage.py:**
1. Remove `isicle_version: str` parameter from create_job_directory() signature
2. Remove `isicle_version=isicle_version` from JobStatus constructor call

Updated signature should be:
```python
def create_job_directory(
    smiles: str,
    solvent: str,
    nwchem_version: str,
    name: Optional[str] = None,
    preset: str = "production",
    notification_email: Optional[str] = None,
) -> JobStatus:
```

**jobs.py:**
1. Find all calls to create_job_directory() and remove isicle_version argument
2. Remove the isicle_version="N/A" lines (there are 2-3 occurrences)
3. The calls should now just pass nwchem_version

**web.py:**
1. Find the call to create_job_directory() and remove isicle_version argument
2. Remove the isicle_version="N/A" line
  </action>
  <verify>
    Run: `python -c "
from qm_nmr_calc.storage import create_job_directory
import inspect

# Check signature no longer has isicle_version
sig = inspect.signature(create_job_directory)
params = list(sig.parameters.keys())
assert 'isicle_version' not in params, f'isicle_version still in signature: {params}'
print('create_job_directory params:', params)
"`

    Run: `grep -n "isicle_version" src/qm_nmr_calc/storage.py src/qm_nmr_calc/api/routers/jobs.py src/qm_nmr_calc/api/routers/web.py || echo "No isicle_version references found - OK"`
  </verify>
  <done>
    - create_job_directory() signature simplified (no isicle_version param)
    - jobs.py API routes call create_job_directory without isicle_version
    - web.py route calls create_job_directory without isicle_version
    - No isicle_version references remain in storage.py or API routers
  </done>
</task>

</tasks>

<verification>
1. Model validation: JobStatus.model_fields does not contain 'isicle_version'
2. Backwards compat: Old job JSON with isicle_version field loads successfully
3. Storage signature: create_job_directory() does not require isicle_version
4. No references: `grep -r "isicle_version" src/qm_nmr_calc/` returns only the comment in nwchem/__init__.py about ISiCLE attribution
5. Tests pass: `pytest tests/ -q`
</verification>

<success_criteria>
- isicle_version removed from JobStatus model
- Old job files with isicle_version still load (extra="ignore" in model_config)
- create_job_directory() no longer accepts isicle_version parameter
- API routes updated to not pass isicle_version
- Only ISiCLE attribution comments remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/11-production-integration/11-02-SUMMARY.md`
</output>
