---
phase: 34-testing-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_api.py
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/jobs/{job_id}/nmredata.sdf returns 404 for non-existent job"
    - "GET /api/v1/jobs/{job_id}/nmredata.sdf returns 409 for incomplete job"
    - "GET /api/v1/jobs/{job_id}/nmredata.sdf returns 200 with SDF content for complete job"
    - "Response has correct Content-Disposition header with filename"
    - "Response has correct media type chemical/x-mdl-sdfile"
    - "SDF content contains NMREDATA_ASSIGNMENT tag"
  artifacts:
    - path: "tests/test_api.py"
      provides: "NMReData endpoint integration tests"
      contains: "TestNMReDataEndpoint"
  key_links:
    - from: "tests/test_api.py"
      to: "src/qm_nmr_calc/api/routers/jobs.py"
      via: "TestClient hitting download_nmredata endpoint"
      pattern: "client\\.get.*nmredata\\.sdf"
---

<objective>
Add integration tests for the NMReData SDF download endpoint

Purpose: Complete TEST-02 requirement - validate complete API endpoint flow including job completion check, file generation, and HTTP response headers
Output: TestNMReDataEndpoint class in tests/test_api.py with 6-8 tests covering all endpoint behaviors
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/test_api.py (existing API test patterns)
@tests/test_nmredata.py (unit tests already covering TEST-01, TEST-03)
@src/qm_nmr_calc/api/routers/jobs.py (endpoint implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TestNMReDataEndpoint class with error case tests</name>
  <files>tests/test_api.py</files>
  <action>
Add a new TestNMReDataEndpoint class to tests/test_api.py with tests for error cases:

1. `test_nmredata_endpoint_returns_404_for_nonexistent_job`:
   - GET /api/v1/jobs/nonexistent123/nmredata.sdf
   - Assert status_code == 404
   - Assert response.json()["detail"]["status"] == 404
   - Assert "title" in response.json()["detail"]

2. `test_nmredata_endpoint_returns_409_for_incomplete_job`:
   - Create a job via POST /api/v1/jobs with {"smiles": "CCO", "solvent": "chcl3"}
   - GET /api/v1/jobs/{job_id}/nmredata.sdf immediately (job still queued)
   - Assert status_code == 409
   - Assert response.json()["detail"]["status"] == 409

Follow the existing test patterns from TestGeometryEndpoint class.
  </action>
  <verify>pytest tests/test_api.py::TestNMReDataEndpoint -v shows both tests passing</verify>
  <done>Two error case tests exist and pass</done>
</task>

<task type="auto">
  <name>Task 2: Add success case tests with mocked complete job</name>
  <files>tests/test_api.py</files>
  <action>
Add tests for successful NMReData download by mocking a complete job with NMR results:

3. `test_nmredata_endpoint_returns_200_for_complete_job`:
   - Use unittest.mock.patch to mock load_job_status returning a complete JobStatus
   - Mock get_geometry_file returning a Path to temp XYZ file
   - Create JobStatus mock with:
     - status="complete"
     - nmr_results with h1_shifts and c13_shifts
     - input.smiles="CCO", input.solvent="chcl3"
     - conformer_mode="single"
   - GET /api/v1/jobs/{job_id}/nmredata.sdf
   - Assert status_code == 200

4. `test_nmredata_endpoint_content_disposition_header`:
   - Same mock setup as above
   - Assert "Content-Disposition" in response.headers
   - Assert "attachment" in response.headers["Content-Disposition"]
   - Assert "nmredata.sdf" in response.headers["Content-Disposition"]

5. `test_nmredata_endpoint_media_type`:
   - Same mock setup
   - Assert response.headers["content-type"] == "chemical/x-mdl-sdfile"

6. `test_nmredata_endpoint_response_contains_assignment_tag`:
   - Same mock setup
   - Assert "NMREDATA_ASSIGNMENT" in response.text
   - Assert "NMREDATA_VERSION" in response.text

Create a helper fixture `mock_complete_job_with_nmr()` to reduce duplication.

Mock data pattern:
```python
from unittest import mock
from qm_nmr_calc.models import JobStatus, JobInput, NMRResults, ChemicalShift, CompletedStep
from datetime import datetime, timezone
import tempfile
from pathlib import Path

# Create mock job status
job_status = JobStatus(
    job_id="test-nmredata-123",
    status="complete",
    created_at=datetime.now(timezone.utc),
    input=JobInput(smiles="CCO", solvent="chcl3", preset="production"),
    conformer_mode="single",
    nmr_results=NMRResults(
        functional="b3lyp",
        basis_set="6-311G(2d,p)",
        solvent="chcl3",
        h1_shifts=[
            ChemicalShift(index=4, atom="H", shift=1.18),
            ChemicalShift(index=5, atom="H", shift=1.18),
            ChemicalShift(index=6, atom="H", shift=1.18),
            ChemicalShift(index=7, atom="H", shift=3.65),
            ChemicalShift(index=8, atom="H", shift=3.65),
            ChemicalShift(index=9, atom="H", shift=2.45),
        ],
        c13_shifts=[
            ChemicalShift(index=1, atom="C", shift=18.2),
            ChemicalShift(index=2, atom="C", shift=58.3),
        ],
    ),
    steps_completed=[],
)
```

XYZ content to write to temp file (ethanol):
```
9
ethanol optimized
C    0.0000    0.0000    0.0000
C    1.5000    0.0000    0.0000
O    2.0000    1.2000    0.0000
H   -0.3500   -0.5000   -0.9000
H   -0.3500   -0.5000    0.9000
H   -0.3500    1.0000    0.0000
H    1.8500   -0.5000   -0.9000
H    1.8500   -0.5000    0.9000
H    2.9000    1.2000    0.0000
```
  </action>
  <verify>pytest tests/test_api.py::TestNMReDataEndpoint -v shows all 6 tests passing</verify>
  <done>Six integration tests covering error cases (404, 409) and success cases (200, headers, content) all pass</done>
</task>

<task type="auto">
  <name>Task 3: Add ensemble mode edge case test</name>
  <files>tests/test_api.py</files>
  <action>
Add a test for ensemble mode to verify it includes Boltzmann metadata in output:

7. `test_nmredata_endpoint_ensemble_mode_includes_provenance`:
   - Mock complete job with conformer_mode="ensemble"
   - Add conformer_ensemble to mock with temperature_k=298.15 and conformers list
   - GET /api/v1/jobs/{job_id}/nmredata.sdf
   - Assert "Boltzmann-averaged" in response.text
   - Assert "conformers" in response.text

Mock ensemble data:
```python
from qm_nmr_calc.models import ConformerEnsemble, ConformerData

conformer_ensemble = ConformerEnsemble(
    method="rdkit_kdg",
    temperature_k=298.15,
    total_generated=20,
    conformers=[
        ConformerData(
            conformer_id="conf_001",
            status="nmr_complete",
            energy=-154.123,
            energy_unit="hartree",
            weight=0.65,
        ),
        ConformerData(
            conformer_id="conf_002",
            status="nmr_complete",
            energy=-154.120,
            energy_unit="hartree",
            weight=0.35,
        ),
    ],
)
```

Also add test for edge case with no geometry file:

8. `test_nmredata_endpoint_returns_404_when_no_geometry`:
   - Mock complete job but get_geometry_file returns None
   - Assert status_code == 404
   - Assert "Geometry" in response.json()["detail"]["title"]
  </action>
  <verify>pytest tests/test_api.py::TestNMReDataEndpoint -v shows all 8 tests passing</verify>
  <done>Eight integration tests in TestNMReDataEndpoint class, all passing</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_api.py -v` - All API tests pass
2. `pytest tests/test_nmredata.py -v` - All unit tests still pass (36 tests)
3. `pytest tests/ -v --tb=short` - Full test suite passes
4. Total test count increases from ~321 to ~329 tests
</verification>

<success_criteria>
- TestNMReDataEndpoint class exists in tests/test_api.py with 8 tests
- All tests pass: 404 for non-existent, 409 for incomplete, 200 for complete
- Response headers verified (Content-Disposition, media type)
- SDF content verified (contains NMREDATA tags)
- Ensemble mode provenance verified
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/34-testing-validation/34-01-SUMMARY.md`
</output>
