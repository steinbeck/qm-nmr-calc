---
phase: 53-conformer-progress-bug-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/tasks.py
autonomous: true

must_haves:
  truths:
    - "Conformer statuses in status.json update as each conformer completes (not only at job end)"
    - "Frontend status bar shows accurate conformer count during processing (e.g., '1/2' not '0/2')"
    - "Progress bar reflects actual conformer completion state"
  artifacts:
    - path: "src/qm_nmr_calc/tasks.py"
      provides: "Fixed on_progress callback that persists conformer ensemble to disk"
      contains: "update_job_status(job_id, conformer_ensemble=ensemble)"
  key_links:
    - from: "src/qm_nmr_calc/tasks.py:on_progress"
      to: "src/qm_nmr_calc/storage.py:update_job_status"
      via: "update_job_status(job_id, conformer_ensemble=ensemble) call in callback"
      pattern: "update_job_status\\(job_id, conformer_ensemble=ensemble\\)"
    - from: "status.json (conformer_ensemble field)"
      to: "src/qm_nmr_calc/api/templates/status.html:updateConformerProgress"
      via: "Frontend polling /api/v1/jobs/{job_id} reads persisted conformer statuses"
      pattern: "conformer_progress\\.filter"
---

<objective>
Fix conformer progress tracking so the status page displays accurate conformer counts during ensemble NMR processing.

Purpose: The status bar currently shows "0/2" throughout processing because the `on_progress()` callback in `tasks.py` updates the step label but never persists the mutated conformer ensemble to disk. The frontend polls `status.json` and never sees intermediate conformer status changes.

Output: One-line fix in `tasks.py` that adds `update_job_status(job_id, conformer_ensemble=ensemble)` to the `on_progress()` callback, matching the persistence pattern already used at lines 326 and 403 of the same function.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-conformer-progress-bug-fix/53-RESEARCH.md
@src/qm_nmr_calc/tasks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ensemble persistence to on_progress callback</name>
  <files>src/qm_nmr_calc/tasks.py</files>
  <action>
In `src/qm_nmr_calc/tasks.py`, find the `on_progress()` closure defined inside `run_ensemble_nmr_task()` at lines 329-331:

```python
def on_progress(step: str, current: int, total: int):
    """Update job status with progress during conformer processing."""
    start_step(job_id, step, f"{step.replace('_', ' ').title()} ({current}/{total})")
```

Add one line after the `start_step()` call to persist the mutated conformer ensemble to disk:

```python
def on_progress(step: str, current: int, total: int):
    """Update job status with progress during conformer processing."""
    start_step(job_id, step, f"{step.replace('_', ' ').title()} ({current}/{total})")
    update_job_status(job_id, conformer_ensemble=ensemble)
```

Why this works:
- The `ensemble` object is already mutated in-place by `run_conformer_dft_optimization()` before the callback fires (conformer.status changes from "pending" to "optimized" etc.)
- `update_job_status` is already imported at line 10 of this file
- The `ensemble` variable is accessible via closure (defined at line 304-322, callback defined at line 329)
- This matches the existing pattern at line 326 (after generation) and line 403 (at task completion)
- Single-threaded Huey worker means no concurrency concerns with two disk writes per callback

Do NOT:
- Modify the callback signature (do not add ensemble parameter)
- Modify runner.py or any other file
- Add any frontend changes (the JS already handles updated statuses correctly)
- Add any new imports (update_job_status is already imported)
  </action>
  <verify>
1. `grep -n "update_job_status(job_id, conformer_ensemble=ensemble)" src/qm_nmr_calc/tasks.py` shows the line appearing 3 times (line ~327, ~332, ~403)
2. `python -c "import ast; ast.parse(open('src/qm_nmr_calc/tasks.py').read()); print('Syntax OK')"` confirms no syntax errors
3. `cd /Users/steinbeck/Dropbox/develop/qm-nmr-calc && python -m pytest tests/ -x -q --timeout=30 -k "not nwchem and not integration"` passes (unit tests unaffected by this change)
  </verify>
  <done>
The `on_progress()` callback in `run_ensemble_nmr_task()` calls both `start_step()` and `update_job_status(job_id, conformer_ensemble=ensemble)`, ensuring conformer statuses are persisted to disk after each conformer completes. The frontend will now see updated conformer statuses when polling and display accurate counts like "1/2" instead of "0/2".
  </done>
</task>

</tasks>

<verification>
1. The `on_progress()` function body contains exactly 2 lines: `start_step(...)` and `update_job_status(job_id, conformer_ensemble=ensemble)`
2. No other files were modified (this is a one-line addition to one file)
3. Python syntax validation passes
4. Existing tests pass (the fix is additive - one extra disk write per conformer callback)
</verification>

<success_criteria>
- BUG-01 satisfied: Conformer progress tracking updates correctly during processing (conformer statuses persisted to disk via on_progress callback)
- BUG-02 satisfied: Status bar shows accurate count because frontend reads updated conformer_ensemble from status.json with correct per-conformer statuses
- No regressions: All existing tests pass, no files modified beyond tasks.py
</success_criteria>

<output>
After completion, create `.planning/phases/53-conformer-progress-bug-fix/53-01-SUMMARY.md`
</output>
