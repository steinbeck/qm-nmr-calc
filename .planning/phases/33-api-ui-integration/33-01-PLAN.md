---
phase: 33-api-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/api/routers/jobs.py
  - src/qm_nmr_calc/api/templates/results.html
autonomous: true

must_haves:
  truths:
    - "User can download NMReData file via GET /api/v1/jobs/{job_id}/nmredata.sdf"
    - "Response has Content-Type chemical/x-mdl-sdfile and Content-Disposition with filename"
    - "Endpoint returns 404 if job not found"
    - "Endpoint returns 409 if job not complete"
    - "Results page shows NMReData download button alongside existing downloads"
  artifacts:
    - path: "src/qm_nmr_calc/api/routers/jobs.py"
      provides: "NMReData download endpoint"
      contains: "nmredata.sdf"
    - path: "src/qm_nmr_calc/api/templates/results.html"
      provides: "NMReData download button"
      contains: "nmredata.sdf"
  key_links:
    - from: "src/qm_nmr_calc/api/routers/jobs.py"
      to: "src/qm_nmr_calc/nmredata.py"
      via: "import generate_nmredata_sdf"
      pattern: "from.*nmredata import generate_nmredata_sdf"
    - from: "jobs.py download endpoint"
      to: "job_status.nmr_results"
      via: "extract shifts for NMReData generation"
      pattern: "job_status.nmr_results.h1_shifts"
---

<objective>
Wire Phase 32's NMReData module into the API and web UI.

Purpose: Enable users to download NMReData SDF files containing their NMR prediction results in a machine-readable format for use with NMReData-compatible tools.

Output: Working download endpoint and UI button for NMReData export.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 32 output - NMReData generation module
@src/qm_nmr_calc/nmredata.py

# Existing patterns to follow exactly
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/api/templates/results.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NMReData download endpoint</name>
  <files>src/qm_nmr_calc/api/routers/jobs.py</files>
  <action>
Add `GET /{job_id}/nmredata.sdf` endpoint following the exact pattern of `download_geometry_sdf()` (lines 655-745).

Implementation:
1. Add import at top of file: `from ...nmredata import generate_nmredata_sdf`

2. Add new endpoint after `download_geometry_sdf` (around line 746):

```python
@router.get(
    "/{job_id}/nmredata.sdf",
    response_class=Response,
    responses={
        200: {"description": "NMReData file with predicted shifts (SDF)", "content": {"chemical/x-mdl-sdfile": {}}},
        404: {"model": ProblemDetail, "description": "Job not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_nmredata(job_id: str):
    """Download NMReData SDF file with predicted chemical shifts.

    Contains optimized 3D geometry plus NMReData tags with:
    - ASSIGNMENT: 1H and 13C chemical shifts with atom indices
    - SOLVENT, TEMPERATURE, VERSION metadata
    - Provenance (method, basis set, scaling factors)
    """
```

3. Error handling - copy exact pattern from `download_geometry_sdf`:
   - 404 if `load_job_status(job_id)` returns None
   - 409 if `job_status.status != "complete"`
   - Check `job_status.nmr_results` exists (return 404 if None)

4. Get geometry file using `get_geometry_file(job_id)` - return 404 if None

5. Read XYZ content from geometry file

6. Extract shift data from job_status.nmr_results:
```python
h1_shifts = [
    {"index": s.index, "atom": s.atom, "shift": s.shift}
    for s in job_status.nmr_results.h1_shifts
]
c13_shifts = [
    {"index": s.index, "atom": s.atom, "shift": s.shift}
    for s in job_status.nmr_results.c13_shifts
]
```

7. Determine ensemble metadata for provenance:
```python
is_ensemble = job_status.conformer_mode == "ensemble"
conformer_count = None
if is_ensemble and job_status.conformer_ensemble:
    conformer_count = len([c for c in job_status.conformer_ensemble.conformers if c.status == "nmr_complete"])
```

8. Get temperature (default 298.15 K, or from ensemble if available):
```python
temperature_k = 298.15
if is_ensemble and job_status.conformer_ensemble:
    temperature_k = job_status.conformer_ensemble.temperature_k
```

9. Call generate_nmredata_sdf:
```python
sdf_content = generate_nmredata_sdf(
    smiles=job_status.input.smiles,
    geometry_xyz=xyz_content,
    h1_shifts=h1_shifts,
    c13_shifts=c13_shifts,
    solvent=job_status.nmr_results.solvent,
    temperature_k=temperature_k,
    functional=job_status.nmr_results.functional.upper(),
    basis_set=job_status.nmr_results.basis_set,
    is_ensemble=is_ensemble,
    conformer_count=conformer_count,
)
```

10. Return Response with proper headers:
```python
return Response(
    content=sdf_content,
    media_type="chemical/x-mdl-sdfile",
    headers={"Content-Disposition": f'attachment; filename="{job_id}_nmredata.sdf"'},
)
```
  </action>
  <verify>
Run existing tests to ensure no regressions:
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/api/ -v --tb=short
```
  </verify>
  <done>
- Endpoint `GET /api/v1/jobs/{job_id}/nmredata.sdf` exists
- Returns 404 for unknown job_id
- Returns 409 for incomplete jobs
- Returns SDF with media type `chemical/x-mdl-sdfile`
- Response header includes `Content-Disposition: attachment; filename="{job_id}_nmredata.sdf"`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add NMReData download button to results page</name>
  <files>src/qm_nmr_calc/api/templates/results.html</files>
  <action>
Add NMReData download button to the Downloads card, following the exact pattern of existing buttons.

In results.html, find the download-grid div (around lines 236-255) and add ONE new button after the "Geometry (SDF)" button:

```html
<a href="/api/v1/jobs/{{ job.job_id }}/nmredata.sdf" class="download-btn" download>
    <span class="download-btn__label">NMReData (SDF)</span>
</a>
```

Place it as the third button, after "Geometry (SDF)" and before "Raw Output (ZIP)". This keeps related SDF downloads together.

The complete download-grid should now have 7 buttons:
1. Geometry (XYZ)
2. Geometry (SDF)
3. NMReData (SDF) <-- NEW
4. Raw Output (ZIP)
5. 1H Spectrum (PNG)
6. 13C Spectrum (PNG)
7. Structure (PNG)
  </action>
  <verify>
Verify HTML is valid and button follows existing pattern:
```bash
grep -A2 "nmredata.sdf" /home/chris/develop/qm-nmr-calc/src/qm_nmr_calc/api/templates/results.html
```
  </verify>
  <done>
- Results page has NMReData download button
- Button follows existing glassmorphism design (uses `download-btn` class)
- Button href points to `/api/v1/jobs/{{ job.job_id }}/nmredata.sdf`
- Button has `download` attribute for proper download behavior
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Start dev server and test with a completed job:
```bash
cd /home/chris/develop/qm-nmr-calc
# Find a complete job ID from jobs/ directory
JOB_ID=$(ls jobs/ | head -1)
curl -I "http://localhost:8000/api/v1/jobs/${JOB_ID}/nmredata.sdf"
```

Expected:
- HTTP 200
- Content-Type: chemical/x-mdl-sdfile
- Content-Disposition: attachment; filename="{job_id}_nmredata.sdf"

2. Verify error responses:
```bash
# 404 for unknown job
curl -s "http://localhost:8000/api/v1/jobs/nonexistent/nmredata.sdf" | grep -o '"status": 404'

# 409 for incomplete job (if one exists)
```

3. Download and validate content contains NMReData tags:
```bash
curl -s "http://localhost:8000/api/v1/jobs/${JOB_ID}/nmredata.sdf" | grep -E "NMREDATA_(VERSION|ASSIGNMENT|SOLVENT)"
```
</verification>

<success_criteria>
1. GET /api/v1/jobs/{job_id}/nmredata.sdf returns SDF with predicted shifts (API-01)
2. Response has media type chemical/x-mdl-sdfile and proper filename header (API-02)
3. Endpoint returns 404 for unknown jobs, 409 for incomplete jobs (API-03)
4. Results page includes NMReData download button matching existing design (UI-01)
5. All existing API tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/33-api-ui-integration/33-01-SUMMARY.md`
</output>
