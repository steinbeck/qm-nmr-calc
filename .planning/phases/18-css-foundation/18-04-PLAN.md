---
phase: 18-css-foundation
plan: 04
type: execute
wave: 2
depends_on: ["18-01", "18-02", "18-03"]
files_modified:
  - src/qm_nmr_calc/api/templates/base.html
  - src/qm_nmr_calc/api/static/css/custom.css
autonomous: false

must_haves:
  truths:
    - "Pico CSS is completely removed from base template"
    - "Custom CSS files load in correct order (layers.css first)"
    - "All pages render correctly with new CSS (no visual regressions)"
  artifacts:
    - path: "src/qm_nmr_calc/api/templates/base.html"
      provides: "Updated base template with custom CSS loading"
      contains: "layers.css"
  key_links:
    - from: "base.html"
      to: "layers.css"
      via: "first stylesheet link"
      pattern: "layers.css.*reset.css.*tokens.css"
---

<objective>
Integrate custom CSS into base template and remove Pico CSS.

Purpose: Complete the CSS migration by updating base.html to load the new CSS architecture and fully removing Pico CSS dependency. This enables the glassmorphism design system for all pages.

Output: Updated base.html with custom CSS, verified working on all existing pages.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-css-foundation/18-RESEARCH.md
@src/qm_nmr_calc/api/templates/base.html
@src/qm_nmr_calc/api/static/css/custom.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update base.html stylesheet loading</name>
  <files>
    src/qm_nmr_calc/api/templates/base.html
  </files>
  <action>
Update base.html to load the new CSS architecture in correct order:

1. REMOVE the Pico CSS CDN link completely:
   `<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.blue.min.css">`

2. ADD the new CSS files in this exact order (layers.css MUST be first):
```html
<!-- CSS Architecture: Layers must load first -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/layers.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/reset.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/layout.css') }}">
<!-- Components -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/components/glass-card.css') }}">
<!-- Utilities (highest priority) -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/utilities.css') }}">
```

3. KEEP the custom.css link (rename to legacy.css for transition period):
   `<link rel="stylesheet" href="{{ url_for('static', path='/css/legacy.css') }}">`
   This preserves existing page-specific styles until they're migrated in later phases.

4. REMOVE data-theme="light" from html tag (we control theme via custom CSS now)

5. UPDATE the header and footer structure:
   - Keep semantic structure but remove Pico-specific classes if any
   - Add .container class to main sections (header, main, footer)
  </action>
  <verify>
base.html no longer contains "picocss". base.html contains layers.css as first stylesheet.
  </verify>
  <done>
base.html loads custom CSS architecture in correct order, Pico CSS removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate custom.css to legacy.css and clean up</name>
  <files>
    src/qm_nmr_calc/api/static/css/legacy.css
    src/qm_nmr_calc/api/static/css/custom.css
  </files>
  <action>
1. RENAME custom.css to legacy.css:
   - Copy content to legacy.css
   - Delete custom.css

2. WRAP legacy.css content in @layer components to integrate with cascade:
   ```css
   /* Legacy styles from pre-v2.1 -- migrate to new components in Phases 19-21 */
   @layer components {
       /* existing custom.css content here */
   }
   ```

3. UPDATE legacy.css to use new design tokens where possible:
   - Replace hardcoded colors with var(--color-*)
   - Replace hardcoded spacing with var(--space-*)
   - Remove any var(--pico-*) references (Pico CSS variables no longer exist)

4. REMOVE references to Pico CSS variables from legacy.css:
   - var(--pico-muted-color) -> var(--color-text-muted)
   - var(--pico-muted-border-color) -> var(--color-border)
   - var(--pico-card-background-color) -> var(--glass-bg-subtle) or hsl(0 0% 100%)
   - var(--pico-primary) -> var(--color-primary)
   - var(--pico-primary-background) -> var(--color-primary-light)
   - var(--pico-secondary-background) -> var(--color-gray-100)
   - var(--pico-secondary-hover-background) -> var(--color-gray-200)

This preserves existing functionality while preparing for component-by-component migration.
  </action>
  <verify>
legacy.css exists. custom.css does not exist. legacy.css wrapped in @layer components. No var(--pico-*) references remain.
  </verify>
  <done>
Legacy styles preserved in legacy.css, integrated with cascade layers, Pico variables replaced with design tokens.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CSS architecture migration:
1. Removed Pico CSS CDN from base.html
2. Added custom CSS files in correct load order (layers first)
3. Migrated custom.css to legacy.css with layer integration
4. Replaced Pico CSS variables with design tokens
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd /home/chris/develop/qm-nmr-calc && hatch run dev` (or existing process)

2. Visit the following pages and verify they render correctly:
   - http://localhost:8000/ (index page)
   - http://localhost:8000/submit (job submission form)
   - http://localhost:8000/status/{job_id} (status page - need existing job)
   - http://localhost:8000/results/{job_id} (results page - need completed job)

3. Check for visual issues:
   - Text is readable (correct fonts, colors)
   - Forms are functional (inputs visible, styled)
   - Layout is reasonable (no broken layouts)
   - No console errors related to CSS

4. Verify in browser DevTools:
   - Network tab shows all CSS files loading (200 status)
   - No 404s for CSS files
   - No Pico CSS in network requests

Note: Pages will NOT look "designed" yet - the glassmorphism design comes in Phases 19-21. This check confirms the CSS architecture is working and nothing is broken.
  </how-to-verify>
  <resume-signal>Type "approved" if pages render correctly, or describe any visual issues.</resume-signal>
</task>

</tasks>

<verification>
1. Pico CSS removed: `grep -c "picocss" src/qm_nmr_calc/api/templates/base.html` returns 0
2. Correct load order: `grep -A 10 "layers.css" src/qm_nmr_calc/api/templates/base.html` shows layers first
3. Legacy file exists: `ls src/qm_nmr_calc/api/static/css/legacy.css`
4. Custom.css removed: `ls src/qm_nmr_calc/api/static/css/custom.css` should fail (file not found)
5. No Pico variables: `grep -c "var(--pico" src/qm_nmr_calc/api/static/css/legacy.css` returns 0
6. Layer wrapper: `grep "@layer components" src/qm_nmr_calc/api/static/css/legacy.css`
</verification>

<success_criteria>
- CSS-01: Pico CSS replaced with custom CSS framework
- CSS-04: Multi-file CSS organization (no build step)
- CSS-05: Base template updated with new stylesheet loading
- All existing pages render correctly (no visual regressions)
- CSS files load in correct order (layers.css first)
</success_criteria>

<output>
After completion, create `.planning/phases/18-css-foundation/18-04-SUMMARY.md`
</output>
