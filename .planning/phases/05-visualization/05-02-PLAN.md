---
phase: 05-visualization
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/qm_nmr_calc/tasks.py
  - src/qm_nmr_calc/storage.py
  - src/qm_nmr_calc/api/routers/jobs.py
autonomous: true

must_haves:
  truths:
    - "Completed job includes spectrum_1H.png and spectrum_13C.png files"
    - "Completed job includes structure_annotated.png file"
    - "User can download spectrum images via GET /api/v1/jobs/{job_id}/spectrum/1h.png"
    - "User can download annotated structure via GET /api/v1/jobs/{job_id}/structure.png"
  artifacts:
    - path: "src/qm_nmr_calc/tasks.py"
      provides: "Visualization generation after NMR calculation"
      contains: "generate_spectrum_plot"
    - path: "src/qm_nmr_calc/storage.py"
      provides: "Helper functions for visualization file paths"
      exports: ["get_visualization_file"]
    - path: "src/qm_nmr_calc/api/routers/jobs.py"
      provides: "Download endpoints for spectrum and structure images"
      contains: "spectrum"
  key_links:
    - from: "src/qm_nmr_calc/tasks.py"
      to: "src/qm_nmr_calc/visualization.py"
      via: "import and call after NMR results"
      pattern: "from \\.visualization import"
    - from: "src/qm_nmr_calc/api/routers/jobs.py"
      to: "src/qm_nmr_calc/storage.py"
      via: "get_visualization_file for paths"
      pattern: "get_visualization_file"
---

<objective>
Integrate visualization generation into the task pipeline and add API endpoints for downloading the generated images.

Purpose: Complete the visualization feature by generating images when jobs complete and exposing them via the API.

Output:
- tasks.py calls visualization functions after NMR calculation
- storage.py has helper for visualization file paths
- jobs.py has download endpoints for all 6 visualization files (3 images x 2 formats)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-visualization/05-CONTEXT.md
@.planning/phases/05-visualization/05-RESEARCH.md
@.planning/phases/05-visualization/05-01-SUMMARY.md

# Source files to modify
@src/qm_nmr_calc/tasks.py
@src/qm_nmr_calc/storage.py
@src/qm_nmr_calc/api/routers/jobs.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add storage helper for visualization files</name>
  <files>src/qm_nmr_calc/storage.py</files>
  <action>
Add a helper function to storage.py for getting visualization file paths:

```python
def get_visualization_file(job_id: str, filename: str) -> Optional[Path]:
    """Get path to a visualization file if it exists.

    Args:
        job_id: Job identifier
        filename: One of: spectrum_1H.svg, spectrum_1H.png, spectrum_13C.svg,
                  spectrum_13C.png, structure_annotated.svg, structure_annotated.png

    Returns:
        Path to file if exists, None otherwise
    """
    viz_file = get_job_dir(job_id) / "output" / filename
    return viz_file if viz_file.exists() else None
```

This follows the pattern of `get_geometry_file()` already in the module.
  </action>
  <verify>
Run: `uv run python -c "from qm_nmr_calc.storage import get_visualization_file; print('Function imported successfully')"`
  </verify>
  <done>get_visualization_file() function exists and is importable</done>
</task>

<task type="auto">
  <name>Task 2: Integrate visualization into tasks.py</name>
  <files>src/qm_nmr_calc/tasks.py</files>
  <action>
Modify `run_nmr_task()` in tasks.py to generate visualizations after NMR results are computed.

Add import at top of file:
```python
from .visualization import generate_spectrum_plot, generate_annotated_structure
```

After the line that saves `nmr_results.json` (around line 140), add visualization generation:

```python
# Generate visualizations
# output_dir already defined as job_dir / 'output'

# 1H spectrum
generate_spectrum_plot(
    shifts=[s.shift for s in h1_shifts],
    nucleus="1H",
    output_dir=output_dir,
)

# 13C spectrum
generate_spectrum_plot(
    shifts=[s.shift for s in c13_shifts],
    nucleus="13C",
    output_dir=output_dir,
)

# Annotated structure (both 1H and 13C on one image)
generate_annotated_structure(
    smiles=smiles,
    h1_shifts=[{"index": s.index, "shift": s.shift} for s in h1_shifts],
    c13_shifts=[{"index": s.index, "shift": s.shift} for s in c13_shifts],
    output_dir=output_dir,
)
```

Place this BEFORE the `update_job_status()` call so visualizations are ready when status is "complete".
  </action>
  <verify>
The task runs in the Huey worker, so direct verification requires a running consumer.
For quick verification, check the import works:
```bash
uv run python -c "from qm_nmr_calc.tasks import run_nmr_task; print('Import successful')"
```
  </verify>
  <done>tasks.py imports visualization module and calls generation functions after NMR calculation</done>
</task>

<task type="auto">
  <name>Task 3: Add API endpoints for visualization downloads</name>
  <files>src/qm_nmr_calc/api/routers/jobs.py</files>
  <action>
Add download endpoints for visualization files to jobs.py. Follow the existing pattern from `download_geometry()`.

Add import at top:
```python
from ...storage import create_job_directory, get_geometry_file, get_output_files, get_visualization_file, load_job_status
```

Add 6 new endpoints (3 images x 2 formats). Use a helper function to reduce duplication:

```python
async def _get_visualization(job_id: str, filename: str, media_type: str, download_name: str):
    """Common logic for visualization download endpoints."""
    job_status = load_job_status(job_id)
    if job_status is None:
        raise HTTPException(
            status_code=404,
            detail={
                "type": "https://qm-nmr-calc.example/problems/job-not-found",
                "title": "Job Not Found",
                "status": 404,
                "detail": f"No job exists with ID '{job_id}'",
            },
        )

    if job_status.status != "complete":
        raise HTTPException(
            status_code=409,
            detail={
                "type": "https://qm-nmr-calc.example/problems/job-not-complete",
                "title": "Job Not Complete",
                "status": 409,
                "detail": f"Job '{job_id}' is in '{job_status.status}' state. Visualizations available when complete.",
            },
        )

    viz_file = get_visualization_file(job_id, filename)
    if viz_file is None:
        raise HTTPException(
            status_code=404,
            detail={
                "type": "https://qm-nmr-calc.example/problems/visualization-not-found",
                "title": "Visualization Not Found",
                "status": 404,
                "detail": f"Visualization file '{filename}' not found for job '{job_id}'.",
            },
        )

    return FileResponse(
        path=viz_file,
        media_type=media_type,
        filename=download_name,
    )
```

Then add the 6 endpoints:

```python
@router.get(
    "/{job_id}/spectrum/1h.png",
    response_class=FileResponse,
    responses={
        200: {"description": "1H NMR spectrum plot (PNG)", "content": {"image/png": {}}},
        404: {"model": ProblemDetail, "description": "Job or file not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_h1_spectrum_png(job_id: str):
    """Download 1H NMR spectrum plot as PNG (300 DPI)."""
    return await _get_visualization(job_id, "spectrum_1H.png", "image/png", f"{job_id}_1H_spectrum.png")


@router.get(
    "/{job_id}/spectrum/1h.svg",
    response_class=FileResponse,
    responses={
        200: {"description": "1H NMR spectrum plot (SVG)", "content": {"image/svg+xml": {}}},
        404: {"model": ProblemDetail, "description": "Job or file not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_h1_spectrum_svg(job_id: str):
    """Download 1H NMR spectrum plot as SVG."""
    return await _get_visualization(job_id, "spectrum_1H.svg", "image/svg+xml", f"{job_id}_1H_spectrum.svg")


@router.get(
    "/{job_id}/spectrum/13c.png",
    response_class=FileResponse,
    responses={
        200: {"description": "13C NMR spectrum plot (PNG)", "content": {"image/png": {}}},
        404: {"model": ProblemDetail, "description": "Job or file not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_c13_spectrum_png(job_id: str):
    """Download 13C NMR spectrum plot as PNG (300 DPI)."""
    return await _get_visualization(job_id, "spectrum_13C.png", "image/png", f"{job_id}_13C_spectrum.png")


@router.get(
    "/{job_id}/spectrum/13c.svg",
    response_class=FileResponse,
    responses={
        200: {"description": "13C NMR spectrum plot (SVG)", "content": {"image/svg+xml": {}}},
        404: {"model": ProblemDetail, "description": "Job or file not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_c13_spectrum_svg(job_id: str):
    """Download 13C NMR spectrum plot as SVG."""
    return await _get_visualization(job_id, "spectrum_13C.svg", "image/svg+xml", f"{job_id}_13C_spectrum.svg")


@router.get(
    "/{job_id}/structure.png",
    response_class=FileResponse,
    responses={
        200: {"description": "Annotated structure image (PNG)", "content": {"image/png": {}}},
        404: {"model": ProblemDetail, "description": "Job or file not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_structure_png(job_id: str):
    """Download annotated molecular structure as PNG (300 DPI equivalent)."""
    return await _get_visualization(job_id, "structure_annotated.png", "image/png", f"{job_id}_structure.png")


@router.get(
    "/{job_id}/structure.svg",
    response_class=FileResponse,
    responses={
        200: {"description": "Annotated structure image (SVG)", "content": {"image/svg+xml": {}}},
        404: {"model": ProblemDetail, "description": "Job or file not found"},
        409: {"model": ProblemDetail, "description": "Job not complete"},
    },
)
async def download_structure_svg(job_id: str):
    """Download annotated molecular structure as SVG."""
    return await _get_visualization(job_id, "structure_annotated.svg", "image/svg+xml", f"{job_id}_structure.svg")
```
  </action>
  <verify>
Run the API tests to ensure new endpoints are recognized:
```bash
uv run python -c "
from fastapi.testclient import TestClient
from qm_nmr_calc.api.app import create_app

client = TestClient(create_app())

# Check that endpoints exist in OpenAPI spec
response = client.get('/api/v1/openapi.json')
spec = response.json()
paths = list(spec['paths'].keys())

# Look for visualization endpoints
viz_endpoints = [p for p in paths if 'spectrum' in p or 'structure' in p]
print('Visualization endpoints found:')
for ep in viz_endpoints:
    print(f'  {ep}')

assert '/api/v1/jobs/{job_id}/spectrum/1h.png' in paths, 'Missing 1H PNG endpoint'
assert '/api/v1/jobs/{job_id}/structure.png' in paths, 'Missing structure PNG endpoint'
print('All expected endpoints present!')
"
```
  </verify>
  <done>
- 6 new endpoints exist: spectrum/1h.png, spectrum/1h.svg, spectrum/13c.png, spectrum/13c.svg, structure.png, structure.svg
- Endpoints follow existing pattern with proper error handling (404, 409)
- OpenAPI spec includes new endpoints
  </done>
</task>

</tasks>

<verification>
Full integration verification:

1. Quick syntax/import check:
```bash
uv run python -c "
from qm_nmr_calc.storage import get_visualization_file
from qm_nmr_calc.tasks import run_nmr_task
from qm_nmr_calc.api.routers.jobs import download_h1_spectrum_png
print('All imports successful!')
"
```

2. API endpoint check:
```bash
uv run python -c "
from fastapi.testclient import TestClient
from qm_nmr_calc.api.app import create_app

client = TestClient(create_app())

# Test 404 for non-existent job
response = client.get('/api/v1/jobs/nonexistent/spectrum/1h.png')
assert response.status_code == 404, f'Expected 404, got {response.status_code}'
print('404 handling works!')

# Test endpoint appears in OpenAPI
response = client.get('/api/v1/openapi.json')
paths = response.json()['paths']
expected = [
    '/api/v1/jobs/{job_id}/spectrum/1h.png',
    '/api/v1/jobs/{job_id}/spectrum/13c.png',
    '/api/v1/jobs/{job_id}/structure.png',
]
for ep in expected:
    assert ep in paths, f'Missing endpoint: {ep}'
print('All visualization endpoints registered!')
"
```

Note: Full end-to-end test (submit job, wait for completion, download visualization) requires running the Huey consumer and is beyond quick verification scope.
</verification>

<success_criteria>
- [ ] storage.py has get_visualization_file() function
- [ ] tasks.py imports and calls visualization functions
- [ ] jobs.py has 6 new visualization download endpoints
- [ ] All imports work without errors
- [ ] OpenAPI spec includes new endpoints
- [ ] Endpoints return 404 for non-existent jobs
</success_criteria>

<output>
After completion, create `.planning/phases/05-visualization/05-02-SUMMARY.md`
</output>
