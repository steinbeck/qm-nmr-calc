---
phase: 05-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/qm_nmr_calc/visualization.py
autonomous: true

must_haves:
  truths:
    - "generate_spectrum_plot() produces valid SVG and PNG files"
    - "generate_annotated_structure() produces valid SVG and PNG files"
    - "Spectrum plots have inverted x-axis (high ppm on left)"
    - "Structure annotations show shift values at correct atoms"
  artifacts:
    - path: "src/qm_nmr_calc/visualization.py"
      provides: "Spectrum and structure visualization functions"
      min_lines: 80
      exports: ["generate_spectrum_plot", "generate_annotated_structure"]
    - path: "pyproject.toml"
      provides: "matplotlib dependency"
      contains: "matplotlib"
  key_links:
    - from: "src/qm_nmr_calc/visualization.py"
      to: "matplotlib.pyplot"
      via: "stem() for stick plots"
      pattern: "plt\\.stem"
    - from: "src/qm_nmr_calc/visualization.py"
      to: "rdkit.Chem.Draw.rdMolDraw2D"
      via: "atomNote for annotations"
      pattern: "SetProp.*atomNote"
---

<objective>
Create the visualization module with functions for generating NMR spectrum plots and annotated molecular structure images.

Purpose: Provide reusable visualization functions that tasks.py can call after NMR calculation completes.

Output:
- `src/qm_nmr_calc/visualization.py` with `generate_spectrum_plot()` and `generate_annotated_structure()`
- matplotlib added to dependencies
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-visualization/05-CONTEXT.md
@.planning/phases/05-visualization/05-RESEARCH.md

# Source files to reference
@src/qm_nmr_calc/models.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add matplotlib dependency</name>
  <files>pyproject.toml</files>
  <action>
Add matplotlib to the dependencies list in pyproject.toml:
- Add "matplotlib>=3.10.0" to the dependencies array

Run `uv sync` to install the new dependency.
  </action>
  <verify>Run `uv run python -c "import matplotlib; print(matplotlib.__version__)"` - should print version 3.10+</verify>
  <done>matplotlib is installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create visualization module</name>
  <files>src/qm_nmr_calc/visualization.py</files>
  <action>
Create `src/qm_nmr_calc/visualization.py` with two main functions.

**CRITICAL**: Set matplotlib backend BEFORE importing pyplot:
```python
import matplotlib
matplotlib.use('Agg')  # Non-interactive backend - MUST be before pyplot import
import matplotlib.pyplot as plt
```

**Function 1: `generate_spectrum_plot()`**

```python
def generate_spectrum_plot(
    shifts: list[float],
    nucleus: str,  # "1H" or "13C"
    output_dir: Path,
) -> tuple[Path, Path]:
    """Generate stick spectrum plot in SVG and PNG formats.

    Args:
        shifts: List of chemical shift values in ppm
        nucleus: "1H" or "13C" for labeling
        output_dir: Directory to write output files

    Returns:
        Tuple of (svg_path, png_path)
    """
```

Implementation details:
- Use `plt.stem()` with `linefmt='k-'`, `markerfmt=' '`, `basefmt=' '` for clean stick plot
- Call `ax.invert_xaxis()` for NMR convention (high ppm on left)
- Set x-label to "ppm", no y-axis ticks (intensity is relative)
- Add nucleus label ("1H" or "13C") in top-left corner via `ax.text(0.02, 0.95, nucleus, ...)`
- Auto-fit x-axis with padding: min 0.5 ppm or 10% of range
- Save as SVG and PNG (300 DPI)
- **CRITICAL**: Call `plt.close(fig)` after saving to prevent memory leaks
- File names: `spectrum_1H.svg`, `spectrum_1H.png` (or 13C)

**Function 2: `generate_annotated_structure()`**

```python
def generate_annotated_structure(
    smiles: str,
    h1_shifts: list[dict],  # [{"index": 1, "shift": 7.26}, ...]
    c13_shifts: list[dict],
    output_dir: Path,
) -> tuple[Path, Path]:
    """Generate structure with chemical shift annotations.

    Args:
        smiles: SMILES string for the molecule
        h1_shifts: List of {"index": int, "shift": float} for 1H
        c13_shifts: List of {"index": int, "shift": float} for 13C
        output_dir: Directory to write output files

    Returns:
        Tuple of (svg_path, png_path)
    """
```

Implementation details:
- Create mol from SMILES with `Chem.MolFromSmiles(smiles)` then `Chem.AddHs(mol)`
- **CRITICAL**: Convert NWChem 1-based indices to RDKit 0-based: `rdkit_idx = nwchem_idx - 1`
- Set atomNote BEFORE calling PrepareMolForDrawing:
  ```python
  for shift_data in h1_shifts + c13_shifts:
      rdkit_idx = shift_data['index'] - 1
      atom = mol.GetAtomWithIdx(rdkit_idx)
      atom.SetProp('atomNote', f"{shift_data['shift']:.2f}")
  rdMolDraw2D.PrepareMolForDrawing(mol)
  ```
- Generate SVG using `MolDraw2DSVG(800, 600)` with `annotationFontScale = 0.6`
- Generate PNG using `MolDraw2DCairo(2400, 1800)` for 300 DPI equivalent
- File names: `structure_annotated.svg`, `structure_annotated.png`

Import requirements:
```python
from pathlib import Path
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from rdkit import Chem
from rdkit.Chem.Draw import rdMolDraw2D
```
  </action>
  <verify>
Create a test script and run it:
```python
# test_viz.py
from pathlib import Path
import tempfile
from qm_nmr_calc.visualization import generate_spectrum_plot, generate_annotated_structure

with tempfile.TemporaryDirectory() as tmpdir:
    output_dir = Path(tmpdir)

    # Test spectrum plot
    svg, png = generate_spectrum_plot([7.26, 5.12, 3.89], "1H", output_dir)
    assert svg.exists() and png.exists()
    print(f"Spectrum: {svg.stat().st_size} bytes SVG, {png.stat().st_size} bytes PNG")

    # Test structure annotation
    svg, png = generate_annotated_structure(
        "CCO",
        [{"index": 7, "shift": 1.18}, {"index": 8, "shift": 1.18}, {"index": 9, "shift": 1.18},
         {"index": 4, "shift": 3.68}, {"index": 5, "shift": 3.68}],
        [{"index": 1, "shift": 18.2}, {"index": 2, "shift": 57.8}],
        output_dir
    )
    assert svg.exists() and png.exists()
    print(f"Structure: {svg.stat().st_size} bytes SVG, {png.stat().st_size} bytes PNG")
    print("All tests passed!")
```
Run: `uv run python test_viz.py`
  </verify>
  <done>
- generate_spectrum_plot() creates valid SVG and PNG spectrum images
- generate_annotated_structure() creates valid SVG and PNG structure images with shift labels
- Both functions properly clean up matplotlib figures
  </done>
</task>

</tasks>

<verification>
Run quick verification:
```bash
uv run python -c "
from pathlib import Path
import tempfile
from qm_nmr_calc.visualization import generate_spectrum_plot, generate_annotated_structure

with tempfile.TemporaryDirectory() as tmpdir:
    output_dir = Path(tmpdir)

    # Quick smoke test
    svg, png = generate_spectrum_plot([7.26, 1.23], '1H', output_dir)
    assert svg.exists(), 'SVG not created'
    assert png.exists(), 'PNG not created'

    svg2, png2 = generate_annotated_structure(
        'CC',
        [{'index': 3, 'shift': 0.86}, {'index': 4, 'shift': 0.86}],
        [{'index': 1, 'shift': 5.7}],
        output_dir
    )
    assert svg2.exists() and png2.exists(), 'Structure images not created'

print('Visualization module working!')
"
```
</verification>

<success_criteria>
- [ ] matplotlib is in pyproject.toml dependencies
- [ ] `uv run python -c "import matplotlib"` succeeds
- [ ] visualization.py exists with generate_spectrum_plot and generate_annotated_structure
- [ ] Test script creates valid SVG and PNG files for both spectrum and structure
- [ ] Spectrum plots have inverted x-axis (check SVG for axis ordering)
</success_criteria>

<output>
After completion, create `.planning/phases/05-visualization/05-01-SUMMARY.md`
</output>
