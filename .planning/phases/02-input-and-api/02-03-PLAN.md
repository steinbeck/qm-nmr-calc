---
phase: 02-input-and-api
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/qm_nmr_calc/api/app.py
  - src/qm_nmr_calc/__init__.py
  - scripts/run_api.py
  - tests/test_api.py
autonomous: true

must_haves:
  truths:
    - "FastAPI app serves OpenAPI docs at /docs"
    - "POST /api/v1/jobs with valid SMILES returns 202 and job ID"
    - "POST /api/v1/jobs with invalid SMILES returns 422 with error detail"
    - "GET /api/v1/jobs/{job_id} returns status for existing job"
    - "GET /api/v1/jobs/{job_id} returns 404 for non-existent job"
    - "API can be started with uvicorn and responds to requests"
  artifacts:
    - path: "src/qm_nmr_calc/api/app.py"
      provides: "Assembled FastAPI application"
      exports: ["app"]
    - path: "scripts/run_api.py"
      provides: "API server startup script"
    - path: "tests/test_api.py"
      provides: "API integration tests"
  key_links:
    - from: "src/qm_nmr_calc/api/app.py"
      to: "src/qm_nmr_calc/api/routers/jobs.py"
      via: "app.include_router"
      pattern: "include_router.*jobs"
    - from: "src/qm_nmr_calc/api/app.py"
      to: "src/qm_nmr_calc/api/routers/health.py"
      via: "app.include_router"
      pattern: "include_router.*health"
    - from: "tests/test_api.py"
      to: "src/qm_nmr_calc/api/app.py"
      via: "TestClient"
      pattern: "TestClient.*app"
---

<objective>
Assemble the FastAPI application, create startup script, and write integration tests.

Purpose: Wire together all the components (routers, validation, storage, queue) into a working API application. Verify the complete flow with tests.

Output:
- app.py with configured FastAPI instance and mounted routers
- run_api.py startup script for development
- test_api.py with integration tests for all endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-input-and-api/02-CONTEXT.md
@.planning/phases/02-input-and-api/02-RESEARCH.md

# Prior plan outputs
@.planning/phases/02-input-and-api/02-01-SUMMARY.md
@.planning/phases/02-input-and-api/02-02-SUMMARY.md

# Code to assemble
@src/qm_nmr_calc/api/routers/jobs.py
@src/qm_nmr_calc/api/routers/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI application</name>
  <files>src/qm_nmr_calc/api/app.py, src/qm_nmr_calc/__init__.py</files>
  <action>
Create the main FastAPI application:

**src/qm_nmr_calc/api/app.py:**
```python
"""FastAPI application for QM NMR Calculator API."""

from fastapi import FastAPI
from .routers import jobs, health

app = FastAPI(
    title="QM NMR Calculator API",
    description="Asynchronous NMR quantum mechanical calculations via ISiCLE/NWChem",
    version="0.1.0",
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_url="/api/v1/openapi.json",
)

# Health endpoints at root (no version prefix)
app.include_router(health.router)

# API v1 endpoints
app.include_router(jobs.router, prefix="/api/v1")
```

**Update src/qm_nmr_calc/__init__.py:**
Add export for the app:
```python
from .api.app import app
```

Ensure the app:
- Has proper OpenAPI metadata
- Mounts health router at / (no prefix)
- Mounts jobs router at /api/v1
- Serves Swagger UI at /docs
- Serves ReDoc at /redoc
- Serves OpenAPI JSON at /api/v1/openapi.json
  </action>
  <verify>
```bash
uv run python -c "
from qm_nmr_calc.api.app import app
from fastapi import FastAPI
assert isinstance(app, FastAPI)
assert app.title == 'QM NMR Calculator API'
print('App OK')
"
```
  </verify>
  <done>FastAPI app configured with all routers mounted</done>
</task>

<task type="auto">
  <name>Task 2: Create API startup script</name>
  <files>scripts/run_api.py</files>
  <action>
Create a development startup script:

**scripts/run_api.py:**
```python
#!/usr/bin/env python
"""Run the QM NMR Calculator API server."""
import sys
from pathlib import Path

# Add src to path for development
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

import uvicorn

def main():
    """Run the API server with auto-reload for development."""
    uvicorn.run(
        "qm_nmr_calc.api.app:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        reload_dirs=["src"],
    )

if __name__ == "__main__":
    main()
```

Make the script executable and verify it can start:
```bash
chmod +x scripts/run_api.py
```

Note: Don't actually run the server continuously - just verify it can import and would start.
  </action>
  <verify>
```bash
uv run python -c "
import sys
sys.path.insert(0, 'src')
# Verify the module path works
from qm_nmr_calc.api.app import app
print('Startup script module path OK')
"
```
  </verify>
  <done>run_api.py script ready for development server startup</done>
</task>

<task type="auto">
  <name>Task 3: Create API integration tests</name>
  <files>tests/test_api.py</files>
  <action>
Create integration tests using FastAPI TestClient:

**tests/test_api.py:**
```python
"""Integration tests for the QM NMR Calculator API."""
import pytest
from fastapi.testclient import TestClient

from qm_nmr_calc.api.app import app

client = TestClient(app)


class TestHealth:
    """Health endpoint tests."""

    def test_liveness(self):
        """GET /health returns alive status."""
        response = client.get("/health")
        assert response.status_code == 200
        assert response.json()["status"] == "alive"

    def test_readiness(self):
        """GET /health/ready checks dependencies."""
        response = client.get("/health/ready")
        # May be 200 or 503 depending on environment
        assert response.status_code in [200, 503]
        assert "status" in response.json()


class TestJobSubmission:
    """Job submission endpoint tests."""

    def test_submit_valid_smiles(self):
        """POST /api/v1/jobs with valid SMILES returns 202."""
        response = client.post(
            "/api/v1/jobs",
            json={"smiles": "CCO", "name": "Ethanol"}
        )
        assert response.status_code == 202
        data = response.json()
        assert "job_id" in data
        assert data["status"] == "queued"
        assert data["input_smiles"] == "CCO"
        assert data["input_name"] == "Ethanol"
        # Check headers
        assert "Location" in response.headers
        assert "Retry-After" in response.headers

    def test_submit_invalid_smiles(self):
        """POST /api/v1/jobs with invalid SMILES returns 422."""
        response = client.post(
            "/api/v1/jobs",
            json={"smiles": "not-a-valid-smiles-string"}
        )
        assert response.status_code == 422
        data = response.json()["detail"]
        assert data["status"] == 422
        assert "title" in data  # RFC 7807

    def test_submit_smiles_without_name(self):
        """POST /api/v1/jobs works without optional name."""
        response = client.post(
            "/api/v1/jobs",
            json={"smiles": "c1ccccc1"}
        )
        assert response.status_code == 202
        data = response.json()
        assert data["input_name"] is None


class TestJobStatus:
    """Job status endpoint tests."""

    def test_get_existing_job(self):
        """GET /api/v1/jobs/{id} returns status for existing job."""
        # First create a job
        create_response = client.post(
            "/api/v1/jobs",
            json={"smiles": "CCO"}
        )
        job_id = create_response.json()["job_id"]

        # Then get its status
        response = client.get(f"/api/v1/jobs/{job_id}")
        assert response.status_code == 200
        data = response.json()
        assert data["job_id"] == job_id
        assert data["status"] == "queued"

    def test_get_nonexistent_job(self):
        """GET /api/v1/jobs/{id} returns 404 for unknown job."""
        response = client.get("/api/v1/jobs/nonexistent123")
        assert response.status_code == 404
        data = response.json()["detail"]
        assert data["status"] == 404
        assert "title" in data  # RFC 7807


class TestFileUpload:
    """File upload endpoint tests."""

    def test_upload_mol_file(self):
        """POST /api/v1/jobs/upload with MOL file returns 202."""
        # Simple MOL file content for ethane
        mol_content = """
  ethane

  2  1  0  0  0  0  0  0  0  0999 V2000
    0.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    1.5400    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0  0  0  0
M  END
"""
        response = client.post(
            "/api/v1/jobs/upload",
            files={"file": ("ethane.mol", mol_content, "chemical/x-mdl-molfile")},
            data={"name": "Ethane"}
        )
        assert response.status_code == 202
        data = response.json()
        assert "job_id" in data
        assert data["status"] == "queued"

    def test_upload_invalid_file_type(self):
        """POST /api/v1/jobs/upload with wrong extension returns 422."""
        response = client.post(
            "/api/v1/jobs/upload",
            files={"file": ("test.txt", "not a molecule", "text/plain")}
        )
        assert response.status_code == 422


class TestOpenAPI:
    """OpenAPI documentation tests."""

    def test_docs_available(self):
        """GET /docs returns Swagger UI."""
        response = client.get("/docs")
        assert response.status_code == 200
        assert "swagger" in response.text.lower()

    def test_openapi_json(self):
        """GET /api/v1/openapi.json returns OpenAPI spec."""
        response = client.get("/api/v1/openapi.json")
        assert response.status_code == 200
        data = response.json()
        assert data["info"]["title"] == "QM NMR Calculator API"
        assert "/api/v1/jobs" in str(data["paths"])
```

Install pytest if not present and run tests:
```bash
uv add --dev pytest httpx
uv run pytest tests/test_api.py -v
```

Note: httpx is required by FastAPI TestClient.
  </action>
  <verify>
```bash
uv run pytest tests/test_api.py -v --tb=short
```
Tests should pass (may need to ensure data directory exists for job creation tests).
  </verify>
  <done>All API tests pass - endpoints validated for success and error cases</done>
</task>

</tasks>

<verification>
Phase 2 success criteria verification:
1. User can POST SMILES and receive job ID - tested in test_submit_valid_smiles
2. User can POST MOL/SDF file and receive job ID - tested in test_upload_mol_file
3. Invalid molecules return clear validation error - tested in test_submit_invalid_smiles
4. User can GET job status - tested in test_get_existing_job
5. OpenAPI docs served at /docs - tested in test_docs_available
</verification>

<success_criteria>
- FastAPI app assembles correctly with all routers
- /docs serves Swagger UI
- /api/v1/openapi.json returns valid OpenAPI spec
- All test cases pass
- API ready for production use
</success_criteria>

<output>
After completion, create `.planning/phases/02-input-and-api/02-03-SUMMARY.md`
</output>
