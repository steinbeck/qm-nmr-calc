---
phase: 02-input-and-api
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/qm_nmr_calc/api/routers/__init__.py
  - src/qm_nmr_calc/api/routers/jobs.py
  - src/qm_nmr_calc/api/routers/health.py
autonomous: true

must_haves:
  truths:
    - "POST /api/v1/jobs accepts SMILES JSON and returns 202 with JobStatus"
    - "POST /api/v1/jobs/upload accepts MOL/SDF file and returns 202 with JobStatus"
    - "GET /api/v1/jobs/{job_id} returns job status or 404"
    - "Invalid molecules return 422 with RFC 7807 error details"
    - "GET /health returns liveness status"
    - "GET /health/ready checks dependencies and returns readiness"
  artifacts:
    - path: "src/qm_nmr_calc/api/routers/jobs.py"
      provides: "Job submission and status endpoints"
      exports: ["router"]
    - path: "src/qm_nmr_calc/api/routers/health.py"
      provides: "Health check endpoints"
      exports: ["router"]
  key_links:
    - from: "src/qm_nmr_calc/api/routers/jobs.py"
      to: "src/qm_nmr_calc/validation.py"
      via: "validate_smiles, validate_mol_file"
      pattern: "validate_smiles|validate_mol_file"
    - from: "src/qm_nmr_calc/api/routers/jobs.py"
      to: "src/qm_nmr_calc/storage.py"
      via: "create_job_directory, load_job_status"
      pattern: "create_job_directory|load_job_status"
    - from: "src/qm_nmr_calc/api/routers/jobs.py"
      to: "src/qm_nmr_calc/tasks.py"
      via: "run_optimization_task.schedule"
      pattern: "run_optimization_task"
---

<objective>
Create the FastAPI routers for job submission, status polling, and health checks.

Purpose: Implement the actual REST endpoints that receive requests, validate input, create jobs, queue tasks, and return status. These routers are the core API functionality.

Output:
- jobs.py router with POST /jobs, POST /jobs/upload, GET /jobs/{job_id}
- health.py router with GET /health, GET /health/ready
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-input-and-api/02-CONTEXT.md
@.planning/phases/02-input-and-api/02-RESEARCH.md

# Prior plan outputs
@.planning/phases/02-input-and-api/02-01-SUMMARY.md

# Code to use
@src/qm_nmr_calc/validation.py
@src/qm_nmr_calc/api/schemas.py
@src/qm_nmr_calc/storage.py
@src/qm_nmr_calc/tasks.py
@src/qm_nmr_calc/isicle_wrapper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health router</name>
  <files>src/qm_nmr_calc/api/routers/__init__.py, src/qm_nmr_calc/api/routers/health.py</files>
  <action>
Create the routers package and health endpoints:

**src/qm_nmr_calc/api/routers/__init__.py:**
```python
"""API routers for QM NMR Calculator."""
```

**src/qm_nmr_calc/api/routers/health.py:**
Create two health endpoints:

**GET /health (liveness):**
- Returns {"status": "alive"}
- No dependency checks - just confirms service is running
- Fast response for load balancer probes

**GET /health/ready (readiness):**
- Checks data directory is writable (create test file, delete it)
- Checks Huey queue is importable
- Returns {"status": "ready", "checks": {...}, "timestamp": "..."}
- Returns 503 if any check fails

Use the pattern from 02-RESEARCH.md health router example.
No authentication on health endpoints.
  </action>
  <verify>
```bash
uv run python -c "
from qm_nmr_calc.api.routers.health import router
from fastapi import APIRouter
assert isinstance(router, APIRouter)
print('Health router OK')
"
```
  </verify>
  <done>Health router with /health and /health/ready endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create jobs router</name>
  <files>src/qm_nmr_calc/api/routers/jobs.py</files>
  <action>
Create the jobs router with three endpoints:

**POST /api/v1/jobs (SMILES submission):**
- Accept JobSubmitRequest JSON body
- Validate SMILES with validate_smiles()
- On invalid: raise HTTPException 422 with ProblemDetail
- On valid:
  - Get versions from isicle_wrapper.get_versions()
  - Create job via storage.create_job_directory(smiles, name, versions)
  - Queue task via tasks.run_optimization_task(job_id)
  - Return JSONResponse with:
    - status_code=202
    - content=JobStatusResponse converted from JobStatus
    - headers={"Location": f"/api/v1/jobs/{job_id}", "Retry-After": "30"}

**POST /api/v1/jobs/upload (file submission):**
- Accept UploadFile and optional Form name parameter
- Validate file extension (.mol or .sdf) or content-type
- Read file content with `await file.read()`
- Validate with validate_mol_file()
- On invalid: raise HTTPException 422 with ProblemDetail
- On valid:
  - Convert mol to SMILES with Chem.MolToSmiles(mol)
  - Create job (use filename as name if no name provided)
  - Queue task
  - Return 202 response like SMILES endpoint

**GET /api/v1/jobs/{job_id} (status):**
- Load status with load_job_status(job_id)
- If None: raise HTTPException 404 with ProblemDetail
- Convert JobStatus to JobStatusResponse and return

**Router configuration:**
- prefix="/jobs", tags=["jobs"]
- The /api/v1 prefix will be added when mounting in app.py

**JobStatus to JobStatusResponse conversion:**
Create a helper function that:
- Flattens input.smiles to input_smiles
- Flattens input.name to input_name
- Converts datetime fields to ISO strings
- Copies other fields directly
  </action>
  <verify>
```bash
uv run python -c "
from qm_nmr_calc.api.routers.jobs import router
from fastapi import APIRouter
assert isinstance(router, APIRouter)

# Check routes are registered
routes = [r.path for r in router.routes]
assert '' in routes or '/' in routes, 'Missing POST / route'
assert '/upload' in routes, 'Missing POST /upload route'
assert '/{job_id}' in routes, 'Missing GET /{job_id} route'

print('Jobs router OK')
"
```
  </verify>
  <done>Jobs router with POST /, POST /upload, GET /{job_id} endpoints</done>
</task>

</tasks>

<verification>
All tasks complete when:
1. Health router importable with /health and /health/ready routes
2. Jobs router importable with /, /upload, /{job_id} routes
3. Routers use proper status codes (200, 202, 404, 422)
4. Error responses use ProblemDetail format
</verification>

<success_criteria>
- Health router checks liveness and readiness
- Jobs router handles SMILES submission with validation
- Jobs router handles file upload with validation
- Jobs router handles status queries with 404 for missing
- All endpoints follow patterns from 02-RESEARCH.md
- Routers are ready to be mounted in FastAPI app
</success_criteria>

<output>
After completion, create `.planning/phases/02-input-and-api/02-02-SUMMARY.md`
</output>
