---
phase: 29-library-documentation
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - docs/libraries.md
autonomous: true

must_haves:
  truths:
    - "Developer can understand how 3Dmol.js viewer is initialized and styled"
    - "Developer can understand how chemical shift labels are added to 3D viewer"
    - "Developer can understand how SmilesDrawer provides real-time preview"
    - "Developer can understand how CREST availability is detected"
    - "Developer can understand how CREST ensemble output is parsed"
  artifacts:
    - path: "docs/libraries.md"
      provides: "Complete library integration documentation"
      contains: "## 3Dmol.js"
      min_lines: 350
  key_links:
    - from: "docs/libraries.md"
      to: "src/qm_nmr_calc/api/templates/results.html"
      via: "code example reference"
      pattern: "results.html"
    - from: "docs/libraries.md"
      to: "src/qm_nmr_calc/conformers/crest_generator.py"
      via: "code example reference"
      pattern: "crest_generator.py"
---

<objective>
Document JavaScript libraries (3Dmol.js, SmilesDrawer) and optional CREST/xTB integration in docs/libraries.md.

Purpose: Complete the library documentation with frontend integrations and optional tooling for ensemble calculations.

Output: Complete docs/libraries.md covering all 6 libraries (RDKit, NWChem, Huey from Plan 01, plus 3Dmol.js, SmilesDrawer, CREST/xTB in this plan).
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-library-documentation/29-RESEARCH.md

# Source files for code examples
@src/qm_nmr_calc/api/templates/results.html
@src/qm_nmr_calc/api/templates/submit.html
@src/qm_nmr_calc/conformers/crest_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: 3Dmol.js Integration Documentation</name>
  <files>docs/libraries.md</files>
  <action>
Append 3Dmol.js section to docs/libraries.md:

**3Dmol.js Section** (~70 lines) - LIB-04

1. **Overview**
   - Purpose: Interactive 3D molecule viewer with chemical shift labels
   - Integration points:
     | Template | Features | Purpose |
     |----------|----------|---------|
     | `results.html` | Viewer, shift labels | Results visualization |
     | `status.html` | Viewer (optional) | Progress preview |
   - CDN: `https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js`

2. **Viewer Setup**
   - Show viewer initialization code (from RESEARCH.md lines 413-434)
   - Key configuration:
     - Container element via getElementById
     - backgroundColor: 'white'
     - Model loading: prefer SDF for proper bonds, fallback to XYZ with assignBonds
   - Style application: stick + sphere with Jmol colorscheme

3. **Chemical Shift Labels**
   - Show addShiftLabels function (from RESEARCH.md lines 441-471)
   - CRITICAL: Index conversion (3Dmol.js 0-based serial, NWChem 1-based indices)
   - Label styling:
     - Blue (#3498db) for 1H
     - Orange (#e67e22) for 13C
     - White text, 85% opacity background, inFront: true
   - Note: Labels added per-atom, not per-peak (identical shifts shown for equivalent atoms)

4. **Geometry Loading**
   - Fetch from /api/v1/jobs/{job_id}/geometry.json
   - Response contains xyz and sdf formats
   - SDF preferred for correct bond orders (aromatic rings, double bonds)

Include template file path references.
  </action>
  <verify>
```bash
# Verify 3Dmol.js section exists
grep -E "^## 3Dmol.js" docs/libraries.md

# Verify viewer setup code
grep -E "createViewer|backgroundColor" docs/libraries.md

# Verify shift labels function
grep -E "addShiftLabels|atom.serial" docs/libraries.md

# Verify index conversion warning
grep -E "0-based|1-based|CRITICAL" docs/libraries.md
```
  </verify>
  <done>
3Dmol.js section added with:
- Integration points table
- Viewer initialization code example
- Shift labels function with index conversion warning
- Geometry loading explanation
- Template file references
  </done>
</task>

<task type="auto">
  <name>Task 2: SmilesDrawer and CREST/xTB Documentation</name>
  <files>docs/libraries.md</files>
  <action>
Append SmilesDrawer and CREST/xTB sections to docs/libraries.md:

**SmilesDrawer Section** (~40 lines) - LIB-06

1. **Overview**
   - Purpose: Real-time 2D structure preview during SMILES input
   - Integration point: `submit.html` template
   - CDN: `https://unpkg.com/smiles-drawer@1.2.0/dist/smiles-drawer.min.js`

2. **Canvas Setup**
   - Show Drawer configuration (from RESEARCH.md lines 530-554)
   - Key options:
     - Dimensions: 350x350
     - bondThickness, bondLength
     - terminalCarbons: true (show CH3 labels)
     - Custom color theme for atoms
   - Parse + draw pattern with error callback

3. **Debounced Input**
   - Explain real-time preview on input change
   - Pattern: Parse SMILES, draw on success, show error on failure
   - Status feedback: "Valid SMILES" or "Invalid SMILES syntax"

**CREST/xTB Section** (~60 lines) - LIB-05

1. **Overview**
   - Purpose: Optional high-accuracy conformer ensemble generation
   - Integration point: `conformers/crest_generator.py`
   - Binaries: crest and xtb must be on PATH
   - Note: Falls back to RDKit KDG when not available

2. **Availability Detection**
   - Show detect_crest_available() function (from RESEARCH.md lines 481-486)
   - Pattern: lru_cache + shutil.which for both binaries
   - Health endpoint reports CREST availability at /api/v1/health

3. **CREST Execution**
   - Subprocess call with timeout (default 7200s)
   - ALPB solvation model matching job solvent
   - Environment variables for stability:
     - OMP_STACKSIZE
     - GFORTRAN_UNBUFFERED_ALL
   - Fail-fast on timeout (no auto-fallback to RDKit)

4. **Ensemble Parsing**
   - Show parse_crest_ensemble() function (from RESEARCH.md lines 493-519)
   - CREST output format: concatenated XYZ with energy in comment
   - Returns list of CRESTConformer objects with:
     - conformer_id (e.g., "conf_001")
     - energy_hartree
     - xyz_block

Include source file paths for all code examples.
  </action>
  <verify>
```bash
# Verify SmilesDrawer section
grep -E "^## SmilesDrawer" docs/libraries.md

# Verify SmilesDrawer code example
grep -E "SmilesDrawer.Drawer|SmilesDrawer.parse" docs/libraries.md

# Verify CREST section
grep -E "^## CREST" docs/libraries.md

# Verify availability detection
grep -E "detect_crest_available|shutil.which" docs/libraries.md

# Verify ensemble parsing
grep -E "parse_crest_ensemble|CRESTConformer" docs/libraries.md
```
  </verify>
  <done>
SmilesDrawer section added with:
- Canvas setup code example
- Debounced input pattern explanation

CREST/xTB section added with:
- Availability detection code example
- CREST execution explanation
- Ensemble parsing code example
  </done>
</task>

<task type="auto">
  <name>Task 3: Final Polish and Commit</name>
  <files>docs/libraries.md</files>
  <action>
Add navigation and commit the complete library documentation:

1. **Add Navigation Footer**
   - Horizontal rule
   - Links: Back to [Documentation Index](README.md)
   - Related: [Technical Architecture](architecture.md) for system-level view
   - Dependencies: Link to pyproject.toml for version info

2. **Review and Polish**
   - Ensure consistent heading levels (## for library, ### for subsections)
   - Verify all code blocks have language specifiers (python, html, javascript)
   - Check all source file references are accurate
   - Ensure introduction mentions all 6 libraries

3. **Commit Complete Documentation**

```bash
git add docs/libraries.md
git commit -m "docs(29): complete library integration documentation

- Document RDKit usage (LIB-01): SMILES validation, conformer generation, 2D drawing
- Document NWChem integration (LIB-02): input generation, output parsing
- Document Huey task queue (LIB-03): configuration, signals, task definition
- Document 3Dmol.js integration (LIB-04): viewer setup, shift labels
- Document CREST/xTB integration (LIB-05): availability detection, ensemble parsing
- Document SmilesDrawer usage (LIB-06): canvas setup, real-time preview
- All code examples from actual codebase with source file references

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
```bash
# Verify commit created
git log -1 --oneline

# Verify all 6 library sections present
grep -E "^## (RDKit|NWChem|Huey|3Dmol|SmilesDrawer|CREST)" docs/libraries.md

# Verify line count
wc -l docs/libraries.md
# Should be 350+ lines

# Verify navigation footer
grep -E "Documentation Index|README.md" docs/libraries.md

# Verify code block count
grep -c '```' docs/libraries.md
# Should have 12+ code blocks (6 libraries x 2 avg)
```
  </verify>
  <done>
Complete library documentation committed with:
- All 6 libraries documented (RDKit, NWChem, Huey, 3Dmol.js, SmilesDrawer, CREST/xTB)
- Navigation footer added
- All code examples with source file references
- Consistent formatting throughout
  </done>
</task>

</tasks>

<verification>
- [ ] 3Dmol.js section covers viewer setup and shift labels (LIB-04)
- [ ] SmilesDrawer section covers canvas setup and input handling (LIB-06)
- [ ] CREST/xTB section covers detection and ensemble parsing (LIB-05)
- [ ] All code examples from actual codebase with source file references
- [ ] Navigation footer with links to related docs
- [ ] Complete docs/libraries.md is 350+ lines
- [ ] Changes committed to git
- [ ] All 6 LIB requirements satisfied
</verification>

<success_criteria>
- LIB-04: 3Dmol.js integration documented with viewer and shift label examples
- LIB-05: CREST/xTB integration documented with availability detection and parsing
- LIB-06: SmilesDrawer usage documented with canvas setup and preview pattern
- All 6 library requirements (LIB-01 through LIB-06) satisfied
- Complete documentation committed
</success_criteria>

<output>
After completion, create `.planning/phases/29-library-documentation/29-02-SUMMARY.md`
</output>
