---
phase: 12-conformer-data-model
plan: 03
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - tests/test_backward_compat.py
  - src/qm_nmr_calc/api/schemas.py
autonomous: true

must_haves:
  truths:
    - "A v1.x status.json file (no conformer fields) loads into updated JobStatus without error"
    - "A v1.x job submission (no conformer params) creates a job with conformer_mode=single"
    - "API response schema includes conformer_mode field for future-proofing"
    - "Existing API tests continue to pass unchanged"
    - "Full test suite (95+ existing tests + new tests) passes with zero regressions"
  artifacts:
    - path: "tests/test_backward_compat.py"
      provides: "Backward compatibility tests with real v1.x JSON fixtures"
      contains: "test_v1_status_json_loads"
    - path: "src/qm_nmr_calc/api/schemas.py"
      provides: "Updated API schemas with optional conformer_mode"
      contains: "conformer_mode"
  key_links:
    - from: "tests/test_backward_compat.py"
      to: "src/qm_nmr_calc/models.py"
      via: "JobStatus.model_validate with v1.x fixture data"
      pattern: "JobStatus\\.model_validate"
    - from: "src/qm_nmr_calc/api/schemas.py"
      to: "src/qm_nmr_calc/models.py"
      via: "JobStatusResponse reflects JobStatus conformer fields"
      pattern: "conformer_mode"
---

<objective>
Verify backward compatibility of the updated data models and extend API schemas to expose conformer mode in responses.

Purpose: Phase 12 requirement API-04 (partial) demands that existing v1.x single-conformer API behavior is preserved. This plan proves it with tests using realistic v1.x JSON fixtures and updates the API response schema to include conformer_mode so clients can distinguish single vs ensemble jobs.

Output: Backward compatibility test suite, updated API schemas, full regression verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/12-conformer-data-model/12-01-SUMMARY.md
@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/api/schemas.py
@src/qm_nmr_calc/api/routers/jobs.py
@tests/test_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backward compatibility tests with v1.x JSON fixtures</name>
  <files>tests/test_backward_compat.py</files>
  <action>
Create tests/test_backward_compat.py with tests proving v1.x data loads correctly.

**Fixture data:** Create inline dict fixtures that exactly match the structure of a real v1.x status.json (NO conformer fields present):

```python
V1_STATUS_JSON = {
    "job_id": "abc123def456",
    "status": "complete",
    "created_at": "2026-01-20T10:00:00",
    "started_at": "2026-01-20T10:01:00",
    "completed_at": "2026-01-20T10:15:00",
    "input": {
        "smiles": "CCO",
        "name": "Ethanol",
        "preset": "production",
        "solvent": "chcl3",
        "notification_email": None,
    },
    "nwchem_version": "7.0.2",
    "current_step": None,
    "current_step_label": None,
    "step_started_at": None,
    "steps_completed": [
        {
            "step": "geometry_optimization",
            "label": "Optimizing geometry",
            "started_at": "2026-01-20T10:01:00",
            "completed_at": "2026-01-20T10:10:00",
            "duration_seconds": 540.0,
        }
    ],
    "error_message": None,
    "error_traceback": None,
    "cpu_time_seconds": 540.0,
    "memory_peak_mb": 256.0,
    "nmr_results": {
        "h1_shifts": [
            {"index": 7, "atom": "H", "shielding": 29.5, "shift": 3.7}
        ],
        "c13_shifts": [
            {"index": 1, "atom": "C", "shielding": 120.0, "shift": 58.0}
        ],
        "functional": "b3lyp",
        "basis_set": "6-311+G(2d,p)",
        "solvent": "chcl3",
    },
    "optimized_geometry_file": "output/optimized.xyz",
}
```

**Test cases:**

1. `test_v1_status_json_loads` - `JobStatus.model_validate(V1_STATUS_JSON)` succeeds
2. `test_v1_status_defaults` - loaded v1 job has `conformer_mode="single"` and `conformer_ensemble=None`
3. `test_v1_input_defaults` - loaded v1 job's input has `conformer_mode="single"`, `conformer_method=None`, `max_conformers=None`
4. `test_v1_status_preserves_all_fields` - loaded v1 job has correct job_id, status, nmr_results, etc. (verify existing data not corrupted)
5. `test_v1_status_roundtrip` - load v1 JSON, dump to dict, reload -- all values preserved
6. `test_v1_queued_job_loads` - minimal v1 queued job (status="queued", no results) loads correctly
7. `test_v1_failed_job_loads` - v1 failed job (with error_message) loads correctly

Also add a v1.x JobInput fixture test:
8. `test_v1_job_input_loads` - `JobInput.model_validate({"smiles": "CCO", "solvent": "chcl3"})` succeeds with conformer defaults
  </action>
  <verify>
Run: `cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_backward_compat.py -v`

Expected: All 8 tests pass.
  </verify>
  <done>tests/test_backward_compat.py exists with 8 tests proving v1.x status.json files load correctly into updated models with correct defaults for new conformer fields. No v1.x data is lost or corrupted during load.</done>
</task>

<task type="auto">
  <name>Task 2: Update API schemas and verify full regression</name>
  <files>src/qm_nmr_calc/api/schemas.py</files>
  <action>
1. Read the current src/qm_nmr_calc/api/schemas.py file.

2. Add `conformer_mode` field to `JobStatusResponse`:
   - `conformer_mode: str = "single"` (string, not Literal, for API flexibility)
   - Place it near the other status fields

3. Add `conformer_mode` field to `JobSubmitRequest`:
   - `conformer_mode: str = "single"` (default single for backward compat)
   - `conformer_method: Optional[str] = None`
   - `max_conformers: Optional[int] = None`
   - Add Field descriptions explaining these are for v2.0 ensemble mode

4. Update `job_status_to_response()` in `src/qm_nmr_calc/api/routers/jobs.py`:
   - Include `conformer_mode` in the response dict, reading from `job_status.conformer_mode`
   - This is a single line addition in the response dict construction

5. Run the FULL test suite to verify zero regressions:
   - All existing 95+ tests pass
   - All new conformer model tests pass
   - All new backward compat tests pass
   - All new atom ordering tests pass

Important: The API changes are minimal -- just adding optional fields with defaults. Existing API clients sending v1.x requests (no conformer fields) will get default values. This is partial API-04 coverage; full API integration happens in Phase 17.
  </action>
  <verify>
Run: `cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/ -v --tb=short`

Expected: Full test suite passes (95+ existing tests + all new tests from plans 01, 02, 03). Zero failures, zero errors.

Then verify API schema:
`cd /home/chris/develop/qm-nmr-calc && python -c "from qm_nmr_calc.api.schemas import JobStatusResponse, JobSubmitRequest; r = JobStatusResponse.model_json_schema(); print('conformer_mode' in str(r)); s = JobSubmitRequest.model_json_schema(); print('conformer_mode' in str(s))"`

Expected: Both print True.
  </verify>
  <done>API schemas include conformer_mode field. JobStatusResponse includes conformer_mode. JobSubmitRequest accepts optional conformer parameters. Full test suite passes with zero regressions. v1.x API behavior completely preserved.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_backward_compat.py -v` -- all backward compat tests pass
2. `python -m pytest tests/ -v --tb=short` -- full suite passes (zero regressions)
3. `python -c "from qm_nmr_calc.api.schemas import JobStatusResponse; print(JobStatusResponse.model_json_schema())"` -- includes conformer_mode
4. API test `test_submit_valid_smiles` still returns 202 with no conformer params (backward compat)
</verification>

<success_criteria>
- v1.x status.json loads into updated JobStatus with correct defaults
- v1.x API requests work unchanged (no conformer params required)
- API responses include conformer_mode="single" for existing jobs
- Full test suite passes with zero regressions
- Phase 12 requirements DFT-03 and API-04 (partial) verified
</success_criteria>

<output>
After completion, create `.planning/phases/12-conformer-data-model/12-03-SUMMARY.md`
</output>
