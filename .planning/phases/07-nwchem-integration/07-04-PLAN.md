---
phase: 07-nwchem-integration
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - src/qm_nmr_calc/nwchem/runner.py
  - src/qm_nmr_calc/nwchem/__init__.py
  - src/qm_nmr_calc/tasks.py
  - src/qm_nmr_calc/startup.py
  - src/qm_nmr_calc/__init__.py
  - src/qm_nmr_calc/solvents.py
  - README.md
autonomous: true

must_haves:
  truths:
    - "run_nmr_task uses new nwchem module instead of isicle_wrapper"
    - "COSMO solvation applied to both geometry optimization AND NMR shielding"
    - "Only CHCl3 and DMSO are supported solvents"
    - "isicle_wrapper.py is deleted from codebase"
    - "startup.py validates RDKit instead of ISiCLE"
    - "ISiCLE attribution appears in README.md"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/runner.py"
      provides: "run_nwchem, run_calculation functions"
      exports: ["run_nwchem", "run_calculation"]
    - path: "src/qm_nmr_calc/tasks.py"
      provides: "Updated Huey tasks using nwchem module"
      min_lines: 100
    - path: "README.md"
      provides: "ISiCLE attribution"
      contains: "ISiCLE"
  key_links:
    - from: "src/qm_nmr_calc/tasks.py"
      to: "src/qm_nmr_calc/nwchem/runner.py"
      via: "import and function calls"
      pattern: "from \\.nwchem|from qm_nmr_calc\\.nwchem"
    - from: "src/qm_nmr_calc/nwchem/runner.py"
      to: "subprocess/nwchem binary"
      via: "subprocess.run with nwchem command"
      pattern: "subprocess\\.run.*nwchem"
---

<objective>
Integrate nwchem module into the calculation pipeline, replacing isicle_wrapper completely.

Purpose: Wire up the new NWChem I/O modules (from Plans 01-03) to replace ISiCLE dependency. Fix COSMO solvation bug by applying it to both calculation steps.
Output: Fully working NMR calculation pipeline without ISiCLE, with proper COSMO solvation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nwchem-integration/07-RESEARCH.md
@.planning/phases/07-nwchem-integration/07-CONTEXT.md

# Wave 1 plan outputs (will exist by Wave 2)
@.planning/phases/07-nwchem-integration/07-01-SUMMARY.md
@.planning/phases/07-nwchem-integration/07-02-SUMMARY.md
@.planning/phases/07-nwchem-integration/07-03-SUMMARY.md

# Existing code to update/replace
@src/qm_nmr_calc/isicle_wrapper.py
@src/qm_nmr_calc/tasks.py
@src/qm_nmr_calc/startup.py
@src/qm_nmr_calc/__init__.py
@src/qm_nmr_calc/solvents.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NWChem runner module</name>
  <files>
    src/qm_nmr_calc/nwchem/runner.py
    src/qm_nmr_calc/nwchem/__init__.py
  </files>
  <action>
Create `src/qm_nmr_calc/nwchem/runner.py`:

**run_nwchem(input_file: Path, output_file: Path, processes: int = 4) -> None:**
- Execute NWChem via subprocess: `mpirun -np {processes} nwchem {input_file}`
- Capture stdout to output_file
- Raise RuntimeError if NWChem returns non-zero exit code
- Include stderr in error message for debugging

**validate_nwchem() -> None:**
- Check nwchem is in PATH using `which nwchem`
- Exit with FATAL message if not found (fail-fast startup)
- Same pattern as current isicle_wrapper.validate_nwchem()

**get_nwchem_version() -> str:**
- Return "7.0.2" (hardcoded, same as current)
- TODO comment noting dynamic parsing could be added

**run_calculation(smiles: str, job_dir: Path, preset: dict, solvent: str, processes: int = 4, skip_optimization: bool = False, geometry_file: Path = None) -> dict:**
- Main entry point replacing isicle_wrapper functions
- If skip_optimization=False (default): Run full two-step calculation
  1. Call smiles_to_xyz to get initial geometry
  2. Generate optimization input with COSMO
  3. Run NWChem optimization
  4. Extract optimized geometry from output
  5. Generate shielding input with COSMO
  6. Run NWChem NMR calculation
  7. Parse shielding output
- If skip_optimization=True:
  1. Load geometry_file using load_geometry_file
  2. Skip directly to step 5 (NMR shielding)
- Return dict with:
  - 'geometry_file': Path to optimized.xyz
  - 'shielding_data': dict in shifts.py expected format
  - 'optimization_output': Path to optimize.out
  - 'shielding_output': Path to shielding.out

Uses:
- generate_optimization_input, generate_shielding_input (from input_gen)
- extract_optimized_geometry, parse_shielding_output (from output_parser)
- smiles_to_xyz, load_geometry_file, mol_to_xyz_block (from geometry)

File organization:
- scratch_dir = job_dir / 'scratch'
- output_dir = job_dir / 'output'
- optimize.nw, optimize.out in scratch_dir
- shielding.nw, shielding.out in scratch_dir
- optimized.xyz in output_dir

Update `src/qm_nmr_calc/nwchem/__init__.py` to export:
- run_nwchem, run_calculation, validate_nwchem, get_nwchem_version
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem import run_calculation, validate_nwchem; print('OK')"`
  </verify>
  <done>
- runner.py exists with all functions
- run_calculation handles both SMILES and pre-optimized geometry paths
- COSMO applied to both optimization and shielding steps
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tasks.py and remove isicle_wrapper</name>
  <files>
    src/qm_nmr_calc/tasks.py
    src/qm_nmr_calc/startup.py
    src/qm_nmr_calc/__init__.py
  </files>
  <action>
**Update src/qm_nmr_calc/tasks.py:**
- Replace imports:
  - Remove: `from .isicle_wrapper import run_geometry_optimization, run_geometry_opt_dft, run_nmr_shielding`
  - Add: `from .nwchem import run_calculation`
- Update run_nmr_task():
  - Remove separate calls to run_geometry_opt_dft and run_nmr_shielding
  - Replace with single call to run_calculation:
    ```python
    result = run_calculation(
        smiles=smiles,
        job_dir=job_dir,
        preset=preset,
        solvent=solvent,
        processes=preset['processes'],
    )
    ```
  - Use result['shielding_data'] for shift conversion
  - Use result['geometry_file'] for geometry_file path
- Keep step tracking (start_step, complete_current_step) - adapt to new flow
- Remove run_optimization_task if it was only using old isicle_wrapper

**Update src/qm_nmr_calc/startup.py:**
- Replace ISiCLE validation with RDKit validation:
  ```python
  # Remove: import isicle
  # Remove: isicle.load("C").initial_optimize(embed=True)
  # Add: from rdkit import Chem; from rdkit.Chem import AllChem
  # Add: mol = Chem.MolFromSmiles("C"); mol = Chem.AddHs(mol); AllChem.EmbedMolecule(mol)
  ```
- Update validate_nwchem import: `from .nwchem import validate_nwchem`
- Update success message: "[OK] RDKit working" instead of "[OK] ISiCLE/RDKit working"

**Update src/qm_nmr_calc/__init__.py:**
- Replace: `from .isicle_wrapper import validate_nwchem, get_versions`
- With: `from .nwchem import validate_nwchem, get_nwchem_version`
- Update __all__ accordingly
- Note: get_versions returned Versions namedtuple, decide if needed or just get_nwchem_version
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.tasks import run_nmr_task; print('OK')"`
Run: `python -c "from qm_nmr_calc.startup import validate_environment; print('OK')"`
Run: `python -c "from qm_nmr_calc import validate_nwchem; print('OK')"`

Verify no isicle imports remain:
`grep -r "isicle" src/qm_nmr_calc/ --include="*.py" | grep -v "# ISiCLE" | grep -v "__pycache__" || echo "No isicle imports found"`
  </verify>
  <done>
- tasks.py uses nwchem module instead of isicle_wrapper
- startup.py validates RDKit directly
- __init__.py exports updated
- No isicle imports remain in codebase
  </done>
</task>

<task type="auto">
  <name>Task 3: Update solvents.py, delete isicle_wrapper, add attribution</name>
  <files>
    src/qm_nmr_calc/solvents.py
    src/qm_nmr_calc/isicle_wrapper.py
    README.md
  </files>
  <action>
**Update src/qm_nmr_calc/solvents.py:**
- Reduce SUPPORTED_SOLVENTS to only CHCl3 and DMSO:
  ```python
  SUPPORTED_SOLVENTS: dict[str, str] = {
      "chcl3": "Chloroform (CDCl3)",
      "dmso": "Dimethylsulfoxide (DMSO-d6)",
  }
  ```
- Remove all other solvents (methanol, acetone, benzene, h2o, etc.)
- This matches user decision and the only solvents we have COSMO dielectric values for

**Delete src/qm_nmr_calc/isicle_wrapper.py:**
- Remove the file entirely
- Per user decision: immediate replacement, no coexistence

**Update README.md with ISiCLE attribution:**
- Per user decision: attribution in README only, no in-code comments
- Add an "Acknowledgments" or "Credits" section if not present
- Include text like:
  ```markdown
  ## Acknowledgments

  This project's NWChem integration was informed by [ISiCLE](https://github.com/pnnl/isicle),
  a Python package for high-throughput NMR chemical shift calculations developed at
  Pacific Northwest National Laboratory.
  ```
  </action>
  <verify>
# Verify isicle_wrapper deleted
ls src/qm_nmr_calc/isicle_wrapper.py 2>&1 | grep -q "No such file" && echo "isicle_wrapper.py deleted: OK"

# Verify solvents reduced
python -c "
from qm_nmr_calc.solvents import SUPPORTED_SOLVENTS
assert 'chcl3' in SUPPORTED_SOLVENTS
assert 'dmso' in SUPPORTED_SOLVENTS
assert len(SUPPORTED_SOLVENTS) == 2, f'Expected 2 solvents, got {len(SUPPORTED_SOLVENTS)}'
print('Solvents: OK (CHCl3 and DMSO only)')
"

# Verify README has attribution
grep -i "ISiCLE" README.md && echo "Attribution: OK"
  </verify>
  <done>
- isicle_wrapper.py deleted
- solvents.py reduced to CHCl3 and DMSO only
- README.md contains ISiCLE attribution
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Verify no ISiCLE imports
echo "Checking for ISiCLE imports..."
grep -r "import isicle" src/qm_nmr_calc/ --include="*.py" | grep -v "__pycache__" || echo "No ISiCLE imports: OK"

# 2. Verify isicle_wrapper deleted
ls src/qm_nmr_calc/isicle_wrapper.py 2>&1 | grep -q "No such file" && echo "isicle_wrapper.py deleted: OK"

# 3. Verify imports work
python -c "
from qm_nmr_calc.nwchem import (
    generate_optimization_input,
    generate_shielding_input,
    extract_optimized_geometry,
    parse_shielding_output,
    smiles_to_xyz,
    load_geometry_file,
    run_calculation,
    validate_nwchem,
)
from qm_nmr_calc.tasks import run_nmr_task
from qm_nmr_calc.startup import validate_environment
from qm_nmr_calc.solvents import SUPPORTED_SOLVENTS

print('All imports OK')
print(f'Supported solvents: {list(SUPPORTED_SOLVENTS.keys())}')
"

# 4. Verify COSMO in generated inputs
python -c "
from qm_nmr_calc.nwchem import generate_optimization_input, generate_shielding_input

opt = generate_optimization_input('C 0 0 0', 'b3lyp', '6-31G*', 'chcl3')
nmr = generate_shielding_input('C 0 0 0', 'b3lyp', '6-311+G(2d,p)', 'chcl3')

assert 'cosmo' in opt.lower() and 'dielec' in opt.lower(), 'COSMO missing from optimization'
assert 'cosmo' in nmr.lower() and 'dielec' in nmr.lower(), 'COSMO missing from shielding'
print('COSMO applied to BOTH steps: OK (bug fixed)')
"

# 5. Run all tests
pytest tests/ -v --ignore=tests/test_integration_full.py
```
</verification>

<success_criteria>
1. isicle_wrapper.py is deleted from the codebase
2. No `import isicle` statements remain in src/qm_nmr_calc/
3. tasks.py uses nwchem.run_calculation instead of isicle_wrapper functions
4. startup.py validates RDKit directly (not via ISiCLE)
5. solvents.py supports only CHCl3 and DMSO
6. README.md contains ISiCLE attribution
7. All existing tests pass (except integration tests needing actual NWChem)
8. COSMO solvation applied to both geometry optimization and NMR shielding
</success_criteria>

<output>
After completion, create `.planning/phases/07-nwchem-integration/07-04-SUMMARY.md`
</output>
