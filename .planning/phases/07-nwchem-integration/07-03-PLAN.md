---
phase: 07-nwchem-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/geometry.py
  - src/qm_nmr_calc/nwchem/__init__.py
autonomous: true

must_haves:
  truths:
    - "SMILES string converts to 3D coordinates with hydrogens added"
    - "XYZ file loads and has bonds determined from coordinates"
    - "SDF file loads with existing bond information preserved"
    - "Pre-optimized geometry validation confirms atoms have valid coordinates"
    - "Geometry output is XYZ-format string suitable for NWChem input"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/geometry.py"
      provides: "smiles_to_xyz, load_geometry_file, mol_to_xyz_block functions"
      exports: ["smiles_to_xyz", "load_geometry_file", "mol_to_xyz_block"]
  key_links:
    - from: "src/qm_nmr_calc/nwchem/geometry.py"
      to: "RDKit"
      via: "Chem.MolFromSmiles, AllChem.ETKDGv3, MolFromXYZFile, MolFromMolFile"
      pattern: "from rdkit import|from rdkit\\.Chem"
---

<objective>
Create geometry handling module for SMILES-to-3D conversion and pre-optimized geometry loading.

Purpose: Enable molecule geometry preparation via RDKit without ISiCLE dependency, supporting both new SMILES submissions and pre-optimized XYZ/SDF uploads.
Output: `nwchem/geometry.py` module with functions for geometry conversion and loading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nwchem-integration/07-RESEARCH.md
@.planning/phases/07-nwchem-integration/07-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geometry handling module</name>
  <files>
    src/qm_nmr_calc/nwchem/geometry.py
  </files>
  <action>
Create `src/qm_nmr_calc/nwchem/geometry.py`:

**smiles_to_xyz(smiles: str, random_seed: int = 0xf00d) -> tuple[Chem.Mol, str]:**
- Parse SMILES with `Chem.MolFromSmiles()`
- Raise ValueError if SMILES invalid
- Add hydrogens with `Chem.AddHs()` (required for realistic 3D)
- Generate 3D coordinates with `AllChem.ETKDGv3()` (best method per RESEARCH.md)
- Set random seed for reproducibility
- If embedding fails, raise RuntimeError with helpful message
- Run UFF optimization: `AllChem.UFFOptimizeMolecule()`
- Convert to XYZ block: `Chem.MolToXYZBlock()` then strip first two lines (atom count + comment)
- Return tuple of (mol object, xyz_block string)

**load_geometry_file(filepath: Path, charge: int = 0) -> tuple[Chem.Mol, str]:**
- Detect format from file extension (.xyz or .sdf)
- For SDF: Use `Chem.MolFromMolFile(filepath, removeHs=False)` - bonds already present
- For XYZ: Use `Chem.MolFromXYZFile()` then `rdDetermineBonds.DetermineBonds(mol, charge=charge)`
- Raise ValueError if file doesn't parse or has unsupported extension
- Validate geometry: Check mol has conformer with coordinates
- Convert to XYZ block for NWChem input
- Return tuple of (mol object, xyz_block string)

**mol_to_xyz_block(mol: Chem.Mol) -> str:**
- Helper to convert RDKit mol to XYZ coordinate block
- Extract from `Chem.MolToXYZBlock(mol)` - skip first two lines (atom count, title)
- Return just the "Element X Y Z" lines for NWChem geometry block

**validate_geometry(mol: Chem.Mol) -> bool:**
- Check mol has at least one conformer
- Check conformer has valid 3D coordinates (not all zeros)
- Return True if valid, raise ValueError with reason if not

Note: Per user decision, XYZ files require charge parameter for bond determination. Default charge=0.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem.geometry import smiles_to_xyz, load_geometry_file; print('OK')"`

Test SMILES conversion:
```python
from qm_nmr_calc.nwchem.geometry import smiles_to_xyz

mol, xyz = smiles_to_xyz("CCO")  # Ethanol
lines = [l for l in xyz.strip().split('\n') if l.strip()]
assert len(lines) == 9, f"Ethanol should have 9 atoms (2C + 1O + 6H), got {len(lines)}"
assert all(len(l.split()) >= 4 for l in lines), "Each line should have element + 3 coords"
print("SMILES to XYZ: OK")
```

Test invalid SMILES:
```python
from qm_nmr_calc.nwchem.geometry import smiles_to_xyz

try:
    smiles_to_xyz("invalid_smiles_xyz")
    assert False, "Should raise ValueError"
except ValueError:
    print("Invalid SMILES handling: OK")
```
  </verify>
  <done>
- smiles_to_xyz converts SMILES to 3D coordinates using ETKDGv3 + UFF
- load_geometry_file loads XYZ and SDF files
- XYZ bond determination uses rdDetermineBonds with charge parameter
- Invalid inputs raise ValueError with clear messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for geometry handling</name>
  <files>
    tests/test_nwchem_geometry.py
    tests/fixtures/ethanol.xyz
    tests/fixtures/ethanol.sdf
  </files>
  <action>
Create test fixtures:

**tests/fixtures/ethanol.xyz:**
Create valid XYZ file for ethanol (9 atoms: 2C + 1O + 6H)
```
9
Ethanol
C     0.000000    0.000000    0.000000
C     1.521900    0.000000    0.000000
O     2.049900    1.311200    0.000000
H    -0.366200   -0.523900    0.890000
H    -0.366200   -0.523900   -0.890000
H    -0.366200    1.027900    0.000000
H     1.888100   -0.523900    0.890000
H     1.888100   -0.523900   -0.890000
H     2.726100    1.311200    0.000000
```

**tests/fixtures/ethanol.sdf:**
Create valid SDF file (can generate from RDKit if needed, or use known good SDF)

**tests/test_nwchem_geometry.py:**

`test_smiles_to_xyz_ethanol`:
- Convert "CCO" to XYZ
- Verify 9 atom lines returned
- Verify each line has element and 3 coordinate values

`test_smiles_to_xyz_adds_hydrogens`:
- Convert "C" (methane as SMILES) to XYZ
- Verify 5 atoms (1C + 4H) - hydrogens were added

`test_smiles_to_xyz_reproducible`:
- Convert same SMILES twice with same seed
- Verify identical coordinates

`test_smiles_to_xyz_invalid_smiles`:
- Pass invalid SMILES string
- Verify ValueError raised

`test_load_geometry_file_xyz`:
- Load tests/fixtures/ethanol.xyz
- Verify mol has 9 atoms
- Verify xyz_block has 9 lines

`test_load_geometry_file_sdf`:
- Load tests/fixtures/ethanol.sdf
- Verify mol has 9 atoms
- Verify bonds present (SDF includes connectivity)

`test_load_geometry_file_unsupported_format`:
- Try loading a .txt file
- Verify ValueError raised

`test_xyz_output_format_for_nwchem`:
- Convert SMILES or load file
- Verify output format matches NWChem geometry block requirements
- Each line: element symbol (1-2 chars) followed by 3 floats
  </action>
  <verify>
Run: `pytest tests/test_nwchem_geometry.py -v`

All tests should pass.
  </verify>
  <done>
- Test fixtures exist for XYZ and SDF formats
- All tests pass
- Edge cases covered (invalid SMILES, unsupported format)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update nwchem package exports</name>
  <files>
    src/qm_nmr_calc/nwchem/__init__.py
  </files>
  <action>
Update `src/qm_nmr_calc/nwchem/__init__.py` to export geometry functions:

Add imports:
```python
from .geometry import smiles_to_xyz, load_geometry_file, mol_to_xyz_block
```

Update __all__ to include all geometry exports.

Note: If Plans 01/02 haven't run yet (parallel Wave 1), create the full __init__.py with all exports from all three modules.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem import smiles_to_xyz, load_geometry_file; print('OK')"`
  </verify>
  <done>
- Geometry functions exportable from qm_nmr_calc.nwchem package
  </done>
</task>

</tasks>

<verification>
```bash
# Module imports
python -c "from qm_nmr_calc.nwchem import smiles_to_xyz, load_geometry_file, mol_to_xyz_block"

# Run tests
pytest tests/test_nwchem_geometry.py -v

# End-to-end check: SMILES to NWChem-ready coordinates
python -c "
from qm_nmr_calc.nwchem import smiles_to_xyz

mol, xyz = smiles_to_xyz('c1ccccc1')  # Benzene
lines = xyz.strip().split('\n')
print(f'Benzene: {len(lines)} atoms')
# Benzene should have 12 atoms (6C + 6H)
assert len(lines) == 12, f'Expected 12, got {len(lines)}'
print('XYZ block format:')
for line in lines[:3]:
    print(f'  {line}')
print('  ...')
"
```
</verification>

<success_criteria>
1. `smiles_to_xyz()` converts SMILES to 3D coordinates with hydrogens
2. `load_geometry_file()` loads XYZ files (with bond determination) and SDF files
3. Output format is XYZ coordinate block suitable for NWChem geometry directive
4. Invalid inputs raise ValueError with clear messages
5. ETKDGv3 used for conformer generation (best available method)
6. All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-nwchem-integration/07-03-SUMMARY.md`
</output>
