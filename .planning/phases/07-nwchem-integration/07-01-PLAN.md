---
phase: 07-nwchem-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/__init__.py
  - src/qm_nmr_calc/nwchem/input_gen.py
autonomous: true

must_haves:
  truths:
    - "NWChem input files contain valid geometry block with atom coordinates"
    - "NWChem input files contain correct COSMO dielec parameter for CHCl3 (4.8) or DMSO (46.0)"
    - "Geometry optimization input ends with 'task dft optimize'"
    - "NMR shielding input ends with 'task dft property' and has property/shielding block"
    - "Basis set names are quoted in input files"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/__init__.py"
      provides: "Package exports for input generation"
      min_lines: 5
    - path: "src/qm_nmr_calc/nwchem/input_gen.py"
      provides: "generate_optimization_input and generate_shielding_input functions"
      exports: ["generate_optimization_input", "generate_shielding_input"]
  key_links:
    - from: "src/qm_nmr_calc/nwchem/input_gen.py"
      to: "COSMO dielectric constants"
      via: "Lookup dict for CHCl3 and DMSO"
      pattern: "dielec.*4\\.8|dielec.*46\\.0"
---

<objective>
Create NWChem input file generation module for geometry optimization and NMR shielding calculations with COSMO solvation.

Purpose: Enable direct NWChem I/O without ISiCLE dependency, fixing the COSMO bug (currently hardcoded to False).
Output: `nwchem/input_gen.py` module with functions to generate valid NWChem input files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nwchem-integration/07-RESEARCH.md
@.planning/phases/07-nwchem-integration/07-CONTEXT.md

# Existing code for reference
@src/qm_nmr_calc/presets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nwchem package with input generation module</name>
  <files>
    src/qm_nmr_calc/nwchem/__init__.py
    src/qm_nmr_calc/nwchem/input_gen.py
  </files>
  <action>
Create `src/qm_nmr_calc/nwchem/` directory and modules:

**__init__.py:**
- Export `generate_optimization_input` and `generate_shielding_input` from input_gen
- Add module docstring noting ISiCLE was reference (attribution in README per user decision)

**input_gen.py:**
- COSMO dielectric constants dict: `COSMO_DIELECTRIC = {"chcl3": 4.8, "dmso": 46.0}`
- Raise ValueError for unsupported solvents with message listing valid options

`generate_optimization_input(geometry_xyz: str, functional: str, basis_set: str, solvent: str, max_iter: int = 150) -> str`:
- Uses f-string template following NWChem format from RESEARCH.md
- CRITICAL: Quote basis set name: `* library "{basis_set}"`
- Include `noautosym` in geometry block
- DFT block: xc functional, iterations max_iter, convergence criteria, direct
- COSMO block with dielec from COSMO_DIELECTRIC
- End with `task dft optimize`

`generate_shielding_input(geometry_xyz: str, functional: str, basis_set: str, solvent: str) -> str`:
- Similar template but with property/shielding block instead of optimize
- Same COSMO block (applies to both steps per user decision)
- End with `task dft property`

Both functions:
- Validate solvent is in COSMO_DIELECTRIC, raise ValueError if not
- Return complete NWChem input file as string
- Use `start molecule` directive (simple fixed name)
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem import generate_optimization_input, generate_shielding_input; print('OK')"`

Verify input generation:
```python
from qm_nmr_calc.nwchem import generate_optimization_input, generate_shielding_input

# Test geometry optimization
opt = generate_optimization_input(
    geometry_xyz="C 0.0 0.0 0.0\nH 1.0 0.0 0.0",
    functional="b3lyp",
    basis_set="6-31G*",
    solvent="chcl3",
    max_iter=150
)
assert "task dft optimize" in opt
assert 'library "6-31G*"' in opt
assert "dielec 4.8" in opt
assert "noautosym" in opt

# Test NMR shielding
nmr = generate_shielding_input(
    geometry_xyz="C 0.0 0.0 0.0\nH 1.0 0.0 0.0",
    functional="b3lyp",
    basis_set="6-311+G(2d,p)",
    solvent="dmso"
)
assert "task dft property" in nmr
assert "shielding" in nmr
assert "dielec 46.0" in nmr

# Test invalid solvent
try:
    generate_optimization_input("C 0 0 0", "b3lyp", "6-31G*", "water")
    assert False, "Should have raised ValueError"
except ValueError as e:
    assert "chcl3" in str(e).lower() and "dmso" in str(e).lower()

print("All checks passed")
```
  </verify>
  <done>
- Both functions generate valid NWChem input file strings
- COSMO block present with correct dielectric for CHCl3 (4.8) and DMSO (46.0)
- Basis set names properly quoted
- Unsupported solvents raise ValueError with valid options listed
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for input generation</name>
  <files>
    tests/test_nwchem_input.py
  </files>
  <action>
Create `tests/test_nwchem_input.py` with pytest tests:

**Test generate_optimization_input:**
- `test_optimization_input_has_required_directives`: Check for geometry, basis, dft, cosmo, task dft optimize
- `test_optimization_input_chcl3_dielectric`: Verify dielec 4.8 for chcl3 solvent
- `test_optimization_input_dmso_dielectric`: Verify dielec 46.0 for dmso solvent
- `test_optimization_input_quoted_basis_set`: Verify basis set name is quoted (important for special chars like *)
- `test_optimization_input_max_iter`: Verify iterations parameter appears in dft block
- `test_optimization_input_noautosym`: Verify geometry block has noautosym

**Test generate_shielding_input:**
- `test_shielding_input_has_property_block`: Check for property/shielding block
- `test_shielding_input_task_dft_property`: Check for task dft property
- `test_shielding_input_has_cosmo`: Verify COSMO block present (both steps need it)

**Test invalid solvent:**
- `test_invalid_solvent_raises_valueerror`: Verify ValueError with helpful message
- `test_solvent_case_insensitive`: Both "CHCL3" and "chcl3" should work
  </action>
  <verify>
Run: `pytest tests/test_nwchem_input.py -v`

All tests should pass.
  </verify>
  <done>
- Test file exists with comprehensive coverage
- All tests pass
- Edge cases covered (case sensitivity, invalid solvent)
  </done>
</task>

</tasks>

<verification>
```bash
# Module imports
python -c "from qm_nmr_calc.nwchem import generate_optimization_input, generate_shielding_input"

# Run tests
pytest tests/test_nwchem_input.py -v

# Verify COSMO is applied
python -c "
from qm_nmr_calc.nwchem import generate_optimization_input, generate_shielding_input
opt = generate_optimization_input('C 0 0 0', 'b3lyp', '6-31G*', 'chcl3')
nmr = generate_shielding_input('C 0 0 0', 'b3lyp', '6-311+G(2d,p)', 'chcl3')
assert 'cosmo' in opt.lower(), 'COSMO missing from optimization'
assert 'cosmo' in nmr.lower(), 'COSMO missing from shielding'
print('COSMO applied to both steps - bug fixed')
"
```
</verification>

<success_criteria>
1. `generate_optimization_input()` returns valid NWChem input for geometry optimization
2. `generate_shielding_input()` returns valid NWChem input for NMR property calculation
3. COSMO solvation applied to BOTH optimization and shielding (fixes existing bug)
4. Only CHCl3 and DMSO supported with correct dielectric constants
5. Invalid solvents raise clear ValueError with valid options
6. All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-nwchem-integration/07-01-SUMMARY.md`
</output>
