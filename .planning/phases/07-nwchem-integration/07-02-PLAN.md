---
phase: 07-nwchem-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/nwchem/output_parser.py
  - src/qm_nmr_calc/nwchem/__init__.py
autonomous: true

must_haves:
  truths:
    - "Parser extracts optimized geometry coordinates from NWChem output"
    - "Parser extracts isotropic shielding values for all H and C atoms"
    - "Parser returns atom indices, element symbols, and shielding values"
    - "Parser raises RuntimeError with descriptive message if section not found"
  artifacts:
    - path: "src/qm_nmr_calc/nwchem/output_parser.py"
      provides: "extract_optimized_geometry and parse_shielding_output functions"
      exports: ["extract_optimized_geometry", "parse_shielding_output"]
  key_links:
    - from: "src/qm_nmr_calc/nwchem/output_parser.py"
      to: "NWChem output format"
      via: "Regex patterns for geometry and shielding sections"
      pattern: "re\\.search|re\\.compile"
---

<objective>
Create NWChem output parsing module to extract optimized geometries and NMR shielding tensors.

Purpose: Parse NWChem calculation results without ISiCLE dependency, enabling direct result extraction.
Output: `nwchem/output_parser.py` module with functions to extract geometry and shielding data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nwchem-integration/07-RESEARCH.md
@.planning/phases/07-nwchem-integration/07-CONTEXT.md

# Existing code showing expected shielding_data format
@src/qm_nmr_calc/shifts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create output parser module</name>
  <files>
    src/qm_nmr_calc/nwchem/output_parser.py
  </files>
  <action>
Create `src/qm_nmr_calc/nwchem/output_parser.py`:

**extract_optimized_geometry(output_text: str) -> str:**
- Search for final optimized geometry in NWChem output
- NWChem prints coordinates after optimization under "Output coordinates in angstroms" or similar header
- Return XYZ-format coordinate block (atom element and x, y, z) without header lines
- Raise RuntimeError if geometry section not found

IMPORTANT: Per RESEARCH.md, exact format may vary. Use flexible regex that handles:
- Section markers like "Output coordinates in angstroms" or "Final geometry"
- Atom lines with format: `Element  X.xxxxxx  Y.yyyyyy  Z.zzzzzz`
- Variable whitespace

**parse_shielding_output(output_text: str) -> dict:**
- Search for "Chemical Shielding Tensors" section (GIAO method)
- Extract isotropic shielding value for each atom
- Return dict matching shifts.py expected format:
  ```python
  {
      "index": [1, 2, 3, ...],  # 1-based atom indices
      "atom": ["C", "H", "H", ...],  # Element symbols
      "shielding": [156.2, 29.1, 28.5, ...]  # Isotropic shielding in ppm
  }
  ```
- Raise RuntimeError if shielding section not found

IMPORTANT: Per RESEARCH.md, exact NWChem output format needs verification. Start with pattern from research:
- Section header: "Chemical Shielding Tensors (GIAO, in ppm)"
- Atom lines may contain: atom index, element, "Isotropic:" followed by value
- Make regex flexible to handle whitespace variations

Include docstrings documenting the expected NWChem output format and noting that patterns may need adjustment based on actual NWChem version output.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem.output_parser import extract_optimized_geometry, parse_shielding_output; print('OK')"`

The full verification requires actual NWChem output files. For now, verify basic structure:
```python
from qm_nmr_calc.nwchem.output_parser import extract_optimized_geometry, parse_shielding_output

# Test error handling
try:
    extract_optimized_geometry("no geometry here")
    assert False, "Should raise RuntimeError"
except RuntimeError as e:
    assert "geometry" in str(e).lower() or "coordinates" in str(e).lower()

try:
    parse_shielding_output("no shielding here")
    assert False, "Should raise RuntimeError"
except RuntimeError as e:
    assert "shielding" in str(e).lower()

print("Error handling works correctly")
```
  </verify>
  <done>
- Module exists with both functions exported
- Functions raise RuntimeError with descriptive messages when sections not found
- Docstrings document expected NWChem output format
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests with mock NWChem output</name>
  <files>
    tests/test_nwchem_output.py
    tests/fixtures/nwchem_optimization_output.txt
    tests/fixtures/nwchem_shielding_output.txt
  </files>
  <action>
Create test fixtures with representative NWChem output format (based on RESEARCH.md patterns).

**tests/fixtures/nwchem_optimization_output.txt:**
Create a mock NWChem geometry optimization output file containing:
- Standard NWChem header/job info
- DFT optimization iterations
- Final "Output coordinates in angstroms" section with 3-4 atoms (e.g., methane: 1 C + 4 H)
- Use realistic-looking coordinate values

**tests/fixtures/nwchem_shielding_output.txt:**
Create a mock NWChem NMR shielding output file containing:
- Standard NWChem header
- "Chemical Shielding Tensors (GIAO, in ppm)" section
- Entries for each atom with isotropic shielding values
- Include both H and C atoms

Note: These fixtures are approximations based on documentation. They will be validated/updated when running actual NWChem calculations in later phases.

**tests/test_nwchem_output.py:**

`test_extract_optimized_geometry_parses_coordinates`:
- Load fixture, call extract_optimized_geometry
- Verify returned string has expected number of atom lines
- Verify each line has element + 3 coordinates

`test_extract_optimized_geometry_missing_section`:
- Pass text without geometry section
- Verify RuntimeError raised with helpful message

`test_parse_shielding_output_returns_expected_format`:
- Load fixture, call parse_shielding_output
- Verify returns dict with keys: index, atom, shielding
- Verify all lists have same length
- Verify index values are integers, atom values are strings, shielding are floats

`test_parse_shielding_output_missing_section`:
- Pass text without shielding section
- Verify RuntimeError raised with helpful message

`test_shielding_data_compatible_with_shifts_module`:
- Parse fixture, pass result to shielding_to_shift (from shifts.py)
- Verify it produces valid output without errors
  </action>
  <verify>
Run: `pytest tests/test_nwchem_output.py -v`

All tests should pass. The fixture-based tests validate the parsing logic works with expected NWChem output format.
  </verify>
  <done>
- Test fixtures exist with representative NWChem output
- All tests pass
- Parser output format confirmed compatible with existing shifts.py
  </done>
</task>

<task type="auto">
  <name>Task 3: Update nwchem package exports</name>
  <files>
    src/qm_nmr_calc/nwchem/__init__.py
  </files>
  <action>
Update `src/qm_nmr_calc/nwchem/__init__.py` to export output parser functions:

Add imports:
```python
from .output_parser import extract_optimized_geometry, parse_shielding_output
```

Update __all__ to include:
```python
__all__ = [
    "generate_optimization_input",
    "generate_shielding_input",
    "extract_optimized_geometry",
    "parse_shielding_output",
]
```

Note: If Plan 01 hasn't run yet (parallel Wave 1), create the full __init__.py with all exports.
  </action>
  <verify>
Run: `python -c "from qm_nmr_calc.nwchem import extract_optimized_geometry, parse_shielding_output; print('OK')"`
  </verify>
  <done>
- All four functions exportable from qm_nmr_calc.nwchem package
  </done>
</task>

</tasks>

<verification>
```bash
# Module imports
python -c "from qm_nmr_calc.nwchem import extract_optimized_geometry, parse_shielding_output"

# Run tests
pytest tests/test_nwchem_output.py -v

# Verify output format compatibility
python -c "
from qm_nmr_calc.nwchem import parse_shielding_output
from qm_nmr_calc.shifts import shielding_to_shift
from pathlib import Path

# Load fixture
fixture_path = Path('tests/fixtures/nwchem_shielding_output.txt')
if fixture_path.exists():
    output_text = fixture_path.read_text()
    shielding_data = parse_shielding_output(output_text)
    shifts = shielding_to_shift(shielding_data)
    print(f'Parsed {len(shifts[\"1H\"])} H shifts and {len(shifts[\"13C\"])} C shifts')
else:
    print('Fixture not found - will be created during task execution')
"
```
</verification>

<success_criteria>
1. `extract_optimized_geometry()` extracts XYZ coordinates from NWChem optimization output
2. `parse_shielding_output()` returns dict with index, atom, shielding lists
3. Output format compatible with existing `shielding_to_shift()` function
4. Both functions raise RuntimeError with clear messages when sections not found
5. All unit tests pass with mock fixtures
6. Functions exported from nwchem package
</success_criteria>

<output>
After completion, create `.planning/phases/07-nwchem-integration/07-02-SUMMARY.md`
</output>
