---
phase: 13-rdkit-conformer-generation
plan: "02"
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/conformers/filters.py
  - tests/test_conformer_filters.py
autonomous: true

must_haves:
  truths:
    - "RMSD deduplication removes conformers within threshold using symmetry-aware comparison"
    - "Energy window filter keeps only conformers within N kcal/mol of minimum"
    - "Single conformer passes through both filters unchanged"
    - "All conformers outside energy window are removed"
  artifacts:
    - path: "src/qm_nmr_calc/conformers/filters.py"
      provides: "RMSD deduplication and energy window filtering"
      exports: ["deduplicate_by_rmsd", "filter_by_energy_window"]
    - path: "tests/test_conformer_filters.py"
      provides: "Unit tests for filter functions"
      min_lines: 80
  key_links:
    - from: "src/qm_nmr_calc/conformers/filters.py"
      to: "rdkit.Chem.rdMolAlign"
      via: "GetBestRMS for symmetry-aware RMSD"
      pattern: "GetBestRMS|GetAllConformerBestRMS"
    - from: "src/qm_nmr_calc/conformers/filters.py"
      to: "energy filtering logic"
      via: "min energy + window comparison"
      pattern: "min\\(.*energ"
---

<objective>
Implement RMSD-based conformer deduplication and energy window filtering using TDD.

Purpose: After KDG generation and MMFF optimization, the conformer set contains duplicates (different starting geometries that converged to same minimum) and high-energy outliers. These two filters produce a diverse, low-energy conformer set ready for DFT calculations.

Output: Tested `conformers/filters.py` module with two functions: `deduplicate_by_rmsd` and `filter_by_energy_window`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-rdkit-conformer-generation/13-RESEARCH.md

@src/qm_nmr_calc/models.py
</context>

<feature>
  <name>RMSD Deduplication and Energy Window Filtering</name>
  <files>
    src/qm_nmr_calc/conformers/filters.py
    tests/test_conformer_filters.py
  </files>
  <behavior>
    Function 1: deduplicate_by_rmsd(mol, rmsd_threshold=0.5) -> list[int]
    - Mol with 1 conformer -> [conf_id_0] (single conformer always kept)
    - Mol with N identical conformers -> [conf_id_0] (only first kept)
    - Mol with N diverse conformers (RMSD > threshold) -> all kept
    - Uses symmetry-aware RMSD (GetBestRMS, NOT AlignMol)
    - Greedy algorithm: keep first, skip similar to any kept conformer
    - Returns list of RDKit conformer IDs to keep

    Function 2: filter_by_energy_window(conf_ids, energies, window_kcal=6.0) -> tuple[list[int], list[float]]
    - All energies within window -> all kept
    - Some energies outside window -> only within-window kept
    - Single conformer -> always kept (is its own minimum)
    - Returns (filtered_conf_ids, filtered_energies) preserving order
    - Empty inputs -> ([], [])
    - Window of 0.0 -> only minimum energy conformer(s) kept

    Both functions are pure (no side effects) and deterministic.
  </behavior>
  <implementation>
    Create src/qm_nmr_calc/conformers/filters.py with two functions.

    deduplicate_by_rmsd:
    - Get conf_ids from mol.GetConformers() via [conf.GetId() for conf in mol.GetConformers()]
    - If len <= 1, return conf_ids directly
    - Greedy loop: for each conformer, compare to all kept conformers using
      rdMolAlign.GetBestRMS(mol, mol, prbId=conf_id, refId=kept_id)
    - If RMSD < threshold to ANY kept conformer, mark as duplicate
    - Return list of kept conformer IDs

    NOTE on RMSD approach: Use GetBestRMS (pairwise) rather than GetAllConformerBestRMS
    (full matrix). The matrix approach requires careful index math with the lower-triangle
    flattened format. The pairwise approach is clearer and only marginally slower for
    typical ensemble sizes (< 200 conformers). The research shows both approaches.
    Choose clarity over micro-optimization.

    filter_by_energy_window:
    - Accept conf_ids (list[int]) and energies (list[float]) as parallel lists
    - If empty, return ([], [])
    - Find min_energy = min(energies)
    - Keep (conf_id, energy) pairs where (energy - min_energy) <= window_kcal
    - Return (filtered_conf_ids, filtered_energies) as tuple

    Note: This function is intentionally decoupled from RDKit Mol objects.
    It operates on pre-extracted conf_ids and energies, making it easy to test
    with synthetic data and reusable for both MMFF and DFT energy filtering.
  </implementation>
</feature>

<verification>
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_conformer_filters.py -v
```
All tests pass. No regressions in existing tests:
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest --tb=short -q
```
</verification>

<success_criteria>
- deduplicate_by_rmsd returns fewer conformers when duplicates exist
- deduplicate_by_rmsd preserves all conformers when all are diverse
- filter_by_energy_window removes conformers above threshold
- filter_by_energy_window keeps all when all within window
- Edge cases: single conformer, empty input, zero window
- Tests cover both functions with at least 8 test cases total
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/13-rdkit-conformer-generation/13-02-SUMMARY.md`
</output>
