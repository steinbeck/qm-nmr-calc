---
phase: 13-rdkit-conformer-generation
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/qm_nmr_calc/conformers/__init__.py
  - src/qm_nmr_calc/conformers/generator.py
  - tests/test_conformer_generator.py
autonomous: true

must_haves:
  truths:
    - "KDG conformer generation produces multiple 3D conformers from SMILES"
    - "MMFF optimization assigns energies in kcal/mol to each conformer"
    - "Adaptive conformer count returns 50 for rigid molecules and 200 for flexible ones"
    - "Invalid SMILES or MMFF-incompatible molecules raise clear errors"
    - "Random coords fallback fires when standard embedding fails"
  artifacts:
    - path: "src/qm_nmr_calc/conformers/__init__.py"
      provides: "Package marker for conformers module"
    - path: "src/qm_nmr_calc/conformers/generator.py"
      provides: "KDG generation, MMFF optimization, adaptive count"
      exports: ["generate_conformers_kdg", "optimize_conformers_mmff", "calculate_num_conformers"]
    - path: "tests/test_conformer_generator.py"
      provides: "Unit tests for generator functions"
      min_lines: 100
  key_links:
    - from: "src/qm_nmr_calc/conformers/generator.py"
      to: "rdkit.Chem.rdDistGeom"
      via: "KDG() params + EmbedMultipleConfs"
      pattern: "rdDistGeom\\.KDG|EmbedMultipleConfs"
    - from: "src/qm_nmr_calc/conformers/generator.py"
      to: "rdkit.Chem.AllChem"
      via: "MMFFOptimizeMoleculeConfs"
      pattern: "MMFFOptimizeMoleculeConfs"
    - from: "src/qm_nmr_calc/conformers/generator.py"
      to: "rdkit.Chem.rdMolDescriptors"
      via: "CalcNumRotatableBonds"
      pattern: "CalcNumRotatableBonds"
---

<objective>
Implement KDG conformer generation with MMFF optimization and adaptive conformer counts using TDD.

Purpose: This is the core conformer generation engine -- the first step in the ensemble pipeline. Distance geometry embedding with KDG (no crystal bias) produces initial 3D structures, MMFF optimization refines them and provides energies for downstream filtering.

Output: Tested `conformers/generator.py` module with three functions: `generate_conformers_kdg`, `optimize_conformers_mmff`, `calculate_num_conformers`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-rdkit-conformer-generation/13-RESEARCH.md

@src/qm_nmr_calc/models.py
@src/qm_nmr_calc/nwchem/geometry.py
</context>

<feature>
  <name>KDG Conformer Generation and MMFF Optimization</name>
  <files>
    src/qm_nmr_calc/conformers/__init__.py
    src/qm_nmr_calc/conformers/generator.py
    tests/test_conformer_generator.py
  </files>
  <behavior>
    Function 1: calculate_num_conformers(smiles, max_conformers=None) -> int
    - "CCO" (ethanol, 0 rotatable) -> 50
    - "CCCCCCCCCCCC" (dodecane, ~9 rotatable) -> 200
    - Any SMILES with max_conformers=10 -> 10 (override)
    - Invalid SMILES -> ValueError

    Function 2: generate_conformers_kdg(smiles, num_confs, random_seed=0xF00D) -> Chem.Mol
    - Valid SMILES + num_confs=5 -> Mol with 5 conformers (or fewer if molecule is constrained)
    - Must use rdDistGeom.KDG() params (NOT ETKDG)
    - Must set pruneRmsThresh=-1.0 (no pre-opt pruning)
    - Must set numThreads=0 (all threads)
    - Invalid SMILES -> ValueError
    - Must add hydrogens before embedding
    - On empty generation: retry with useRandomCoords=True, raise RuntimeError if still empty

    Function 3: optimize_conformers_mmff(mol, max_iters=200) -> list[tuple[int, float]]
    - Mol with conformers -> list of (not_converged, energy) tuples in kcal/mol
    - Must check MMFFHasAllMoleculeParams before optimization
    - Molecule without MMFF params -> ValueError with clear message
    - Returns one tuple per conformer, same order as mol.GetConformers()
  </behavior>
  <implementation>
    Create src/qm_nmr_calc/conformers/__init__.py (empty, package marker).

    Create src/qm_nmr_calc/conformers/generator.py with three functions.

    calculate_num_conformers:
    - Parse SMILES without H (Chem.MolFromSmiles)
    - If max_conformers is not None, return it directly
    - Count rotatable bonds via rdMolDescriptors.CalcNumRotatableBonds(mol)
    - Return 200 if num_rotatable > 8 else 50
    - Raise ValueError for invalid SMILES

    generate_conformers_kdg:
    - Parse SMILES, add H (Chem.AddHs)
    - Create KDG params: rdDistGeom.KDG()
    - Set params.randomSeed, params.numThreads=0, params.pruneRmsThresh=-1.0
    - Call rdDistGeom.EmbedMultipleConfs(mol, numConfs=num_confs, params=params)
    - If empty result, set params.useRandomCoords=True and retry
    - If still empty, raise RuntimeError
    - Return mol with conformers

    optimize_conformers_mmff:
    - Check AllChem.MMFFHasAllMoleculeParams(mol), raise ValueError if False
    - Call AllChem.MMFFOptimizeMoleculeConfs(mol, numThreads=0, maxIters=max_iters)
    - Return list of (not_converged, energy) tuples
    - Energy units are kcal/mol (MMFF native)
  </implementation>
</feature>

<verification>
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest tests/test_conformer_generator.py -v
```
All tests pass. No regressions in existing tests:
```bash
cd /home/chris/develop/qm-nmr-calc && python -m pytest --tb=short -q
```
</verification>

<success_criteria>
- generate_conformers_kdg("CCO", 5) returns Mol with >=1 conformer (KDG may produce fewer than requested)
- optimize_conformers_mmff returns list of tuples with float energies
- calculate_num_conformers returns 50 for ethanol, 200 for long chains
- All edge cases (invalid SMILES, no MMFF params) raise appropriate errors
- Tests cover all three functions with at least 8 test cases total
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/13-rdkit-conformer-generation/13-01-SUMMARY.md`
</output>
