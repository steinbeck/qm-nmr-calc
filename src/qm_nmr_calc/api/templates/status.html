{% extends "base.html" %}

{% block title %}Job Status | QM NMR Calculator{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.5.3/3Dmol-min.js"></script>
<style>
    /* Conformer progress styling */
    .status-nmr_complete td:nth-child(2) { color: green; }
    .status-failed td:nth-child(2) { color: red; }
    .status-optimizing td:nth-child(2),
    .status-nmr_running td:nth-child(2) { color: orange; }
    #conformer-progress-bar {
        height: 1.5rem;
    }
    #conformer-table {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<article>
    <header>
        <h2>Job Status: {{ job.job_id }}</h2>
    </header>

    <div id="status-display">
        <dl class="metadata-grid">
            <dt>Status</dt>
            <dd><span id="job-status" data-status="{{ job.status }}">{{ job.status }}</span></dd>

            <dt>Total Elapsed</dt>
            <dd><span id="elapsed-time">--</span></dd>

            {% if job.input_name %}
            <dt>Molecule</dt>
            <dd>{{ job.input_name }}</dd>
            {% endif %}

            <dt>SMILES</dt>
            <dd><code>{{ job.input_smiles }}</code></dd>

            <dt>Solvent</dt>
            <dd>{{ job.solvent }}</dd>

            <dt>Preset</dt>
            <dd>{{ job.preset }}</dd>
        </dl>
    </div>

    <!-- 3D Molecule Viewer -->
    <div id="viewer-section" style="margin-top: 1.5rem;">
        <h4>Molecular Structure</h4>
        <div id="viewer-container-3d"></div>
        <small class="muted">RDKit-generated geometry. Final optimized structure available when complete.</small>
    </div>

    <!-- Step Progress Section -->
    <div id="progress-section" style="display: none; margin-top: 1.5rem;">
        <h4>Progress</h4>

        <!-- Current Step -->
        <div id="current-step-display" style="display: none; margin-bottom: 1rem;">
            <div class="step-indicator">
                <span class="status-indicator status-running"></span>
                <strong id="current-step-label">--</strong>
                <span class="muted"> - <span id="step-elapsed">--</span></span>
            </div>
        </div>

        <!-- Completed Steps -->
        <div id="completed-steps" style="display: none;">
            <table role="grid" class="steps-table">
                <thead>
                    <tr>
                        <th>Step</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="steps-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Conformer Progress Section (for ensemble jobs) -->
    <div id="conformer-progress" style="display: none; margin-top: 1.5rem;">
        <h4>Conformer Progress</h4>
        <div id="conformer-stage" style="margin-bottom: 0.5rem;"></div>
        <progress id="conformer-progress-bar" value="0" max="100" style="width: 100%;"></progress>
        <p id="conformer-count" style="margin-top: 0.5rem;"></p>
        <p id="eta-display" class="muted"></p>

        <!-- Per-conformer status table (collapsible) -->
        <details style="margin-top: 1rem;">
            <summary>Conformer Details</summary>
            <table id="conformer-table" role="grid" style="margin-top: 0.5rem;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Energy (kcal/mol)</th>
                        <th>Population</th>
                    </tr>
                </thead>
                <tbody id="conformer-table-body">
                </tbody>
            </table>
        </details>
    </div>

    <div id="error-display" style="display: none;" role="alert">
        <p id="error-message"></p>
    </div>

    <footer>
        <small id="polling-status">Page refreshes automatically while job is running</small>
        <br>
        <a href="/">Submit another job</a>
    </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const JOB_ID = "{{ job.job_id }}";
    const CREATED_AT = new Date("{{ job.created_at }}");
    const POLL_INTERVAL = 3000; // 3 seconds

    const statusSpan = document.getElementById('job-status');
    const elapsedSpan = document.getElementById('elapsed-time');
    const errorDisplay = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');
    const pollingStatus = document.getElementById('polling-status');

    // Step progress elements
    const progressSection = document.getElementById('progress-section');
    const currentStepDisplay = document.getElementById('current-step-display');
    const currentStepLabel = document.getElementById('current-step-label');
    const stepElapsed = document.getElementById('step-elapsed');
    const completedStepsDiv = document.getElementById('completed-steps');
    const stepsTbody = document.getElementById('steps-tbody');

    // Conformer progress elements
    const conformerProgressDiv = document.getElementById('conformer-progress');
    const conformerStage = document.getElementById('conformer-stage');
    const conformerProgressBar = document.getElementById('conformer-progress-bar');
    const conformerCount = document.getElementById('conformer-count');
    const etaDisplay = document.getElementById('eta-display');
    const conformerTableBody = document.getElementById('conformer-table-body');

    let currentStepStartedAt = null;

    // 3D Viewer
    let viewer = null;

    function initViewer() {
        const container = document.getElementById('viewer-container-3d');
        if (!container) return;

        viewer = $3Dmol.createViewer(container, {
            backgroundColor: 'white'
        });
        loadGeometry(false);  // No labels for running job
    }

    async function loadGeometry(showLabels) {
        if (!viewer) return;

        try {
            const response = await fetch('/api/v1/jobs/' + JOB_ID + '/geometry.json');
            if (!response.ok) return;

            const data = await response.json();

            viewer.removeAllModels();
            viewer.removeAllLabels();

            // Prefer SDF format for proper double/triple bond display
            let model;
            if (data.sdf) {
                model = viewer.addModel(data.sdf, 'sdf');
            } else {
                model = viewer.addModel(data.xyz, 'xyz', {assignBonds: true});
            }

            viewer.setStyle({}, {
                stick: {radius: 0.12, colorscheme: 'Jmol'},
                sphere: {scale: 0.25, colorscheme: 'Jmol'}
            });

            viewer.zoomTo();
            viewer.render();
        } catch (error) {
            console.error('Error loading geometry:', error);
        }
    }

    function formatElapsed(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins > 0) {
            return mins + 'm ' + secs + 's';
        }
        return secs + 's';
    }

    function formatDuration(seconds) {
        if (seconds < 60) {
            return seconds.toFixed(1) + 's';
        }
        const mins = Math.floor(seconds / 60);
        const secs = (seconds % 60).toFixed(0);
        return mins + 'm ' + secs + 's';
    }

    function formatConformerStatus(status) {
        const labels = {
            'pending': 'Pending',
            'optimizing': 'Optimizing...',
            'optimized': 'Optimized',
            'nmr_running': 'NMR running...',
            'nmr_complete': 'Complete',
            'failed': 'Failed'
        };
        return labels[status] || status;
    }

    function formatEta(seconds) {
        if (seconds < 60) return '~' + Math.round(seconds) + ' seconds';
        if (seconds < 3600) return '~' + Math.ceil(seconds / 60) + ' minutes';
        return '~' + (seconds / 3600).toFixed(1) + ' hours';
    }

    function updateConformerProgress(data) {
        // Only show for ensemble jobs
        if (data.conformer_mode !== 'ensemble') {
            conformerProgressDiv.style.display = 'none';
            return;
        }

        conformerProgressDiv.style.display = 'block';

        // Update stage display
        if (data.current_step_label) {
            conformerStage.textContent = data.current_step_label;
        }

        // Update conformer count and progress
        if (data.conformer_progress && data.conformer_progress.length > 0) {
            const total = data.conformer_progress.length;
            const completed = data.conformer_progress.filter(c =>
                c.status === 'nmr_complete' || c.status === 'optimized'
            ).length;
            const failed = data.conformer_progress.filter(c =>
                c.status === 'failed'
            ).length;

            let countText = 'Conformers: ' + completed + '/' + total;
            if (failed > 0) {
                countText += ' (' + failed + ' failed)';
            }
            conformerCount.textContent = countText;

            // Update progress bar
            const progress = (completed / total) * 100;
            conformerProgressBar.value = progress;

            // Update per-conformer table
            conformerTableBody.innerHTML = data.conformer_progress.map(c => {
                const energyStr = c.energy_kcal !== null && c.energy_kcal !== undefined
                    ? c.energy_kcal.toFixed(2)
                    : '-';
                const popStr = c.population !== null && c.population !== undefined
                    ? (c.population * 100).toFixed(1) + '%'
                    : '-';
                return '<tr class="status-' + c.status + '">' +
                    '<td>' + c.conformer_id + '</td>' +
                    '<td>' + formatConformerStatus(c.status) + '</td>' +
                    '<td>' + energyStr + '</td>' +
                    '<td>' + popStr + '</td>' +
                    '</tr>';
            }).join('');
        }

        // Update ETA
        if (data.eta_seconds) {
            etaDisplay.textContent = 'Estimated time remaining: ' + formatEta(data.eta_seconds);
        } else {
            etaDisplay.textContent = '';
        }
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - CREATED_AT) / 1000);
        elapsedSpan.textContent = formatElapsed(elapsed);

        // Update current step elapsed time
        if (currentStepStartedAt) {
            const stepSecs = (now - currentStepStartedAt) / 1000;
            stepElapsed.textContent = formatElapsed(stepSecs);
        }
    }

    function updateStepProgress(data) {
        // Show progress section if there's any step info
        if (data.current_step || data.steps_completed.length > 0) {
            progressSection.style.display = 'block';
        }

        // Update current step
        if (data.current_step_label) {
            currentStepDisplay.style.display = 'block';
            currentStepLabel.textContent = data.current_step_label;
            currentStepStartedAt = data.step_started_at ? new Date(data.step_started_at) : null;
        } else {
            currentStepDisplay.style.display = 'none';
            currentStepStartedAt = null;
        }

        // Update completed steps table
        if (data.steps_completed && data.steps_completed.length > 0) {
            completedStepsDiv.style.display = 'block';
            stepsTbody.innerHTML = data.steps_completed.map(step =>
                `<tr>
                    <td><span class="status-indicator status-complete"></span>${step.label}</td>
                    <td>${formatDuration(step.duration_seconds)}</td>
                </tr>`
            ).join('');
        }
    }

    async function checkStatus() {
        try {
            const response = await fetch('/api/v1/jobs/' + JOB_ID);
            const data = await response.json();

            // Update status display
            statusSpan.textContent = data.status;
            statusSpan.setAttribute('data-status', data.status);
            updateElapsedTime();

            // Update step progress
            updateStepProgress(data);

            // Update conformer progress (for ensemble jobs)
            updateConformerProgress(data);

            if (data.status === 'complete') {
                // Redirect to results page
                pollingStatus.textContent = 'Job complete! Redirecting to results...';
                window.location.href = '/results/' + JOB_ID;
            } else if (data.status === 'failed') {
                // Show error message
                errorDisplay.style.display = 'block';
                errorMessage.textContent = data.error_message || 'An unknown error occurred';
                pollingStatus.textContent = 'Job failed. No automatic refresh.';
            } else {
                // Continue polling
                setTimeout(checkStatus, POLL_INTERVAL);
            }
        } catch (error) {
            console.error('Error checking job status:', error);
            // Retry with longer interval on error
            setTimeout(checkStatus, POLL_INTERVAL * 2);
        }
    }

    // Start polling and elapsed time updates when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        initViewer();
        checkStatus();
        setInterval(updateElapsedTime, 1000);
    });
})();
</script>
{% endblock %}
