{% extends "base.html" %}

{% block title %}Submit Job | QM NMR Calculator{% endblock %}

{% block content %}
<article>
    <header>
        <h2>NMR Calculation</h2>
        <p>Submit a molecule for quantum mechanical NMR prediction.</p>
    </header>

    {% if error %}
    <div role="alert">{{ error }}</div>
    {% endif %}

    <form action="/submit" method="post" enctype="multipart/form-data">
        <fieldset>
            <legend>Molecule Input</legend>

            <label for="smiles">SMILES String</label>
            <input type="text" id="smiles" name="smiles" placeholder="e.g., CCO for ethanol" value="{{ form_data.smiles or '' }}">
            <small>Enter the SMILES representation of your molecule</small>

            <label for="file">Or Upload MOL/SDF File</label>
            <input type="file" id="file" name="file" accept=".mol,.sdf">
            <small>Upload a .mol or .sdf file (single molecule)</small>
        </fieldset>

        <fieldset>
            <legend>Calculation Settings</legend>

            <label for="solvent">
                Solvent
                <span aria-label="Required field" style="color: var(--color-error);">*</span>
            </label>
            <select id="solvent" name="solvent" required>
                <option value="" disabled {% if not form_data.solvent %}selected{% endif %}>Select a solvent...</option>
                {% for solvent in solvents %}
                <option value="{{ solvent.value }}" {% if form_data.solvent == solvent.value %}selected{% endif %}>{{ solvent.label }}</option>
                {% endfor %}
            </select>

            <label for="preset">Calculation Preset</label>
            <select id="preset" name="preset">
                {% for preset in presets %}
                <option value="{{ preset.value }}" {% if (form_data.preset == preset.value) or (not form_data.preset and preset.value == 'production') %}selected{% endif %}>{{ preset.label }}</option>
                {% endfor %}
            </select>
        </fieldset>

        <fieldset>
            <legend>Conformer Mode</legend>

            <label for="conformer_mode">Calculation Mode</label>
            <select id="conformer_mode" name="conformer_mode" required>
                <option value="ensemble" {% if form_data.get('conformer_mode', 'ensemble') == 'ensemble' %}selected{% endif %}>
                    Ensemble (multi-conformer, recommended)
                </option>
                <option value="single" {% if form_data.get('conformer_mode') == 'single' %}selected{% endif %}>
                    Single conformer (faster, v1.x behavior)
                </option>
            </select>
            <small>Ensemble mode generates multiple conformers for more accurate predictions on flexible molecules.</small>

            <label for="conformer_method">Conformer Method</label>
            <select id="conformer_method" name="conformer_method">
                <option value="rdkit_kdg" {% if form_data.get('conformer_method', 'rdkit_kdg') == 'rdkit_kdg' %}selected{% endif %}>
                    RDKit KDG (fast, always available)
                </option>
                <option value="crest" {% if not crest_available %}disabled{% endif %}
                        {% if form_data.get('conformer_method') == 'crest' %}selected{% endif %}>
                    CREST/xTB (thorough){% if not crest_available %} - not installed{% endif %}
                </option>
            </select>
            <small>CREST provides better conformer sampling for complex molecules but requires external installation.</small>
        </fieldset>

        <details>
            <summary>Advanced Options</summary>
            <fieldset>
                <label for="max_conformers">Max Conformers (optional)</label>
                <input type="number" id="max_conformers" name="max_conformers"
                       value="{{ form_data.get('max_conformers', '') }}"
                       min="1" max="500" placeholder="Auto (based on flexibility)">
                <small>Leave empty for automatic selection based on molecular flexibility.</small>
            </fieldset>
        </details>

        <fieldset>
            <legend>Optional Details</legend>

            <label for="name">Molecule Name (optional)</label>
            <input type="text" id="name" name="name" placeholder="e.g., Caffeine" value="{{ form_data.name or '' }}">

            <label for="notification_email">Email Notification (optional)</label>
            <input type="email" id="notification_email" name="notification_email" placeholder="your@email.com" value="{{ form_data.notification_email or '' }}">
            <small>Leave blank if you don't want email notification</small>
        </fieldset>

        <button type="submit">Calculate NMR</button>
    </form>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const smilesInput = document.getElementById('smiles');
    const fileInput = document.getElementById('file');

    // Visual feedback for active input mode
    function updateInputStates() {
        const smilesHasValue = smilesInput.value.trim().length > 0;
        const fileHasValue = fileInput.files && fileInput.files.length > 0;

        if (smilesHasValue) {
            fileInput.disabled = true;
            fileInput.style.opacity = '0.5';
        } else if (fileHasValue) {
            smilesInput.disabled = true;
            smilesInput.style.opacity = '0.5';
        } else {
            // Both empty - enable both
            smilesInput.disabled = false;
            fileInput.disabled = false;
            smilesInput.style.opacity = '1';
            fileInput.style.opacity = '1';
        }
    }

    // When SMILES input changes
    smilesInput.addEventListener('input', function() {
        if (this.value.trim().length > 0) {
            // Clear file selection when typing SMILES
            fileInput.value = '';
        }
        updateInputStates();
    });

    // When file selection changes
    fileInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
            // Clear SMILES when selecting file
            smilesInput.value = '';
        }
        updateInputStates();
    });

    // Initial state check
    updateInputStates();

    // Conformer mode/method interaction
    const modeSelect = document.getElementById('conformer_mode');
    const methodSelect = document.getElementById('conformer_method');

    function updateMethodState() {
        if (modeSelect.value === 'single') {
            methodSelect.disabled = true;
            methodSelect.value = 'rdkit_kdg';
            methodSelect.style.opacity = '0.5';
        } else {
            // Only enable if not CREST-disabled
            const crestOption = methodSelect.querySelector('option[value="crest"]');
            if (crestOption && !crestOption.disabled) {
                methodSelect.disabled = false;
            } else if (methodSelect.value === 'rdkit_kdg') {
                methodSelect.disabled = false;
            }
            methodSelect.style.opacity = '1';
        }
    }

    modeSelect.addEventListener('change', updateMethodState);

    // Initialize conformer method state
    updateMethodState();
});
</script>
{% endblock %}
